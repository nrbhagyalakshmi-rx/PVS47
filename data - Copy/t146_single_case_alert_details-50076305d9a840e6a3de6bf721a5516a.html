var signal = signal || {};

// a convenience function for parsing string namespaces and
// automatically generating nested namespaces
function extend( ns, ns_string ) {
    var parts = ns_string.split('.'),
        parent = ns,
        pl, i;
    if (parts[0] == "signal") {
        parts = parts.slice(1);
    }
    pl = parts.length;
    for (i = 0; i < pl; i++) {
        //create a property if it doesnt exist
        if (typeof parent[parts[i]] == 'undefined') {
            parent[parts[i]] = {};
        }
        parent = parent[parts[i]];
    }
    return parent;
}

//Prototype methods
Date.prototype.addDays = function(days) {
    var date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
};

Array.prototype.remove = function (value) {
    return this.filter(function(f){f != value});
};

SCA_WORKFLOW_STATUS_ENUM = { NEW: 'New',
    ASSOCIATE_REVIEWED: 'AssociateReviewed',
    PHYSICIAN_REVIEWED: 'PhysicianReviewed',
    REQUIRED_EVALUATION: 'RequiredEvaluation',
    CONTINUED_MONITORING: 'ContinuedMonitoring'
};

SCA_DISPOSITION_ENUM = {
    VALIDATED_SIGNAL : 'ValidatedSignal',
    VALIDATED_NON_CONFIRMED_SIGNAL : 'ValidatedNonConfirmedSignal',
    VALIDATED_UNDER_INVESTIGATION : 'ValidatedUnderInvestigation',
    COMMUNICATED_SIGNAL : 'CommunicatedSignal',
    NON_VALID: 'NonValid'
};

SCA_PRIORITY_ENUM = {
    HIGH: "High",
    MEDIUM: "Medium",
    LOW: "LOW"
};

DATE_FMT_TZ = "YYYY-MM-DD";

signal.utils = (function() {

    var stacked = function(topValue, bottomValue) {
        var topComp = "";
        var bottomComp = "";

        if(_.isFunction(topValue)) {
            topComp = topValue()
        } else {
            topComp = '<div class="stacked-cell-center-top">' + topValue + '</div>'
        }

        if (_.isFunction(bottomValue)) {
            bottomComp = bottomValue()
        } else {
            bottomComp = '<div class="stacked-cell-center-bottom">' + bottomValue + '</div>'
        }

        return topComp + bottomComp
    };

    // And this is the definition of the custom function â€‹
    var render = function(tmpl_name, tmpl_data) {

        if ( !render.tmpl_cache ) {



            render.tmpl_cache = {};
        }
        if (!render.tmpl_cache[tmpl_name]) {
            var tmpl_dir = '/signal/assets/app/pvs/hbs-templates';
            var tmpl_url = tmpl_dir + '/' + tmpl_name + '.hbs';

            var tmpl_string = "";
            $.ajax({
                url: tmpl_url,
                method: 'GET',
                async: false,
                success: function(data) {
                    tmpl_string = data
                }
            });

            render.tmpl_cache[tmpl_name] = Handlebars.compile(tmpl_string);
        }

        return render.tmpl_cache[tmpl_name](tmpl_data)
    };

    var hbs_partial = function(tmpl_name) {
        if (!hbs_partial.tmpl_cache) {
            hbs_partial.tmpl_cache = {}
        }

        if (!hbs_partial.tmpl_cache[tmpl_name]) {
             var tmpl_dir = '/signal/assets/app/pvs/hbs-templates';
            var tmpl_url = tmpl_dir + '/' + tmpl_name + '.hbs';

            var tmpl_string = "";
            $.ajax({
                url: tmpl_url,
                method: 'GET',
                async: false,
                success: function(data) {
                    tmpl_string = data
                }
            });

            hbs_partial.tmpl_cache[tmpl_name] = tmpl_string
        }

        return hbs_partial.tmpl_cache[tmpl_name]
    };

    var composeUrl = function(controller, action, params) {
        var url = "/signal/" + controller + "/" + action + (_.isNull(params) ? '' : '?' + composeParams(params));

        return url
    };

    //TODO : Need to change this to handlebar form, Will be done later
    var postUrl = function (path, params, newWindow) {

        const form = document.createElement('form');
        form.method = "post";
        form.action = path;
        form.enctype = "application/x-www-form-urlencoded";
        if (newWindow) form.target = "_blank";

        var token = $("meta[name='_csrf']").attr("content");
        var parameter = $("meta[name='_csrf_parameter']").attr("content");
        params[parameter] = token;
        for (let key in params) {
            if (params.hasOwnProperty(key)) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = key;
                hiddenField.value = params[key];
                form.appendChild(hiddenField);
            }
        }
        document.body.appendChild(form);
        form.submit();
    }

    var composeParams = function(o) {
        return _.map(_.pairs(o), function(p){return p.join('=')} ).join('&')
    };

    var capitalIt = function(s) {
        return s && s[0].toUpperCase() + s.slice(1);
    };

    var breakIt = function(s) {
        return s ? s.split(/(?=[A-Z])/).join(' ') : s
    };

    var enable_load_button = function(ele, enabled) {
        return function(evt) {
            var targetEle = ele.find('.glyphicon');
            if (enabled) {
                $(targetEle).addClass('refresh-animate');
            } else {
                $(targetEle).removeClass('refresh-animate');
            }
        }
    };
    var setInLocalStorage = function(prop, data) {
        localStorage.setItem(prop, data);
    };

    var getFromLocalStorage = function(prop) {
        return localStorage.getItem(prop);
    };

    var setJSONInLocalStorage = function(prop, data) {
        localStorage.setItem(prop, JSON.stringify(data));
    };

    var getJSONFromLocalStorage = function (prop) {
        return JSON.parse(localStorage.getItem(prop));
    };

    var localStorageUtil = {
        setProp : setInLocalStorage,
        getProp : getFromLocalStorage,
        setJSON : setJSONInLocalStorage,
        getJSON : getJSONFromLocalStorage
    };

    var getQueryString = function() {
        var key = false, res = {}, itm = null;
        // get the query string without the ?
        var qs = location.search.substring(1);
        // check for the key as an argument
        if (arguments.length > 0 && arguments[0].length > 1)
            key = arguments[0];
        // make a regex pattern to grab key/value
        var pattern = /([^&=]+)=([^&]*)/g;
        // loop the items in the query string, either
        // find a match to the argument, or build an object
        // with key/value pairs
        while (itm = pattern.exec(qs)) {
            if (key !== false && decodeURIComponent(itm[1]) === key)
                return decodeURIComponent(itm[2]);
            else if (key === false)
                res[decodeURIComponent(itm[1])] = decodeURIComponent(itm[2]);
        }

        return key === false ? res : null;
    };

    return {
        render : render,
        stacked: stacked,
        composeUrl: composeUrl,
        postUrl: postUrl,
        composeParams: composeParams,
        capitalIt: capitalIt,
        breakIt: breakIt,
        hbs_partial: hbs_partial,
        enable_load_button: enable_load_button,
        localStorageUtil: localStorageUtil,
        getQueryString: getQueryString
    }
})();



Handlebars.registerHelper('i18n',
    function(str){
        return ( (typeof i18n) !== 'undefined' ? str : str)
    }
);

Handlebars.registerHelper('select', function(name, selectedValue, options, disp_field, value_field) {
    var out = "<select class='form-control selectBox' id=\'" + name + "\' name=" + name + ">\n";
    _.each(options, function(v) {
        out += "<option value='" + v[value_field] + "'" +
            (v[value_field] == selectedValue[value_field] ? " selected " : "") + " >" +
            escapeHTML(v[disp_field]) + "</option>\n"
    });
    out += "</select>";

    return new Handlebars.SafeString(out)
});

Handlebars.registerPartial('date_picker_template', signal.utils.hbs_partial('date_picker_template'));

//Handlebar helper to imitate the if conditions
Handlebars.registerHelper('if_eq', function(a, b, opts) {
    if (a == b) {
        return opts.fn(this);
    }
});

//Handlebar helper to imitate the if..else conditions
Handlebars.registerHelper('if_else_eq', function(a, b, opts) {
    if (a == b) {
        return opts.fn(this);
    } else {
        return opts.inverse(this);
    }
});

Handlebars.registerHelper('if_tag_exist', function(key, value,tags, opts) {
    if(value.tagText == tags[key-1].tagText && value.subTagText!=null && value.subTagText != tags[key-1].subTagText){
        return opts.fn(this);
    } else{
        return opts.inverse(this);
    }
});

Handlebars.registerHelper('if_else_neq', function(a, b, opts) {
    if (a != b) {
        return opts.fn(this);
    } else {
        return opts.inverse(this);
    }
});

//= require app/pvs/common/rx_handlebar_ext.js

var signal = signal || {};

signal.alerts_utils = (function() {
    var priorities;
    var workflowStates;

    var get_priorities = function() {
        $.ajax({
            url: "/signal/workflow/priorities",
            async: false,
            success: function(result) {
                priorities = result
            }
        });

        return priorities
    };

    var get_workflowStates = function(initData) {
        $.ajax({
            url: "/signal/workflow/workflowState",
            async: false,
            data: initData,
            success: function(result) {
                workflowStates = result
            }
        });

        return workflowStates
    };

    var priorities_selections = function(data, type, row) {
        var new_select = '<div><select class="form-control add-cursor" ' +
            'style="height: 30px;" onchange="updatePriority(this.value,' + row.id + ')">';
        var priority = row.priority;

        var the_select = _.reduce(priorities, function(m, p){
            if (p.value == priority)
                return m + '<option value="' + p.value + '" selected> ' + p.displayName + '</option>';
            else
                return m + '<option value="' + p.value + '">' + p.displayName + '</option>'
        }, new_select);
        the_select = the_select + '</select></div>';
        return the_select;
    };

    var workflow_selections = function(data, type, row) {
        var new_select = '<div><select class="form-control add-cursor" style="height: 30px;" onchange="updateStatus(this.value,' + row.id + ')">';
        var workflowState = row.workflowState;

        var the_select = _.reduce(workflowStates, function(m, ws){
            if (ws.value == workflowState)
                return m + '<option value="' + ws.value + '" selected> ' + ws.displayName + '</option>';
            else
                return m + '<option value="' + ws.value + '">' + ws.displayName + '</option>'
        }, new_select);
        the_select = the_select + '</select></div>';
        return the_select;
    };

    var compose_edit_state_link = function(value, rowId, filedName) {
        return "<span>" + value + "</span>" + "<a href='#' class='edit-state' >" +
            "<i class='fa fa-share-alt pull-right' data-field='"  + filedName +
            "' data-id='" + rowId + "'/></a>"
    };

    var state_changed = function(extra_values) {
        $("#valueSelect").change(function(evt) {
            var available_extra_values = extra_values[$(valueSelect).val()]
        })
    };

    //TODO this is a temp solution for the JSON format. It should come from server side
    //Function that converts the json innerhtml to the csv values.
    //It converts the properties which are not id.
    var show_json_as_csv = function (elementClass) {
        $("." + elementClass).each(function () {
           try {
              if (isNaN($(this).html())) {
                  var modifiedVal = "";
                  var jsonVal = JSON.parse($(this).html());
                  for (var obj in jsonVal) {
                     if (jsonVal.hasOwnProperty(obj)) {
                        for (var prop in jsonVal[obj]) {
                           if (jsonVal[obj].hasOwnProperty(prop)) {
                              if (prop != 'id') {
                                 modifiedVal = modifiedVal + jsonVal[obj][prop] + ","
                              }
                           }
                        }
                     }
                  }
                  $(this).html(modifiedVal.slice(0, -1))
              }
           } catch (err) {
              //Do nothing
              //console.log(err)
           }
           $(this).html()
        })
    };

    var init_matched_alerts_table = function(tableEle, url) {
        var table = tableEle.DataTable({
            "language": {
                "url": "/signal/assets/i18n/dataTables_" + userLocale + ".json"
            },

            ajax: {
                url: url,
                dataSrc: '',
                error: function(xhr,status,error){}
            },

            aoColumns:[
                {
                    mData: 'name'
                },
                {
                    mData: 'productSelection'
                },
                {
                    mData: 'topic'
                },
                {
                    mData: 'detectedDate'
                },
                {
                    mData: 'disposition'
                }
            ],
            dom: ''
        });

        return table
    };

    var getSignalNameList = function(signalsAndTopics) {
        var signalAndTopics = '';
        $.each(signalsAndTopics, function(i, obj){
            var url = signalDetailUrl + '?id=' + obj['signalId'];
            signalAndTopics = signalAndTopics + '<span class="click"><a href="' + url + '">' + obj['name'] + '</a></span>&nbsp;'
            signalAndTopics = signalAndTopics + ","
        });
        if(signalAndTopics.length > 1)
            return '<div>' + signalAndTopics.substring(0, signalAndTopics.length - 1) + '</div>';
        else
            return '-';
    };

    // For shared with modal
    var initializeShareWithSelect2 = function(){
        $('#shareWith').select2().on("change", function (e) {
            $('#shareWith').parent().removeClass('has-error');
        });
    };

    var initializeShareWithValues = function(){
        $('#sharedWithModal').on('show.bs.modal', function(e) {
            var executedConfigId = e.relatedTarget.id;
            $('#executedConfigId').val(executedConfigId);
            $('#sharedWith').parent().removeClass('has-error');

            $.ajax({
                cache: false,
                type: 'GET',
                url: getSharedWith + '?id=' + executedConfigId,
                success: function(result) {
                    var users = '';
                    $.each(result.users, function() {
                        users += this.name + '<br />'
                    });
                    $('#sharedWithUserList').html(users);
                    var groups = '';
                    $.each(result.groups, function() {
                        groups +=  this.name + ' <br />'
                    });
                    $('#sharedWithGroupList').html(groups);

                    $.each(result.all, function(i, data){
                        var option = new Option(data.name, data.id, true, true);
                        $('#sharedWith').append(option).trigger('change');
                    });
                }
            });

            sharedWithModalShow = true;

        }).on('hidden.bs.modal', function(e) {
            sharedWithModalShow = false;
            $('#sharedWith').val(null).trigger('change');
            $('#sharedWith').find('option').remove();
        });
    };

    var getTagsElement = function(tags) {
        var tagsElement = '<div class="tag-container block-ellipsis"><div class="tag-length">';
        var globalTagsArray = [];
        var alertTagsrray = [];
        var privateTagsArray = [];
        $.each(tags, function (key, value) {
            if (value.privateUser == '(P)') {
                privateTagsArray.push(value)
            } else if (value.tagType == '(A)') {
                alertTagsrray.push(value)
            } else {
                globalTagsArray.push(value);
            }
            tagsElement += signal.utils.render('tags_details', {
                key: key,
                value: value,
                tags:tags,
            });
        });
        var viewAllElements = fetchViewAllTags(globalTagsArray , alertTagsrray , privateTagsArray);

        tagsElement += '<a tabindex="0" title="Add/Edit Categories" class="editAlertTags btn-edit-tag mid"><i class="mdi mdi-pencil-box font-20 blue-1"> </i></a>';
        tagsElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="'+viewAllElements+'"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
        tagsElement += '</div></div>';
        return tagsElement
    };

    var fetchViewAllTags = function(globalTagsArray , alertTagsArray , privateTagsArray) {
        var returnElement = "";
        if (globalTagsArray.length > 0) {
            returnElement = "<p class='pbr' style='margin-top:7px'><b>Global Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {tags: globalTagsArray}) + "</p>"  ;
        }
        if (alertTagsArray.length > 0) {
            returnElement += "<p class='pbr' style='margin-top:7px'><b>Alert Specific Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {
                tags: alertTagsArray,
            })  + "</p>" ;
        }
        if (privateTagsArray.length > 0) {
            returnElement += "<p class='pbr' style='margin-top:7px'><b>Private Category</b><hr class='tagehr'>";
            returnElement += signal.utils.render('tags_details_view_all', {tags: privateTagsArray})  + "</p>" ;
        }
        return returnElement
    };
    return {
        get_priorities: get_priorities,
        priorities_selections: priorities_selections,
        get_workflowStates: get_workflowStates,
        workflow_selections: workflow_selections,
        compose_edit_state_link: compose_edit_state_link,
        state_change: state_changed,
        show_json_as_csv: show_json_as_csv,
        init_matched_alerts_table: init_matched_alerts_table,
        getSignalNameList: getSignalNameList,
        initializeShareWithSelect2 : initializeShareWithSelect2,
        initializeShareWithValues:initializeShareWithValues,
        get_tags_element : getTagsElement
    }
})();

var signal = signal || {};

signal.list_utils = (function () {
    var flag_it = function (flag, id) {
        var theHtml = '<i class="fa fa-flag-o text-muted rx-list-flag" data-id="' + id + '"></i>'
        if (flag) {
            theHtml = '<i class="fa fa-flag text-primary rx-list-flag" data-id="' + id + '"></i>'
        }
        return theHtml
    };

    var flag_handler = function (controller, action) {
        $(document).on('click', '.rx-list-flag', function (e) {
            var ele = e.target;
            var id = $(ele).attr('data-id');

            $.ajax({
                url: "/signal/" + controller + "/" + action + "?id=" + id,
                success: function (result) {
                    if (result.flagged) {
                        $(ele).removeClass('fa-flag-o').removeClass('text-muted');
                        $(ele).addClass('fa-flag').addClass('text-primary');
                    } else {
                        $(ele).addClass('fa-flag-o').addClass('text-muted');
                        $(ele).removeClass('fa-flag').removeClass('text-primary')
                    }
                }
            })
        })
    };

    var priority_link = function (priority, id) {
        var icon_url = compose_priority_icon(priority);
        return '<a href="#" class="change-priority"><img data-field="priority" data-info="row" data-id="' +
            id + '" data-value="' + priority + '" src="' + icon_url + '"/></a>'
    };

    var compose_priority_icon = function (priority) {
        var icon_url = "/signal/assets/icons/default_priority.png";

        if (_.contains(['high', 'low', 'medium'], priority.toLowerCase())) {
            icon_url = "/signal/assets/icons/" + priority.toLowerCase() + "_priority.png";
        }
        return icon_url;
    };

    var change_priority = function (priorityEle, priority) {
        var icon_url = compose_priority_icon(priority);
        $(priorityEle).attr("src", icon_url);
        $(priorityEle).attr("data-value", priority);
    };

    var change_priorityTest = function (priorityEle, priority) {
        $(priorityEle).attr("data-value", priority);
    };

    change_priorityTest

    var find_field = function (table_row_ele, attr_name) {
        return $(table_row_ele).find("[data-attribute-name='" + attr_name + "']")
    };

    var set_value = function (table_row_ele, attr_name, id, data_fun, app_name) {
        var ele = find_field(table_row_ele, attr_name);
        ele.html(data_fun(id, app_name));
    };

    var get_due_in = function (id, app_name) {
        var dueIn = 0;
        $.ajax({
            url: "/signal/alert/dueIn?alertId=" + id + "&appName=" + app_name,
            async: false,
            success: function (data) {
                dueIn = data.result;
            }
        });
        return dueIn
    };

    var due_in_comp = function (value) {
        if (value <= 0) {
            return "<div data-attribute-name='dueIn' style = 'color:red'>" + value + "</div>";
        } else {
            return "<div data-attribute-name='dueIn'>" + value + "</div>";
        }
    };

    var assigned_to_comp = function (id, assignedTo) {
        var html = '<div class="assignedToContainer"><select class="assignedToSelect form-control select2"></select><i class="mdi mdi-spin mdi-loading assignToProcessing" style="display: none"></i></div>';
        return html
    };

    var truncateTextAndShowTooltip = function (cutoff, wordbreak, escapeHtml) {
        var esc = function (t) {
            return t
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        };

        return function (d, type, row) {
            // Order, search and type get the original data
            if (type !== 'display') {
                return d;
            }

            if (typeof d !== 'number' && typeof d !== 'string') {
                return d;
            }

            d = d.toString(); // cast numbers

            if (d.length <= cutoff) {
                return esc(d);
            }

            var shortened = d.substr(0, cutoff - 1);

            // Find the last white space character in the string
            if (wordbreak) {
                shortened = shortened.replace(/\s([^\s]*)$/, '');
            }

            // Protect against uncontrolled HTML input
            if (escapeHtml) {
                shortened = esc(shortened);
            }

            return '<span class="ellipsis" title="' + esc(d) + '">' + shortened + '&#8230;</span>';
        };
    };

    var add_filters = function (table, filters, filter_toggle_bt_container) {

        var yadcf_filters = _.filter(filters, function (f) {
            if (f[1] != 'customized') {
                return true;
            } else {
                return false;
            }
        });

        var cust_filters = _.difference(filters, yadcf_filters);

        yadcf.init(table, _.map(yadcf_filters, function (item) {
            if (item[2] == true)
                return {column_number: item[0], filter_type: item[1], filter_reset_button_text: 'x'};
            else
                return {column_number: item[0], filter_type: item[1], filter_reset_button_text: false};
        }));

        if (filter_toggle_bt_container) {
            add_filter_toggle_button('idxxxxxx', filter_toggle_bt_container);
        }

        if (cust_filters) {
            _.each(cust_filters, function (f) {
                $(table.column(f[0]).header()).append(create_stacked_filter(f[0]));
            });
        }
    };

    var create_stacked_filter = function (idx) {
        return $("<input type='text' data-index='" + idx + "' class='column-filter' placeholder='Type to filter'>" +
            "<input type='text' data-index='" + idx + "' class='column-filter' placeholder='Type to filter'>");
    };

    var add_filter_toggle_button = function (table_id, container) {
        $('.yadcf-filter-wrapper, .column-filter').hide();
        $('.column-filter').click(function (evt) {
            evt.preventDefault();
            return false;
        });
        $('.column-filter').on('keyup', function (evt) {
            // Perform search
            var index = $(this).data('index');
            $(table_id).DataTable().column(index).search($(this).val()).draw();
        });
        var filterToggle = "<i class='table-filter-toggle glyphicon glyphicon-filter' data-table='" + table_id +
            "' onclick='signal.list_utils.handle_filter_toggle' data-show-filter='true'></i>";
        var toggle_button = $.parseHTML(filterToggle);
        if (!(_.isUndefined(container) && _.isNull(container))) {
            container.append(toggle_button);
        }

        $(document).on('filter-toggle-init', function (evt) {
            $('.table-filter-toggle').click(function (evt) {
                var hide_show_fitler = function (tableId, hideOrShow) {
                    if (hideOrShow === false) {
                        $(tableId + '_wrapper .yadcf-filter-wrapper,.column-filter').hide();
                    } else {
                        $(tableId + '_wrapper .yadcf-filter-wrapper,.column-filter').show();
                    }
                };

                var targetFilterToggle = $(evt.target);
                var tableId = targetFilterToggle.data('table');
                var showFilter = targetFilterToggle.data('show-filter');
                if (showFilter === 'true') {
                    targetFilterToggle.data('showFilter', 'false');
                    hide_show_fitler(tableId, false);
                } else {
                    targetFilterToggle.data('showFilter', 'true');
                    hide_show_fitler(tableId, true);
                }
            });
        });

        $(document).trigger('filter-toggle-init');
        return $(toggle_button);
    };

    var handle_filter_toggle = function (evt) {
        $(this).attr('target-table');
    };

    return {
        flag_it: flag_it,
        flag_handler: flag_handler,
        priority_link: priority_link,
        change_priority: change_priority,
        find_field: find_field,
        set_value: set_value,
        get_due_in: get_due_in,
        due_in_comp: due_in_comp,
        assigned_to_comp: assigned_to_comp,
        truncateTextAndShowTooltip: truncateTextAndShowTooltip,
        add_filters: add_filters,
        handle_filter_toggle: handle_filter_toggle,
        add_filter_toggle_button: add_filter_toggle_button
    }
})();
var signal = signal || {}

signal.activities_utils = (function() {
    var activity_table;
    var sortingCount = 3;

    var init_activities_table = function(table, url, appType) {
        var columns = create_activity_column_data(appType);
        activity_table = $(table).DataTable({
            "sPaginationType": "bootstrap",

            "language": {
                "url": "../assets/i18n/dataTables_" + userLocale + ".json"
            },
            "ajax": {
                "url": url,
                "dataSrc": ""
            },
            fnDrawCallback: function () {
                $('a[href="#activities"]').on("shown.bs.tab", function (e) {
                    $('#activitiesTable').DataTable().ajax.url(getActivityUrl()).load();
                    addGridShortcuts('#activitiesTable');
                    removeGridShortcuts('#alertsDetailsTable');
                    removeGridShortcuts('#archivedAlertsTable');
                });
            },
            "aaSorting": [[sortingCount, "desc"]],
            "bLengthChange": true,
            "iDisplayLength": 10,
            "bAutoWidth": false,
            "aoColumns": columns,
            "scrollX": true,
            "scrollY":"calc(100vh - 301px)",
            "autoWidth":true,
            columnDefs: [{
                "targets": '_all',
                "render": $.fn.dataTable.render.text()
            }]
        });
        return activity_table;
    };

    var create_activity_column_data = function(appType) {
        var aoColumns = [
            {
                "mData": "type",
                "mRender": function(data, type, row) {
                    if(row.type=='PECDissociated'){
                        return 'PEC Dissociated'
                    } else if(row.type=='PECAssociated') {
                        return 'PEC Associated'
                    }
                    return signal.utils.breakIt(row.type)
                },
                'className': 'col-min-150'
            },
            {
                "mData": "details",
                "mRender": function(data, type, row) {
                    row.details = row.details.replace(/<br>/g,'\n')
                    if (row.justification) {
                        return "<span class='word-wrap-break-word'>"+escapeHTML(row.details) + " -- with Justification '" + escapeHTML(row.justification) + "'"+"</span>";
                    } else {
                        var descriptionText = process_description(row.details);
                        return "<span class='word-wrap-break-word cell-break'>"+descriptionText+"</span>";
                    }
                },
                'className': 'col-min-200 col-max-300'
            },
            {
                "mData": "performedBy",
                "mRender": function (data, type, row) {
                    if(row.performedByDept && row.performedByDept != '') {
                        return escapeHTML(row.performedBy + " (" + row.performedByDept + ")")
                    } else{
                        return row.performedBy
                    }
                },
                'className': 'col-min-150'
            },
            {
                "mData": "timestamp",
                "mRender": function(data, type, full) {
                    return data

                },
                'className': 'col-min-150'
            }
        ];
        if(appType == 'Single Case Alert') {
            aoColumns.splice(0,0,{
                "mData": "caseNumber",
                'className': 'col-min-100'
            });
            aoColumns.splice(2,0,{
                "mData": "suspect",
                'className': 'col-min-200'
            });
            aoColumns.splice(3,0,{
                "mData": "eventName",
                'className': 'col-min-150'
            });
            aoColumns.splice(5,0,{
                "mData": "currentAssignment",
                "mRender": function (data, type, row) {
                    var currAssignment
                    if (row.currentAssignmentDept && row.currentAssignmentDept != '') {
                        currAssignment = row.currentAssignment + " (" + row.currentAssignmentDept + ")"
                    } else {
                        currAssignment = (row.currentAssignment)
                    }
                    return escapeHTML(currAssignment)
                },
                'className': 'col-min-150'
            });
            sortingCount = 7
        }else if(appType == 'Literature Search Alert') {
            aoColumns.splice(0,0,{
                "mData": "articleId",
                'className': 'col-min-100'
            });
            aoColumns.splice(2,0,{
                "mData": "searchString",
                'className': 'col-min-100'
            });
            aoColumns.splice(3,0,{
                "mData": "productName",
                'className': 'col-min-200'
            });
            aoColumns.splice(4,0,{
                "mData": "eventName",
                'className': 'col-min-150'
            });
            aoColumns.splice(6,0,{
                "mData": "currentAssignment",
                "mRender": function (data, type, row) {
                    var currAssignment
                    if (row.currentAssignmentDept && row.currentAssignmentDept != '') {
                        currAssignment = row.currentAssignment + " (" + row.currentAssignmentDept + ")"
                    } else {
                        currAssignment = (row.currentAssignment)
                    }
                    return escapeHTML(currAssignment)
                },
                'className': 'col-min-150'
            });
            sortingCount = 8
        } else if (appType == 'Aggregate Case Alert' || appType == 'EVDAS Alert') {
            aoColumns.splice(1,0,{
                "mData": "suspect",
                'className': 'col-min-150'
            });
            aoColumns.splice(2,0,{
                "mData": "eventName",
                'className': 'col-min-150'
            });
            aoColumns.splice(4,0,{
                "mData": "currentAssignment",
                "mRender": function (data, type, row) {
                    var currAssignment
                    if (row.currentAssignmentDept && row.currentAssignmentDept != '') {
                        currAssignment = row.currentAssignment + " (" + row.currentAssignmentDept + ")"
                    } else {
                        currAssignment = (row.currentAssignment)
                    }
                    return escapeHTML(currAssignment)
                },
                'className': 'col-min-150'
            });
            sortingCount = 6
        }
        return aoColumns
    };

    var reload_activity_table = function() {

        if (typeof activity_table != "undefined" && activity_table != null) {
            activity_table.ajax.reload();
        } else {
            console.log("Unable to reload the activity table. Please refresh the page.")
        }

    };

    var process_description = function(descriptionStr) {
        if (typeof descriptionStr != "undefined" && descriptionStr != null) {
            var descriptions = descriptionStr.split('|');
            //var formattedString = ''
            var formattedString =  document.createElement('div');
            for (var index = 0; index<descriptions.length; index++) {
                var description = descriptions[index];
                var descSpan = document.createElement('span');
                descSpan.innerHTML = escapeHTML(description);
                descSpan.innerHTML = descSpan.innerHTML.replace(/\n/g, '<br>')
                formattedString.appendChild(descSpan);
                formattedString.appendChild(document.createElement('br'));
            }
            return formattedString.innerHTML;
        }
    };

    return {
        init_activities_table : init_activities_table,
        process_description : process_description,
        reload_activity_table : reload_activity_table
    }
})();

function getActivityUrl() {
    if (applicationName === ALERT_CONFIG_TYPE.LITERATURE_SEARCH_ALERT) {
        return alertActivities;
    } else if (applicationName === ALERT_CONFIG_TYPE.SIGNAL_MANAGEMENT) {
        return activityUrl;
    }
    return alertActivitiesUrl + '?executedIdList=' + executedIdList + "&appType=" + applicationName

}


var signal = signal || {};

signal.actions_utils = (function() {
    var action_list_table;
    var current_create_bt;
    var adhoc_validated_table;

    var set_action_create_modal = function () {
        $('#createActionModal').on('hidden.bs.modal', function (e) {
            $(this)
                .find('#config').val('').end()
                .find('#type').val('').end()
                .find('#meetingElement').val('').end()
                .find('.assignedToValue').val('').trigger('change').end()
                .find('.assignedToValue').empty().end()
                .find("input[type=text],textarea").val('')
                .end();

            $('#createActionModal .select2-selection__rendered').hover(function () {
                $(this).removeAttr('title');
            });

        });

        $('#action-edit-modal').on('hidden.bs.modal', function (e) {
            clear_edit_errors();
            $(this)
                .find("input[type=text],textarea,select")
                .val('')
                .end()
        });

        $('#editActionModal').on('hidden.bs.modal', function (e) {
            clear_edit_signal();
            $(this)
                .find("input[type=text],textarea,select")
                .val('')
                .end()
        });

        $(document).on('click', '.action-create', function (evt) {
            var srcEle = $(evt.target);
            current_create_bt = srcEle;
            var alertId = alertId;
            if (typeof (srcEle.attr('alert-id')) !== 'undefined') {
                alertId = srcEle.attr('alert-id')
            }
            var createActionModal = $('#createActionModal');
            var createActionButton = $("#create-action-btn");
            createActionModal.find('.id-element').attr('data-id', alertId);

            //Set the alertId in the hidden field of the modal.
            if (typeof alertId != "undefined" && alertId != '') {
                createActionModal.find(".alertId").val(alertId);
            }

            createActionModal.find('#due-date-picker').datepicker();
            createActionButton.attr("disabled", false);
            clear_errors();
            $('.action-type-list').removeClass('hidden');
            $('.meeting-list').addClass('hidden');
            createActionModal.modal({});

            //Event bind when the save/create button is click
            // ked in the action event modal.
            createActionButton.unbind('click').click(function (event) {
                createActionButton.attr("disabled", true);
                var alertId = $(event.target).attr('data-id');
                var actionModalId = $("#createActionModal #tempForm");
                $.ajax({
                    type: "POST",
                    url: '/signal/action/save',
                    data: getActionDetails(actionModalId),
                    async: false,
                    cache: false
                }).success(function (response) {
                    if (response.status == false) {
                        clear_errors();
                        var errorMsg = "<div class='alert alert-danger'>";
                        for (var index = 0; index < response.data.length; index++) {
                            var errorMessageObj = response.data[index];
                            errorMsg += errorMessageObj;
                            errorMsg += '</br>';
                        }
                        errorMsg += "</div>";
                        $('#createActionModal .modal-body').prepend(errorMsg);
                        createActionButton.attr("disabled", false);
                    } else {
                        createActionModal.modal('hide');
                        current_create_bt.parentsUntil("td").find('.default-value').html(response.actionCount);

                        if (typeof applicationLabel != 'undefined' && applicationLabel === "Case Detail") {
                            $('#action-table').DataTable().ajax.reload();
                        } else {
                            if (typeof alertId != "undefined" && alertId != '') {
                                if (typeof detail_table != "undefined") {
                                    detail_table.ajax.reload();
                                }
                            } else {
                                $('#action-table').DataTable().ajax.reload();
                                $('#meeting-table').DataTable().ajax.reload();
                                $('#signalActivityTable').DataTable().ajax.reload();
                            }
                        }

                        //Refresh the activity table
                        if (typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                            signal.activities_utils.reload_activity_table();
                            if (applicationLabel == APPLICATION_LABEL.SIGNAL_MANAGEMENT) {
                                signal.meeting_utils.reload_meeting_table();
                            }
                        }
                    }
                }).error(function (data) {
                    clear_errors();
                    var errorMsg = "<div class='alert alert-danger'>";
                    errorMsg += "Error occured while saving Action.";
                    errorMsg += "</div>";
                    $('#createActionModal .modal-body').prepend(errorMsg);
                    createActionButton.attr("disabled", false);
                })
            })
        })
    };

    var getActionDetails = function(modalId) {
        return {
            "config": modalId.find("#config").val(),
            "type": modalId.find("#type").val(),
            "assignedToValue": modalId.find("#assignedTo").val(),
            "dueDate": modalId.find("#dueDate").val(),
            "details": modalId.find("#details").val(),
            "comments": modalId.find("#comments").val(),
            "alertId": modalId.find("#alertId").val(),
            "appType": modalId.find("#appType").val(),
            "exeConfigId": modalId.find("#exeConfigId").val(),
            "meetingId": modalId.find("#meetingElement").val(),
            "actionStatus": modalId.find("#actionStatus").val(),
            "actionId": modalId.find("#actionId").val()
        }
    };

    var clear_errors = function() {
        $('#createActionModal .modal-body .alert').remove()
    };

    var clear_edit_errors = function () {
        $('#action-edit-modal .modal-body .alert').remove()
    };
    var clear_edit_signal = function () {
        $('#editActionModal .modal-body .alert').remove()
    };

//Single and Aggregate Action list data
    var set_action_list_modal = function(comp) {
        $(document).on('click', '.list-action', function(evt) {
            evt.preventDefault();
            comp.modal('toggle', $(this));
        });
        comp.on('shown.bs.modal', function(evt) {
            var srcEle = evt.relatedTarget;
            var alertId = $(srcEle).attr('data-id');
            var appType = $("#createActionModal #tempForm").find("#appType").val();
            var actionUrl = "/signal/action/listByAlert?alertId=" + alertId +"&appType=" + appType;
            action_list_table = $('#action-table').DataTable({
                destroy : true,
                "language": {
                    "url": "../assets/i18n/dataTables_" + userLocale + ".json"
                },
                fnDrawCallback: function () {
                    $('.edit-action-link').click(function(evt) {
                        var url = "/signal/action/getById?id=" + $(this).attr('data-id');
                        $.ajax({
                            url: url,
                            async: false,
                            cache: false
                        }).done(function(data) {
                            data.action_types = action_select_values.types;
                            data.action_configs = action_select_values.configs;
                            data.all_status = action_select_values.allStatus;
                            data.alertId = alertId;
                            data.actionStatus = {name: data.actionStatus};

                            var html_content = signal.utils.render('action_editor', data);
                            $('#action-editor-container').html(html_content);
                            $('#action-editor-container #due-date-picker').datepicker({
                                date: data.dueDate
                            }).keydown(preventEnterKeySubmit);

                            var dueDate = moment(data.dueDate, "DD-MMM-YYYY").format(DEFAULT_DATE_FORMAT);
                            $('#action-editor-container').find('#due-date-picker').find('#dueDate').val(dueDate);
                            $('#action-editor-container').find('#appType').val(appType);
                            var action_editor = $('#action-editor-container');
                            var editActionModal = $('#action-edit-modal');
                            editActionModal.find('.id-element').attr('data-id', alertId);
                            editActionModal.find('.assignedToValue').val(null).trigger('change');
                            $('#action-modal').modal('hide');
                            editActionModal.modal({});

                            $('#action-edit-modal #cancel-bt').click(handle_action_editor_cancel);
                            $('#action-edit-modal #update-bt').click(handle_action_editor_update)
                        })
                    })
                },
                "fnInitComplete": function(oSettings, json) {
                    $('.action-create').attr('data-id', alertId);
                    signal.actions_utils.set_action_create_modal();
                    $('#due-date-picker').datepicker()
                },
                "ajax": {
                    "url": actionUrl,
                    cache:false,
                    "dataSrc": ""
                },
                "searching": true,
                "bProcessing": true,
                "bLengthChange": true,
                "oLanguage": {
                    "sProcessing": '<div class="grid-loading"><img src="/signal/assets/spinner.gif" width="30" align="middle" /></div>'
                },
                "iDisplayLength": 5,
                "aLengthMenu": [[5, 10, 20, -1], [5, 10, 20, "All"]],
                "aoColumns": [
                    {
                        "mData": "id",
                        "mRender": function (data, type, row) {
                            return "<a href='#' class='edit-action-link' data-id='" +
                                row.id + "'>" + row.id + "<a>"
                        }
                    },
                    {
                        "mData": "type"
                    },
                    {
                        "mData": "config"
                    },
                    {
                        "mData": "details",
                        "className":"col-min-200"
                    },
                    {
                        "mData": "dueDate",
                        "className":"col-min-100"
                    },
                    {
                        "mData": "assignedTo",
                        "className":"col-min-100"
                    },
                    {
                        "mData" : "actionStatus"
                    },
                    {
                        "mData": "completedDate",
                        "className":"col-min-150",
                        mRender: function(data, type,row){
                            return row.completedDate
                        }
                    }
                ],
                scrollX: true,
                columnDefs: [{
                    "targets": '_all',
                    "render": $.fn.dataTable.render.text()
                }]
            })
        });

        comp.on('hidden.bs.modal', function(evt) {
          comp.find("#action-table").empty();
         });
        return action_list_table
    };
    var setEditModalValues = function (editActionModal, data) {
        var actionType = data.typeObj.id;
        var meetingId = data.meetingId;
        var option = new Option(data.assignedToObj.fullName, data.assignedToObj.id, true, true);
        editActionModal.find("#assignedTo").append(option).trigger('change');
        if(!meetingId) {
            editActionModal.find("#type").val(actionType)
        } else {
            editActionModal.find("#meetingElement").val(meetingId);
            editActionModal.find("#meetingValue").val(meetingId);
        }
        editActionModal.find(".status-icon").removeClass('hidden');
        editActionModal.find("#config").val(data.configObj.id);
        editActionModal.find("#actionId").val(data.id);
        var dueDate = moment(data.dueDate, DEFAULT_DATE_FORMAT).format(DEFAULT_DATE_FORMAT);
        editActionModal.find("#due-date-picker").datepicker({
            date: $("#due-date-picker").val() ? new Date($("#due-date-picker").val()) : null,
            momentConfig: {
                culture: userLocale,
                format: DEFAULT_DATE_DISPLAY_FORMAT
            }
        }).keypress(preventEnterKeySubmit);
        editActionModal.find("#dueDate").val(dueDate);
        editActionModal.find("#comments").val(data.comments);
        editActionModal.find("#details").val(data.details);
        editActionModal.find("#actionStatus").val(data.actionStatus);
        editActionModal.find('.action-value').trigger('change');
    };
    var handle_action_editor_cancel = function(evt) {
        evt.preventDefault();
        var action_list_table = $('#action-table').DataTable();
        action_list_table.ajax.reload();
        $('#action-edit-modal').modal('hide')
    };

    var handle_action_editor_update = function(evt) {
        evt.preventDefault();
        if (!evt.handled) {
            evt.handled = true;
            var json = $('#action-editor-container form#action-editor-form').serialize() + "&appType=" + $("#appType").val() + "&exeConfigId=" + $("#exeConfigId").val();

            $.ajax({
                url: '/signal/action/updateAction',
                method: 'POST',
                data: json,
                async: false,
                cache: false,
                success: function(response) {
                    if (response.status == false) {
                        clear_edit_errors();
                        var errorMsg = "<div class='alert alert-danger'>";
                        for(var index = 0; index < response.data.length; index++) {
                            var errorMessageObj = response.data[index];
                            errorMsg += errorMessageObj;
                            errorMsg += '</br>';
                        }
                        errorMsg += "</div>";
                        $('#action-edit-modal .modal-body').prepend(errorMsg)
                    } else {
                        var action_list_table = $('#action-table').DataTable()
                        action_list_table.ajax.reload()
                        //Refresh the activity table
                        if(typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                            signal.activities_utils.reload_activity_table();
                        }
                        $('#action-edit-modal').modal('hide')
                    }

                }
            })
        }
    }
    //Ad-hoc alert action list data
    var init_action_table = function (table_id, appType) {

        var dataUrl = "/signal/action/listByAlert?alertId=" + alertId +"&appType=" + appType;
        adhoc_validated_table = $(table_id).DataTable({
            //"sPaginationType": "bootstrap",

            "language": {
                "url": "../assets/i18n/dataTables_" + userLocale + ".json"
            },

            fnDrawCallback: function () {
                $('.edit-action-link').click(function(evt) {
                    var url = "/signal/action/getById?id=" + $(this).attr('data-id')
                    $.ajax({
                        url: url,
                        async: false,
                        cache: false
                    }).done(function(data) {
                        if(appType == "Signal Management" || appType == "Topic") {
                            var editActionModal = $('#editActionModal');
                            setEditModalValues(editActionModal, data);
                            editActionModal.modal({});
                            editActionModal.find('.update-action').unbind().click(function () {
                                var actionModalId = $("#editActionModal #tempForm");
                                var url;
                                if ($('.meeting-decider').val() == 'true') {
                                    url = '/signal/action/updateMeetingAction';
                                } else {
                                    url = '/signal/action/updateAction';
                                }
                                $.ajax({
                                    url: url,
                                    method: 'POST',
                                    data: getActionDetails(actionModalId),
                                    async: false,
                                    cache: false,
                                    success: function (response) {
                                        if (response.status == false) {
                                            clear_edit_signal();
                                            var errorMsg = "<div class='alert alert-danger'>";
                                            for(var index = 0; index < response.data.length; index++) {
                                                var errorMessageObj = response.data[index];
                                                errorMsg += errorMessageObj;
                                                errorMsg += '</br>';
                                            }
                                            errorMsg += "</div>";
                                            $('#editActionModal .modal-body').prepend(errorMsg)
                                        } else {
                                            $('#action-table').DataTable().ajax.reload();
                                            $('#meeting-table').DataTable().ajax.reload();

                                            //Refresh the activity table
                                            if(typeof applicationLabel != 'undefined' && applicationLabel !== APPLICATION_LABEL.CASE_DETAIL && applicationLabel !== APPLICATION_LABEL.EVENT_DETAIL) {
                                                signal.activities_utils.reload_activity_table();
                                            }
                                            editActionModal.modal('hide');
                                        }
                                    }
                                })
                            });
                        } else {
                            data.action_types = action_select_values.types;
                            data.action_configs = action_select_values.configs;
                            data.all_status = action_select_values.allStatus;
                            data.alertId = alertId;
                            data.actionStatus = {name: data.actionStatus};
                            var html_content = signal.utils.render('action_editor', data);
                            var action_editor = $('#action-editor-container');
                            action_editor.html(html_content);
                            $('#action-editor-container #due-date-picker').datepicker({
                                date: data.dueDate,
                                momentConfig: {
                                    culture: userLocale,
                                    tz: userTimeZone,
                                    format: DEFAULT_DATE_DISPLAY_FORMAT
                                }
                            }).keydown(preventEnterKeySubmit);
                            action_editor.find('#due-date-picker').find('#dueDate').val(data.dueDate);
                            action_editor.find('#due-date-picker').datepicker();
                            var editActionModal = $('#action-edit-modal');
                            editActionModal.find('.id-element').attr('data-id', alertId);
                            editActionModal.modal({});
                            $('#action-editor-container').find('#appType').val(appType);
                            $('#action-edit-modal #cancel-bt').click(handle_action_editor_cancel);
                            $('#action-edit-modal #update-bt').click(handle_action_editor_update)
                        }

                    })
                })

            },
            "fnInitComplete": function(oSettings, json) {
                $('.action-create').attr('data-id', alertId)
                signal.actions_utils.set_action_create_modal()
                $('#due-date-picker').datepicker()
            },
            "ajax": {
                "url": dataUrl,
                cache: false,
                dataSrc: ""
            },
            searching: true,
            dom: 'Bfrtip',
            buttons: [
                {
                    text: 'New Action',
                    className: 'btn-primary action-create',
                    action: function ( e, dt, node, config ) {
                    }
                }
            ],
            aaSorting: [[0, "desc"]],
            "bLengthChange": true,
            "iDisplayLength": 10,
            "aLengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            "aoColumns": [
                {
                    "mData": "id",
                    mRender: function(data, type, row) {
                        return "<a href='#' class='edit-action-link' data-id='" +
                            row.id + "'>" + row.id + "<a>"
                    },
                    "className": ""
                },
                {
                    "mData": "type",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.type) + "</span>";
                    }
                },
                {
                    "mData": "config",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.config) + "</span>";
                    }
                },
                {
                    "mData": "details",
                    "className": "",
                    "mRender": function (data, type, row) {
                        return "<span class='word-wrap-break-word'>" + escapeHTML(row.details) + "</span>";
                    }
                },
                {
                    "mData": "dueDate",
                    'className': 'col-min-100',
                    mRender: function(data, type, row) {
                        if (!(row.actionStatus === 'Closed' && row.actionStatus === 'Deleted') && row.passDue) {
                            return "<div class='closed'>" + row.dueDate + "</div>"
                        } else {
                            return "<div>" + row.dueDate + "</div>"
                        }
                    }
                },
                {
                    "mData": "assignedTo",
                    mRender: function(data, type, row) {
                        return escapeHTML(row.assignedTo)
                    },
                    "className": "col-min-150"
                },
                {
                    "mData": "",
                    mRender: function(data, type, row) {
                        return row.actionStatus
                    },
                    "className": ""
                },
                {
                    "mData": "completedDate",
                    mRender: function(data, type,row){
                        return row.completedDate
                    },
                    "className": "col-min-150"
                }
            ],
            scrollX : true
        });
        adhoc_validated_table.button().disable();
        return adhoc_validated_table
    };

    var build_action_render = function(data) {
        var action_drop_down_html = signal.utils.render("action_drop_down", data);
        return action_drop_down_html
    };
    var reload_action_table = function () {
        if (typeof adhoc_validated_table != "undefined" && adhoc_validated_table != null) {
            adhoc_validated_table.ajax.reload();
        } else {
            console.log("Unable to reload the activity table. Please refresh the page.")
        }
    };

    return {
        set_action_list_modal: set_action_list_modal,
        set_action_create_modal: set_action_create_modal,
        build_action_render: build_action_render,
        init_action_table: init_action_table,
        reload_action_table : reload_action_table,
        handle_action_editor_cancel: handle_action_editor_cancel,
        handle_action_editor_update: handle_action_editor_update,
        clear_edit_errors: clear_edit_errors
    }
})();

var signal = signal || {}

signal.alertComments = (function () {

    var listComments = function (caseJson) {

        //Modal object
        var commentModal = $('#commentModal');

        //Populate the existing comments and bind events to them.
        populateComments(commentModal, caseJson);

        //Set values to the modal elements.
        var commentMetaInfo = ""
        if (caseJson.alertType == "Aggregate Case Alert") {
            commentMetaInfo = '<span id="productName">' + caseJson.productName + '</span> - <span id="eventName">' + caseJson.eventName + '</span>'
        } else {
            commentMetaInfo = '<span id="caseNumber">' + caseJson.caseNumber + '</span> - <span id="productFamily">' + caseJson.productFamily + '</span>'
        }
        commentModal.find("#comment-meta-info").html(commentMetaInfo);
        commentModal.find("#application").html(caseJson.alertType);
        commentModal.modal('show');
        bindSaveComment(commentModal);
    };

    var populateComments = function (commentModal, caseJson, onSignalScreen) {
        var updatedComments = $("#commentbox").val();
        $.ajax({
            url: "/signal/alertComment/listComments",
            data: caseJson,
            success: function (result) {
                if (result) {
                    commentModal.find("#no-comments").addClass("hide");
                    commentModal.find('#commentbox').removeClass("hide");
                    commentModal.find('.add-comments').html("Update");
                    if(updatedComments.length >= result.comments.length){
                        commentModal.find("#commentbox").val(updatedComments);
                    }else{
                        commentModal.find("#commentbox").val(result.comments);
                    }
                    commentModal.find("#commentId").val(result.id);
                    commentModal.find(".createdBy").text("Last Modified by " + result.modifiedBy + " on " + result.dateUpdated);
                    commentModal.find('.add-comments').prop("disabled", true);

                }else if(typeof isCommentAdded != 'undefined' && isCommentAdded && onSignalScreen){
                    commentModal.find("#commentId").val('');
                    commentModal.find('.add-comments').html("Add");
                    commentModal.find("#commentbox").val('');
                    commentModal.find("#no-comments").removeClass("hide");
                    commentModal.find('.add-comments').prop("disabled", true);
                    commentModal.find(".createdBy").text('');

                }else if(typeof isCommentAdded != 'undefined' && isCommentAdded){
                    commentModal.find("#commentId").val('');
                    commentModal.find('.add-comments').html("Add");
                    commentModal.find("#commentbox").val('');
                    commentModal.find("#no-comments").removeClass("hide");
                    commentModal.find('.add-comments').prop("disabled", true);
                    commentModal.find('#commentbox').addClass("hide");
                    commentModal.find(".createdBy").text('');
                }else{
                    commentModal.find("#commentId").val('');
                    commentModal.find(".createdBy").text('');
                    commentModal.find('.add-comments').html("Add");
                    commentModal.find('.add-comments').prop("disabled", true);
                }

                commentModal.find('#commentbox').on("keyup", function () {
                    if(commentModal.find("#commentId").val()=="" && commentModal.find('#commentbox').val()=="")
                        commentModal.find('.add-comments').prop("disabled", true);
                    else
                    commentModal.find('.add-comments').prop("disabled", false);
                });

            },
            error: function () {
                console.log("Unable to load previous comments.");
            }
        });
    };

    var bindSaveComment = function (commentModal) {

        //Add click event to the add comment button.
        commentModal.find(".add-comments").unbind().click(function () {
            var caseJsonObjArray = [];
            var appType = $("#application").html();
            var validatedSignalId = $("#validatedSignalId").html();
            var topicId = $("#topicId").html();

            if (appType == '') {
                appType = commentModal.find("#application").html();
                validatedSignalId = commentModal.find("#validatedSignalId").html();
                topicId = commentModal.find("#topicId").html()
            }

            var caseJsonObj;
            var url;
            var data;
            //Case JSON.
            caseJsonObj = {
                "alertType": appType,
                "productName": commentModal.find("#productName").html(),
                "eventName": commentModal.find("#eventName").html(),
                "comments": commentModal.find("#commentbox").val(),
                "validatedSignalId": validatedSignalId,
                "assignedTo": commentModal.find("#assignedTo").html(),
                "executedConfigId": commentModal.find("#executedConfigId").html(),
                "configId" : commentModal.find("#configId").html(),
                "topicId": commentModal.find("#topicId").html(),
                "productFamily": commentModal.find("#prodFamily").html(),
                "caseNumber": commentModal.find("#caseNo").html(),
                "productId": parseInt(commentModal.find("#productId").html()),
                "ptCode": parseInt(commentModal.find("#ptCode").html())

            };
            caseJsonObjArray.push(caseJsonObj);
            if(commentModal.find("#commentId").val()){
                url = "/signal/alertComment/updateComment";
                data = {
                    "alertType": appType,
                    "comment": commentModal.find("#commentbox").val(),
                    "id": commentModal.find("#commentId").val(),
                    "executedConfigId": commentModal.find("#executedConfigId").html(),
                    "validatedSignalId": validatedSignalId
                };
            }else{
                url = "/signal/alertComment/saveComment";
                data = {"caseJsonObjArray": JSON.stringify(caseJsonObjArray)}
            }

            $.ajax({
                url: url,
                data: data,
                type: "POST",
                async: false,
                success: function (result) {
                    if(result.success) {
                        commentModal.find("#isUpdated").val("true");
                        populateComments(commentModal, caseJsonObjArray[0]);
                        $('#commentbox').val('').blur()
                    }
                },
                error: function () {
                }
            });
        });
    };

    var bindEditComment = function (commentModal) {

        commentModal.find(".previous-comments").find('.edit-comment').click(function () {
            $(this).parent().find(".update-comment").removeClass("hidden");
            $(this).parent().find(".comment-area").attr('disabled', false);
            $(this).addClass("hidden")
        });
    };

    var bindDeleteComment = function (commentModal, caseJson) {

        commentModal.find(".previous-comments").find('.delete-comment').click(function () {
            var id = {
                "id": $(this).parent().find(".commentId").val(),
                "validatedSignalId": $("#validatedSignalId").text(),
                "adhocAlertId" : caseJson.adhocAlertId
            };
            $.ajax({
                url: "/signal/alertComment/deleteComment",
                data: id,
                async: false,
                success: function (result) {
                    populateComments(commentModal, caseJson);
                },
                error: function () {
                }
            });
        });
    };

    var bindUpdateComment = function (commentModal, caseJson) {


        commentModal.find(".previous-comments").find('.update-comment').click(function () {

            $(this).parent().find(".glyphicon-pencil").removeClass("hidden");
            var commentData = {
                "comment": $(this).parent().find(".comment-area").val(),
                "id": $(this).parent().find(".commentId").val(),
                "validatedSignalId": $("#validatedSignalId").text(),
                "topicId": $("#topicId").html(),
                "executedConfigId": caseJson.executedConfigId,
                "adhocAlertId" : caseJson.adhocAlertId
            };

            $.ajax({
                url: "/signal/alertComment/updateComment",
                data: commentData,
                async: false,
                success: function (result) {

                    populateComments(commentModal, caseJson);
                },
                error: function () {
                }
            });
        });
    };

    return {
        list_comments: listComments,
        populate_comments: populateComments,
        save_comment: bindSaveComment
    }
})();


var showTopicWidget = function () {
    $("#topic").select2({
        tags: true,
        placeholder: "Select topic",
        allowClear: true,
        width: "100%",
        createTag: function (params) {
            var term = $.trim(params.term);
            if (term != "") {
                return {
                    id: term,
                    text: term
                }
            }
            return null
        }
    });
};
//= require app/pvs/common/rx_common.js
//= require app/pvs/common/rx_list_utils.js
//= require app/pvs/common/rx_handlebar_ext.js
//= require app/pvs/topic/attachAlertToTopic.js

var signal = signal || {};

var topicData;
var columnSeq;
var isViewInstance = 1;
var signalAlertType = {
    SINGLE_CASE_ALERT: "Single Case Alert",
    AGGREGATE_ALERT: "Aggregate Case Alert",
    EVDAS_ALERT: "Evdas Alert",
    ADHOC_ALERT: "Ad-Hoc Alert",
    LITERATURE_SEARCH_ALERT: "Literature Search Alert"
}

signal.alertReview = (function () {

    var ids = [];
    var rows = [];

    var applyBusinessRules = function (row, data) {
        //Apply the eudra rules.
        if (data.format) {
            var obj = JSON.parse(data.format);
            var textObj;
            $.each(obj.text.tc, function (index, data) {
                textObj = $(row).find('.' + data);
                textObj.css('color', obj.text.color);
                if (obj.text.bold) {
                    textObj.css('font-weight', '900');
                }
                if (obj.text.italic) {
                    textObj.css('font-style', 'italic');
                }
                if (obj.text.underline) {
                    textObj.css('text-decoration', 'underline');
                }
            });
            $.each(obj.cell.tc, function (index, data) {
                $(row).find('.' + data).parents('td').css('background-color', obj.cell.color);
            });
        }
    };

    var enableMenuTooltips = function () {
        $(".grid-menu-tooltip").mouseover(function () {
            var $this = $(this);
            var tooltipText = $this.attr("data-title");
            $this.tooltip({
                title: tooltipText,
                placement: "bottom"
            });
            $this.tooltip('show');
        });
    };

    var disableTooltips = function () {
        $(".mdi-alpha-d-box, .mdi-filter-outline, .mdi-trending-up, .mdi-content-save, .mdi-export, .mdi-settings, mdi-plus-box, mdi-chart-bar").click(function () {
            $(".tooltip").hide();
        });
    };

    var sortIconHandler = function () {
        var thArray = $('#alertsDetailsTable').DataTable().columns().header();
        if (isViewInstance) {
            var columnName;
            var indexOfColumn = 0;
            columnSeq.every(function () {
                var seq = columnSeq[indexOfColumn].seq;
                if (index == seq) {
                    columnName = columnSeq[indexOfColumn].name;
                    return false;
                }
                indexOfColumn++;
                return true;
            });
            var columnIndex = $('#alertsDetailsTable').find("th[data-field=" + columnName + "]").attr('data-column-index');
        } else {
            columnIndex = index;
        }
        $.each(thArray, function (currentIndex, element) {
            if (element.classList.contains('sorting_asc')) {
                element.classList.remove('sorting_asc');
                element.classList.add("sorting");
            } else if (element.classList.contains('sorting_desc')) {
                element.classList.remove('sorting_desc');
                element.classList.add("sorting");
            }
            if (currentIndex == columnIndex && !element.classList.contains('sorting_disabled')) {
                if (dir == 'asc') {
                    element.classList.remove('sorting');
                    element.classList.add("sorting_asc");
                } else if (dir == 'desc') {
                    element.classList.remove('sorting');
                    element.classList.add("sorting_desc");
                }
            }
        });
    };

    /**
     * The reset modal screen function which resets the password div in the workflow modal screen.
     * This is internal function to be called internally in this object scope.
     */
    var resetModalScreen = function () {
        //Clean up the the dispositions fields.
        $('#edit-state-modal').find('#extra-value-select').html("<option></option>");
        //Hide the password
        $('#edit-state-modal').find('#passwordDiv').addClass('hide');
        $('#edit-state-modal').find('#isPasswordEnabled').val(0);
    }

    var showPasswordField = function () {
        $('#edit-state-modal').find('#passwordDiv').removeClass('hide');
        $('#edit-state-modal').find('#isPasswordEnabled').val(1);
    }

    var changeWorkflowEditScreen = function (availableValues, targetVal) {

        var availableValObj = _.findWhere(availableValues, {value: targetVal});

        if (typeof availableValObj != 'undefined' && availableValObj) {
            if (availableValObj.approvalRequired) {
                showPasswordField();
            } else {
                resetModalScreen();
            }

            //Clean up the the dispositions fields
            $('#edit-state-modal').find('#extra-value-select').html('')

            //Fill up the dispositions in the combo
            $('#edit-state-modal').find('#extra-value-select').html(getDispositionOptions(availableValObj))
        }
    }

    var getDispositionOptions = function (availableValObj) {
        var dispositionStr = "<option></option>";
        _.each(availableValObj.dispositions, function (disposition) {
            dispositionStr = dispositionStr +
                "<option value=\"" + disposition.value + "\">" + disposition.displayName + "</option>"
        })
        return dispositionStr
    }

    var authenticateUser = function () {
        var returnVal = false
        var passwordJson = {
            "password": $('#edit-state-modal').find('#passwordAuthentication').val()
        }

        var authUrl = '/signal/user/authenticate'

        $.ajax({
            url: authUrl,
            data: passwordJson,
            async: false,
            success: function (result) {
                if (result.authorized) {
                    returnVal = true
                } else {
                    returnVal = false
                }
            },
            error: function () {
                returnVal = false
            }
        });
        return returnVal
    }

    var toggleErrorNotification = function (action) {
        if (action == 'hide') {
            $('#edit-state-modal .errorNotification').addClass('hide');
            $('#edit-state-modal').find('.errorMessage').html('');
        } else {
            $('#edit-state-modal .errorNotification').removeClass('hide')
            $('#edit-state-modal').find('.errorMessage').html(' Authentication Failed!');
        }
    };

    var openCaseHistoryModal = function () {

        //Bind the click event on the case history icon.
        $(document).on('click', '.case-history-icon', function (event) {
            event.preventDefault();
            var parent_row = $(event.target).closest('tr');
            var selectedRowIndex = $(this).closest('tr').index();
            if (isAbstractViewOrCaseView(selectedRowIndex)) {
                selectedRowIndex = selectedRowIndex / 2
            }
            var isSignal = $(this).data('signal');

            var rowObject = {};
            if (!isSignal) {
                rowObject = table.rows(selectedRowIndex).data()[0];
            } else {
                rowObject = tableSingleReview.row($(this).parents('tr')).data();
            }
            var caseNumber = rowObject.caseNumber;
            var productFamily = rowObject.productFamily;
            var caseVersion = rowObject.caseVersion;
            var productName = rowObject.productName;
            var pt = rowObject.primaryEvent;
            var alertConfigId = rowObject.alertConfigId;

            var caseHistoryModal = $('#caseHistoryModal');
            caseHistoryModal.find("#caseNumber").html(caseNumber);
            caseHistoryModal.find("#productFamily").html(productFamily);
            caseHistoryModal.find("#caseVersion").val(caseVersion);
            caseHistoryModal.find("#productName").val(productName);
            caseHistoryModal.find("#alertConfigId").val(alertConfigId);
            caseHistoryModal.find("#pt").val(pt);
            caseHistoryModal.modal('show');

            if(typeof singleCaseUpdateJustificationUrl != 'undefined')
                updateJustificationUrl = singleCaseUpdateJustificationUrl;

            signal.caseHistoryTable.init_case_history_table(caseHistoryUrl);
            signal.caseHistoryTable.init_case_history_table_suspect(caseHistorySuspectUrl);
        });
    };

    var openAlertCommentModal = function (alertType, applicationName) {

        //Modal object
        var commentModal = $('#commentModal');
        $(document).on('click', '.comment-icon', function (event) {
            var $this = this;
            var dataInfo;
            var isCaseDetail;
            var appType;
            var validatedSignalId;
            var commentAlertType = $($this).data('name');
            var isSignal = $($this).data('signal');

            if (commentAlertType !== undefined) {
                alertType = commentAlertType;
            }
            event.preventDefault();
            var caseJsonArray = [];
            dataInfo = $(event.target).attr('data-info');
            isCaseDetail = $(event.target).attr('data-comment');

            appType = $("#application").html();
            if (appType === '') {
                appType = commentModal.find("#application").html();
                validatedSignalId = commentModal.find("#validatedSignalId").html()
            }

            var selectedRowCount;
            if ($('#detailed-view-checkbox').is(':checked')) {
                selectedRowCount = $('table#alertsDetailsTable .copy-select:checked').length;
            } else {
                selectedRowCount = $('table.DTFC_Cloned .copy-select:checked').length;
            }
            if (selectedRowCount > 1 && $($this).closest('tr').find(".copy-select").prop("checked")) {
                var textToDisplay;
                switch (applicationName) {
                    case 'Single Case Alert':
                        textToDisplay = 'Case';
                        break;
                    case 'Aggregate Case Alert':
                        textToDisplay = 'PEC';
                        break;
                    case 'EVDAS Alert':
                        textToDisplay = 'PEC';
                        break;
                    case 'Literature Search Alert':
                        textToDisplay = 'Article';
                        break;
                }
                $(commentModal).find('div.bulkOptionsSection').show();
                $(commentModal).find('div.bulkOptionsSection span.alertTypeText').html(textToDisplay);
                $(commentModal).find('div.bulkOptionsSection span.count').html(selectedRowCount);
            } else {
                $(commentModal).find('div.bulkOptionsSection').hide();
            }

            $('div.bulkOptionsSection input[name=bulkOptions]').unbind().on('change', function () {
                switch ($(this).val()) {
                    case 'allSelected':
                        caseJsonArray = [];
                        initiateSingleBulkRowCommentProcess(caseJsonArray, commentModal, alertType, isCaseDetail, isSignal);
                        bindAddComments(commentModal, caseJsonArray, "bulk", alertType, validatedSignalId, isCaseDetail);
                        break;
                    case 'current':
                        caseJsonArray = [];
                        initiateSingleRowCommentProcess($this, caseJsonArray, commentModal, alertType, isCaseDetail, isSignal);
                        bindAddComments(commentModal, caseJsonArray, "row", alertType, validatedSignalId, isCaseDetail);
                        break;
                }
            });

            if (dataInfo === "row") {
                initiateSingleRowCommentProcess($this, caseJsonArray, commentModal, alertType, isCaseDetail, isSignal);
            }

            commentModal.modal('show');
            bindAddComments(commentModal, caseJsonArray, dataInfo, alertType, validatedSignalId, isCaseDetail, $this)
        })
    };

    var bindAddComments = function (commentModal, caseJsonArray, dataInfo, alertType, validatedSignalId, isCaseDetail, currentRow) {
        commentModal.find(".add-comments").unbind().click(function () {
            var caseJson;
            var caseJsonObj;
            var data;
            var url;
            var $this = this;
            var caseJsonObjArray = [];
            if (dataInfo === "row") {
                caseJson = caseJsonArray[0];

                if (commentModal.find("#commentId").val()) {
                    data = {
                        "alertType": alertType,
                        "comment": commentModal.find("#commentbox").val(),
                        "id": commentModal.find("#commentId").val(),
                        "validatedSignalId": validatedSignalId,
                        "topicId": $("#topicId").html(),
                        "executedConfigId": caseJson.executedConfigId,
                        "adhocAlertId": caseJson.adhocAlertId,
                        "configId": caseJson.configId,
                        "literatureAlertId": caseJson.literatureAlertId
                    };
                    if(data.comment=="") {
                        url = "/signal/alertComment/deleteComment";
                    }
                    else {
                        url = "/signal/alertComment/updateComment";
                    }
                } else {
                    url = "/signal/alertComment/saveComment";

                    caseJsonObj = {
                        "alertType": alertType,
                        "productName": caseJson.productName,
                        "eventName": caseJson.eventName,
                        "pt": caseJson.pt,
                        "comments": commentModal.find("#commentbox").val(),
                        "caseNumber": caseJson.caseNumber,
                        "productFamily": caseJson.productFamily,
                        "validatedSignalId": validatedSignalId,
                        "topicId": commentModal.find("#topicId").html(),
                        "assignedTo": caseJson.assignedTo,
                        "adhocAlertId": caseJson.adhocAlertId,
                        "executedConfigId": caseJson.executedConfigId,
                        "productId": caseJson.productId,
                        "ptCode": caseJson.ptCode,
                        "configId": caseJson.configId,
                        "literatureAlertId": caseJson.literatureAlertId,
                        "articleId": caseJson.articleId
                    };
                    caseJsonObjArray.push(caseJsonObj);
                    data = {
                        caseJsonObjArray: JSON.stringify(caseJsonObjArray)
                    }
                }
            } else {
                url = "/signal/alertComment/saveComment";
                var selectedRowCount;
                if ($('#detailed-view-checkbox').is(':checked')) {
                    selectedRowCount = $('table#alertsDetailsTable .copy-select:checked').length;
                } else {
                    selectedRowCount = $('table.DTFC_Cloned .copy-select:checked').length;
                }
                for (var index = 0; index < selectedRowCount; index++) {
                    validatedSignalId = $("#validatedSignalId").html();
                    caseJson = caseJsonArray[index];

                    //Case JSON.
                    caseJsonObj = {
                        "alertType": alertType,
                        "productName": caseJson.productName,
                        "eventName": caseJson.eventName,
                        "pt": caseJson.pt,
                        "comments": commentModal.find("#commentbox").val(),
                        "caseNumber": caseJson.caseNumber,
                        "productFamily": caseJson.productFamily,
                        "validatedSignalId": validatedSignalId,
                        "topicId": commentModal.find("#topicId").html(),
                        "assignedTo": caseJson.assignedTo,
                        "adhocAlertId": caseJson.adhocAlertId,
                        "productId": caseJson.productId,
                        "ptCode": caseJson.ptCode,
                        "configId": caseJson.configId,
                        "literatureAlertId": caseJson.literatureAlertId,
                        "articleId": caseJson.articleId,
                        "executedConfigId": caseJson.executedConfigId
                    };
                    caseJsonObjArray.push(caseJsonObj)
                }
                data = {
                    caseJsonObjArray: JSON.stringify(caseJsonObjArray)
                }
            }

            //Save comment call
            $.ajax({
                url: url,
                data: data,
                type: "POST",
                async: false,
                beforeSend: function () {
                    commentModal.find("i.isProcessing").show();
                },
                success: function (result) {
                    commentModal.find("i.isProcessing").hide();
                    //Populate the comments again if single comment is added.
                    if (typeof isCaseDetail !== 'undefined') {
                        window.location.reload();
                        return;
                    }
                    if (dataInfo === "row") {
                        signal.alertComments.populate_comments(commentModal, caseJson);
                        $('#commentbox').val('').blur();
                        if (data.comment != "") {
                            showCommentIcon(currentRow) ;
                        }
                        else {
                            removeCommentIcon(currentRow) ;
                        }

                    } else {
                        commentModal.modal("hide");
                        $('body').removeClass('modal-open');
                        $('.modal-backdrop').remove();
                        var checkboxSelector;
                        if ($('#detailed-view-checkbox').is(':checked')) {
                            checkboxSelector = 'table#alertsDetailsTable .copy-select:checked';
                        } else {
                            checkboxSelector = 'table.DTFC_Cloned .copy-select:checked';
                        }
                        $.each($(checkboxSelector), function () {
                            showCommentIcon(this);
                        });
                    }
                    $.Notification.notify('success', 'top right', "Success", "Comments added successfully.", {autoHideDelay: 10000});
                },
                error: function () {
                }
            });
        })
    };

    var initiateSingleRowCommentProcess = function ($this, caseJsonArray, commentModal, alertType, isCaseDetail, isSignal) {
        var adhocAlertId;
        var literatureAlertId;
        var articleId;

        var rowObject = {};
        if ((alertType === 'Aggregate Case Alert' || alertType === 'Single Case Alert' || alertType === 'EVDAS Alert' || alertType === 'Literature Search Alert') && !isSignal) {
            var selectedRowIndex = $($this).closest('tr').index();
            if (isAbstractViewOrCaseView(selectedRowIndex)) {
                selectedRowIndex = selectedRowIndex / 2
            }
            rowObject = table.row(selectedRowIndex).data();
        } else if (alertType === 'Aggregate Case Alert') {
            rowObject = tableAggReview.row($($this).parents('tr')).data();
        } else if (alertType === 'Literature Search Alert') {
            rowObject = tableLiteratureReview.row($($this).parents('tr')).data();
        } else {
            rowObject = tableSingleReview.row($($this).parents('tr')).data();
        }

        var caseNumber = rowObject.caseNumber;
        var productFamily = rowObject.productFamily;
        var caseVersion = rowObject.caseVersion;
        var productName = rowObject.productName;
        var eventName = rowObject.preferredTerm;
        var pt = rowObject.pt;
        var assignedTo = rowObject.assignedTo.id;
        var assignedToUser = null;
         if(rowObject.assignedToUser != undefined)
             assignedToUser = rowObject.assignedToUser.id;
        var productId = rowObject.productId;
        var ptCode = rowObject.ptCode;
        var configId = rowObject.alertConfigId;
        var executedConfigId = rowObject.execConfigId;

        if (alertType === signalAlertType.ADHOC_ALERT) {
            adhocAlertId = rowObject.id;
        } else if (alertType === signalAlertType.LITERATURE_SEARCH_ALERT) {
            literatureAlertId = rowObject.id;
            articleId = rowObject.articleId
        }
        var caseJson = {
            "alertType": alertType,
            "productFamily": productFamily,
            "caseNumber": caseNumber,
            "productName": productName,
            "eventName": eventName,
            "pt": pt,
            "ptCode": ptCode,
            "productId": productId,
            "assignedTo": assignedTo ? assignedTo : assignedToUser,
            "executedConfigId": executedConfigId,
            "configId": configId,
            "adhocAlertId": adhocAlertId,
            "literatureAlertId": literatureAlertId,
            "articleId": articleId
        };

        caseJsonArray.push(caseJson);
        var commentMetaInfo = "";

        if (caseJson.alertType === signalAlertType.AGGREGATE_ALERT || caseJson.alertType === signalAlertType.EVDAS_ALERT) {
            if (typeof (caseJson.eventName) === "undefined" || typeof (caseJson.productName) === "undefined") {
                commentMetaInfo = ""
            } else {
                commentMetaInfo = '<span id="productName">' + caseJson.productName + '</span> - <span id="eventName">' + caseJson.eventName + '</span>' + '<span class="hidden" id="productId">' + caseJson.productId + '</span>' +
                    '<span class="hidden" id="ptCode">' + caseJson.ptCode + '</span>'
            }
        } else {
            if (typeof (caseJson.caseNumber) === "undefined" || typeof (caseJson.productFamily) === "undefined") {
                commentMetaInfo = ""
            } else {
                commentMetaInfo = '<span id="caseNumber">' + caseJson.caseNumber + '</span> - <span id="productFamily">' + caseJson.productFamily + '</span>'
            }
        }
        commentModal.find("#comment-meta-info").html(commentMetaInfo);
        commentModal.find("#assignedTo").html(assignedTo);
        commentModal.find("#configId").html(configId);
        commentModal.find("#application").html(caseJson.alertType);

        //Populate the existing comments and bind events to them in case of single comment.
        if (typeof isCaseDetail !== 'undefined') {
            $('#loadingComments').html('')
        } else {
            signal.alertComments.populate_comments(commentModal, caseJson);
        }
        $("#commentModal").on('hidden.bs.modal', function () {
            $('#commentbox').val('');
            $('.add-comments').html('Add');
            $(".createdBy").text('');
        })
    };

    var initiateSingleBulkRowCommentProcess = function (caseJsonArray, commentModal, alertType, isCaseDetail, isSignal) {
        var indexSet = new Set();
        var checkboxSelector;
        if ($('#detailed-view-checkbox').is(':checked')) {
            checkboxSelector = 'table#alertsDetailsTable .copy-select:checked';
        } else {
            checkboxSelector = 'table.DTFC_Cloned .copy-select:checked';
        }
        $.each($(checkboxSelector), function () {
            var selectedRowIndex = $(this).closest('tr').index();
            if (isAbstractViewOrCaseView(selectedRowIndex))
                selectedRowIndex = selectedRowIndex / 2;
            indexSet.add((selectedRowIndex));
        });
        indexSet.forEach(function (index) {
            var adhocAlertId;
            var literatureAlertId;
            var articleId;
            var rowObject = {};
            if ((alertType === 'Aggregate Case Alert' || alertType === 'Single Case Alert' || alertType === 'EVDAS Alert' || alertType === 'Literature Search Alert') && !isSignal) {
                rowObject = table.rows(index).data()[0];
            } else if (alertType === 'Aggregate Case Alert') {
                rowObject = tableAggReview.rows(index).data()[0];
            } else {
                rowObject = tableSingleReview.rows(index).data()[0];
            }

            var caseNumber = rowObject.caseNumber;
            var productFamily = rowObject.productFamily;
            var caseVersion = rowObject.caseVersion;
            var productName = rowObject.productName;
            var eventName = rowObject.preferredTerm;
            var pt = rowObject.pt;
            var assignedTo = rowObject.assignedTo.id;
            var productId = rowObject.productId;
            var ptCode = rowObject.ptCode;
            var configId = rowObject.alertConfigId;
            var executedConfigId = rowObject.execConfigId;

            if (alertType === signalAlertType.ADHOC_ALERT) {
                adhocAlertId = rowObject.id;
            } else if (alertType === signalAlertType.LITERATURE_SEARCH_ALERT) {
                literatureAlertId = rowObject.id;
                articleId = rowObject.articleId
            }
            var caseJson = {
                "alertType": alertType,
                "productFamily": productFamily,
                "caseNumber": caseNumber,
                "productName": productName,
                "eventName": eventName,
                "pt": pt,
                "ptCode": ptCode,
                "productId": productId,
                "assignedTo": assignedTo,
                "executedConfigId": executedConfigId,
                "configId": configId,
                "adhocAlertId": adhocAlertId,
                "literatureAlertId": literatureAlertId,
                "articleId": articleId
            };
            caseJsonArray.push(caseJson)
        });

        //Set values to the modal elements.
        commentModal.find("#loadingComments").hide();
        commentModal.find("#comment-meta-info").html("");
        commentModal.find(".previous-comments").html("");
        commentModal.find("#commentId").val('');
        commentModal.find(".createdBy").text('');
        if (commentModal.find('.add-comments').html() != 'Update') {
            commentModal.find('.add-comments').html("Add");
        }
        commentModal.find('.add-comments').prop("disabled", false);
        commentModal.find('#commentbox').on("keyup", function () {
            if (commentModal.find('#commentbox').val().length > 0) {
                commentModal.find('.add-comments').prop("disabled", false);
            } else {
                commentModal.find('.add-comments').prop("disabled", true);
            }
        });
    };

    var restartReview = function (caseReviewPreviousUrl) {

        //Event when review restart is clicked.
        $(document).on('click', '.case-restart-review', function (event) {
            event.preventDefault();
            var parent_row = $(event.target).closest('tr');
            var caseNumber = parent_row.find('span[data-field="caseNumber"]').attr("data-id");
            var followUpNumber = parent_row.find('span[data-field="followUpNumber"]').attr("data-id");
            var caseVersion = parent_row.find('span[data-field="caseVersion"]').attr("data-id");
            var productFamily = parent_row.find('input[data-field="productFamily"]').attr("data-id");
            var followUpModal = $('#followUpModal');
            followUpModal.modal('show');
            followUpModal.find(".previous-followUp").unbind().click(function () {
                var getPreviousState = caseReviewPreviousUrl + "?caseNumber=" + caseNumber +
                    "&caseVersion=" + caseVersion + "&productFamily=" + productFamily + "&followUpNumber=" + followUpNumber;
                $.ajax({
                    url: getPreviousState,
                    success: function (result) {
                        parent_row.find('span[data-field="workflowState"]').text(result.previousState);
                        parent_row.find('span[data-field="disposition"]').text(result.previousDisposition);
                        parent_row.find('span[data-field="info-sign"]').addClass("hidden");
                        followUpModal.modal('destroy');
                    }
                })
            })
        });
    };

    var openSimilarCasesModal = function (caseInfoUrl) {

        //Event triggered when similar cases count is clicked.
        $(document).on('click', '.similar-cases', function (event) {

            var similarCaseModal = $('#similarCaseModal');
            event.preventDefault();

            var parent_row = $(event.target).closest("tr");

            //Fetch the values of the event.
            var eventVal = $(event.target).attr('data-event-val');
            var eventType = $(event.target).attr('data-field');
            var executedConfigId = $(event.target).attr("data-id");
            var pt = $(event.target).attr("data-pt");
            var eventCode;
            if (eventType) {
                eventCode = (eventType.split("_code")[0]);
                eventType = eventType.split("_")[2];
            }

            var caseNumber = parent_row.find('span[data-field="caseNumber"]').attr("data-id");
            var caseVersion = parent_row.find('span[data-field="caseVersion"]').attr("data-id");

            //Show modal and set its values.
            similarCaseModal.modal('show');
            similarCaseModal.find("#eventType").html(eventType);
            similarCaseModal.find("#eventVal").html(eventVal);
            similarCaseModal.find("#caseNumberInfo").val(caseNumber);
            similarCaseModal.find("#executedConfigId").val(executedConfigId);
            similarCaseModal.find("#caseCurrentVersion").val(caseVersion);
            similarCaseModal.find("#eventCode").val(eventCode);
            similarCaseModal.find("#eventCodeVal").val(eventVal);
            //Make the modal table as datatable

            setTimeout(function () {
                signal.similarCaseTable.init_similar_case_table(caseInfoUrl)
            }, 100);
        });
    };

    var openAttachmentModal = function () {
        $(document).on('click', '.show-attachment-icon', function (event) {
            var $this = this;
            event.preventDefault();
            var parent_row = $(event.target).closest('tr');
            var alertId = parent_row.find('a[data-field="attachment"]').attr("data-id");
            var caseController = parent_row.find('a[data-field="attachment"]').attr("data-controller");
            var url = "/signal/" + caseController + "/upload";
            var getAttachmentUrl = "/signal/" + caseController + "/fetchAttachment?alertId=" + alertId;
            $('#showAttachmentModal #attachmentForm #attachmentFormId').attr('value', alertId);
            var caseHistoryModal = $('#showAttachmentModal');
            caseHistoryModal.modal('show');
            $("#showAttachmentModal form#attachmentForm").unbind('submit').on('submit', function () {
                var formData = new FormData(this);
                var $this = $(this);
                if ($this.find('.attachment-file').val()) {
                    $this.find(".upload").attr("disabled", true);
                    $.ajax({
                        url: url,
                        type: "POST",
                        data: formData,
                        async: false,
                        success: function () {
                            $this.find('.attachment-file').val('');
                            showAttachmentIcon(parent_row);
                            $('#showAttachmentModal #attachment-table').DataTable().ajax.reload();
                            $this.find(".upload").attr("disabled", false);
                        },
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }
                return false;
            });
            $('#showAttachmentModal #attachment-table').DataTable({
                destroy: true,
                searching: false,
                sPaginationType: "bootstrap",
                responsive: false,
                language: {
                    "url": "../assets/i18n/dataTables_" + userLocale + ".json"
                },
                "ajax": {
                    "url": getAttachmentUrl,
                    "dataSrc": ""
                },
                fnDrawCallback: function () {
                    $('.remove-attachment').click(function (e) {
                        var attachmentRow = $(e.target).closest('tr');
                        var attachmentId = attachmentRow.find('span[data-field="removeAttachment"]').attr("data-attachmentId");
                        var removeUrl = '/signal/' + caseController + '/deleteAttachment?attachmentId=' + attachmentId;
                        $.ajax({
                            type: "POST",
                            url: removeUrl,
                            data: {alertId: alertId},
                            success: function () {
                                if($('.remove-attachment').length ===1 ) {
                                    removeAttachmentIcon($this)
                                }
                                $('#showAttachmentModal #attachment-table').DataTable().ajax.reload();
                            },
                            error: function () {
                                $.Notification.notify('error', 'top right', "Error", "All selected safety observations must be in same disposition for performing the bulk update.", {autoHideDelay: 10000});
                            }
                        })
                    })
                },
                "aoColumns": [
                    {
                        "mData": "name",
                        "mRender": function (data, type, row) {
                            return '<a href="/signal/attachmentable/download?id=' + row.id + '">' + escapeHTML(row.name) + '</a>'
                        }
                    }, {
                        "mData": "description",
                        "className": 'cell-break',
                    }, {
                        "mData": "timeStamp"
                    }, {
                        "mData": "modifiedBy"
                    }, {
                        "mData": "id",
                        "mRender": function (data, type, row) {
                            return '<span tabindex="0" title="Remove Attachment"  style="cursor: pointer" class="glyphicon glyphicon-remove remove-attachment" data-field="removeAttachment" data-attachmentId=' + row.id + '></span>'
                        }
                    }
                ],
                "bLengthChange": false,
                columnDefs: [{
                    "targets": '_all',
                    "render": $.fn.dataTable.render.text()
                }]
            });
        });
    };

    var bindGridDynamicFilters = function (filtersData, prefix, id) {
        //Add filters to the data table.
        var dataTables_length = $('.dataTables_length');
        dataTables_length.addClass('col-sm-12');
        dataTables_length.parent().removeClass("col-xs-2");
        applicationName == ALERT_CONFIG_TYPE.ADHOC_ALERT ? dataTables_length.parent(":not('.dataTables_wrapper')").addClass("col-xs-9") : dataTables_length.parent(":not('.dataTables_wrapper')").addClass("col-xs-10");
        dataTables_length.parent(":not('.dataTables_wrapper')").next().removeClass("col-xs-10");
        applicationName == ALERT_CONFIG_TYPE.ADHOC_ALERT ? dataTables_length.parent(":not('.dataTables_wrapper')").next().addClass("col-xs-3") : dataTables_length.parent(":not('.dataTables_wrapper')").next().addClass("col-xs-2");
        dataTables_length.find("label").addClass('col-xs-2');
        dataTables_length.each(function () {
            var dtButtons = '<div class="dataTable-top-disposition col-xs-10">';
            $.each(filtersData, function (index, obj) {
                if (obj.closed || obj.isClosed) {
                    dtButtons += '<div class="checkbox checkbox-primary checkbox-inline m-l-3 checkbox-pos-abs">';
                    dtButtons += '<input id="filter' + index + '" type="checkbox" class="dynamic-filters" name="relatedResults" data-closed="' + obj.isClosed + '" value="' + obj.value + '" /> <label class="m-r-30"  for="filter' + index + '">' + obj.value + '</label></div>'
                } else {
                    dtButtons += '<div class="checkbox checkbox-primary checkbox-inline m-l-3 checkbox-pos-abs">';
                    dtButtons += '<input id="filter' + index + '" type="checkbox" class="dynamic-filters" name="relatedResults" data-closed="' + obj.isClosed + '" checked="checked" value="' + obj.value + '" /> <label class="m-r-30" for="filter' + index + '">' + obj.value + '</label></div>'
                }
            });
            dtButtons += '</div>';
            dtButtons = dtButtons + '</div>';
            if (this.id !== 'archivedAlertsTable_length' && this.id !== 'activitiesTable_length')
                $(this).append(dtButtons);
            $(document).on('click', '.dynamic-filters', function () {
                var alertDetailsTable;
                var freqSelected = "";
                if ($("#frequencyNames")) {
                    freqSelected = $("#frequencyNames").val();
                }
                var filterArray = [];
                var filterValues = [];
                $('.dynamic-filters').each(function (index) {
                    if ($(this).is(':checked')) {
                        filterValues.push($(this).val());
                    }
                    filterArray.push($(this).is(':checked'));
                });
                sessionStorage.setItem(prefix + "filters_store", JSON.stringify(filterArray));
                sessionStorage.setItem(prefix + "filters_value", JSON.stringify(filterValues));
                sessionStorage.setItem(prefix + "id", id);
                var url;
                if (applicationName == 'Literature Search Alert') {
                    alertDetailsTable = $('#alertsDetailsTable').DataTable();
                    url = listConfigUrl + "?filters=" + filterValues.join(",")
                } else {
                    alertDetailsTable = $('#alertsDetailsTable').DataTable();
                    url = listConfigUrl + "&frequency=" + freqSelected + "&isFilterRequest=true&filters=" + JSON.stringify(filterValues);
                }
                alertDetailsTable.ajax.url(url).load()
            });
        });

    };

    var isAlertPersistedInSessionStorage = function (prefix) {
        var c = signal.utils.getQueryString("configId");
        return c ? sessionStorage.getItem(prefix + "id") == c : false
    };

    var removeFiltersFromSessionStorage = function (prefix) {
        sessionStorage.removeItem(prefix + "filters_store");
        sessionStorage.removeItem(prefix + "filters_value");
        sessionStorage.removeItem(prefix + "id");
    };

    var openSaveViewModal = function (filterIndex, applicationName, viewId) {
        var systemDefault = ["System View"];
        var viewInfo;

        //saving new view
        $(".saveView").unbind('click');
        $('.saveView').on('click', function () {
            viewInfo = generateViewInfo(filterIndex);

            $('#save-view-modal #view_filters').val(JSON.stringify(viewInfo.filterMap));
            $('#save-view-modal #view_columnList').val(viewInfo.notVisibleColumn);
            $('#save-view-modal #view_alertType').val(applicationName);
            $('#save-view-modal #view_sorting').val(JSON.stringify(viewInfo.sortedColumn));
            $('#save-view-modal #view_advanced_filter').val(viewInfo.advancedFilter);
            $('#save-view-modal #current_view_id').val(viewId);
            $('#save-view-modal .save_buttons').show();
            $('#save-view-modal').modal('show');
        })

        //updating existing view
        $(".updateView").unbind('click');
        $('.updateView').on('click', function () {
            viewInfo = generateViewInfo(filterIndex);
            if ($.inArray($('.viewSelect :selected').text().replace("(default)", "").trim(), systemDefault) != -1) {
                $('#save-view-modal #view_filters').val(JSON.stringify(viewInfo.filterMap));
                $('#save-view-modal #view_columnList').val(viewInfo.notVisibleColumn);
                $('#save-view-modal #view_alertType').val(applicationName);
                $('#save-view-modal #view_sorting').val(JSON.stringify(viewInfo.sortedColumn));
                $('#save-view-modal #view_advanced_filter').val(viewInfo.advancedFilter);
                $('#save-view-modal #current_view_id').val(viewId);
                $('#save-view-modal .save_buttons').show();
                $('#save-view-modal').modal('show');
            } else {
                var request = new Object();
                request['name'] = $('.viewSelect :selected').text().replace("(default)", "").trim();
                request['filterMap'] = JSON.stringify(viewInfo.filterMap);
                request['columnList'] = viewInfo.notVisibleColumn.toString();
                request['alertType'] = applicationName;
                request['id'] = $('.viewSelect').val();
                request['sorting'] = JSON.stringify(viewInfo.sortedColumn);
                request['advancedFilter'] = viewInfo.advancedFilter;
                $.ajax({
                    url: updateViewUrl,
                    type: "POST",
                    data: request,
                    dataType: "json",
                    success: function (data) {
                        var pageURL = $(location).attr("href");
                        if (pageURL.indexOf("viewId") != -1) {
                            window.location = pageURL.slice(0, pageURL.indexOf("viewId") + 7) + data.viewId
                        } else {
                            if (pageURL.indexOf("#") != -1) {
                                pageURL = pageURL.slice(0, pageURL.indexOf("#"))
                            }
                            window.location = pageURL + "&viewId=" + data.viewId
                        }
                        if(data.errorMessage){
                            showErrorNotification(data.errorMessage);
                        }
                    }
                })
            }
        });

        //selecting another view
        $('.viewSelect').unbind('click');
        $('.viewSelect').on('change', function () {
            var pageURL = $(location).attr("href");
            var selectedView = $('.viewSelect').val();
            sessionStorage.setItem('isViewCall', 'true');
            if (pageURL.indexOf("viewId") != -1) {
                window.location.href = pageURL.slice(0, pageURL.indexOf("viewId") + 7) + selectedView
            } else {
                if (pageURL.indexOf("#") != -1) {
                    pageURL = pageURL.slice(0, pageURL.indexOf("#"))
                }
                window.location.href = pageURL + "&viewId=" + selectedView
            }
        });

        //deleting or editing selected view
        $('.editView').unbind('click');
        $('.editView').on('click', function () {
            viewInfo = generateViewInfo(filterIndex);

            if ($.inArray($('.viewSelect :selected').text().replace("(default)", "").trim(), systemDefault) == -1) {
                $('#save-view-modal #view_name').val($('.viewSelect :selected').text().replace("(default)", ""));
                $('#save-view-modal #view_default').prop('checked', ($('.viewSelect :selected').text().indexOf("(default)") != -1));
                $('#save-view-modal #view_id').val($('.viewSelect :selected').val());
                $('#save-view-modal #view_filters').val(JSON.stringify(viewInfo.filterMap));
                $('#save-view-modal #view_columnList').val(viewInfo.notVisibleColumn);
                $('#save-view-modal #view_sorting').val(JSON.stringify(viewInfo.sortedColumn));
                $('#save-view-modal #view_advanced_filter').val(viewInfo.advancedFilter);
                $('#save-view-modal #view_alertType').val(applicationName);
                $('#save-view-modal .edit_buttons').show();
                $('#save-view-modal').modal('show');
            } else {
                $('#alert-view-modal').modal('show');
            }
        })
    };

    var generateViewInfo = function (filterIndex) {
        var oTable = $('#alertsDetailsTable').DataTable();

        //generate filter value map
        var filterMap = new Object();
        $.each(filterIndex, function (idx, obj) {
            var filterVal = yadcf.exGetColumnFilterVal(oTable, obj);
            if (filterVal) {
                filterMap[obj] = filterVal
            }
        });

        //generate columns visible list
        var notVisibleColumn = $('#columnIndex').val();

        //generate sorting column info
        var sortedColumn = new Object();
        if ($('#alertsDetailsTable').dataTable().fnSettings().aaSorting[0]) {
            var sortedCol = $('#alertsDetailsTable').dataTable().fnSettings().aaSorting[0][0];
            var columnName = $('#alertsDetailsTable').find("th").eq(sortedCol).attr("data-field");
            var index = 0;
            columnSeq.every(function () {
                var seqName = columnSeq[index].name;
                if (columnName == seqName) {
                    sortedCol = columnSeq[index].seq;
                    return false;
                }
                index++;
                return true;
            });
            var sortedDir = $('#alertsDetailsTable').dataTable().fnSettings().aaSorting[0][1];
            sortedColumn[sortedCol] = sortedDir;
        }

        //generate advanced filter info
        var advancedFiterId = $('.advanced-filter-dropdown').val();
        return {
            'filterMap': filterMap,
            'notVisibleColumn': notVisibleColumn,
            'sortedColumn': sortedColumn,
            'advancedFilter': advancedFiterId
        }
    };

    var createSortingMap = function (infoKey, viewName) {
        var sortingMap = [];
        var sorting = {};
        var sessionStoredVal;
        if (sessionStorage.getItem(viewName) == $('.viewSelect :selected').text().replace("(default)", "").trim()) {
            sessionStoredVal = sessionStorage.getItem(infoKey);
        }
        if (sessionStoredVal) {
            sorting = $.parseJSON(sessionStoredVal);
        } else if ($("#sortedColumn").val() != "" && $("#sortedColumn").val() != "{}" && callingScreen == 'review') {
            sorting = $.parseJSON($('#sortedColumn').val());
        }
        $.each(sorting, function (key, value) {
            sortingMap.push([parseInt(key), value])
        });
        return sortingMap
    };

    var createFilterMap = function (infoKey, viewName) {
        var filtersValue = [];
        var filterMap = {};
        var sessionStoredVal;
        if (sessionStorage.getItem(viewName) == $('.viewSelect :selected').text().replace("(default)", "").trim()) {
            sessionStoredVal = sessionStorage.getItem(infoKey);
        }
        if (sessionStoredVal && sessionStoredVal != {}) {
            filterMap = $.parseJSON(sessionStoredVal);
        } else if ($('#filterMap').val() != "" && $('#filterMap').val() != "{}") {
            filterMap = $.parseJSON($('#filterMap').val());
        }
        $.each(filterMap, function (key, value) {
            var filterArr = [parseInt(key), value];
            filtersValue.push(filterArr)
        });
        return filtersValue
    };

    var createListOfIndex = function (infoKey, isEvdas, viewName) {
        var loi = [];
        var columnIndex = []
        var sessionStoredVal;
        if (sessionStorage.getItem(viewName) == $('.viewSelect :selected').text().replace("(default)", "").trim()) {
            sessionStoredVal = sessionStorage.getItem(infoKey);
        }
        if (callingScreen == 'review') {
            if (sessionStoredVal) {
                columnIndex = sessionStoredVal.split(',')
            } else {
                columnIndex = $('#columnIndex').val().split(',');
            }
            $.each(columnIndex, function () {
                if (isEvdas) {
                    loi.push(parseInt(this))
                } else {
                    loi.push(parseInt(this) + 1)
                }
            });
        }
        return loi
    };

    var setSortOrder = function () {
        $("#alertsDetailsTableRow").on('mousedown', 'th', function () {
            index = $(this).attr("data-column-index");
            dir = 'asc';
            if ($(this).hasClass('sorting_asc')) {
                dir = 'desc'
            } else if ($(this).hasClass('sorting_desc')) {
                dir = 'asc'
            }
            isViewInstance = 0;
        });
    };

    var openAlertTagModal = function () {
        $(document).on('click', '.editAlertTags', function (evt) {
            var parent_row = $(event.target).closest('tr');
            var index = $(this).closest('tr').index();
            var rowObject = table.rows(index).data()[0];
            var alertId = rowObject.id;
            var execConfigId = parent_row.find('.execConfigId').attr("value");
            $.ajax({
                url: fetchTagsUrl,
                data: {
                    alertId: alertId
                },
                success: function (result) {
                    var alertTagModalObj = $('#alertTagModal');
                    alertTagModalObj.find('#singleAlertTags').select2({
                        placeholder: "Add Categories",
                        multiple: true,
                        tags: true,
                        data: result.tagList

                    });
                    alertTagModalObj.modal('show');
                    alertTagModalObj.find('#singleAlertTags').val(result.alertTagList);
                    alertTagModalObj.find('#singleAlertTags').trigger('change');
                    alertTagModalObj.find(".addTags").unbind().click(function () {
                        $.ajax({
                            url: saveTagUrl,
                            data: {
                                alertTags: JSON.stringify(alertTagModalObj.find('#singleAlertTags').val()),
                                alertId: alertId,
                                execConfigId: execConfigId
                            },
                            contentType: 'application/json',
                            success: function (result) {
                                table.ajax.reload()
                            }
                        });
                    });
                }
            });
        });
    };

    var openSingleAlertTagModal = function (tableObj, tagsObj) {
        $(document).on('click', '.editAlertTags', function (event) {
            var parent_row = $(event.target).closest('tr');
            var index = $(this).closest('tr').index();
            if (isAbstractViewOrCaseView(index)) {
                index = index / 2
            }
            var rowObject = tableObj.rows(index).data()[0];
            var alertId = rowObject.id;
            var execConfigId = parent_row.find('.execConfigId').attr("value");
            var alertTagModalObj = $('#alertTagModal');
            var $singleCaseAlertTags = alertTagModalObj.find('#singleAlertTags');
            var $globalTags = alertTagModalObj.find('#globalTags');
            applySelect2ForTags($singleCaseAlertTags, fetchTagsUrl, 'Case Series Categories', true);
            applySelect2ForTags($globalTags, fetchTagsUrl, 'Global Categories', false);
            $singleCaseAlertTags.find('option').remove()
            $globalTags.find('option').remove()
            $singleCaseAlertTags.val(null).trigger("change");
            $globalTags.val(null).trigger("change");
            $.each(rowObject.caseSeriesTags, function (index, value) {
                var option = new Option(value, value, true, true);
                $singleCaseAlertTags.append(option);
            });
            $.each(rowObject.globalTags, function (index, value) {
                var option = new Option(value, value, true, true);
                $globalTags.append(option);
            });
            alertTagModalObj.find('#singleAlertTags').trigger('change');
            alertTagModalObj.find('#globalTags').trigger('change');
            var enableCaseSeriesTags = rowObject.isCaseSeriesGenerated;
            if (!enableCaseSeriesTags) {
                alertTagModalObj.find('#singleAlertTags').attr('disabled', '');
            }
            alertTagModalObj.modal('show');
            alertTagModalObj.find(".addTags").unbind().click(function () {
                $.ajax({
                    url: saveTagUrl,
                    data: {
                        alertTags: JSON.stringify(alertTagModalObj.find('#singleAlertTags').val()),
                        globalTags: JSON.stringify(alertTagModalObj.find('#globalTags').val()),
                        deletedCaseSeriesTags: JSON.stringify(tagsObj.deletedCaseSeriesTags),
                        deletedGlobalTags: JSON.stringify(tagsObj.deletedGlobalTags),
                        addedCaseSeriesTags: JSON.stringify(tagsObj.addedCaseSeriesTags),
                        addedGlobalTags: JSON.stringify(tagsObj.addedGlobalTags),
                        alertId: alertId,
                        execConfigId: execConfigId
                    },
                    contentType: 'application/json',
                    success: function (payload) {
                        if (payload.status) {
                            tableObj.ajax.reload();
                            $.Notification.notify('success', 'top right', "Success", payload.message, {autoHideDelay: 2000});
                        } else {
                            $.Notification.notify('error', 'top right', "Error", payload.message, {autoHideDelay: 2000});
                        }
                        $('#single-case-alert-spinner').addClass('hidden');
                    }
                });
                $('#single-case-alert-spinner').removeClass('hidden');
            });
        });
    };

    var populateAdvancedFilterSelect = function (alertType) {

        $(".advanced-filter-dropdown").select2({
            placeholder: $.i18n._('selectOne'),
            allowClear: true,
            ajax: {
                url: fetchAdvFilterUrl,
                dataType: 'json',
                type: "GET",
                quietMillis: 50,
                data: function (params) {
                    return {
                        alertType: alertType,
                        term: params.term || '',
                        page: params.page || 1,
                        max: params.max || 30
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    return {
                        results: $.map(data.list, function (filter) {
                            return {
                                text: filter.name,
                                id: filter.id
                            }
                        }),
                        pagination: {
                            more: (params.page * 30) < data.totalCount
                        }
                    };
                }
            }
        });

        //select advanced filter based on current view
        if ($('#advancedFilterView').val()) {
            var advancedFilterView = $.parseJSON($('#advancedFilterView').val());
            var option = new Option(advancedFilterView.name, advancedFilterView.id, true, true);
            $(".advanced-filter-dropdown").append(option).trigger('change');
        }

        $('#addAdvancedFilter').on('click', function () {
            signal.advancedFilter.initializeAdvancedFilters($('#createAdvancedFilterModal'));
            $('#createAdvancedFilterModal #selectOperator').empty().append('<option selected="selected" value="">Select Operator</option>');
            $('#createAdvancedFilterModal #name').val('');
            $('#createAdvancedFilterModal #description').val('');
            $('#createAdvancedFilterModal #queryJSON').val('');
            $('#createAdvancedFilterModal #alertType').val('');
            $('#createAdvancedFilterModal #builderAll').find('.expression').remove();
            $('#createAdvancedFilterModal .deleteAdvFilter').addClass('hide');
            $('#createAdvancedFilterModal .filtersWithoutSaving').removeClass('hide');
            $('#createAdvancedFilterModal').modal('show');

        });

        $('#editAdvancedFilter').unbind().on('click', function () {
            var advancedFilterId = $('.advanced-filter-dropdown').val();
            if (advancedFilterId) {
                $.ajax({
                    url: fetchAdvancedFilterInfoUrl,
                    data: {'advancedFilter.id': advancedFilterId},
                    dataType: 'json',
                    type: "GET",
                    success: function (result) {
                        $('#createAdvancedFilterModal #selectOperator').empty().append('<option selected="selected" value="">Select Operator</option>');
                        $('#createAdvancedFilterModal #name').val(result.name);
                        $('#createAdvancedFilterModal #description').val(result.description);
                        $('#createAdvancedFilterModal #queryJSON').val(result.JSONQuery);
                        $('#createAdvancedFilterModal #alertType').val(alertType);
                        $('#createAdvancedFilterModal #filterId').val(advancedFilterId);
                        $('#createAdvancedFilterModal .filtersWithoutSaving').addClass('hide');
                        $('#createAdvancedFilterModal .deleteAdvFilter').removeClass('hide');
                        $('#createAdvancedFilterModal .modal-title').html("Edit Filter");
                        signal.advancedFilter.initializeAdvancedFilters();
                        $('#createAdvancedFilterModal').modal('show');
                    }
                });
            }
        });

        $(".advanced-filter-dropdown").on("change", function (e) {
            table.ajax.reload()
        });
    };

    return {
        openAlertCommentModal: openAlertCommentModal,
        openCaseHistoryModal: openCaseHistoryModal,
        restartReview: restartReview,
        openSimilarCasesModal: openSimilarCasesModal,
        applyBusinessRules: applyBusinessRules,
        showAttachmentModal: openAttachmentModal,
        bindGridDynamicFilters: bindGridDynamicFilters,
        enableMenuTooltips: enableMenuTooltips,
        disableTooltips: disableTooltips,
        sortIconHandler: sortIconHandler,
        isAlertPersistedInSessionStorage: isAlertPersistedInSessionStorage,
        removeFiltersFromSessionStorage: removeFiltersFromSessionStorage,
        openSaveViewModal: openSaveViewModal,
        createSortingMap: createSortingMap,
        createFilterMap: createFilterMap,
        createListOfIndex: createListOfIndex,
        openAlertTagModal: openAlertTagModal,
        setSortOrder: setSortOrder,
        openSingleAlertTagModal: openSingleAlertTagModal,
        generateViewInfo: generateViewInfo,
        populateAdvancedFilterSelect: populateAdvancedFilterSelect
    }

})();

function showErrorMessageInModal($modal, text) {
    clear_errors();
    if (text) {
        text = text;
    } else {
        text = 'Please fill  the required Fields';
    }
    var alertHtml = getErrorMessageHtml(text);
    $modal.find('.modal-body').prepend(alertHtml);
}

function getErrorMessageHtml(msg) {
    var alertHtml = '<div class="alert alert-danger alert-dismissible" role="alert"> ' +
        '<button type="button" class="close" data-dismiss="alert"> ' +
        '<span aria-hidden="true">&times;</span> ' +
        '<span class="sr-only"><g:message code="default.button.close.label" /></span> ' +
        '</button> ' + msg;
    '</div>';
    return alertHtml;
}

var clear_errors = function () {
    $('.modal .modal-body .alert').remove();
};

function search(nameKey, myArray) {
    for (var i = 0; i < myArray.length; i++) {
        if (myArray[i].name === nameKey) {
            return myArray[i];
        }
    }
}

function populateTopicDetail($modal, topicObj) {
    $modal.find('#startDate').val(topicObj.startDate);
    $modal.find('#endDate').val(topicObj.endDate);
    $modal.find('.product-span').text(getProductNameList(JSON.parse(topicObj.products)));
    $modal.find('#startDate').attr("disabled", "");
    $modal.find('#endDate').attr("disabled", "");
    if (topicObj.products) {
        $modal.find('#product').attr("disabled", "");
    }
}

function depopulateTopicDetail($modal) {
    var productJson = $modal.find('.product-json-container').val();
    $modal.find('#startDate').val("");
    $modal.find('#endDate').val("");
    $modal.find('#product').val("");
    $modal.find('.product-span').text(getProductNameList(JSON.parse(productJson)));
    $modal.find('#startDate').removeAttr("disabled");
    $modal.find('#endDate').removeAttr("disabled");
    $modal.find('#product').removeAttr("disabled");
}

function generateProductJson(productId, productName, level) {
    var topicProductValues = {"1": [], "2": [], "3": [], "4": [], "5": []};
    topicProductValues[level].push({name: productName, id: productId});
    return topicProductValues;
}

function getProductNameList(obj) {
    var productArray = [];
    var objArray = obj['3'];
    $.each(objArray, function (index, value) {
        productArray.push(value.name);
    });
    return productArray.join(',');
}

function getProductJson(applicationName, row) {
    var productJson;
    if (applicationName == "Ad-Hoc Alert") {
        if (row.find('.row-product-json-container').val())
            productJson = JSON.parse(row.find('.row-product-json-container').val());
    } else {
        var productName = row.find('span[data-field="productName"]').attr("data-id");
        var productId = row.find('.row-product-id').val();
        var level = row.find('.row-level-id').val();
        if (!level) {
            level = 3;
        }
        productJson = generateProductJson(productId, productName, level);
    }
    return productJson;
}

function applySelect2ForTags($selector, url, placeHolderText, isCaseSeriesTag) {
    $selector.select2({
        minimumInputLength: 0,
        multiple: true,
        tags: true,
        placeholder: placeHolderText,
        allowClear: true,
        width: "100%",
        createTag: function (tag) {

            // check if the option is already there
            found = false;
            $selector.find("option").each(function () {
                if ($.trim(tag.term).toUpperCase() === $.trim($(this).text()).toUpperCase()) {
                    prevTag = $(this);
                    found = true;
                }
            });

            // if it's not there, then show the suggestion
            if (!found) {
                return {
                    id: $.trim(tag.term),
                    text: $.trim(tag.term)
                };
            } else {
                return {
                    id: $.trim(prevTag.text()),
                    text: $.trim(prevTag.text())
                };
            }
        },
        ajax: {
            quietMillis: 250,
            dataType: "json",
            url: url,
            data: function (params) {
                return {
                    term: params.term,
                    page: params.page || 1,
                    max: 30,
                    lang: userLocale,
                    isCaseSeriesTag: isCaseSeriesTag
                };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                return {
                    results: data.list,
                    pagination: {
                        more: (params.page * 30) < data.totalCount
                    }
                };
            }
        }
    });
}

function showCommentIcon(currentRow) {
    var $btnGroup = $(currentRow).closest('tr').find('td.dropDown .btn-group');
    if ($($btnGroup).find('.comment').length === 0) {
        $($btnGroup).find('.dropdown-toggle').after('<i class="mdi mdi-chat blue-2 font-13 pos-ab comment" title="' + $.i18n._('commentAvailable') + '"></i>');
    }
}

function removeCommentIcon(currentRow) {
    var $btnGroup = $(currentRow).closest('tr').find('td.dropDown .btn-group');
    $($btnGroup).find('.dropdown-toggle').next('i').remove();
}

function removeAttachmentIcon(currentRow) {
    var $btnGroup = $(currentRow).closest('tr').find('td.dropDown .btn-group');
    if ($($btnGroup).find('.comment').length === 0) {
        $($btnGroup).find('.dropdown-toggle').next('i').remove();
    } else {
        $($btnGroup).find('.comment').next('i').remove();
    }
}

function showAttachmentIcon(trRow) {
    var $btnGroup = $(trRow).find('td.dropDown .btn-group');
    if ($($btnGroup).find('.attach').length === 0) {
        if ($($btnGroup).find('.comment').length === 0) {
            $($btnGroup).find('.dropdown-toggle').after(' <i class="mdi mdi-attachment blue-1 font-13 pos-ab attach" title="' + $.i18n._('attachmentAvailable') + '"></i> ');
        } else {
            $($btnGroup).find('.comment').after(' <i class="mdi mdi-attachment blue-1 font-13 pos-ab attach" title="' + $.i18n._('attachmentAvailable') + '"></i> ');
        }
    }
}

var isSafetyLeadAllowed = function (listProductIds, selectedProductId) {
    return listProductIds.indexOf(selectedProductId) !== -1
};

var setColumnSeq = function (mapSeq) {
    columnSeq = mapSeq
}

var signal = signal || {};

signal.archived_utils = (function () {
    var archived_table;
    var sortingCount = 1;

    var init_archived_table = function (table, url, appType, alertDetailUrl) {
        if (!$.fn.dataTable.isDataTable(table)) {
            archived_table = $(table).DataTable({
                "sPaginationType": "bootstrap",

                "language": {
                    "url": "../assets/i18n/dataTables_" + userLocale + ".json"
                },
                fnDrawCallback: function (){
                    colEllipsis();
                    webUiPopInit();
                },
                "ajax": {
                    "url": url,
                    "dataSrc": ""
                },
                "aaSorting": [[sortingCount, "desc"]],
                "bLengthChange": true,
                "iDisplayLength": 10,
                "bAutoWidth": false,
                "aoColumns": create_archived_column_data(appType, alertDetailUrl),
                "scrollX": true,
                "scrollY":"calc(100vh - 296px)",
                "autoWidth": true,
                columnDefs: [{
                    "targets": '_all',
                    "render": $.fn.dataTable.render.text()
                }]
            });
            return archived_table;
        }
    };

    var genAlertNameLink = function (value, id, alertDetailUrl) {
        return function () {
            return '<a href="' + (alertDetailUrl + '?' + 'callingScreen=review&' +
                signal.utils.composeParams({configId: id})) + '" + target="_blank">' + value + '</a>'
        }
    };

    var create_archived_column_data = function (appType, alertDetailUrl) {
        var aoColumns = [
            {
                "mData": "alertName",
                "mRender": function (data, type, row) {
                    return genAlertNameLink(escapeHTML(row.alertName), row.exConfigId, alertDetailUrl)
                },
                'className': 'col-min-150'
            },
            {
                "mData": "version",
                "mRender": function (data, type, full) {
                    return data
                },
                'className': 'col-min-100'
            },
            {
                "mData": "product",
                "mRender": function (data, type, row) {
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement+=row.product;
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="'+row.product+'"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement                },
                "className": 'col-min-150 cell-break',
            },
            {
                "mData": "description",
                "mRender": function (data, type, full) {
                    return addEllipsis(data)
                },
                'className': 'col-min-150 cell-break'
            },
            {
                "mData": "caseCount",
                "mRender": function (data, type, full) {
                    return data
                },
                'className': 'col-min-100'
            },
            {
                "mData": "reviewedCases",
                "mRender": function (data, type, full) {
                    return data
                },
                'className': 'col-min-100'
            },
            {
                "mData": "dateRange",
                "mRender": function (data, type, full) {
                    return data
                },
                'className': 'col-min-150'
            },
            {
                "mData": "lastModified",
                "mRender": function (data, type, full) {
                    return data
                },
                'className': 'col-min-150'
            }
        ];
        return aoColumns
    };

    var reload_archived_table = function () {
        if (typeof archived_table != "undefined" && archived_table != null) {
            archived_table.ajax.reload();
        } else {
            console.log("Unable to reload the archived table. Please refresh the page.");
        }
    };

    return {
        init_archived_table: init_archived_table,
        reload_archived_table: reload_archived_table
    }
})();
var signal = signal || {};
var existingRows = [];

signal.commonTag = (function () {
    var openCommonAlertTagModal = function (module, domain, tags) {
        $(document).on('click', '.editAlertTags', function (evt) {
            var parent_row = $(event.target).closest('tr');
            var index = $(this).closest('tr').index();
            var rowObject = table.rows(index).data()[0];
            var alertId = rowObject.id;
            var commonTagModalObj = $('#commonTagModal');
            fillAlertTags(commonTagModalObj, fillCommonTagUrl, module, domain, tags, alertId);
            commonTagModalObj.modal('show');
        });
    };
    return {
        openCommonAlertTagModal: openCommonAlertTagModal
    }
})();

var fillAlertTags = function (tagModal, fillCommonTagUrl, module, domain, tags, alertId) {
    var dataUrl = fillCommonTagUrl + "/"+module+"?domain="+domain + "&alertId="+alertId;
    categoryModalTable = $("#categoryModalTable").DataTable({
        "language": {
            "url": "../assets/i18n/dataTables_" + userLocale + ".json"
        },
        "createdRow": function ( row, data, index ) {
            var tagsEnabled = nonConfiguredEnabled != "true" ? false : true;
            var categories = [];
            tags.forEach(function (map) {
                if(map.parentId ==0 || map.parentId == null) {
                    categories.push({id: map.id, text: map.text});
                }
            });
            $('select', row).eq(0).select2({
                tags: tagsEnabled,
                data: categories,
                placeholder: "Select Category"
            }).on('change', function(obj) {

                var subtagsEnabled = nonConfiguredEnabled != "true" ? false : true;
                var subcategories = [];
                tags.forEach(function (map) {
                    if(map.parentId == obj.currentTarget.value) {
                        subcategories.push({id: map.id, text: map.text});
                    }
                });

                if(data.action == 1) {
                    $('select', row).eq(1).empty();
                }

                // if no subcategory configure then can not add on fly subcategory
                if(subcategories.length <= 0){
                    subtagsEnabled = false;
                }else{
                    subtagsEnabled = (subtagsEnabled && true);
                }

                $('select', row).eq(1).select2({
                    tags: subtagsEnabled,
                    data: subcategories,
                    placeholder: "Select Sub Category"
                });
            }).trigger('change');

            if(data.action != 1) {
                $('input', row).closest('tr').find(":input").attr('disabled', true);
                if(data.subcategory.length <= 0)
                    $('input', row).closest('tr').find(":input[class=select2-search__field]").attr("placeholder", "");
            }

            $(".edit-row", row).unbind().click(function(){
                var isDisabled = $(this).closest('tr').find(":input:not(:first)").attr('disabled');
                $(this).closest('tr').find(":input:not(:first)").attr('disabled', !isDisabled);
                if(isDisabled && data.subcategory.length <= 0)
                    $(this).closest('tr').find(":input[class=select2-search__field]").attr("placeholder", "Select Sub Category");
                else if(isDisabled && data.subcategory.length > 0)
                    $(this).closest('tr').find(":input[class=select2-search__field]").attr("placeholder", "");
                else if(!isDisabled && data.subcategory.length <= 0)
                    $(this).closest('tr').find(":input[class=select2-search__field]").attr("placeholder", "");

            });

            $(".delete-row", row).unbind().click(function(){
                categoryModalTable
                    .row( $(this).parents('tr') )
                    .remove()
                    .draw();
            });

            $(".up-row", row).unbind().click(function(){
                const $row = $(this).parents('tr');
                if ($row.index() === 0) {
                    return;
                }
                $row.prev().before($row.get(0));
            });

            $(".down-row", row).unbind().click(function(){
                const $row = $(this).parents('tr');
                $row.next().after($row.get(0));
            });

        },
        rowCallback: function( row, data, index ) {
            if (data['private'] == true && data['privateAccess'] != true) {
                $(row).hide();
            }
        },
        initComplete: function(settings, json){
            existingRows = [];
            categoryModalTable.rows().every(function(index, element){
                var value = this.data();
                var currentRow = {category: value.category, subcategory: value.subcategory, alert: value.alert, private: value.private,
                    createdBy: value.createdBy, createdDate: value.createdDate, priority: value.priority, updatedDateInit: value.updatedDateInit,
                    updatedByInit: value.updatedByInit};
                if(currentRow.category.id != 0)
                    existingRows.push(currentRow);
            });
        },
        "ajax": {
            "url": dataUrl,
            "dataSrc": ""
        },
        searching: true,
        "bLengthChange": true,
        "paging":   false,
        "ordering": false,
        "searching": false,
        "info": false,
        "bDestroy": true,
        stateSave: true,
        "scrollY":        "350px",
        "scrollCollapse": true,
        "aoColumns": [
            {
                "mData": "category",
                "width": "25%",
                'className': 'dt-center',
                "mRender": function (data, type, row) {
                    var html = '<select name="selectField" id="dynamicSelectFieldCategory" class="dynamicSelectFieldCategory form-control">';
                    if(data) {
                        html += '<option selected="selected" value="' + data.id + '">' + data.name + '</option>';
                    }
                    html += '</select>';
                    return html;
                }
            },
            {
                "mData": "subcategory",
                'className': 'dt-center',
                "width": "35%",
                "mRender": function (data, type, row) {

                    var html = '<select name="selectField" id="dynamicSelectFieldSubCategory" multiple="multiple" class="dynamicSelectFieldSubCategory form-control">';
                    row.subcategory.forEach(function (obj) {
                        html += '<option selected="selected" value="'+obj.id+'">'+obj.name+'</option>';
                    });
                    html += '</select>';
                    return html

                }
            },
            {
                "mData": "alert",
                "className": "justification-cell dataTableColumnCenter text-center",
                "width": "15%",
                "mRender": function (data, type, row) {
                    var checked = row.alert == true ? "checked": "";
                    return '<input type="checkbox" class="alert-check-box" ' + checked +' data-id=' + row.alert + ' />';

                }
            },
            {
                "mData": "private",
                "width": "12%",
                "mRender": function (data, type, row) {
                    var checked = row.private == true ? "checked": "";
                    return '<input type="checkbox" class="private-check-box" ' + checked  +' data-id=' + row.private + ' />';
                },
                'className': 'dt-center dataTableColumnCenter text-center'
            },
            {
                "mData": "action",
                "width": "13%",
                "className": "td-action",
                "mRender": function (data, type, row) {
                    if(data === 1){
                        return '<i class="fa fa-trash-o delete-row tag-action blue-1"></i>';
                    }
                    else {

                        var details = '<b>Created By:</b> '+row.createdBy +'<hr/> <b>Created Date:</b> '+row.createdDate +'<hr/> <b>Last Modified By:</b> '+row.updatedBy
                            +'<hr/> <b>Last Modified Date:</b> '+row.updatedDate;
                        return '<i id="tag-popup" class="fa fa-info popoverMessage tag-action blue-1" title="Details" data-content="' + details + '"></i>' +
                            '  <i class="fa fa-pencil edit-row tag-action blue-1" ></i>' +
                            '  <i class="fa fa-trash-o delete-row tag-action blue-1"></i>';
                    }
                }
            }
        ],
        columnDefs: [{
            "targets": '_all',
            "render": $.fn.dataTable.render.text()
        }]
    });
    $( "#categoryModalTable" ).sortable({
        items: 'tr:not(:first)',
        cursor: 'move',
        opacity: 0.6,
        scrollSpeed: 40,
        cancel: "thead",
        containment : "parent"
    });

    if(privateEnabled != "true") {
        categoryModalTable.column(3).visible(false);
    }else{
        categoryModalTable.column(3).visible(true);
    }
    $('#categoryModalTable').on('mouseover', 'tr', function () {
        $('.popoverMessage').popover({
            placement: 'left',
            trigger: 'hover focus',
            viewport: 'body',
            html: true
        });
    });

    $("#add-row").click(function () {
        var lastRow = categoryModalTable.row(':last').data();
        var lastRowCategory = $('#categoryModalTableBody tr:last').find("td select.dynamicSelectFieldCategory").val();
        if(lastRowCategory != 0) {
            categoryModalTable.row.add({
                "category": {id: 0, name: "Select Category"},
                "subcategory": [],
                "alert": false,
                "private": false,
                "action": 1,
                "priority": 9999,
                "new": true
            }).draw(false);
            var $scrollBody = $(categoryModalTable.table().node()).parent();
            $scrollBody.scrollTop($scrollBody.get(0).scrollHeight);
        }
        $('#categoryModalTableBody tr:last select').eq(0).focus();
    });

    $(".addTags").unbind().click(function () {
        var newRows = [];
        var count = 1;
        $('#categoryModalTableBody tr').each(function(){
            var th = $(this);
            var categoryId = $(th).find("td select.dynamicSelectFieldCategory").val();
            var categoryText = $(th).find("td select.dynamicSelectFieldCategory option:selected").text();
            var category = {id: categoryId, name: categoryText};
            var subcategories = [];
            $(th).find("td select.dynamicSelectFieldSubCategory option:selected").each(function(){
                subcategories.push({id: $(this).val(), name:$(this).text()});
            });
            var alert = $(th).find("td input.alert-check-box").is(":checked");
            var private = $(th).find("td input.private-check-box").is(":checked");
            var currentRow = {category: category, subcategory: subcategories, alert: alert, private: private, priority: count};
            if(currentRow.category.name != 'Select Category' && currentRow.category.name != '') {
                newRows.push(currentRow);
                count = count + 1;
            }
        });

        var data = {
            newRows: JSON.stringify(newRows),
            existingRows: JSON.stringify(existingRows),
            alertId: alertId,
            type: domain
        };
        $.ajax({
            url: saveCommonTagsUrl,
            type: "POST",
            async:false,
            data: JSON.stringify(data),
            contentType: 'application/json; charset=utf-8',
            dataType: "json",
            success: function (data) {
                table.ajax.reload()
            }
        });
    });
    return categoryModalTable
};




//= require app/pvs/common/rx_common.js
//= require app/pvs/common/rx_alert_utils.js
//= require app/pvs/common/rx_list_utils.js
//= require app/pvs/activity/activities.js
//= require app/pvs/actions/actions.js
//= require app/pvs/users/users.js
//= require app/pvs/common/rx_handlebar_ext.js
//= require app/pvs/alertComments/alertComments.js
//= require app/pvs/alerts_review/alert_review.js
//= require app/pvs/alerts_review/archivedAlerts.js
//= require app/pvs/common_tag.js

var userLocale = "en";
var applicationName = "Single Case Alert";
var applicationLabel = "Qualitative Alert";
var table;
var executedIdList = [];
var tagsObj = {
    addedCaseSeriesTags: [],
    addedGlobalTags: [],
    deletedCaseSeriesTags: [],
    deletedGlobalTags: []
};
var tags = [];

var isDynamicFilterApplied = false;
var dir = '';
var index = -1;
var detailsParameters = {};

$(document).ready(function () {
    var customFieldsEnabled = JSON.parse($("#customFieldsEnabled").val());

    $('a[href="#details"]').on("shown.bs.tab", function (e) {
        $('#alertsDetailsTable').DataTable().columns.adjust();
        addGridShortcuts('#alertsDetailsTable');
        removeGridShortcuts('#activitiesTable');
    });

    $('a[href="#archivedAlerts"]').on("shown.bs.tab", function (e) {
        $('#archivedAlertsTable').DataTable().columns.adjust();
        addGridShortcuts('#archivedAlertsTable');
        removeGridShortcuts('#activitiesTable');
        removeGridShortcuts('#alertsDetailsTable');
    });

    var activities_table;
    $('#activity_tab').on('click', function () {
        if (activities_table == null || activities_table == undefined) {
            if (callingScreen == CALLING_SCREEN.REVIEW) {
                activities_table = signal.activities_utils.init_activities_table($("#activitiesTable"),
                    '/signal/activity/listByExeConfig?' + 'executedIdList=' + executedIdList + "&appType=" + applicationName, applicationName);
            } else {
                activities_table = signal.activities_utils.init_activities_table($("#activitiesTable"),
                    '/signal/activity/listActivities?' + "appType=" + applicationName, applicationName);
            }
        }
    });

    $('a[href="#archivedAlerts"]').on('click', function () {
        if (callingScreen == CALLING_SCREEN.REVIEW) {
            archived_table = signal.archived_utils.init_archived_table("#archivedAlertsTable", archivedAlertUrl, applicationName, singleCaseDetailsUrl);
        }
    });

    if (callingScreen == CALLING_SCREEN.REVIEW || callingScreen == CALLING_SCREEN.DASHBOARD) {
        $(window).on('beforeunload', function () {
            $.ajax({
                url: discardTempChangesUrl,
                method: 'GET'
            })
        });
    }

    //back button tag screen
    if (callingScreen != CALLING_SCREEN.TAGS) {
        sessionStorage.setItem("back_url", window.location.href)
    }
    $('.tag-screen-back-btn').on('click', function () {
        window.location.href = sessionStorage.getItem('back_url')
    });

    var fixedColumns = 6;
    var filterIndex = [8, 9, 10, 11, 12, 14, 16];
    if(customFieldsEnabled){
        filterIndex.push.apply(filterIndex, [29, 30, 31, 32, 33, 34, 35, 36])
    }
    var listOfIndex = [13, 14, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 32];
    if (callingScreen == CALLING_SCREEN.DASHBOARD) {
        fixedColumns = 7;
        filterIndex = [9, 10, 11, 12, 13, 15, 17];
        if(customFieldsEnabled){
            filterIndex.push.apply(filterIndex, [30, 31, 32, 33, 34, 35, 36, 37])
        }
    }
    if (callingScreen == CALLING_SCREEN.TRIGGERED_ALERTS) {
        fixedColumns = 6;
        filterIndex = [4, 8, 9, 10, 11, 14, 15, 17];
        listOfIndex = [13, 14, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 32];
        if(customFieldsEnabled){
            filterIndex.push.apply(filterIndex, [29, 30, 31, 32, 33, 34, 35, 36])
        }
    }
    if ($("#isFaers").val() == "true") {
        fixedColumns = 3;
        filterIndex = [5, 6, 7, 8, 9, 10, 11];
        if(customFieldsEnabled){
            filterIndex.push.apply(filterIndex, [23, 24, 25, 26, 27, 28, 29, 30])
        }
    } else if ($("#isCaseSeries").val() == "true") {
        fixedColumns = 5;
        filterIndex = [7, 8, 9, 10, 11, 13, 15];
        if (customFieldsEnabled) {
            filterIndex.push.apply(filterIndex, [28, 29, 30, 31, 32, 33, 34, 35])
        }
    }
    var alertDetailsTable;

    var checkedIdList = [];
    var checkedRowList = [];

    signal.alertReview.openAlertCommentModal("Single Case Alert", applicationName, applicationLabel, checkedIdList, checkedRowList);
    signal.alertReview.showAttachmentModal();
    signal.alertReview.populateAdvancedFilterSelect(applicationName);
    signal.alertReview.setSortOrder();
    signal.list_utils.flag_handler("singleCaseAlert", "toggleFlag");
    //The case history modal.
    signal.alertReview.openCaseHistoryModal();
    //The restart case review.
    signal.alertReview.restartReview(caseReviewPreviousUrl);
    //The similar cases modal.
    signal.alertReview.openSimilarCasesModal(caseInfoUrl);

    //apply the filter values to columns based on saved view
    var filterValue = signal.alertReview.createFilterMap('sca_filterMap_' + executedConfigId, 'sca_viewName_' + executedConfigId);

    $(document).on('click', '#addCase', function () {
        init_add_case_modal()
    });

    $(document).on('click', '.bulkDisposition', function () {
        $('#dispositionSignalPopover').modal('show');
    });

    $(document).on('click', '#addCaseButton', function () {
        add_case_to_list()
    });

    //apply the sorting to column based on saved view
    var sortingMap = signal.alertReview.createSortingMap('sca_sortedColumn_' + executedConfigId, 'sca_viewName_' + executedConfigId);
    if (sortingMap != 'undefined' && sortingMap.length > 0) {
        index = sortingMap[0][0];
        dir = sortingMap[0][1]
    }

    var getAlertType = function () {
        var urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('isFaers') != null && urlParams.get('isFaers') == 'true') {
            return ALERT_TYPE.SINGLE_CASE_ALERT_FAERS;
        }else {
            return applicationName;
        }
        return applicationName;
    };

    if (callingScreen == CALLING_SCREEN.REVIEW) {
        //saving new ViewInstance modal
        var alertType = getAlertType();
        if ($('#isCaseSeries').val() == "true") {
            alertType = ALERT_CONFIG_TYPE.SINGLE_CASE_ALERT_DRILL_DOWN
        }
        signal.alertReview.openSaveViewModal(filterIndex, alertType, viewId)
    } else if (callingScreen == CALLING_SCREEN.DASHBOARD) {
        signal.alertReview.openSaveViewModal(filterIndex, ALERT_CONFIG_TYPE.SINGLE_CASE_ALERT_DASHBOARD, viewId)
    }

    $(window).bind('beforeunload', function () {
        if (sessionStorage.getItem('isViewCall') == 'true' || $('.viewSelect :selected').text().replace("(default)", "").trim() != 'System View') {
            var backUrl = sessionStorage.getItem('back_url');
            sessionStorage.clear();
            sessionStorage.setItem('back_url', backUrl)
        } else {
            var viewInfo = signal.alertReview.generateViewInfo(filterIndex);
            sessionStorage.setItem('sca_filterMap_' + executedConfigId, JSON.stringify(viewInfo.filterMap));
            sessionStorage.setItem('sca_sortedColumn_' + executedConfigId, JSON.stringify(viewInfo.sortedColumn));
            sessionStorage.setItem('sca_notVisibleColumn_' + executedConfigId, viewInfo.notVisibleColumn);
            sessionStorage.setItem('sca_viewName_' + executedConfigId, $('.viewSelect :selected').text().replace("(default)", "").trim())
        }
    });

    $('#alert-list-filter-apply-bt').click(function (evt) {
        evt.preventDefault();
        $('#alert-list-filter').find('#filterUsed').val(true);
        var newUrl = listConfigUrl + "&" + $('#alert-list-filter').serialize() + "&z=" + true;
        $('#alertsDetailsTable').DataTable().ajax.url(newUrl).load()
    });

    $("#detail-tabs a[href='#details']").on("click", function (e) {
        $('#alertsDetailsTable').DataTable().columns.adjust();
    });

    fetchTags();

    var initAlertDetailsTable = function () {
        var prefix = "sca_";
        var isFilterRequest = true;
        var filterArray = [];
        var filterValues = [];
        if (window.sessionStorage && signal.alertReview.isAlertPersistedInSessionStorage(prefix)) {
            filterValues = JSON.parse(sessionStorage.getItem(prefix + "filters_value"));
        } else {
            signal.alertReview.removeFiltersFromSessionStorage(prefix);
            isFilterRequest = false;
        }
        var aoColumns = create_single_case_table_columns(callingScreen, customFieldsEnabled);
        signal.actions_utils.set_action_list_modal($('#action-modal'));
        signal.actions_utils.set_action_create_modal($('#action-create-modal'));

        table = $('#alertsDetailsTable').DataTable({
            "sPaginationType": "bootstrap",
            "language": {
                "url": "../assets/i18n/dataTables_" + userLocale + ".json"
            },
            drawCallback: function (settings) {

                if (typeof settings.json != "undefined") {
                    $("#fullCaseList").val(JSON.stringify(settings.json.fullCaseList));
                    if (!isDynamicFilterApplied) {
                        isDynamicFilterApplied = true;
                        signal.alertReview.bindGridDynamicFilters(settings.json.filters, prefix, settings.json.configId);
                    }
                }
                tagEllipsis();
                colEllipsis();
                webUiPopInit();
                closePopupOnScroll();
                enterKeyAlertDetail();
                if (isCaseDetailView == "true") {
                    showCaseDetailsView();
                }
                signal.alertReview.sortIconHandler();
                if (filterValue.length === 0 && !$(table.table().body()).hasClass('detailsTableBody')) {
                    $(table.table().body()).addClass('detailsTableBody');
                }
            },
            "ajax": {
                "url": createAlertListUrl(isFilterRequest, filterValues),
                "type": "POST",
                "dataSrc": "aaData",
                "cache": false,
                "data": function (d) {
                    if (index != -1) {
                        d.sort = d.columns[index].data;
                        d.direction = dir;
                    }
                    if ($('#advanced-filter').val()) {
                        d.advancedFilterId = $('#advanced-filter').val()
                    }
                    if ($('#queryJSON').val()) {
                        d.queryJSON = $('#queryJSON').val()
                    }
                    d.callingScreen = callingScreen;
                    detailsParameters = d;
                }
            },
            initComplete: function (settings, json) {
                if (filterValue.length === 0 && !isDynamicFilterApplied) {
                    isDynamicFilterApplied = true;
                    signal.alertReview.bindGridDynamicFilters(json.filters, prefix, json.configId);
                }
                if (sessionStorage.getItem(prefix + "filters_store")) {
                    var filtersArray = JSON.parse(sessionStorage.getItem(prefix + "filters_store"));
                    $.each(filtersArray, function (index, obj) {
                        $('#filter' + index).prop("checked", obj == true);
                    });
                }
                signal.alertReview.enableMenuTooltips();
                signal.alertReview.disableTooltips();
                addGridShortcuts('#alertsDetailsTable');
            },
            "bLengthChange": true,
            "cache": true,
            "bProcessing": true,
            "bServerSide": true,
            "colReorder": {
                "realtime": false
            },
            "oLanguage": {
                "sProcessing": '<div class="grid-loading"><img src="/signal/assets/spinner.gif" width="30" align="middle" /></div>',
                "sZeroRecords": "No data available in table", "sEmptyTable": "No data available in table"
            },
            "aLengthMenu": [[50, 100, 200, 500], [50, 100, 200, 500]],
            "pagination": true,
            "iTotalDisplayRecords": "50",
            "aoColumns": aoColumns,
            "responsive": true,
            "deferLoading": filterValue.length > 0 ? 0 : null,
            "scrollX": true,
            "rowCallback": function (row, data, index) {
                $(row).addClass("data-table-row");
                signal.user_group_utils.bind_assignTo_to_grid_row($(row), searchUserGroupListUrl, {
                    name: data.assignedToUser.fullName,
                    id: data.assignedToUser.id
                });
            },
            columnDefs: [{
                "targets": '_all',
                "render": $.fn.dataTable.render.text()
            }]
        });

        signal.user_group_utils.bind_assignTo_selection(assignToGroupUrl, table);
        init_filter(table);

        return table
    };


    var init_filter = function (data_table) {

        var cumulative = $("#cumulative").val();
        var filterOptions = null;
        if (cumulative == "true") {
            filterOptions = [
                {
                    column_number: 4,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //name
                {
                    column_number: 8,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //productName
                {
                    column_number: 9,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //pt
                {
                    column_number: 10,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //listed
                {
                    column_number: 11,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //outcome
                {
                    column_number: 14,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //signal/topic
                {
                    column_number: 15,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //current disposition
                {
                    column_number: 17,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //dueIn
                {
                    column_number: 29,  //Medication Errors PTs
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                },
                {
                    column_number: 30,  //Age
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }]
            if (customFieldsEnabled) {
                filterOptions.push.apply(filterOptions, [
                    {
                    column_number: 31, //Case Type
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                    },
                    {
                        column_number: 32, //Completeness Score
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 33, //Primary IND#
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 34, //Application Type & Number
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 35, //compounding flag
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 36,  //Submitter
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    }])
            }
        } else if (callingScreen == CALLING_SCREEN.DASHBOARD) {
            filterOptions = [
                {
                    column_number: 9,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //productName
                {
                    column_number: 10,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //pt
                {
                    column_number: 11,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //listedness
                {
                    column_number: 12,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //outcome
                {
                    column_number: 13,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //signal / topic
                {
                    column_number: 15,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //current disposition
                {
                    column_number: 17,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Due in`
                {
                    column_number: 30,  //Medication Errors PTs
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                },
                {
                    column_number: 31,  //Age
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }]
            if (customFieldsEnabled) {
                filterOptions.push.apply(filterOptions, [
                    {
                    column_number: 32, //Case Type
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                    },
                    {
                        column_number: 33, //Completeness Score
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 34, //Primary IND#
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 35, //Application Type & Number
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 36, //compounding flag
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 37,  //Submitter
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    }])
            }
        } else if ($("#isFaers").val() == "true") {
            filterOptions = [
                {
                    column_number: 5,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //productName
                {
                    column_number: 6,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //pt
                {
                    column_number: 7,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //listedness
                {
                    column_number: 8,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //outcome
                {
                    column_number: 9,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //signal / topic
                {
                    column_number: 10,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //current disposition
                {
                    column_number: 11,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Susp Products
                {
                    column_number: 23,  //Medication Errors PTs
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                },
                {
                    column_number: 24,  //Age
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }]
            if (customFieldsEnabled) {
                filterOptions.push.apply(filterOptions, [
                    {
                    column_number: 25, //Case Type
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                    },
                    {
                        column_number: 26, //Completeness Score
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 27, //Primary IND#
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 28, //Application Type & Number
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 29, //compounding flag
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 30,  //Submitter
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    }])
            }
        } else if ($('#isCaseSeries').val() == "true") {
            filterOptions = [
                {
                    column_number: 7,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //pt
                {
                    column_number: 8,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //listedness
                {
                    column_number: 9,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //outcome
                {
                    column_number: 10,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //signal / topic
                {
                    column_number: 11,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //current disposition
                {
                    column_number: 13,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Due in
                {
                    column_number: 15,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Serious
                {
                    column_number: 28,  //Medication Errors PTs
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                },
                {
                    column_number: 29,  //Age
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }]
            if (customFieldsEnabled) {
                filterOptions.push.apply(filterOptions, [
                    {
                        column_number: 30, //Case Type
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 31, //Completeness Score
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 32, //Primary IND#
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 33, //Application Type & Number
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 34, //compounding flag
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 35,  //Submitter
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    }])
            }
        } else {
            filterOptions = [
                {
                    column_number: 8,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //pt
                {
                    column_number: 9,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //listedness
                {
                    column_number: 10,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //outcome
                {
                    column_number: 11,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //signal / topic
                {
                    column_number: 12,
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //current disposition
                {
                    column_number: 14,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Due in
                {
                    column_number: 16,
                    filter_type: 'text',
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }, //Serious
                {
                    column_number: 29,  //Medication Errors PTs
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                },
                {
                    column_number: 30,  //Age
                    filter_type: "text",
                    filter_reset_button_text: false,
                    filter_delay: 600,
                    filter_default_label: ''
                }];
            if (customFieldsEnabled) {
                filterOptions.push.apply(filterOptions, [
                    {
                        column_number: 31, //Case Type
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 32, //Completeness Score
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 33, //Primary IND#
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 34, //Application Type & Number
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 35, //compounding flag
                        filter_type: 'text',
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    },
                    {
                        column_number: 36,  //Submitter
                        filter_type: "text",
                        filter_reset_button_text: false,
                        filter_delay: 600,
                        filter_default_label: ''
                    }])
            }
        }
        yadcf.init(data_table, filterOptions);
        if (filterValue.length > 0) {
            yadcf.exFilterColumn(data_table, filterValue, true);
        } else {
            $('.yadcf-filter-wrapper').hide()
        }
        window.sca_data_table = table;
        signal.fieldManagement.init($('#alertsDetailsTable').DataTable(), '#alertsDetailsTable', fixedColumns);
        signal.commonTag.openCommonAlertTagModal("PVS","Qualitative", tags);
        $("#toggle-column-filters").click(function () {
            var ele = $('.yadcf-filter-wrapper');
            var inputEle = $('.yadcf-filter');
            if (ele.is(':visible')) {
                ele.hide();
                inputEle.val('');
            } else {
                ele.show();
                inputEle.first().focus();
            }
            data_table.columns.adjust().fixedColumns().relayout()
        });

    };

    var create_single_case_table_columns = function (callingScreen, customFieldsEnabled) {

        var aoColumns = [

            {
                "mData": "selected",
                "mRender": function (data, type, row) {
                    if ($.inArray(row.execConfigId, executedIdList) == -1) {
                        executedIdList.push(row.execConfigId)
                    }
                    return '<input class="execConfigId" id="execConfigId" type="hidden" value="' + row.execConfigId + '" />' +
                        '<input class="alertConfigId" id="alertConfigId" type="hidden" value="' + row.alertConfigId + '" />' +
                        '<input data-field ="productFamily" data-id="' + row.productFamily + '" type="hidden" value="' + row.productFamily + '" />' +
                        '<input data-field ="primaryEvent" data-id="' + row.primaryEvent + '" type="hidden" value="' + row.primaryEvent + '" />' +
                        '<input type="checkbox" class="alert-check-box editor-active copy-select" data-id=' + row.id + ' />';
                },
                "className": "",
                "orderable": false,
                "visible": true
            },
            {
                "mData": "dropdown",
                "mRender": function (data, type, row) {
                    var actionButton = '<div style="display: block;" class="btn-group dropdown dataTableHideCellContent" align="center"> \
                        <a class="dropdown-toggle" data-toggle="dropdown" tabindex="0"> \
                        <span style="cursor: pointer;font-size: 125%;" class="glyphicon glyphicon-option-vertical"></span><span class="sr-only">Toggle Dropdown</span> \
                        </a> ';

                    if (row.comments) {
                        actionButton += '<i class="mdi mdi-chat blue-2 font-13 pos-ab comment" title="' + $.i18n._('commentAvailable') + '"></i>';
                    }

                    if (row.isAttachment == true) {
                        actionButton += ' <i class="mdi mdi-attachment blue-1 font-13 pos-ab attach" title="' + $.i18n._('attachmentAvailable') + '"></i>';
                    }

                    actionButton += '<ul class="dropdown-menu menu-cosy" role="menu"> <li role="presentation"><a class="review-row-icon case-history-icon" tabindex="0"><span class="fa fa-list m-r-10"></span>History</a></li>';
                    actionButton += '<li role="presentation"><a class="review-row-icon comment-icon " data-info="row" tabindex="0"><span class="fa fa-comment m-r-10"></span>Comments</a></li>';
                    actionButton += '<li role="presentation"><a class="review-row-icon show-attachment-icon" data-field="attachment" data-id="' + row.id + '" data-controller="singleCaseAlert" tabindex="0"><span class="fa fa-file m-r-10"></span>Attachment</a></li>';
                    actionButton += '</ul></div>';

                    return actionButton;
                },
                "orderable": false,
                "visible": true,
                "className": "dropDown"
            }
        ];
        if ($("#isCaseSeries").val() != "true") {
            aoColumns.push.apply(aoColumns, [{
                "mData": "badge",
                "mRender": function (data, type, row) {
                    var flagElement = "";
                    var flag = row.badge ? row.badge.split(',') : null;
                    if (flag) {
                        $.each(flag, function (idx, val) {
                            if (val === BADGES.NEW) {
                                flagElement += '<i class="glyphicon glyphicon-tag m-r-5" style="color: orange"></i>'
                            } else if (val === BADGES.AUTO_FLAGGED) {
                                flagElement += '<i class="glyphicon glyphicon-tag m-r-5" style="color: green"></i>'
                            } else if (val === BADGES.PENDING_REVIEW) {
                                flagElement += '<i class="glyphicon glyphicon-tag m-r-5" style="color: purple"></i>'
                            }
                        });
                    }
                    return flagElement
                },
                "className": '',
                "visible": true
            }
            ]);
        }
        if ($("#isFaers").val() != "true") {
            aoColumns.push.apply(aoColumns, [{
                "mData": "priority",
                "aTargets": ["priority"],
                "mRender": function (data, type, row) {
                    var isPriortyChangeAllowed = (isProductSecurity == 'true' && allowedProductsAsSafetyLead.indexOf(row.productName)) || isProductSecurity == 'false';                    return signal.utils.render('priority', {
                        priorityValue: row.priority.value,
                        priorityClass: row.priority.iconClass,
                        isPriorityChangeAllowed: isPriortyChangeAllowed
                    });
                },
                'className': 'text-center col-min-30 priorityParent',
                "visible": true
            },
                {
                    "mData": "actions",
                    'className': 'col-min-30 text-center action-col',
                    "mRender": function (data, type, row) {
                        return signal.actions_utils.build_action_render(row)
                    },
                    "width": '35px',
                    "visible": true
                }]);
        }
        if (callingScreen == CALLING_SCREEN.DASHBOARD) {
            aoColumns.push.apply(aoColumns, [{
                "mData": "alertName",
                "className": 'col-min-150 col-max-300 cell-break',
                "mRender": function (data, type, row) {
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement += row.alertName;
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + row.alertName + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement
                },
                "visible": true
            }]);
        }
        aoColumns.push.apply(aoColumns, [
            {
                "mData": "caseNumber",
                'className': 'col-min-75',
                "mRender": function (data, type, row) {
                    var isFaers = $("#isFaers").val();
                    var linkPre = '<a target="_blank" class="scaCaseNumber" href="' + (caseDetailUrl + '?' +
                        signal.utils.composeParams({
                            caseNumber: row.caseNumber,
                            version: row.caseVersion,
                            followUpNumber: null,
                            alertId: row.id,
                            isFaers: isFaers
                        })) + '">';

                    var caseNum = "<span data-field ='caseNumber' data-id='" + row.caseNumber + "'>" +
                        (row.caseNumber) + "</span><span data-field ='caseVersion' data-id='" + row.caseVersion +
                        "'></span><span data-field ='execConfigId' data-id='" + row.execConfigId + "'><span data-field ='alertId' data-id='" + row.id + "'></span>";
                    var linkSuf = "(<span data-field ='followUpNumber' data-id='" + row.followUpNumber + "'>" +
                        ((row.followUpNumber < 1) ? 0 : row.followUpNumber) + "</span>)";
                    if (isFaers != "true") {
                        return linkPre + caseNum + linkSuf + "</a>";
                    }
                    else {
                        return linkPre + caseNum + "</a>";
                    }
                },
                "data-type": "caseNumber",
                "visible": true
            },
            {
                "mData": "alertTags",
                "mRender": function (data, type, row) {
                    var tagsElement = signal.alerts_utils.get_tags_element(row.alertTags);
                    return tagsElement
                },
                "className": 'col-max-300 pos-rel',
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('alertTags')
            },
            {
                "mData": "caseInitReceiptDate",
                "mRender": function (data, type, full) {
                    return (data != undefined) ? moment.utc(data).format(DEFAULT_DATE_FORMAT) : '';
                },
                "className": 'col-min-100',
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('caseInitReceiptDate')
            },
            {
                "mData": "productName",
                "className": 'col-min-100 col-max-200 cell-break',
                "mRender": function (data, type, row) {
                    return "<span data-field ='productName' data-id='" + row.productName + "'>" +
                        row.productName + "</span>";
                },
                "visible": signal.fieldManagement.visibleColumns('productName')
            },
            {
                "mData": "pt",
                "className": 'col-min-75',
                "mRender": function (data, type, row) {
                    return '<span data-field="masterPrefTermAll" data-id="' + row.pt + '">' + row.pt + '</span>'
                },
                "visible": signal.fieldManagement.visibleColumns('pt')
            },
            {
                "mData": "listedness",
                "className": '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.listedness + '</span>'
                },
                "visible": signal.fieldManagement.visibleColumns('listedness')
            }, {
                "mData": "outcome",
                "className": '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.outcome + '</span>'
                },
                "visible": signal.fieldManagement.visibleColumns('outcome')
            },
            {
                "mData": 'signalsAndTopics',
                "mRender": function (data, type, row) {
                    var signalAndTopics = '';
                    $.each(row.signalsAndTopics, function (i, obj) {
                        var url = signalDetailUrl + '?id=' + obj['signalId'];
                        if($('#hasSignalManagementAccess').val() == 'true') {
                            signalAndTopics = signalAndTopics + '<span class="click"><a class="cell-break" href="' + url + '">' + escapeHTML(obj['name']) + '</a></span>&nbsp;'
                        }else {
                            signalAndTopics = signalAndTopics + '<span class="click signalSummaryAuth"><a class="cell-break" href="javascript:void(0)">' + escapeHTML(obj['name']) + '</a></span>&nbsp;'
                        }
                        signalAndTopics = signalAndTopics + ","
                    });
                    if (signalAndTopics.length > 1)
                        return '<div>' + signalAndTopics.substring(0, signalAndTopics.length - 1) + '</div>';
                    else
                        return '-';

                },
                "className": 'col-min-150 col-max-200 signalInformation',
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('signalsAndTopics')
            }]);
        if ($("#isFaers").val() != "true") {
            aoColumns.push.apply(aoColumns, [
                {
                    "mData": "currentDisposition",
                    "mRender": function (data, type, row) {
                        return signal.utils.render('disposition', {
                            allowedDisposition: dispositionIncomingOutgoingMap[row.disposition],
                            currentDisposition: row.disposition,
                            forceJustification: forceJustification,
                            isReviewed: row.isReviewed,
                            isValidationStateAchieved: row.isValidationStateAchieved
                        });
                    },
                    "visible": signal.fieldManagement.visibleColumns('currentDisposition'),
                    "class": 'col-max-250 dispositionAction'
                }]);
        }
        aoColumns.push.apply(aoColumns, [{
            "mData": "disposition",
            "mRender": function (data, type, row) {
                return row.disposition
            },
            "className": 'col-max-250 currentDisposition',
            "visible": signal.fieldManagement.visibleColumns('disposition')
        }]);
        if ($("#isFaers").val() != "true") {
            aoColumns.push.apply(aoColumns, [
                {
                    "mData": "assignedToUser",
                    "mRender": function (data, type, row) {
                        return signal.list_utils.assigned_to_comp(row.id, row.assignedToUser)
                    },
                    "className": 'col-min-100 col-max-150 assignedTo',
                    "orderable": false,
                    "visible": signal.fieldManagement.visibleColumns('assignedToUser')
                },
                {
                    "mData": "dueDate",
                    'className': 'dueIn col-min-50',
                    "mRender": function (data, type, row) {
                        return signal.list_utils.due_in_comp(row.dueIn)
                    },
                    "visible": signal.fieldManagement.visibleColumns('dueDate')
                }]);
        }

        aoColumns.push.apply(aoColumns, [
            {
                "mData": "suspProd",
                'className': 'col-min-150 col-max-200 cell-break',
                "mRender": function (data, type, row) {
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement += row.suspProd;
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + row.suspProd + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('suspProd')
            },
            {
                "mData": "conComit",
                'className': 'col-min-100 col-max-200',
                "mRender": function (data, type, row) {
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement += removeLineBreak(row.conComit);
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + removeLineBreak(row.conComit) + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement
                },
                "visible": signal.fieldManagement.visibleColumns('conComit')
            },

            {
                "mData": "masterPrefTermAll",
                'className': 'col-min-100 col-max-200',
                "mRender": function (data, type, row) {
                    var ptList = '';
                    if (row.masterPrefTermAll) {
                        ptList = row.masterPrefTermAll.split('!@##@!').join(' ');
                        ptList = ptList.split('!@.@!').join(') ');
                    }
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement += ptList;
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + ptList + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('masterPrefTermAll')
            },
            {
                "mData": "serious",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.serious + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('serious')
            },
            {
                "mData": "caseReportType",
                "className": '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.caseReportType + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('caseReportType')
            },
            {
                "mData": "reportersHcpFlag",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.reportersHcpFlag + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('reportersHcpFlag')
            },
            {
                "mData": "country",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.country + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('country')
            },
            {
                "mData": "age",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.age + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('age')
            },
            {
                "mData": "gender",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.gender + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('gender')
            },
            {
                "mData": "rechallenge",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.rechallenge + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('rechallenge')
            },
            {
                "mData": "lockedDate",
                'className': 'col-min-100',
                "mRender": function (data, type, row) {
                    return (data && data != undefined ) ? moment.utc(data).format(DEFAULT_DATE_FORMAT) : '';
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('lockedDate')
            },
            {
                "mData": "death",
                'className': '',
                "mRender": function (data, type, row) {
                    return '<span>' + row.death + '</span>'
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('death')
            },
            {
                "mData": "medErrorsPt",
                'className': 'col-min-100 col-max-200 cell-break',
                "mRender": function (data, type, row) {
                    var colElement = '<div class="col-container"><div class="col-height">';
                    colElement += row.medErrorsPt;
                    colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + row.medErrorsPt + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                    colElement += '</div></div>';
                    return colElement
                },
                "orderable": false,
                "visible": signal.fieldManagement.visibleColumns('medErrorsPt')
            },
            {
                "mData": "patientAge",
                'className': 'col-min-100',
                "mRender": function (data, type, row) {
                    return'<span>'+row.patientAge+'</span>'
                },
                "visible": signal.fieldManagement.visibleColumns('patientAge')
            }]);

        if (customFieldsEnabled) {
            aoColumns.push.apply(aoColumns, [
                {
                    "mData": "caseType",
                    'className': '',
                    "mRender": function (data, type, row) {
                        return '<span>' + row.caseType + '</span>'
                    },
                    "visible": signal.fieldManagement.visibleColumns('caseType')
                },
                {
                    "mData": "completenessScore",
                    'className': '',
                    "mRender": function (data, type, row) {
                        return '<span>' + row.completenessScore + '</span>'
                    },
                    "visible": signal.fieldManagement.visibleColumns('completenessScore')
                },
                {
                    "mData": "indNumber",
                    'className': '',
                    "mRender": function (data, type, row) {
                        return '<span>' + row.indNumber + '</span>'
                    },
                    "visible": signal.fieldManagement.visibleColumns('indNumber')
                },
                {
                    "mData": "appTypeAndNum",
                    'className': '',
                    "mRender": function (data, type, row) {
                        return '<span>' + row.appTypeAndNum + '</span>'
                    },
                    "visible": signal.fieldManagement.visibleColumns('appTypeAndNum')
                },
                {
                    "mData": "compoundingFlag",
                    'className': 'col-min-100 col-max-200',
                    "mRender": function (data, type, row) {
                        var colElement = '<div class="col-container"><div class="col-height">';
                        colElement += row.compoundingFlag;
                        colElement += '<a tabindex="0" title="' + $.i18n._('appLabel.viewAll') + '" class="ico-dots view-all" more-data="' + row.compoundingFlag + '"><i class="mdi mdi-dots-horizontal font-20 blue-1"> </i></a>';
                        colElement += '</div></div>';
                        return colElement
                    },
                    "visible": signal.fieldManagement.visibleColumns('compoundingFlag')
                },
                {
                    "mData": "submitter",
                    'className': '',
                    "mRender": function (data, type, row) {
                        return '<span>' + row.submitter + '</span>'
                    },
                    "visible": signal.fieldManagement.visibleColumns('submitter')
                }
            ])
        }
        if (callingScreen == CALLING_SCREEN.TRIGGERED_ALERTS) {
            aoColumns.splice(4, 0, {
                "mData": "name",
                "mRender": function (data, type, row) {
                    return '<span>' + row.alertName + '</span>'
                },
                "visible": true
            });
        }
        return aoColumns
    };

    var createAlertListUrl = function (isFilterRequest, filterValues) {
        var listUrl = listConfigUrl + '&isFilterRequest=' + isFilterRequest + '&filters=' + JSON.stringify(filterValues);
        if ($('#isFaers').val()) {
            listUrl += '&isFaers=' + $('#isFaers').val()
        }
        return listUrl
    };

    var showAllSelectedCaseNumbers = function () {
        $('#copyCaseNumberModel').modal({
            show: true
        });

        var numbers = _.map($('input.copy-select:checked').parent().parent().find('td:nth-child(5)'), function (it) {
            return $(it).text()
        });
        $("#caseNumbers").text(numbers);
    };

    var initUpdateAssignedTo = function () {

        $("#updateAssignedToBtn").on('click', function () {
            $.ajax({
                type: "POST",
                url: $("#change-user-url").val(),
                data: {
                    alertId: $("#assignedToModal #alertId").val(),
                    assignedTo: $("#_assignedTo").find("option:selected").val()
                }
            }).success(function (data) {
                $("#assignedToModal").find('.form-control').val("")
                $("#assignedToModal").modal('hide')
                alertDetailsTable.ajax.reload()
            }).error(function () {
            })
        });
    };

    var init_add_case_modal = function () {
        addCaseModalObj = $('#addCaseModal');
        addCaseModalObj.find('input:text').val('');
        addCaseModalObj.find('#justification').val("");
        addCaseModalObj.find('#importCasesExcel').prop('checked', false);
        addCaseModalObj.find('#importCasesSection').attr('hidden', 'hidden');
        addCaseModalObj.find('#caseNumber').prop('disabled', false).siblings('label').find('span').show()
        addCaseModalObj.find('#justificationListPriority').val('');
        addCaseModalObj.find('#addCaseButton').prop('disabled', false);
        addCaseModalObj.modal('show');

        addCaseModalObj.find('#importCasesExcel').on('click', function () {
            if (addCaseModalObj.find('#importCasesExcel').is(':checked')) {
                addCaseModalObj.find('#importCasesSection').removeAttr('hidden');
                addCaseModalObj.find('#versionNumber, #caseNumber').val('').attr('disabled', 'disabled').siblings('label').find('span').hide();
                $('.add-case-to-list').attr('disabled', 'disabled');
            } else {
                addCaseModalObj.find('#importCasesSection').attr('hidden', 'hidden');
                addCaseModalObj.find(':file').val('').parents('.input-group').find(':text').val('');
                addCaseModalObj.find('#versionNumber, #caseNumber').removeAttr('disabled').siblings('label').find('span').show();
                $('.add-case-to-list').removeAttr('disabled');
            }
        });


        $(document).on('change', '#justificationListPriority', function () {
            var value = $(this).val();
            if (value != "") {
                var text = justificationObj.filter(function (arr) {
                    return arr.id == value
                })[0].text;
                addCaseModalObj.find('#justification').val(text);
            } else {
                addCaseModalObj.find('#justification').val('');
            }
        });


        addCaseModalObj.on('change', ':file', function () {
            var input = $(this);
            var numFiles = input.get(0).files ? input.get(0).files.length : 0;
            var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            var validExts = new Array(".xlsx", ".xls");
            var fileExt = label.substring(label.lastIndexOf('.'));
            if (numFiles > 0) {
                if (validExts.indexOf(fileExt.toLowerCase()) < 0) {
                    $('#fileFormatError').show();
                    $('.add-case-to-list').attr('disabled', 'disabled');
                } else {
                    $('#fileFormatError').hide();
                    $('.add-case-to-list').removeAttr('disabled');
                }
            } else {
                $('#fileFormatError').hide();
            }
            input.trigger('fileselect', [numFiles, label]);
        });

        addCaseModalObj.find(':file').on('fileselect', function (event, numFiles, label) {
            var input = $(this).parents('.input-group').find(':text');
            var log = numFiles > 0 ? label : "";

            if (input.length) {
                input.val(log);
            }
        });
    };

    var add_case_to_list = function () {
        addCaseModalObj.find('#addCaseButton').attr('disabled', 'disabled');
        var formData = new FormData(addCaseModalObj.find('#addNewCase')[0]);
        if (addCaseModalObj.find(':file').val()) {
            formData.append("file", $('#file_input').get(0).files[0]);
        }
        $.ajax({
            url: "/signal/singleCaseAlert/addCaseToSingleCaseAlert",
            type: 'POST',
            data: formData,
            mimeType: "multipart/form-data",
            contentType: false,
            cache: false,
            processData: false,
            success: function (data) {
                if (!JSON.parse(data).success) {
                    addCaseModalObj.find('#addCaseButton').removeAttr('disabled');
                    addCaseModalObj.find('.alert-danger').removeClass('hide');
                    addCaseModalObj.find('.errorMessageSpan').html(JSON.parse(data).message);
                    setTimeout(function () {
                        addCaseModalObj.find('.alert-danger').addClass('hide');
                    }, 5000)
                } else {
                    addCaseModalObj.find('#addCaseButton').removeAttr('disabled');
                    addCaseModalObj.find('#importCasesSection').attr('hidden', 'hidden');
                    addCaseModalObj.find(':file').val('').parents('.input-group').find(':text').val('');
                    addCaseModalObj.find('#versionNumber, #caseNumber').removeAttr('disabled').siblings('label').find('span').show();
                    addCaseModalObj.modal('hide');
                    reloadData("", true);
                    showSuccessNotification(JSON.parse(data).message);
                }
            }
        });
    };

    function showSuccessNotification(message) {
        $(".alert-success").alert('close');
        if (message != undefined && message != "")
            $('#detailsTab').prepend(
                '<div class="alert alert-success alert-dismissable">' +
                '<button type="button" class="close" ' +
                'data-dismiss="alert" aria-hidden="true">' +
                '&times;' +
                '</button>' +
                message +
                '</div>'
            );
    }


    var reloadData = function (rowId, resetPagination) {
        if (resetPagination != true) {
            resetPagination = false
        }
        var dataTable = $("#alertsDetailsTable").DataTable();
        dataTable.ajax.reload(function () {
            highlightRow(rowId, dataTable);
        }, resetPagination);
    };

    var highlightRow = function (rowId, dataTable) {
        if (rowId != undefined && rowId != "") {
            dataTable.row('#' + rowId).nodes()
                .to$()
                .addClass('flash-row');
        }
    };


    var init = function () {
        signal.fieldManagement.populateColumnList(gridColumnsViewUrl, gridColumnsViewUpdateUrl);
        alertDetailsTable = initAlertDetailsTable();

        $('i#copySelection').click(function () {
            showAllSelectedCaseNumbers()
        });

        $(document).on('click', 'input#select-all', function () {
            $(".copy-select").prop('checked', this.checked);
        });

        initUpdateAssignedTo()

    };

    init();

    $('#exportTypes a[href]').click(function (e) {
        var clickedURL = e.currentTarget.href;
        var updatedExportUrl = clickedURL;
        var ids = [];
        $('.alert-check-box').each(function () {
            if ($(this)[0]['checked']) {
                ids.push($(this).attr('data-id'))
            }
        });

        var checkedColumns = {};
        $('#tableColumns tr ').each(function () {
            var fieldName = $(this).children().children().attr('data-field');
            if (fieldName) {
                checkedColumns[fieldName] = $(this).children()[1].firstChild.checked
            }
        });


        if (ids.length > 0) {
            updatedExportUrl = clickedURL + "&selectedCases=" + ids + "&viewId=" + viewId;
        }
        else {

            var prefix = "sca_";
            var isFilterRequest = true;
            var filterValues = [];
            if (window.sessionStorage) {
                if (signal.alertReview.isAlertPersistedInSessionStorage(prefix)) {
                    filterValues = JSON.parse(sessionStorage.getItem(prefix + "filters_value"));
                } else {
                    signal.alertReview.removeFiltersFromSessionStorage(prefix);
                    isFilterRequest = false;
                }
            }

            var filterList = {};
            $(".yadcf-filter-wrapper").each(function () {
                var filterVal = $(this).children().val();
                if (filterVal) {
                    filterList[$(this).prev().attr('data-field')] = filterVal
                }
            });
            var filterListJson = JSON.stringify(filterList);
            updatedExportUrl = clickedURL + '&isFilterRequest=' + isFilterRequest + '&filters=' + JSON.stringify(filterValues) + "&viewId=" + viewId + "&filterList=" + encodeURI(filterListJson) + "&isFaers=" + $('#isFaers').val();
            if ($('#advanced-filter').val()) {
                updatedExportUrl += "&advancedFilterId=" + $('#advanced-filter').val()
            }

        }
        window.location.href = updatedExportUrl;
        return false
    });

    $(".exportCaseHistory").click(function (e) {
        var caseHistoryModal = $('#caseHistoryModal');
        var caseVal = caseHistoryModal.find("#caseNumber").html();
        var productFamily = caseHistoryModal.find("#productFamily").html();
        var alertConfigId = caseHistoryModal.find("#alertConfigId").val();
        var caseVersion = caseHistoryModal.find("#caseVersion").val();
        var selectedCase = e.currentTarget.href + "&caseNumber=" + caseVal + "&productFamily=" + productFamily + "&alertConfigId=" + alertConfigId + "&caseVersion=" + caseVersion;
        window.location.href = selectedCase;
        return false
    });

    $("#alertsDetailsTable_filter").hide();


    $('.saveCases').on('click', function () {
        $("#showConfigNameModal").modal('show');
        $("#save-cases-btn").on('click', function () {
            $('#save-cases-btn, #cancel-btn').attr("disabled", "disabled");
            var saveScaCasesUrl = saveCasesUrl + "&configName=" + $('#configName').val();
            $.ajax({
                url: saveScaCasesUrl,
                success: function (result) {
                    if (result.success) {
                        $('#alertMessage').show();
                        setTimeout(function () {
                            $('#save-cases-btn, #cancel-btn').removeAttr("disabled");
                            $('#configName').val('');
                            $('#showConfigNameModal').modal('hide');
                        }, 2000);
                        location.reload()
                    } else {
                        $('#errorMessage').show();
                        setTimeout(function () {
                            $('#save-cases-btn, #cancel-btn').removeAttr("disabled");
                            $('#configName').val('');
                            $('#errorMessage').hide();
                        }, 1000);

                    }
                }
            })
        })
    });

    $(document).on('click', '#detailed-view-checkbox', function () {
        var $this = $(this);
        var reloadUrl = $this.data('url') + '?callingScreen=' + $this.data('callingScreen') + '&configId=' + $this.data('configId') + "&viewId=" + viewId + '&isCaseDetailView=' + $this.data('isCaseDetailView');
        if ($("#isFaers").val()) {
            reloadUrl += '&isFaers=' + $("#isFaers").val();
        }
        window.location.href = reloadUrl

    });

    $(document).on('click', '.scaCaseNumber', function (e) {
        e.preventDefault();
        var scaAlertId = $(this).find("span[data-field=alertId]").attr("data-id");
        var caseVersion = $(this).find("span[data-field=caseVersion]").attr("data-id");
        var caseNumber = $(this).find("span[data-field=caseNumber]").attr("data-id");
        var execConfigId = $(this).find("span[data-field=execConfigId]").attr("data-id");
        $.ajax({
            url: updateAutoRouteDispositionUrl,
            data: {'id': scaAlertId},
            success: function (result) {
                if (result.status) {
                    alertDetailsTable.ajax.reload();
                }
                signal.utils.postUrl(caseDetailUrl, {
                    caseNumber: caseNumber,
                    version: caseVersion,
                    followUpNumber: null,
                    alertId: scaAlertId,
                    isFaers: $("#isFaers").val(),
                    fullCaseList: $("#fullCaseList").val(),
                    execConfigId : execConfigId,
                    totalCount : table.page.info().recordsTotal,
                    detailsParameters: JSON.stringify(detailsParameters)
                }, true);
            },
            error: function () {
                console.error("Some error occured while updating AutoRoute Disposition");
            }
        });
    });

    registerUnselectEventForCaseSeriesTag();
    registerUnselectEventForGlobalTag();
    registerSelectEventForCaseSeriesTag();
    registerSelectEventForGlobalTag();
    $('#alertTagModal').on('shown.bs.modal', function () {
        tagsObj.addedCaseSeriesTags = [];
        tagsObj.addedGlobalTags = [];
        tagsObj.deletedCaseSeriesTags = [];
        tagsObj.deletedGlobalTags = [];
    })
});

var format = function (d, className) {
    var productList = d.productList;
    var productArray = productList.split(',');
    var ptArray = d.ptList.split('!@##@!');
    for (var i = 0; i < productArray.length; i++) {
        if (productArray[i] == d.productName) {
            productArray[i] = productArray[i] + " (Primary)"
        }
    }
    var resultedObj = {
        productList: productArray.join(','),
        ptList: ptArray,
        caseNarrative: d.caseNarrative,
        conMeds: removeLineBreak(d.conMeds),
        medErrorsPt : d.medErrorsPt
    };
    html = signal.utils.render("case_details_child_view", resultedObj);
    return html;
};

function showCaseDetailsView() {
    $("tr.data-table-row").each(function (index) {
        var tr = $(this);
        var row = window.sca_data_table.row(tr);
        var className = $(this).hasClass('odd') ? 'odd' : 'even';
        row.child(format(row.data()), className).show();
    });
}

function registerUnselectEventForCaseSeriesTag() {
    $(document).on("select2:unselect", '#singleAlertTags', function (e) {
        var tag = e.params.data.text;
        if (!tagsObj.deletedCaseSeriesTags.includes(tag)) {
            tagsObj.deletedCaseSeriesTags.push(tag);
            tagsObj.addedCaseSeriesTags = tagsObj.addedCaseSeriesTags.remove(tag);
        }
    });
}

function registerUnselectEventForGlobalTag() {
    $(document).on("select2:unselect", '#globalTags', function (e) {
        var tag = e.params.data.text;
        if (!tagsObj.deletedGlobalTags.includes(tag)) {
            tagsObj.deletedGlobalTags.push(tag);
            tagsObj.addedGlobalTags = tagsObj.addedGlobalTags.remove(tag);
        }
    });
}

function registerSelectEventForCaseSeriesTag() {
    $(document).on("select2:selecting", '#singleAlertTags', function (e) {
        var tag = e.params.args.data.id;
        if (!tagsObj.addedCaseSeriesTags.includes(tag)) {
            tagsObj.addedCaseSeriesTags.push(tag);
            tagsObj.deletedCaseSeriesTags = tagsObj.deletedCaseSeriesTags.remove(tag);
        }
    });
}

function registerSelectEventForGlobalTag() {
    $(document).on("select2:selecting", '#globalTags', function (e) {
        var tag = e.params.args.data.id;
        if (!tagsObj.addedGlobalTags.includes(tag)) {
            tagsObj.addedGlobalTags.push(tag);
            tagsObj.deletedGlobalTags = tagsObj.deletedGlobalTags.remove(tag);
        }
    });
}

$(document).on('click', '.signalSummaryAuth', function (evt) {
    $.Notification.notify('warning','top right', "Warning", "You don't have access to view signal summary", {autoHideDelay: 2000});
});

var fetchTags = function () {
    $.ajax({
        url: fetchCommonTagsUrl,
        async:false,
        success: function (result) {
            result.commonTagList.forEach(function(map){
                tags.push({
                    id: map.id,
                    text: map.text,
                    parentId: map.parentId
                });
            });
        }
    });
};

