var selectedDisposition,selectedSignal;
$(document).ready(function(){$("#dispositionJustificationPopover a.selectJustification").hover(function(){var a=$(this).attr("data-title");$("<div/>",{text:a,class:"box"}).appendTo(this);$(".tooltip").not(this).hide()},function(){$(document).find("div.box").remove();$(".tooltip").not(this).show()});$("#dispositionJustificationPopover a.addNewJustification").hover(function(){var a=$(this).attr("data-title");$("<div/>",{text:a,class:"box"}).appendTo(this);$(".tooltip").not(this).hide()},function(){$(document).find("div.box").remove();
$(".tooltip").not(this).show()});$("#dispositionJustificationPopover #edit-box").hide();$("#dispositionSignalPopover #new-signal-box").hide();$(document).on("click",".changeDisposition",setDispositionTriggerButton);$(document).on("click",".selectSignal",setSignalSelectTriggerButton);$("#dispositionJustificationPopover").on("hide.bs.modal",function(){selectedSignal=void 0;$("#dispositionJustificationPopover").removeClass("level2");clearAndHideNewSignalBox();clearAndHideDispositionJustificationEditBox()});
$("#dispositionSignalPopover").on("hide.bs.modal",function(){selectedSignal=selectedDisposition=void 0;clearAndHideNewSignalBox();clearAndHideDispositionJustificationEditBox()});$("#dispositionJustificationPopover").on("shown.bs.modal",function(){$("#dispositionJustificationPopover .popover-content").scrollTop(0);var a=$(this).css("left").replace("px","");375>$(".panel-heading").width()-a?($(this).css("left",a-225),$("#dispositionJustificationPopover .arrow").css("left","95%")):$("#dispositionJustificationPopover .arrow").css("left",
"50%");$("a:visible:first",this).focus()});$("#dispositionSignalPopover").on("shown.bs.modal",function(){$("#dispositionJustificationPopover").hide();$("#dispositionSignalPopover .popover-content").scrollTop(0);var a=$(this).css("left").replace("px","");175>$(".panel-heading").width()-a?($(this).css("left",a-135),$("#dispositionSignalPopover .arrow").css("left","95%")):$("#dispositionSignalPopover .arrow").css("left","50%");$("a:visible:first",this).focus()});$("#dispositionJustificationPopover .selectJustification").unbind("click").click(function(a){a.preventDefault();
1==a.which&&(initChangeDisposition($(this).html()),dispositionEditPadding())});$("#dispositionJustificationPopover #addNewJustification, #dispositionJustificationPopover .editIcon").on("click",function(a){$(a.target).hasClass("editIcon")&&($("#dispositionJustificationPopover .editedJustification").val($(this).parent().siblings(".selectJustification").html()),dispositionEditPadding());$("#dispositionJustificationPopover #addNewJustification").hide();$("#dispositionJustificationPopover #edit-box").show();
dispositionEditPadding()});$("#dispositionSignalPopover #addNewSignal").on("click",function(){$("#dispositionJustificationPopover").modalPopover("hide");$("#dispositionSignalPopover #new-signal-box").show();$("#newSignalName").focus();$("#dispositionSignalPopover #addNewSignal").hide()});$("#dispositionJustificationPopover #cancelJustification").on("click",function(){clearAndHideDispositionJustificationEditBox()});$("#dispositionSignalPopover #cancelSignal").on("click",function(){$("#dispositionJustificationPopover").modalPopover("hide");
clearAndHideNewSignalBox()});$("#dispositionSignalPopover #createSignal").on("click",function(){var a=$("#dispositionSignalPopover #newSignalName").val();a&&("undefined"!==typeof availableSignalNameList&&-1!==$.inArray(a,availableSignalNameList)?$.Notification.notify("error","top right","Failed",$.i18n._("signalExistsError"),{autoHideDelay:1E4}):255<=a.length?$.Notification.notify("error","top right","Failed",$.i18n._("signalMaxSizeExceedError"),{autoHideDelay:1E4}):$("#dispositionSignalPopover #newSignalJustification").click())});
$("#dispositionJustificationPopover #confirmJustification").on("click",function(){initChangeDisposition($("#dispositionJustificationPopover .editedJustification").val())})});
var clearAndHideDispositionJustificationEditBox=function(){$("#dispositionJustificationPopover #edit-box").hide();$("#dispositionJustificationPopover .editedJustification").val("");$("#dispositionJustificationPopover #addNewJustification").show();dispositionEditPadding()},clearAndHideNewSignalBox=function(){$("#dispositionSignalPopover #new-signal-box").hide();$("#dispositionSignalPopover #newSignalName").val("");showHideAddNewSignal()},setDispositionTriggerButton=function(a){selectedDisposition=
$(a.target);a=$(selectedDisposition).parent().data("validated-confirmed");forceJustification||a?setDispositionPopOverTitle():initChangeDisposition()},setDispositionPopOverTitle=function(){showHideAddNewSignal();var a=$(selectedDisposition).closest("ul").data("current-disposition"),b=$(selectedDisposition).parent().attr("title"),a="undefined"===typeof a?"Alert Disposition Change to "+b:"Change "+a+" to "+b;$("#dispositionJustificationPopover .popover-title").html(a);$("#dispositionJustificationPopover").removeClass("left")},
setSignalSelectTriggerButton=function(a){selectedSignal=$(a.target);$("#dispositionJustificationPopover").addClass("level2").removeClass("bottom");forceJustification?"newSignalJustification"!==$(selectedSignal).attr("id")&&clearAndHideNewSignalBox():initChangeDisposition()},initChangeDisposition=function(a){if($(selectedDisposition).parent().data("bulk-disp-update"))bindAlertLevelDisposition(a);else if($(selectedDisposition).parent().data("auth-required"))initiateAuthFlow(a);else{var b,d;$("#detailed-view-checkbox").is(":checked")?
(d=$("table#alertsDetailsTable .copy-select:checked").length,b="table#alertsDetailsTable tbody.detailsTableBody"):(d=$("table.DTFC_Cloned .copy-select:checked").length,b="table.DTFC_Cloned tbody");var c=$(selectedDisposition).closest("tr").index();1<d&&$(b+" > tr:nth("+c+") .copy-select").prop("checked")?dispositionBulkUpdate(d,a):(isAbstractViewOrCaseView(c)&&(c/=2),b=populateDispositionChangeData(c,!1),changeDisposition(a,b,!1))}},bindAlertLevelDisposition=function(a){a={justificationText:a,"targetDisposition.id":$(selectedDisposition).parent().data("disposition-id")};
applicationLabel===ALERT_CONFIG_TYPE.EVDAS_ALERT&&(a["config.id"]=configId);applicationLabel!==ALERT_CONFIG_TYPE.LITERATURE_SEARCH_ALERT&&(a["execConfig.id"]=executedConfigId);var b=[];$.ajax({type:"POST",url:changeAlertLevelDispositionUrl,data:a,beforeSend:function(){$("#bulkDispositionPopover").modalPopover("hide");$("#dispositionJustificationPopover").modalPopover("hide");$("table#alertsDetailsTable td.dispositionAction").each(function(){$(this).find("ul").data("is-reviewed")||(b.push($(this)),
$(this).html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>"))})},success:function(a){if(a.status){var c=$(selectedDisposition).parent(),e=signal.utils.render("disposition",{allowedDisposition:dispositionIncomingOutgoingMap[$(c).attr("title")],currentDisposition:$(c).attr("title"),forceJustification:forceJustification,isReviewed:!1,isValidationStateAchieved:$(c).data("validated-confirmed")});b.forEach(function(a){$(a).html(e);$(a).parent().find("td.currentDisposition").html($(c).attr("title"))});
$(".dataTable-top-disposition :input").each(function(){$(this).data("closed")||($(this).next().remove(),$(this).remove())});changeDispositionFilters(c);table.columns.adjust().fixedColumns().relayout();$.Notification.notify("success","top right","Success",a.message,{autoHideDelay:2E4})}else $.Notification.notify("error","top right","Error",a.message,{autoHideDelay:2E4}),table.ajax.reload()}})},changeDisposition=function(a,b,d){forceJustification&&(b.justification=a);$(selectedDisposition).parent().data("validated-confirmed")&&
selectedSignal&&("newSignalJustification"===$(selectedSignal).attr("id")?(b.validatedSignalName=$("#dispositionSignalPopover #newSignalName").val(),availableSignalNameList.push($("#newSignalName").val()),addNewSignal='<li> <a tabindex="0" data-target="#dispositionJustificationPopover" role="button" class="selectSignal text" data-toggle="modal-popover" data-placement="left" title="'+$("#newSignalName").val()+'"> '+$("#newSignalName").val()+"</a></li>",$("#signal-list").prepend(addNewSignal)):b.validatedSignalName=
$(selectedSignal).html().trim(),a=$(selectedDisposition).closest("tr"),b.productJson=JSON.stringify(getProductJson(applicationName,a)),b.productJson||(b.productJson=JSON.stringify(getProductJson())));b["targetDisposition.id"]=$(selectedDisposition).parent().data("disposition-id");b["targetDisposition.id"]||(b["targetDisposition.id"]=$(selectedDisposition).data("disposition-id"));b.incomingDisposition=$(selectedDisposition).closest("ul").data("current-disposition");var c=$(selectedDisposition).closest("td"),
e=$(selectedDisposition),h;$.ajax({url:changeDispositionUrl,type:"POST",data:b,dataType:"json",beforeSend:function(){$(c).is("td")||(c=e.closest("span.disposition"));h=$(c).html();if(d){$("#dispositionJustificationPopover").modalPopover("hide");$("#dispositionSignalPopover").modalPopover("hide");var a;a=$("#detailed-view-checkbox").is(":checked")?"table#alertsDetailsTable .copy-select:checked":"table.DTFC_Cloned .copy-select:checked";$.each($(a),function(){$("table#alertsDetailsTable tr:nth-child("+
($(this).closest("tr").index()+1)+") td.dispositionAction").html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")})}else $(c).html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")},success:function(a){if(a.status){var k=new Set;d&&$.each($("table.DTFC_Cloned .copy-select:checked"),function(){k.add($(this).closest("tr").index())});k.size||-1<$(c).closest("tr").index()&&k.add($(c).closest("tr").index());var f=e.parent(),g=!1;"undefined"!=typeof reviewCompletedDispostionList&&
-1<$.inArray($(f).attr("title"),reviewCompletedDispostionList)&&(g=!0);var q=signal.utils.render("disposition",{allowedDisposition:dispositionIncomingOutgoingMap[$(f).attr("title")],currentDisposition:$(f).attr("title"),forceJustification:forceJustification,isReviewed:g,isValidationStateAchieved:$(f).data("validated-confirmed")});1==$(f).data("disposition-closed")&&$(c).closest("tr").find("td.dueIn").html("-");k.size&&!$("#signalIdPartner").val()?k.forEach(function(a){var b=$("table#alertsDetailsTable tbody tr:nth-child("+
(a+1)+")");applicationLabel===ALERT_CONFIG_TYPE.STATISTICAL_COMPARISON&&(b=$("table#statsTable tbody tr:nth-child("+(a+1)+")"));b.find("td.currentDisposition").html($(f).attr("title"));b.find("td.dispositionAction").html(q)}):($(c).html(q),$(c).is("span.disposition")?$(c).closest("div").siblings("div.currentDisposition").find("h5").html($(f).attr("title")):$(c).siblings("td.currentDisposition").html($(f).attr("title")));var n=e.parent().attr("title");if(n&&0>=$('.dataTable-top-disposition :input[value="'+
n+'"]').size()){var p=[],l=[];$(".dynamic-filters").each(function(a){$(this).is(":checked")&&l.push($(this).val());p.push($(this).is(":checked"))});"true"==e.parent().attr("data-disposition-closed")||"true"==e.parent().attr("data-is-reviewed")?(g=!0,p.push(!1)):(g=!1,p.push(!0),l.push(n));var m="";applicationName===ALERT_CONFIG_TYPE.SINGLE_CASE_ALERT?m=ALERTS_PREFIX.SCA:applicationName===ALERT_CONFIG_TYPE.AGGREGATE_CASE_ALERT?m=ALERTS_PREFIX.AGG:applicationName===ALERT_CONFIG_TYPE.EVDAS_ALERT&&(m=
ALERTS_PREFIX.EV);sessionStorage.setItem(m+"filters_store",JSON.stringify(p));sessionStorage.setItem(m+"filters_value",JSON.stringify(l));g=fetchDynamicDispositionFilterHtml(n,g);$(".dataTable-top-disposition").append($(g));applicationName==ALERT_CONFIG_TYPE.LITERATURE_SEARCH_ALERT?url=listConfigUrl+"?filters="+l.join(","):"undefined"!==typeof listConfigUrl&&(url=listConfigUrl+"&isFilterRequest=true&filters="+JSON.stringify(l),table.ajax.url(url).load())}"undefined"!==typeof table&&(a.data&&"false"!==
a.data.attachedSignalData||$("table#alertsDetailsTable tbody tr:first td.currentDisposition").length)&&("Ad-Hoc Alert"===applicationName?(assignedToData=[],table.ajax.reload()):table.columns.adjust().draw(),$(".select-all-check input#select-all").prop("checked",!1));$("#dispositionJustificationPopover").modalPopover("hide");$("#dispositionSignalPopover").modalPopover("hide");a.data&&"false"!==a.data.attachedSignalData?("undefined"!==typeof availableSignalNameList&&-1===$.inArray(b.validatedSignalName,
availableSignalNameList)&&availableSignalNameList.push(b.validatedSignalName),$.Notification.notify("success","top right","Success","Added to signal successfully.",{autoHideDelay:1E4})):($.Notification.notify("success","top right","Success","Disposition changed successfully.",{autoHideDelay:1E4}),"undefined"!==typeof table&&"undefined"!==typeof table.ajax&&table.ajax.reload());applicationLabel==APPLICATION_LABEL.CASE_DETAIL&&$("#caseHistoryModalTable").DataTable().ajax.reload();applicationLabel==
APPLICATION_LABEL.EVENT_DETAIL&&($("#currentAlertHistoryModalTable").DataTable().ajax.reload(),$("#evdasHistoryModalTable").DataTable().ajax.reload());applicationLabel===ALERT_CONFIG_TYPE.SIGNAL_MANAGEMENT&&updateSignalHistory()}else c&&$(c).html(h),$("#dispositionJustificationPopover").modalPopover("hide"),$("#dispositionSignalPopover").modalPopover("hide"),$.Notification.notify("error","top right","Failed",a.message,{autoHideDelay:1E4})},error:function(){c&&$(c).html(h)}})},populateDispositionChangeData=
function(a,b){var d={},c=$("#signalIdPartner").val();if(b){var e=new Set,h=[];a=$("#detailed-view-checkbox").is(":checked")?"table#alertsDetailsTable .copy-select:checked":"table.DTFC_Cloned .copy-select:checked";$.each($(a),function(){var a=$(this).closest("tr").index();isAbstractViewOrCaseView(a)&&(a/=2);e.add(a)});e.forEach(function(a){h.push(populateDispositionDataFromGrid(a))});d.selectedRows=JSON.stringify(h)}else d.selectedRows=-1<a&&!c?JSON.stringify([populateDispositionDataFromGrid(a)]):
JSON.stringify([populateDispositionDataFromOther(c)]);return d},populateDispositionDataFromGrid=function(a){var b={};a=table.rows(a).data()[0];b["configObj.id"]=a.alertConfigId;b["executedConfigObj.id"]=a.execConfigId;b["alert.id"]=a.id;return b},populateDispositionDataFromOther=function(a){var b={};b["signal.id"]=a;b["configObj.id"]=$("#configId").html();b["executedConfigObj.id"]=$("#execConfigId").val();b["alert.id"]=$("#alertId").val();return b},fetchDynamicDispositionFilterHtml=function(a,b){return b?
'<div class="checkbox checkbox-primary checkbox-inline m-l-3 checkbox-pos-abs"><input id="filter'+$(".dynamic-filters").size()+'" type="checkbox" class="dynamic-filters" name="relatedResults" value="'+a+'" /> <label class="m-r-30" for="filter'+$(".dynamic-filters").size()+'">'+a+"</label></div>":'<div class="checkbox checkbox-primary checkbox-inline m-l-3 checkbox-pos-abs"><input id="filter'+$(".dynamic-filters").size()+'" type="checkbox" class="dynamic-filters" name="relatedResults" checked="checked" value="'+
a+'" /> <label class="m-r-30" for="filter'+$(".dynamic-filters").size()+'">'+a+"</label></div>"};function dispositionEditPadding(){var a=$(".popover.justification ul.text-list > li:last-child").height()+10+"px";$(".popover.justification ul.text-list").css("padding-bottom",a);$(".editedJustification").focus()}
function changeDispositionFilters(a){(a=$(a).attr("title"))&&0>=$('.dataTable-top-disposition :input[value="'+a+'"]').size()&&(a=fetchDynamicDispositionFilterHtml(a,!1),$(".dataTable-top-disposition").append($(a)));var b=[],d=[];$(".dynamic-filters").each(function(a){$(this).is(":checked")&&d.push($(this).val());b.push($(this).is(":checked"))});a="";applicationName===ALERT_CONFIG_TYPE.SINGLE_CASE_ALERT?a=ALERTS_PREFIX.SCA:applicationName===ALERT_CONFIG_TYPE.AGGREGATE_CASE_ALERT?a=ALERTS_PREFIX.AGG:
applicationName===ALERT_CONFIG_TYPE.EVDAS_ALERT&&(a=ALERTS_PREFIX.EV);sessionStorage.setItem(a+"filters_store",JSON.stringify(b));sessionStorage.setItem(a+"filters_value",JSON.stringify(d))}
var fetchNewlyAttachedSignalData=function(a){var b="";$.each(a,function(a,c){b=b+'<span class="click"><a href="'+(signalDetailUrl+"?id="+c.signalId)+'">'+c.name+"</a></span>&nbsp;";b+=","});return 1<b.length?"<div>"+b.substring(0,b.length-1)+"</div>":"-"},dispositionBulkUpdate=function(a,b){var d;switch(applicationName){case "Single Case Alert":d="Case";break;case "Aggregate Case Alert":d="PEC";break;case "EVDAS Alert":d="PEC";break;case "Ad-Hoc Alert":d="Observation";break;case "Literature Search Alert":d=
"Article"}bootbox.dialog({title:"Apply To All",message:signal.utils.render("bulk_operation_options",{totalSelectedRecords:a,alertType:d}),buttons:{ok:{label:"Ok",className:"btn btn-primary",callback:function(){switch($("input[name=bulkOptions]:checked").val()){case "current":var a=populateDispositionChangeData($(selectedDisposition).closest("tr").index(),!1);changeDisposition(b,a,!1);break;case "allSelected":checkIfAllSelectedRowsInSameDispositionState()?(a=populateDispositionChangeData($(selectedDisposition).closest("tr").index(),
!0),changeDisposition(b,a,!0)):$.Notification.notify("error","top right","Error","All selected safety observations must be in same disposition for performing the bulk update.",{autoHideDelay:1E4})}}},cancel:{label:"Cancel",className:"btn btn-default"}}})},checkIfAllSelectedRowsInSameDispositionState=function(){var a=$(selectedDisposition).closest("ul").data("current-disposition"),b=new Set;$.each($(".copy-select:checked"),function(){b.add($(this).closest("tr").index())});var d=!0;b.forEach(function(b){d&&
(d=a===$("table#alertsDetailsTable tr:nth-child("+(b+1)+") div.disposition ul").data("current-disposition"))});return d},initiateAuthFlow=function(a){bootbox.dialog({title:"User authentication",message:signal.utils.render("userAuth",{}),buttons:{ok:{label:"Confirm",className:"btn btn-primary",callback:function(){var b=$("#username").val(),d=$("#password").val();if(b&&d){if(b==loggedInUser){if(authenticateUser(b,d)){$("#detailed-view-checkbox").is(":checked")?(d=$("table#alertsDetailsTable .copy-select:checked").length,
b="table#alertsDetailsTable tbody.detailsTableBody"):(d=$("table.DTFC_Cloned .copy-select:checked").length,b="table.DTFC_Cloned tbody");var c=$(selectedDisposition).closest("tr").index();isAbstractViewOrCaseView(c)&&(c/=2);1<d&&$(b+" > tr:nth("+c+") .copy-select").prop("checked")?dispositionBulkUpdate(d,a):(b=populateDispositionChangeData(c,!1),changeDisposition(a,b,!1));return!0}$("#authCheck").addClass("show");return!1}$.Notification.notify("error","top right","Error","Please select the logged in User.",
{autoHideDelay:1E4})}else return b||$("#userNameField").addClass("show"),d||$("#passwordField").addClass("show"),!1}},cancel:{label:"Cancel",className:"btn btn-default",callback:function(){$("#dispositionJustificationPopover").modalPopover("hide")}}}})},authenticateUser=function(a,b){var d=!1;$.ajax({type:"POST",url:authUrl,data:{userName:a,password:b},async:!1,success:function(a){a.authorized&&(d=!0)}});return d},showHideAddNewSignal=function(){"undefined"!==typeof applicationName&&applicationName===
ALERT_CONFIG_TYPE.LITERATURE_SEARCH_ALERT?$("#dispositionSignalPopover #addNewSignal").hide():$("#dispositionSignalPopover #addNewSignal").show()},isAbstractViewOrCaseView=function(a){return"undefined"!=typeof isCaseDetailView&&"true"==isCaseDetailView&&0!=a||0<$("#detailed-view-checkbox").length&&1==$("#detailed-view-checkbox").prop("checked")&&0!=a?!0:!1},updateSignalHistory=function(){$.ajax({url:refreshSignalHistory,success:function(a){a.status?($("#signalHistory").html(a.data),setCreatedDate()):
$.Notification.notify("error","top right","Error",a.message,{autoHideDelay:2E4})}})};