<?xml version="1.0" encoding="utf-8"?>
<HTTPSnapshot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" id="132">
  <HTTPTask id="781" hostname="10.100.22.24:8181" path="/signal/assets/yadcf/jquery.dataTables.yadcf-a13c93c305588bd0340c6a9901cd3492.js" url="http://10.100.22.24:8181/signal/assets/yadcf/jquery.dataTables.yadcf-a13c93c305588bd0340c6a9901cd3492.js" ip="10.100.22.24" port="8181" connectionId="33" origin="Primary" frame="1" startDateTime="2020-05-22T11:19:00.792+05:30" startTime="89388578" endTime="89390015">
    <HTTPRequest method="GET">
      <HTTPHeaders>
        <HTTPHeaderEntity name="Host" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>MTAuMTAwLjIyLjI0OjgxODE=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Connection" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>a2VlcC1hbGl2ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="User-Agent" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzgxLjAuNDA0NC4xMzggU2FmYXJpLzUzNy4zNg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Ki8q</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Referer" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>aHR0cDovLzEwLjEwMC4yMi4yNDo4MTgxL3NpZ25hbC9zaW5nbGVDYXNlQWxlcnQvZGV0YWlscz9jYWxsaW5nU2NyZWVuPXJldmlldyZjb25maWdJZD0xNQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Encoding" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Language" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Cookie" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>U0VTU0lPTj04ZmE2YTc5MS0zOTFlLTRkNDItYjAzNi0xYzUwNjdhYzZkOGU=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>R0VUIC9zaWduYWwvYXNzZXRzL3lhZGNmL2pxdWVyeS5kYXRhVGFibGVzLnlhZGNmLWExM2M5M2MzMDU1ODhiZDAzNDBjNmE5OTAxY2QzNDkyLmpzIEhUVFAvMS4xDQpIb3N0OiAxMC4xMDAuMjIuMjQ6ODE4MQ0KQ29ubmVjdGlvbjoga2VlcC1hbGl2ZQ0KVXNlci1BZ2VudDogTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzgxLjAuNDA0NC4xMzggU2FmYXJpLzUzNy4zNg0KQWNjZXB0OiAqLyoNClJlZmVyZXI6IGh0dHA6Ly8xMC4xMDAuMjIuMjQ6ODE4MS9zaWduYWwvc2luZ2xlQ2FzZUFsZXJ0L2RldGFpbHM/Y2FsbGluZ1NjcmVlbj1yZXZpZXcmY29uZmlnSWQ9MTUNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KQ29va2llOiBTRVNTSU9OPThmYTZhNzkxLTM5MWUtNGQ0Mi1iMDM2LTFjNTA2N2FjNmQ4ZQ0KDQo=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
        <HTTPCookies>
          <HTTPHeaderEntity name="SESSION" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>OGZhNmE3OTEtMzkxZS00ZDQyLWIwMzYtMWM1MDY3YWM2ZDhl</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
        </HTTPCookies>
      </HTTPHeaders>
    </HTTPRequest>
    <HTTPResponse>
      <contentLenght>32483</contentLenght>
      <HTTPHeaders>
        <HTTPHeaderEntity name="Last-Modified" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>VGh1LCAyMSBNYXkgMjAyMCAwODoxNzoxNCBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="ETag" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>InlhZGNmL2pxdWVyeS5kYXRhVGFibGVzLnlhZGNmLWExM2M5M2MzMDU1ODhiZDAzNDBjNmE5OTAxY2QzNDkyLmpzIg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Vary" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>QWNjZXB0LUVuY29kaW5n</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Cache-Control" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>cHVibGljLCBtYXgtYWdlPTMxNTM2MDAw</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Encoding" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Type" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdDtjaGFyc2V0PVVURi04</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Length" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>MzI0ODM=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Date" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>RnJpLCAyMiBNYXkgMjAyMCAwNTo0MDoxNSBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SFRUUC8xLjEgMjAwIA0KTGFzdC1Nb2RpZmllZDogVGh1LCAyMSBNYXkgMjAyMCAwODoxNzoxNCBHTVQNCkVUYWc6ICJ5YWRjZi9qcXVlcnkuZGF0YVRhYmxlcy55YWRjZi1hMTNjOTNjMzA1NTg4YmQwMzQwYzZhOTkwMWNkMzQ5Mi5qcyINClZhcnk6IEFjY2VwdC1FbmNvZGluZw0KQ2FjaGUtQ29udHJvbDogcHVibGljLCBtYXgtYWdlPTMxNTM2MDAwDQpDb250ZW50LUVuY29kaW5nOiBnemlwDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQ7Y2hhcnNldD1VVEYtOA0KQ29udGVudC1MZW5ndGg6IDMyNDgzDQpEYXRlOiBGcmksIDIyIE1heSAyMDIwIDA1OjQwOjE1IEdNVA0KDQo=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
      <HTTPBody>
        <HTTPDataSet>
          <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
            <ActualData>LyohCiogWWV0IEFub3RoZXIgRGF0YVRhYmxlcyBDb2x1bW4gRmlsdGVyIC0gKHlhZGNmKQoqCiogRmlsZTogICAgICAgIGpxdWVyeS5kYXRhVGFibGVzLnlhZGNmLmpzCiogVmVyc2lvbjogICAgIDAuOS4zCioKKiBBdXRob3I6ICAgICAgRGFuaWVsIFJlem5pY2sKKiBJbmZvOiAgICAgICAgaHR0cHM6Ly9naXRodWIuY29tL3ZlZG1hY2sveWFkY2YKKiBDb250YWN0OiAgICAgdmVkbWFja0BnbWFpbC5jb20KKiBUd2l0dGVyOiAgICAgQGRhbmllbHJlem5pY2sKKiBRJkEgICAgICAgICAgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy90YWdnZWQveWFkY2YKKgoqIENvcHlyaWdodCAyMDE1IERhbmllbCBSZXpuaWNrLCBhbGwgcmlnaHRzIHJlc2VydmVkLgoqIENvcHlyaWdodCAyMDE1IFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZQoqCiogVGhpcyBzb3VyY2UgZmlsZSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQKKiBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mIE1FUkNIQU5UQUJJTElUWQoqIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIGxpY2Vuc2UgZmlsZXMgZm9yIGRldGFpbHMuCiovCi8qCiogUGFyYW1ldGVyczoKKgoqCiogLS0tLS0tLS0tLS0tLQoKKiBjb2x1bW5fbnVtYmVyCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIHRydWUKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgaW50CiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIFRoZSBudW1iZXIgb2YgdGhlIGNvbHVtbiB0byB3aGljaCB0aGUgZmlsdGVyIHdpbGwgYmUgYXBwbGllZAoKKiBmaWx0ZXJfdHlwZQogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgJ3NlbGVjdCcKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgc2VsZWN0IC8gbXVsdGlfc2VsZWN0IC8gYXV0b19jb21wbGV0ZSAvIHRleHQgLyBkYXRlIC8gcmFuZ2VfbnVtYmVyIC8gcmFuZ2VfbnVtYmVyX3NsaWRlciAvIHJhbmdlX2RhdGUgLyBjdXN0b21fZnVuYyAvIG11bHRpX3NlbGVjdF9jdXN0b21fZnVuYyAvIGRhdGVfY3VzdG9tX2Z1bmMKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVGhlIHR5cGUgb2YgdGhlIGZpbHRlciB0byBiZSB1c2VkIGluIHRoZSBjb2x1bW4KCiogY3VzdG9tX2Z1bmMKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgdHJ1ZSAod2hlbiBmaWx0ZXJfdHlwZSBpcyBjdXN0b21fZnVuYyAvIG11bHRpX3NlbGVjdF9jdXN0b21fZnVuYyAvIGRhdGVfY3VzdG9tX2Z1bmMpCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBzaG91bGQgYmUgcG9pbnRpbmcgdG8gYSBmdW5jdGlvbiB3aXRoIHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlIG15Q3VzdG9tRmlsdGVyRnVuY3Rpb24oZmlsdGVyVmFsLCBjb2x1bW5WYWwsIHJvd1ZhbHVlcywgc3RhdGVWYWwpICwgd2hlcmUgYGZpbHRlclZhbGAgaXMgdGhlIHZhbHVlIGZyb20gdGhlIHNlbGVjdCBib3gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBjb2x1bW5WYWxgIGlzIHRoZSB2YWx1ZSBmcm9tIHRoZSByZWxldmFudCByb3cgY29sdW1uLCBgcm93VmFsdWVzYCBpcyBhbiBhcnJheSB0aGF0IGhvbGRzIHRoZSB2YWx1ZXMgb2YgdGhlIGVudGlyZSByb3cgYW5kIGBzdGF0ZVZhbGAgd2hpY2ggaG9sZHMgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHRhYmxlIHJvdyBET00KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCBzdGF0ZVZhbCBpcyBwZXJmZWN0IHRvIGhhbmRsZSBzaXR1YXRpb25zIGluIHdoaWNoIHlvdSBwbGFjaW5nIHJhZGlvYnV0dG9ucyAvIGNoZWNrYm94IGluc2lkZSB0YWJsZSBjb2x1bW4uIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0cnVlIGlmIHRoZSByb3cgbWF0Y2hlcyB5b3VyIGNvbmRpdGlvbiBhbmQgdGhlIHJvdyBzaG91bGQgYmUgZGlzcGxheWVkKSBhbmQgZmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICBOb3RlOiAgICAgICAgICAgICAgIFdoZW4gdXNpbmcgbXVsdGlfc2VsZWN0X2N1c3RvbV9mdW5jIGFzIGZpbHRlcl90eXBlIGZpbHRlclZhbCB3aWxsIGhvbGQgYW4gYXJyYXkgb2Ygc2VsZWN0ZWQgdmFsdWVzIGZyb20gdGhlIG11bHRpIHNlbGVjdCBlbGVtZW50CgoqIGRhdGEKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgQXJyYXkgKG9mIHN0cmluZyBvciBvYmplY3RzKQogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBXaGVuIHRoZSBuZWVkIG9mIHByZWRlZmluZWQgZGF0YSBmb3IgZmlsdGVyIGlzIG5lZWRlZCBqdXN0IHVzZSBhbiBhcnJheSBvZiBzdHJpbmdzIFsidmFsdWUxIiwidmFsdWUyIi4uLi5dIChzdXBwb3J0ZWQgaW4gc2VsZWN0IC8gbXVsdGlfc2VsZWN0IC8gYXV0b19jb21wbGV0ZSBmaWx0ZXJzKSBvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheSBvZiBvYmplY3RzIFt7dmFsdWU6ICdTb21lIERhdGEgMScsIGxhYmVsOiAnT25lJ30sIHt2YWx1ZTogJ1NvbWUgRGF0YSAzJywgbGFiZWw6ICdUaHJlZSd9XSAoc3VwcG9ydGVkIGluIHNlbGVjdCAvIG11bHRpX3NlbGVjdCBmaWx0ZXJzKQogICAgICAgICAgICAgICAgTm90ZTogICAgICAgICAgICAgICB0aGF0IHdoZW4gZmlsdGVyX3R5cGUgaXMgY3VzdG9tX2Z1bmMgLyBtdWx0aV9zZWxlY3RfY3VzdG9tX2Z1bmMgdGhpcyBhcnJheSB3aWxsIHBvcHVsYXRlIHRoZSBjdXN0b20gZmlsdGVyIHNlbGVjdCBlbGVtZW50CgoqIGRhdGFfYXNfaXMKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgYm9vbGVhbgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICBmYWxzZQogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBXaGVuIHNldCB0byB0cnVlLCB0aGUgdmFsdWUgb2YgdGhlIGRhdGEgYXR0cmlidXRlIHdpbGwgYmUgZmVkIGludG8gdGhlIGZpbHRlciBhcyBpcyAod2l0aG91dCBhbnkgbW9kaWZpY2F0aW9uL2RlY29yYXRpb24pLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQZXJmZWN0IHRvIHVzZSB3aGVuIHlvdSB3YW50IHRvIGRlZmluZSB5b3VyIG93biA8b3B0aW9uPjwvb3B0aW9uPiBmb3IgdGhlIGZpbHRlcgogICAgICAgICAgICAgICAgTm90ZTogICAgICAgICAgICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIGJ5IHRoZSBzZWxlY3QgLyBtdWx0aV9zZWxlY3QgZmlsdGVycwoKKiBhcHBlbmRfZGF0YV90b190YWJsZV9kYXRhCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB1bmRlZmluZWQKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgYmVmb3JlIC8gc29ydGVkCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIFVzZSAnYmVmb3JlJyB0byBwbGFjZSB5b3VyIGRhdGEgYXJyYXkgYmVmb3JlIHRoZSB2YWx1ZXMgdGhhdCB5YWRjZiBncmFicyBmcm9tIHRoZSB0YWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2UgJ3NvcnRlZCcgdG8gcGxhY2UgdGhlIGRhdGEgYXJyYXkgc29ydGVkIGFsb25nIHdpdGggdGhlIHZhbHVlcyB0aGF0IHlhZGNmIGdyYWJzIGZyb20gdGhlIHRhYmxlCiAgICAgICAgICAgICAgICBOb3RlOiAgICAgICAgICAgICAgICdzb3J0ZWQnIG9wdGlvbiB3aWxsIGhhdmUgYWZmZWN0IG9ubHkgaWYgeW91IGRhdGEgaXMgYW4gYXJyYXkgb2YgcHJpbWl0aXZlcyAobm90IG9iamVjdHMpCgoqIGNvbHVtbl9kYXRhX3R5cGUKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgICd0ZXh0JwogICAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzOiAgICB0ZXh0IC8gaHRtbCAvIHJlbmRlcmVkX2h0bWwKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVGhlIHR5cGUgb2YgZGF0YSBpbiBjb2x1bW4gLCB1c2UgImh0bWwiIHdoZW4geW91IGhhdmUgc29tZSBodG1sIGNvZGUgaW4gdGhlIGNvbHVtbiAoc3VwcG9ydCBwYXJzaW5nIG9mIG11bHRpcGxlIGVsZW1lbnRzIHBlciBjZWxsKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlIHJlbmRlcmVkX2h0bWwgd2hlbiB5b3UgYXJlIHVzaW5nIHJlbmRlciBmdW5jdGlvbiBvZiBjb2x1bW5EZWZzIG9yIHNpbWlsYXIsIHRoYXQgcHJvZHVjZXMgYSBodG1sIGNvZGUsIG5vdGUgdGhhdCBib3RoIHR5cGVzIHJlbmRlcmVkX2h0bWwgYW5kIGh0bWwgaGF2ZSBhIGZhbGxiYWNrIGZvciBzaW1wbGUgdGV4dCBwYXJzaW5nCgoqIHRleHRfZGF0YV9kZWxpbWl0ZXIKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIERlbGltaXRlciB0aGF0IHNlcGVyYXRlcyB0ZXh0IGluIHRhYmxlIGNvbHVtbiwgZm9yIGV4YW1wbGUgdGV4dF9kYXRhX2RlbGltaXRlcjogIiwiCgoqIGh0bWxfZGF0YV90eXBlCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICAndGV4dCcKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgdGV4dCAvIHZhbHVlIC8gaWQgLyBzZWxlY3RvcgogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBXaGVuIHVzaW5nICJodG1sIiBmb3IgY29sdW1uX2RhdGFfdHlwZSBhcmd1bWVudCB5b3UgY2FuIGNob29zZSBob3cgZXhhY3RseSB0byBwYXJzZSB5b3VyIGh0bWwgZWxlbWVudC9zIGluIGNvbHVtbiAsIGZvciBleGFtcGxlIHVzZSAidGV4dCIgZm9yIHRoZSBmb2xsb3dpbmcgPHNwYW4gY2xhc3M9InNvbWVDbGFzcyI+U29tZSB0ZXh0PC9zcGFuPgogICAgICAgICAgICAgICAgU3BlY2lhbCBub3RlczogICAgICB3aGVuIHVzaW5nIHNlbGVjdG9yIHlvdSBtdXN0IHByb3ZpZGUgYSB2YWxpZCBzZWxlY3RvciBzdHJpbmcgZm9yIHRoZSBodG1sX2RhdGFfc2VsZWN0b3IgcHJvcGVydHkKCiogaHRtbF9kYXRhX3NlbGVjdG9yCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB1bmRlZmluZWQKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgYW55IHZhbGlkIHNlbGVjdG9yIHN0cmluZywgZm9yIGV4YW1wbGUgJ2xpOmVxKDEpJwogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBhbGxvd3MgZm9yIGFkdmFuY2VkIHRleHQgdmFsdWUgc2VsZWN0aW9uIHdpdGhpbiB0aGUgaHRtbCBsb2NhdGVkIGluIHRoZSB0ZCBlbGVtZW50CiAgICAgICAgICAgICAgICBTcGVjaWFsIG5vdGVzOiAgICAgIGtub3cgdGhhdCB0aGUgc2VsZWN0b3Igc3RyaW5nICJiZWdpbiBpcyBzZWFyY2giIGZyb20gKGFuZCBub3Qgb3V0c2lkZSkgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGh0bWwgaW5zaWRlIHRoZSB0ZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoc3VwcG9ydGVkIGJ5IHJhbmdlX251bWJlcl9zbGlkZXIgLyBzZWxlY3QgLyBhdXRvX2NvbXBsZXRlKQoKKiBodG1sNV9kYXRhCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB1bmRlZmluZWQKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgZGF0YS1maWx0ZXIgLyBkYXRhLXNlYXJjaCAvIGFueXRoaW5nIHRoYXQgaXMgc3VwcG9ydGVkIGJ5IGRhdGF0YWJsZXMKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3dzIHRvIGZpbHRlciBiYXNlZCBvbiBkYXRhLWZpbHRlciAvIGRhdGEtc2VhcmNoIGF0dHJpYnV0ZXMgb2YgdGhlIDx0ZD4gZWxlbWVudCwgcmVhZCBtb3JlOiBodHRwOi8vd3d3LmRhdGF0YWJsZXMubmV0L2V4YW1wbGVzL2FkdmFuY2VkX2luaXQvaHRtbDUtZGF0YS1hdHRyaWJ1dGVzLmh0bWwKCiogZmlsdGVyX2NvbnRhaW5lcl9pZAogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgSW4gY2FzZSB0aGF0IHVzZXIgZG9uJ3Qgd2FudCB0byBwbGFjZSB0aGUgZmlsdGVyIGluIGNvbHVtbiBoZWFkZXIgLCBoZSBjYW4gcGFzcyBhbiBpZCBvZiB0aGUgZGVzaXJlZCBjb250YWluZXIgZm9yIHRoZSBjb2x1bW4gZmlsdGVyCgoqIGZpbHRlcl9jb250YWluZXJfc2VsZWN0b3IKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIEluIGNhc2UgdGhhdCB1c2VyIGRvbid0IHdhbnQgdG8gcGxhY2UgdGhlIGZpbHRlciBpbiBjb2x1bW4gaGVhZGVyICwgaGUgY2FuIHBhc3MgYSAoanF1ZXJ5KSBzZWxlY3RvciBvZiB0aGUgZGVzaXJlZCBjb250YWluZXIgZm9yIHRoZSBjb2x1bW4gZmlsdGVyCgoqIGZpbHRlcl9kZWZhdWx0X2xhYmVsCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZyAvIEFycmF5IG9mIHN0cmluZyBpbiBjYXNlIG9mIHJhbmdlX251bWJlciBmaWx0ZXIgKGZpcnN0IGVudHJ5IGlzIGZvciB0aGUgZmlyc3QgaW5wdXQgYW5kIHRoZSBzZWNvbmQgZW50cnkgaXMgZm9yIHRoZSBzZWNvbmQgaW5wdXQKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgJ1NlbGVjdCB2YWx1ZScKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVGhlIGxhYmVsIHRoYXQgd2lsbCBhcHBlYXIgaW4gdGhlIHNlbGVjdCBtZW51IGZpbHRlciB3aGVuIG5vIHZhbHVlIGlzIHNlbGVjdGVkIGZyb20gdGhlIGZpbHRlcgoKKiBvbWl0X2RlZmF1bHRfbGFiZWwKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgYm9vbGVhbgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICBmYWxzZQogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBQcmV2ZW50IHlhZGNmIGZyb20gYWRkaW5nICJkZWZhdWx0X2xhYmVsIiAoU2VsZWN0IHZhbHVlIC8gU2VsZWN0IHZhbHVlcykKICAgICAgICAgICAgICAgIE5vdGUgICAgICAgICAgICAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBpbiBzZWxlY3QgLyBtdWx0aV9zZWxlY3QgLyBjdXN0b21fZnVuYyAvIG11bHRpX3NlbGVjdF9jdXN0b21fZnVuYwoKKiBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nIC8gYm9vbGVhbgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICAneCcKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVGhlIHRleHQgdGhhdCB3aWxsIGFwcGVhciBpbnNpZGUgdGhlIHJlc2V0IGJ1dHRvbiBuZXh0IHRvIHRoZSBzZWxlY3QgZHJvcCBkb3duIChzZXQgdGhpcyB0byBmYWxzZSAoYm9vbGVhbikgaW4gb3JkZXIgdG8gaGlkZSBpdCBmcm9tIHRoYXQgY29sdW1uIGZpbHRlcikKCiogZW5hYmxlX2F1dG9fY29tcGxldGUgKHRoaXMgYXR0cmlidXRlIGlzIGRlcHJlY2F0ZWQgLCBhbmQgd2lsbCBiZWNvbWUgb2Jzb2xldGUgaW4gdGhlIGZ1dHVyZSAsIHNvIHlvdSBiZXR0ZXIgc3RhcnQgdXNpbmcgZmlsdGVyX3R5cGU6ICJhdXRvX2NvbXBsZXRlIikKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgYm9vbGVhbgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICBmYWxzZQogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBUdXJucyB0aGUgZmlsdGVyIGludG8gYW4gYXV0b2NvbXBsZXRlIGlucHV0IC0gbWFrZSB1c2Ugb2YgdGhlIGpRdWVyeSBVSSBBdXRvY29tcGxldGUgd2lkZ2V0ICh3aXRoIHNvbWUgZW5oYW5jZW1lbnRzKQoKKiBzb3J0X2FzCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICAnYWxwaGEnCiAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXM6ICAgIGFscGhhIC8gbnVtIC8gYWxwaGFOdW0gLyBub25lCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIERlZmluZXMgaG93IHRoZSB2YWx1ZXMgaW4gdGhlIGZpbHRlciB3aWxsIGJlIHNvcnRlZCwgYWxwaGFiZXRpY2FsbHkgLyBudW1lcmljYWxseSAvIGFscGhhbnVtZXJpYyAvIGN1c3RvbSAvIG5vdCBzb3J0ZWQgYXQgYWxsIChub25lIGlzIHVzZWZ1bCB0byBwcmVzZXJ2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgb3JkZXIgb2YgdGhlIGRhdGEgYXR0cmlidXRlIGFzIGlzKQogICAgICAgICAgICAgICAgTm90ZTogICAgICAgICAgICAgICBXaGVuIGN1c3RvbSB2YWx1ZSBpcyBzZXQgeW91IG11c3QgcHJvdmlkZSBhIGN1c3RvbSBzb3J0aW5nIGZ1bmN0aW9uIGZvciB0aGUgc29ydF9hc19jdXN0b21fZnVuYyBwcm9wZXJ0eQoKKiBzb3J0X2FzX2N1c3RvbV9mdW5jCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBBbGxvd3MgdG8gcHJvdmlkZSBhIGN1c3RvbSBzb3J0aW5nIGZ1bmN0aW9uIGZvciB0aGUgZmlsdGVyIGVsZW1lbnRzCgoqIHNvcnRfb3JkZXIKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgICdhc2MnCiAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXM6ICAgIGFzYyAvIGRlc2MKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgRGVmaW5lcyB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIHZhbHVlcyBpbiB0aGUgZmlsdGVyIHdpbGwgYmUgc29ydGVkLCBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZwoKKiBkYXRlX2Zvcm1hdAogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgJ21tL2RkL3l5eXknCiAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXM6ICAgIG1tL2RkL3l5eXkgLyBkZC9tbS95eXl5IC8gaGg6bW0gKHdoZW4gdXNpbmcgZGF0ZXBpY2tlcl90eXBlOiAnYm9vdHN0cmFwLWRhdGV0aW1lcGlja2VyJykKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgRGVmaW5lcyB0aGUgZm9ybWF0IGluIHdoaWNoIHRoZSBkYXRlIHZhbHVlcyBhcmUgYmVpbmcgcGFyc2VkIGludG8gRGF0ZSBvYmplY3QKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgWW91IGNhbiByZXBsYWNlIHRoZSAvIHNlcGFyYXRvciB3aXRoIG90aGVyIG9uZSAsIGZvciBleGFtcGxlIG1tLWRkLXl5CgoqIG1vbWVudF9kYXRlX2Zvcm1hdAogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXM6ICAgIEFueSBmb3JtYXQgYWNjZXB0ZWQgYnkgbW9tZW50anMKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgRGVmaW5lcyB0aGUgZm9ybWF0IGluIHdoaWNoIHRoZSBkYXRlIHZhbHVlcyBhcmUgYmVpbmcgcGFyc2VkIGludG8gRGF0ZSBvYmplY3QgYnkgbW9tZW50anMgbGlicmFyeQogICAgICAgICAgICAgICAgTm90ZTogICAgICAgICAgICAgICBDdXJyZW50bHkgcmVsZXZhbnQgb25seSB3aGVuIHVzaW5nIGRhdGVwaWNrZXJfdHlwZTogJ2Jvb3RzdHJhcC1kYXRldGltZXBpY2tlcicpCgoqIGlnbm9yZV9jaGFyCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBUZWxscyB0aGUgcmFuZ2VfbnVtYmVyIGFuZCByYW5nZV9udW1iZXJfc2xpZGUgdG8gaWdub3JlIHNwZWNpZmljIGNoYXIgd2hpbGUgZmlsdGVyaW5nICh0aGF0IGNoYXIgY2FuIHVzZWQgYXMgbnVtYmVyIHNlcGFyYXRvcikKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgVXNlIGRvdWJsZSBlc2NhcGUgZm9yIHJlZ2V4IGNoYXJzICwgZS5nIFxcJCAsIGFsc28geW91IGNhbiB1c2UgbXVsdGlwbGUgaWdub3JlIGNoYXJzIHdpdGggfCAsIGUuZyAnX3xcXC58XFwkJwoKKiBmaWx0ZXJfbWF0Y2hfbW9kZQogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgY29udGFpbnMKICAgICAgICAgICAgICAgIFBvc3NpYmxlIHZhbHVlczogICAgY29udGFpbnMgLyBleGFjdCAvIHN0YXJ0c1dpdGggLyByZWdleAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBBbGxvd3MgdG8gY29udHJvbCB0aGUgbWF0Y2hpbmcgbW9kZSBvZiB0aGUgZmlsdGVyIChzdXBwb3J0ZWQgaW4gc2VsZWN0IC8gYXV0b19jb21wbGV0ZSAvIHRleHQgZmlsdGVycykKCiogZXhjbHVkZQogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBib29sZWFuCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBBZGRzIGEgY2hlY2tib3ggbmV4dCB0byB0aGUgZmlsdGVyIHRoYXQgYWxsb3dzIHRvIGRvIGEgIm5vdC9leGNsdWRlIiBmaWx0ZXJpbmcgKGFjdHMgdGhlIHNhbWUgIGFsbCBmaWx0ZXJfbWF0Y2hfbW9kZSkKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgQ3VycmVudGx5IGF2YWlsYWJsZSBmb3IgdGhlIHRleHQgZmlsdGVyCgoqIGV4Y2x1ZGVfbGFiZWwKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgICdleGNsdWRlJwogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBUaGUgbGFiZWwgdGhhdCB3aWxsIGFwcGVhciBhYm92ZSB0aGUgZXhjbHVkZSBjaGVja2JveAoKKiBzZWxlY3RfdHlwZQogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXM6ICAgIGNob3NlbiAvIHNlbGVjdDIgLyBjdXN0b21fc2VsZWN0CiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIFR1cm5zIHRoZSBzaW1wbGUgc2VsZWN0IGVsZW1lbnQgaW50byBDaG9zZW4gLyBTZWxlY3QyIChtYWtlIHVzZSBvZiB0aGUgQ2hvc2VuIC8gU2VsZWN0MiBzZWxlY3QgalF1ZXJ5IHBsdWdpbnMpCiAgICAgICAgICAgICAgICBOb3RlOiAgICAgICAgICAgICAgIFdoZW4gdXNpbmcgY3VzdG9tX3NlbGVjdCAsIG1ha2Ugc3VyZSB0byBjYWxsIHRoZSBpbml0U2VsZWN0UGx1Z2luQ3VzdG9tVHJpZ2dlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZSBjYWxsaW5nIHlhZGNmIGNvbnN0cnVjdG9yIC8gaW5pdCBmdW5jdGlvbgoKKiBzZWxlY3RfdHlwZV9vcHRpb25zCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIE9iamVjdAogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB7fQogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBUaGlzIHBhcmFtZXRlciB3aWxsIGJlIHBhc3NlZCAiYXMgaXMiIHRvIHRoZSBDaG9zZW4vU2VsZWN0MiBwbHVnaW4gY29uc3RydWN0b3IKCiogZmlsdGVyX3BsdWdpbl9vcHRpb25zCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIE9iamVjdAogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB1bmRlZmluZWQKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVGhpcyBwYXJhbWV0ZXIgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGpRdWVyeSBBdXRvY29tcGxldGUgLyBqUXVlcnkgU2xpZGVyIC8gQm9vdHN0cmFwIERhdGV0aW1lcGlja2VyCgoqIGNhc2VfaW5zZW5zaXRpdmUKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgYm9vbGVhbgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB0cnVlCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIERvIGNhc2UtaW5zZW5zaXRpdmUgZmlsdGVyaW5nIChzdXBwb3J0ZWQgaW4gc2VsZWN0IC8gYXV0b19jb21wbGV0ZSAvIHRleHQgZmlsdGVycykKCgoqIGZpbHRlcl9kZWxheQogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBpbnRlZ2VyCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBEZWxheSBmaWx0ZXIgZXhlY3V0aW9uIGZvciBhIFhYWCBtaWxsaXNlY29uZHMgLSBmaWx0ZXIgd2lsbCBmaXJlIFhYWCBtaWxsaXNlY29uZHMgYWZ0ZXIgdGhlIGxhc3Qga2V5dXAuCiAgICAgICAgICAgICAgICBTcGVjaWFsIG5vdGVzOiAgICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgaW4gdGV4dCAvIHJhbmdlX251bWJlciAvIHJhbmdlX2RhdGUgZmlsdGVycyAvIHJhbmdlX251bWJlcl9zbGlkZXIKCiogZGF0ZXBpY2tlcl90eXBlCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIFN0cmluZwogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICAnanF1ZXJ5LXVpJwogICAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzOiAgICAnanF1ZXJ5LXVpJyAvICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInIC8gYm9vdHN0cmFwLWRhdGVwaWNrZXIKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgWW91IGNhbiBjaG9vc2UgZGF0YXBpY2tlciBsaWJyYXJ5IGZyb20gZGVmaW5lZCBpbiBzcGVjaWFsIG5vdGVzCiAgICAgICAgICAgICAgICBTcGVjaWFsIG5vdGVzOiAgICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb25seSBqUXVlcnlVSSBkYXRlcGlja2VyIChkYXRlcGlja2VyKSBhbmQgQm9vdHN0cmFwIGRhdGVwaWNrZXIgKGVvbmFzZGFuLWJvb3RzdHJhcC1kYXRldGltZXBpY2tlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQm9vdHN0cmFwIGRhdGVwaWNrZXIgZGVwZW5kcyBtb21lbnQgbGlicmFyeS4gVGhpcyBwbHVnaW4gZGVwZW5kcyBtb21lbnQgdG9vLgoKKiBzdHlsZV9jbGFzcwogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3dzIGFkZGluZyBhZGRpdGlvbmFsIGNsYXNzL2NsYXNzZXMgdG8gZmlsdGVyIC0gYXZhaWxhYmxlIGZvciB0aGUgZm9sbG93aW5nIGZpbHRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdCAvIG11bHRpX3NlbGVjdCAvIHRleHQgLyBjdXN0b21fZnVuYyAvIG11bHRpX3NlbGVjdF9jdXN0b21fZnVuYyAvIHJhbmdlX251bWJlciAvIHJhbmdlX251bWJlcl9zbGlkZXIgLyByYW5nZV9kYXRlCgoqIHJlc2V0X2J1dHRvbl9zdHlsZV9jbGFzcwogICAgICAgICAgICAgICAgUmVxdWlyZWQ6ICAgICAgICAgICBmYWxzZQogICAgICAgICAgICAgICAgVHlwZTogICAgICAgICAgICAgICBTdHJpbmcKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3dzIGFkZGluZyBhZGRpdGlvbmFsIGNsYXNzL2NsYXNzZXMgdG8gZmlsdGVyIHJlc2V0IGJ1dHRvbgoKCiogR2xvYmFsIFBhcmFtZXRlcnMgKHBlciB0YWJsZSByYXRoZXIgdGhhbiBwZXIgY29sdW1uKQoqCiogVXNhZ2UgZXhhbXBsZSB5YWRjZi5pbml0KG9UYWJsZSxbe2NvbHVtbl9udW1iZXIgOiAwfSwge2NvbHVtbl9udW1iZXI6IDN9XSx7Y3VtdWxhdGl2ZV9maWx0ZXJpbmc6IHRydWV9KTsKKiAtLS0tLS0tLS0tLS0tCgoqIGV4dGVybmFsbHlfdHJpZ2dlcmVkCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIGJvb2xlYW4KICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgRmlsdGVycyB3aWxsIGZpbHRlciBvbmx5IHdoZW4geWFkY2YuZXhGaWx0ZXJFeHRlcm5hbGx5VHJpZ2dlcmVkKHRhYmxlX2FyZykgaXMgY2FsbGVkCiAgICAgICAgICAgICAgICBTcGVjaWFsIG5vdGVzOiAgICAgIFVzZWZ1bCB3aGVuIHlvdSB3YW50IHRvIGJ1aWxkIHNvbWUgZm9ybSB3aXRoIGZpbHRlcnMgYW5kIHlvdSB3YW50IHRvIHRyaWdnZXIgdGhlIGZpbHRlciB3aGVuIHRoYXQgZm9ybQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3VibWl0IiBidXR0b24gaXMgY2xpY2tlZCAoaW5zdGVhZCBvZiBmaWx0ZXJpbmcgcGVyIGZpbHRlciBpbnB1dCBjaGFuZ2UpCgoqIGN1bXVsYXRpdmVfZmlsdGVyaW5nCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIGJvb2xlYW4KICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQ2hhbmdlIHRoZSBkZWZhdWx0IGJlaGF2aW91ciBvZiB0aGUgZmlsdGVycyBzbyBpdHMgb3B0aW9ucyB3aWxsIGJlIHBvcHVsYXRlZCBmcm9tIHRoZSBmaWx0ZXJlZCByb3dzIChyZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGUgZGF0YSBhZnRlciBmaWx0ZXJpbmcpIG9ubHksIHVubGlrZSB0aGUgbm9ybWFsIGJlaGF2aW91ciBpbiB3aGljaCB0aGUgb3B0aW9ucyBvZiB0aGUgZmlsdGVycyBhcmUgZnJvbSBhbGwgdGhlIHRhYmxlIGRhdGEKCgoqIGZpbHRlcnNfcG9zaXRpb24KICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgU3RyaW5nCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIGhlYWRlcgogICAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzOiAgICAnaGVhZGVyJyAvICdmb290ZXInCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIEZpbHRlcnMgY2FuIGJlIHBsYWNlZCBpbiB0aGUgaGVhZGVyICh0aGVhZCkgb3IgaW4gdGhlIGZvb3RlciAodGZvb3QpIG9mIHRoZSB0YWJsZSwKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgV2hlbiAnZm9vdGVyJyB5b3UgbXVzdCBwcm92aWRlIGEgdmFsaWQgdGZvb3QgZWxlbWV0IGluIHlvdXIgdGFibGUKCgoqIGZpbHRlcnNfdHJfaW5kZXgKICAgICAgICAgICAgICAgIFJlcXVpcmVkOiAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICAgIFR5cGU6ICAgICAgICAgICAgICAgaW50ZWdlcgogICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogICAgICB1bmRlZmluZWQKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3cgdG8gY29udHJvbCB0aGUgaW5kZXggb2YgdGhlIDx0cj4gaW5zaWRlIHRoZSB0aGVhZCBvZiB0aGUgdGFibGUsIGUuZyB3aGVuIG9uZSA8dHI+IGlzIHVzZWQgZm9yIGhlYWRlcnMvc29ydCBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5vdGhlciA8dHI+IGlzIHVzZWQgZm9yIGZpbHRlcnMKCgoqIG9uSW5pdENvbXBsZXRlCiAgICAgICAgICAgICAgICBSZXF1aXJlZDogICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgICBUeXBlOiAgICAgICAgICAgICAgIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAgICAgIHVuZGVmaW5lZAogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBDYWxscyB0aGUgcHJvdmlkZWQgY2FsbGJhY2sgZnVuY3Rpb24gaW4gdGhlIGVuZCBvZiB0aGUgeWFkY2YgaW5pdCBmdW5jdGlvbgoJCQkJTm90ZTogICAgICAgICAgICAgICBUaGlzIGNhbGxiYWNrIGZ1bmN0aW9uIHdpbGwgcnVuIGJlZm9yZSBkYXRhdGFibGVzIGZpcmVzIGl0cyBldmVudCBzdWNoIGFzIGRyYXcveGhyL2V0Yy4sIG1pZ3RoIGJlIHVzZWZ1bGwgZm9yIGNhbGwgc29tZQoJCQkJCQkJCQl0aGlyZCBwYXJ0aWVzIGluaXQgLyBsb2FkaW5nIGNvZGUKKgoqCioKKgoqIEV4dGVybmFsIEFQSSBmdW5jdGlvbnM6CioKKgoqIC0tLS0tLS0tLS0tLS0KCiogZXhGaWx0ZXJDb2x1bW4KICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3dzIHRvIHRyaWdnZXIgZmlsdGVyL3MgZXh0ZXJuYWxseS9wcm9ncmFtbWF0aWNhbGx5IChzdXBwb3J0IEFMTCBmaWx0ZXIgdHlwZXMhISEpICwgcGVyZmVjdCBmb3Igc2hvd2luZyB0YWJsZSB3aXRoIHByZSBmaWx0ZXJlZCBjb2x1bW5zCiAgICAgICAgICAgICAgICBBcmd1bWVudHM6ICAgICAgICAgIHRhYmxlX2FyZzogKHZhcmlhYmxlIG9mIHRoZSBkYXRhdGFibGUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheSBvZiBwYWlyczogY29sdW1uIG51bWJlciBTdHJpbmcvT2JqZWN0IHdpdGggZnJvbSBhbmQgdG8sIGZpbHRlcl92YWx1ZSAodGhlIGFjdHVhbCBzdHJpbmcgdmFsdWUgdGhhdCB3ZSB3YW50IHRvIGZpbHRlciBieSkKICAgICAgICAgICAgICAgIFVzYWdlIGV4YW1wbGU6ICAgICAgeWFkY2YuZXhGaWx0ZXJDb2x1bW4ob1RhYmxlLCBbWzAsICdTb21lIERhdGEgMiddXSk7IC8vcHJlIGZpbHRlciBvbmUgY29sdW1uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhZGNmLmV4RmlsdGVyQ29sdW1uKG9UYWJsZSwgW1swLCAnU29tZSBEYXRhIDEnXSwgWzEsIHtmcm9tOiAxMTEsIHRvOiAxMTEwfV0sIFsyLCB7ZnJvbTogIiIsIHRvOiAiMTEvMjUvMjAxNCJ9XV0pOyAvL3ByZSBmaWx0ZXIgc2V2ZXJhbCBjb2x1bW5zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhZGNmLmV4RmlsdGVyQ29sdW1uKG9UYWJsZSwgW1swLCBbJ1NvbWUgRGF0YSAxJywnU29tZSBEYXRhIDInXV1dKTsgLy8gZm9yIHByZSBmaWx0ZXJpbmcgbXVsdGkgc2VsZWN0IGZpbHRlciB5b3Ugc2hvdWxkIHVzZSBhcnJheSB3aXRoIHZhbHVlcyAob3IgYW4gYXJyYXkgd2l0aCBzaW5nbGUgdmFsdWUpCgoqIGV4R2V0Q29sdW1uRmlsdGVyVmFsCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIEFsbG93cyB0byByZXRyaWV2ZSAgY29sdW1uIGN1cnJlbnQgZmlsdGVyZWQgdmFsdWUgKHN1cHBvcnQgQUxMIGZpbHRlciB0eXBlcyEhISkKICAgICAgICAgICAgICAgIEFyZ3VtZW50czogICAgICAgICAgdGFibGVfYXJnOiAodmFyaWFibGUgb2YgdGhlIGRhdGF0YWJsZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbiBudW1iZXI6ICBjb2x1bW4gbnVtYmVyIGZyb20gd2hpY2ggd2Ugd2FudCB0aGUgdmFsdWUKICAgICAgICAgICAgICAgIFVzYWdlIGV4YW1wbGU6ICAgICAgeWFkY2YuZXhHZXRDb2x1bW5GaWx0ZXJWYWwob1RhYmxlLDEpOwogICAgICAgICAgICAgICAgUmV0dXJuIHZhbHVlOiAgICAgICBTdHJpbmcgKGZvciBzaW1wbGUgZmlsdGVyKSAvIE9iamVjdCAoZm9yIHJhbmdlIGZpbHRlcikgd2l0aCBmcm9tIGFuZCB0byBwcm9wZXJ0aWVzIC8gQXJyYXkgb2Ygc3RyaW5ncyBmb3IgbXVsdGlfc2VsZWN0IGZpbHRlcgoKCiogZXhSZXNldEFsbEZpbHRlcnMKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgQWxsb3dzIHRvIHJlc2V0IGFsbCBmaWx0ZXJzIGV4dGVybmFsbHkvcHJvZ3JhbW1hdGljYWxseSAoc3VwcG9ydCBBTEwgZmlsdGVyIHR5cGVzISEhKSAsIHBlcmZlY3QgZm9yIGFkZGluZyBhICJyZXNldCBhbGwiIGJ1dHRvbiB0byB5b3VyIHBhZ2UhCiAgICAgICAgICAgICAgICBBcmd1bWVudHM6ICAgICAgICAgIHRhYmxlX2FyZzogKHZhcmlhYmxlIG9mIHRoZSBkYXRhdGFibGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vUmVkcmF3OiAgIChib29sZWFuKSAsIHVzZSBpdCBpZiB5b3UgZG9uJ3Qgd2FudCB5b3VyIHRhYmxlIHRvIGJlIHJlbG9hZGVkIGFmdGVyIHRoZSBmaWx0ZXIgcmVzZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBleGFtcGxlIGlmIHlvdSBwbGFubmluZyB0byBjYWxsIGV4RmlsdGVyQ29sdW1uIGZ1bmN0aW9uIHJpZ2h0IGFmdGVyIHRoZSBleFJlc2V0QWxsRmlsdGVycyAodG8gYXZvaWQgdHdvIEFKQVggcmVxdWVzdHMpCiAgICAgICAgICAgICAgICBVc2FnZSBleGFtcGxlOiAgICAgIHlhZGNmLmV4UmVzZXRBbGxGaWx0ZXJzKG9UYWJsZSk7CgoqIGV4UmVzZXRGaWx0ZXJzCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIEFsbG93cyB0byByZXNldCBzcGVjaWZpYyBmaWx0ZXJzIGV4dGVybmFsbHkvcHJvZ3JhbW1hdGljYWxseSAoc3VwcG9ydCBBTEwgZmlsdGVyIHR5cGVzISEhKSAsIGNhbiBiZSB1c2VkIGZvciByZXNldHRpbmcgb25lIG9yIG1vcmUgZmlsdGVycwogICAgICAgICAgICAgICAgQXJndW1lbnRzOiAgICAgICAgICB0YWJsZV9hcmc6ICh2YXJpYWJsZSBvZiB0aGUgZGF0YXRhYmxlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheSB3aXRoIGNvbHVtbnMgbnVtYmVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub1JlZHJhdzogICAoYm9vbGVhbikgLCB1c2UgaXQgaWYgeW91IGRvbid0IHdhbnQgeW91ciB0YWJsZSB0byBiZSByZWxvYWRlZCBhZnRlciB0aGUgZmlsdGVyIHJlc2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXhhbXBsZSBpZiB5b3UgcGxhbm5pbmcgdG8gY2FsbCBleEZpbHRlckNvbHVtbiBmdW5jdGlvbiByaWdodCBhZnRlciB0aGUgZXhSZXNldEZpbHRlcnMgKHRvIGF2b2lkIHR3byBBSkFYIHJlcXVlc3RzKQogICAgICAgICAgICAgICAgVXNhZ2UgZXhhbXBsZTogICAgICB5YWRjZi5leFJlc2V0QWxsRmlsdGVycyhvVGFibGUsIFsxLDJdKTsKCiogaW5pdFNlbGVjdFBsdWdpbkN1c3RvbVRyaWdnZXJzCiAgICAgICAgICAgICAgICBEZXNjcmlwdGlvbjogICAgICAgIEFsbG93cyB0byBzZXQgYW55IHNlbGVjdCBqcXVlcnkgcGx1Z2luIGluaXRpYWxpemUgYW5kIHJlZnJlc2ggZnVuY3Rpb25zLiBqUXVlcnkgc2VsZWN0b3Igd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHVzZXIgZGVmaW5lZCBmdW5jdGlvbiB0byBpbml0aWFsaXplIGFuZCByZWZyZXNoIHRoZSBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdyZWF0IGZvciBpbnRlZ3JhdGluZyBhbnkganF1ZXkgc2VsZWN0IHBsdWdpbiAgKFNlbGVjdGl6ZSAvIE11bHRpU2VsZWN0IC8gZXRjKQogICAgICAgICAgICAgICAgQXJndW1lbnRzOiAgICAgICAgICBpbml0RnVuYyAgOiBmdW5jdGlvbiB3aGljaCB3aWxsIGluaXRpYWxpemUgdGhlIHBsdWdpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoRnVuYyA6IGZ1bmN0aW9uIHRoYXQgd2lsbCByZWZyZXNoIHRoZSBwbHVnaW4uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lGdW5jIDogZnVuY3Rpb24gdGhhdCB3aWxsIGRlc3Ryb3kgdGhlIHBsdWdpbiAodXBvbiB0YWJsZSBkZXN0cm95IGV2ZW4gdHJpZ2dlcikuCiAgICAgICAgICAgICAgICBVc2FnZSBleGFtcGxlOiAgICAgIHlhZGNmLmluaXRTZWxlY3RQbHVnaW5DdXN0b21UcmlnZ2VycyhmdW5jdGlvbiAoJGZpbHRlclNlbGVjdG9yKXskZmlsdGVyU2VsZWN0b3IubXVsdGlzZWxlY3Qoe30pO30sIGZ1bmN0aW9uICgkZmlsdGVyU2VsZWN0b3IpeyRmaWx0ZXJTZWxlY3Rvci5tdWx0aXNlbGVjdCgicmVmcmVzaCIpfSwgLCBmdW5jdGlvbiAoJGZpbHRlclNlbGVjdG9yKXskZmlsdGVyU2VsZWN0b3IubXVsdGlzZWxlY3QoImRlc3Ryb3kiKX0pOwoKKiBleEZpbHRlckV4dGVybmFsbHlUcmlnZ2VyZWQKICAgICAgICAgICAgICAgIERlc2NyaXB0aW9uOiAgICAgICAgVHJpZ2dlcnMgYWxsIHRoZSBhdmFpbGFibGUgZmlsdGVycywgc2hvdWxkIGJlIHVzZWQgb25seSB3aGVuIHRoZSBleHRlcm5hbGx5X3RyaWdnZXJlZCBvcHRpb24gdXNlZAogICAgICAgICAgICAgICAgQXJndW1lbnRzOiAgICAgICAgICB0YWJsZV9hcmc6ICh2YXJpYWJsZSBvZiB0aGUgZGF0YXRhYmxlKQogICAgICAgICAgICAgICAgVXNhZ2UgZXhhbXBsZTogICAgICB5YWRjZi5leFJlc2V0QWxsRmlsdGVycyh0YWJsZV9hcmcpOwoqCioKKgoqIFNlcnZlci1zaWRlIHByb2Nlc3NpbmcgQVBJIChzZWUgbW9yZSBvbiBzaG93Y2FzZSk6CioKKiBGcm9tIHNlcnZlciB0byBjbGllbnQ6CiogSW4gb3JkZXIgdG8gcG9wdWxhdGUgdGhlIGZpbHRlcnMgd2l0aCBkYXRhIGZyb20gc2VydmVyIChzZWxlY3QgLyBhdXRvX2NvbXBsZXRlIC8gcmFuZ2VfbnVtYmVyX3NsaWRlciAobWluIGFuZCBtYXggdmFsdWVzKSwgeW91IHNob3VsZCBhZGQgdG8geW91ciBjdXJyZW50IGpzb24gcmVzcG9uZCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiogbGV0cyBzYXkgZm9yIGZpcnN0IGNvbHVtbiB5b3UgYWRkIHlhZGNmX2RhdGFfMCBmaWxsZWQgd2l0aCBhcnJheSBvZiB2YWx1ZXMsIGZvciBjb2x1bW4gc2Vjb25kIGNvbHVtbiB5YWRjZl9kYXRhXzEgYW5kIHNvIG9uLi4uCioKKiBGcm9tIGNsaWVudCB0byBzZXJ2ZXI6CiogUmVhZCB0aGUgZmlsdGVyZWQgdmFsdWUgbGlrZSB0aGlzIChmb3IgZmlyc3QgY29sdW1uKSByZXEuZ2V0UGFyYW1ldGVyKCJjb2x1bW5zWzBdW3NlYXJjaF1bdmFsdWVdIik7IDwtIGphdmEgY29kZSAsIHBocC8uTmV0L2V0YyB5b3UganVzdCBuZWVkIHRvIGdldCBpdCBmcm9tIHRoZSByZXF1ZXN0CiogUmFuZ2UgZmlsdGVyIHZhbHVlIHdpbGwgYXJyaXZlIGRlbGltaXRlZCBieSAgLXlhZGNmX2RlbGltLSAsIHNvIGp1c3Qgc3BsaXQgaXQgaW50byBhbiBhcnJheSBvciBzb21ldGhpbmcgbGlrZSB0aGlzOiBTdHJpbmdbXSBtaW5NYXggPSBzU2VhcmNoXzAuc3BsaXQoIi15YWRjZl9kZWxpbS0iKTsKKgoqCgoKKgoqCioKKiBXb3JraW5nIHdpdGggZmlsdGVycyBmb3IgbXVsdGlwbGUgdGFibGVzOgoqCioKKiAtLS0tLS0tLS0tLS0tCgoqIGluaXRNdWx0aXBsZVRhYmxlcwogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBBbGxvd3MgdG8gY3JlYXRlIGZpbHRlciB0aGF0IHdpbGwgYWZmZWN0IG11bHRpcGxlIHRhYmxlcyAvIG11bHRpcGxlIGNvbHVtbihzKSBpbiBtdWx0aXBsZSB0YWJsZXMKICAgICAgICAgICAgICAgIEFyZ3VtZW50czogICAgICAgICAgQXJyYXkgb2YgdGFibGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcnJheSBvZiBvYmplY3RzIHdpdGggcHJvcGVydGllcyBmb3IgZWFjaCBmaWx0ZXIKICAgICAgICAgICAgICAgIFVzYWdlIGV4YW1wbGU6ICAgICAgeWFkY2YuaW5pdE11bHRpcGxlVGFibGVzKFtvVGFibGUsIG9UYWJsZTJdLCBbewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcjogWzAsIDFdLCBmaWx0ZXJfY29udGFpbmVyX2lkOiAnbXVsdGktdGFibGUtZmlsdGVyLTAnLCBmaWx0ZXJfZGVmYXVsdF9sYWJlbDogJ0ZpbHRlciBhbGwgdGFibGVzIGNvbHVtbnMgMSBhbmQgMiEnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXI6IFsyXSwgZmlsdGVyX2NvbnRhaW5lcl9pZDogJ211bHRpLXRhYmxlLWZpbHRlci0xJywgZmlsdGVyX2RlZmF1bHRfbGFiZWw6ICdGaWx0ZXIgYWxsIHRhYmxlcyBjb2x1bW4gMyEnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIFZhbGlkIHByb3BlcnRpZXM6ICAgZmlsdGVyX3R5cGU6ICd0ZXh0JyAoZGVmYXVsdCkgLyAnc2VsZWN0JyAvICdtdWx0aV9zZWxlY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyOiBub3QgcmVxdWlyZWQgKGluIHRoYXQgY2FzZSB0aGUgZmlsdGVyIHdpbGwgYmUgZ2xvYmFsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW4gYmUgZWl0aGVyIG51bWJlcihzaW5nbGUgY29sdW1uIGZpbHRlcikgb3IgYXJyYXkgb2YgbnVtYmVycyhtdWx0aXBsZSBjb2x1bW5zIGZpbHRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX2NvbnRhaW5lcl9pZDogJycgKHJlcXVpcmVkKSwKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgQWxsIHRoZSB1c3VhbCBwcm9wZXJ0aWVzIG9mIHlhZGNmIHNob3VsZCBiZSBzdXBwb3J0ZWQgaW4gaW5pdE11bHRpcGxlVGFibGVzIHRvbyEKCiogaW5pdE11bHRpcGxlQ29sdW1ucwogICAgICAgICAgICAgICAgRGVzY3JpcHRpb246ICAgICAgICBBbGxvd3MgdG8gY3JlYXRlIGZpbHRlciB0aGF0IHdpbGwgYWZmZWN0IG11bHRpcGxlIGNvbHVtbihzKSBpbiBpbiBhIHBhcnRpY3VsYXIgdGFibGUKICAgICAgICAgICAgICAgIEFyZ3VtZW50czogICAgICAgICAgVGFibGUgdmFyaWFibGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFycmF5IG9mIG9iamVjdHMgd2l0aCBwcm9wZXJ0aWVzIGZvciBlYWNoIGZpbHRlcgogICAgICAgICAgICAgICAgVXNhZ2UgZXhhbXBsZTogICAgICB5YWRjZi5pbml0TXVsdGlwbGVDb2x1bW5zKG9UYWJsZSwgW3sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXI6IFswLCAxXSwgZmlsdGVyX2NvbnRhaW5lcl9pZDogJ211bHRpLXRhYmxlLWZpbHRlci0wJywgZmlsdGVyX2RlZmF1bHRfbGFiZWw6ICdGaWx0ZXIgY29sdW1ucyAxIGFuZCAyIScKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcjogWzIsIDNdLCBmaWx0ZXJfY29udGFpbmVyX2lkOiAnbXVsdGktdGFibGUtZmlsdGVyLTEnLCBmaWx0ZXJfZGVmYXVsdF9sYWJlbDogJ0ZpbHRlciBjb2x1bW4gMyBhbmQgNCEnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1dKTsKICAgICAgICAgICAgICAgIFZhbGlkIHByb3BlcnRpZXM6ICAgZmlsdGVyX3R5cGU6ICd0ZXh0JyAoZGVmYXVsdCkgLyAnc2VsZWN0JyAvICdtdWx0aV9zZWxlY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyOiBub3QgcmVxdWlyZWQgKGluIHRoYXQgY2FzZSB0aGUgZmlsdGVyIHdpbGwgYmUgZ2xvYmFsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW4gYmUgZWl0aGVyIG51bWJlcihzaW5nbGUgY29sdW1uIGZpbHRlcikgb3IgYXJyYXkgb2YgbnVtYmVycyhtdWx0aXBsZSBjb2x1bW5zIGZpbHRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX2NvbnRhaW5lcl9pZDogJycgKHJlcXVpcmVkKSwKICAgICAgICAgICAgICAgIE5vdGU6ICAgICAgICAgICAgICAgQWxsIHRoZSB1c3VhbCBwcm9wZXJ0aWVzIG9mIHlhZGNmIHNob3VsZCBiZSBzdXBwb3J0ZWQgaW4gaW5pdE11bHRpcGxlQ29sdW1ucyB0b28hCiovCi8vUG9seWZpbGxzCmlmICh3aW5kb3cuTm9kZUxpc3QgJiYgIU5vZGVMaXN0LnByb3RvdHlwZS5mb3JFYWNoKSB7CiAgICBOb2RlTGlzdC5wcm90b3R5cGUuZm9yRWFjaCA9IGZ1bmN0aW9uIChjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgIHRoaXNBcmcgPSB0aGlzQXJnIHx8IHdpbmRvdzsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzQXJnLCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgICAgICB9CiAgICB9Owp9CmlmICghT2JqZWN0LmVudHJpZXMpIHsKICAgIE9iamVjdC5lbnRyaWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgdmFyIG93blByb3BzID0gT2JqZWN0LmtleXMob2JqKSwKICAgICAgICAgICAgaSA9IG93blByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzQXJyYXkgPSBuZXcgQXJyYXkoaSk7IC8vIHByZWFsbG9jYXRlIHRoZSBBcnJheQogICAgICAgIHdoaWxlIChpLS0pCiAgICAgICAgICAgIHJlc0FycmF5W2ldID0gW293blByb3BzW2ldLCBvYmpbb3duUHJvcHNbaV1dXTsKCiAgICAgICAgcmV0dXJuIHJlc0FycmF5OwogICAgfTsKfQooZnVuY3Rpb24gKGZhY3RvcnkpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ECiAgICAgICAgZGVmaW5lKFsnanF1ZXJ5J10sIGZ1bmN0aW9uICgkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KCQsIHdpbmRvdywgZG9jdW1lbnQpOwogICAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIENvbW1vbkpTCiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAocm9vdCwgJCkgewogICAgICAgICAgICBpZiAoIXJvb3QpIHsKICAgICAgICAgICAgICAgIC8vIENvbW1vbkpTIGVudmlyb25tZW50cyB3aXRob3V0IGEgd2luZG93IGdsb2JhbCBtdXN0IHBhc3MgYQogICAgICAgICAgICAgICAgLy8gcm9vdC4gVGhpcyB3aWxsIGdpdmUgYW4gZXJyb3Igb3RoZXJ3aXNlCiAgICAgICAgICAgICAgICByb290ID0gd2luZG93OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoISQpIHsKICAgICAgICAgICAgICAgICQgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/IC8vIGpRdWVyeSdzIGZhY3RvcnkgY2hlY2tzIGZvciBhIGdsb2JhbCB3aW5kb3cKICAgICAgICAgICAgICAgICAgICByZXF1aXJlKCdqcXVlcnknKSA6CiAgICAgICAgICAgICAgICAgICAgcmVxdWlyZSgnanF1ZXJ5Jykocm9vdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmYWN0b3J5KCQsIHJvb3QsIHJvb3QuZG9jdW1lbnQpOwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIC8vIEJyb3dzZXIKICAgICAgICBmYWN0b3J5KGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCk7CiAgICB9Cn0KKGZ1bmN0aW9uICgkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpIHsKICAgIHZhciB5YWRjZiA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgJ3VzZSBzdHJpY3QnOwoKICAgICAgICB2YXIgdGFibGVzRFQgPSB7fSwKICAgICAgICAgICAgb1RhYmxlcyA9IHt9LAogICAgICAgICAgICBvVGFibGVzSW5kZXggPSB7fSwKICAgICAgICAgICAgb3B0aW9ucyA9IHt9LAogICAgICAgICAgICBwbHVnaW5zID0ge30sCiAgICAgICAgICAgIGV4RmlsdGVyQ29sdW1uUXVldWUgPSBbXSwKICAgICAgICAgICAgeWFkY2ZEZWxheSwKICAgICAgICAgICAgc2VsZWN0RWxlbWVudEN1c3RvbUluaXRGdW5jLAogICAgICAgICAgICBzZWxlY3RFbGVtZW50Q3VzdG9tUmVmcmVzaEZ1bmMsCiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnRDdXN0b21EZXN0cm95RnVuYywKICAgICAgICAgICAgcGxhY2Vob2xkZXJMYW5nID0gewogICAgICAgICAgICAgICAgc2VsZWN0OiAnU2VsZWN0IHZhbHVlJywKICAgICAgICAgICAgICAgIHNlbGVjdF9tdWx0aTogJ1NlbGVjdCB2YWx1ZXMnLAogICAgICAgICAgICAgICAgZmlsdGVyOiAnVHlwZSB0byBmaWx0ZXInLAogICAgICAgICAgICAgICAgcmFuZ2U6IFsnRnJvbScsICdUbyddLAogICAgICAgICAgICAgICAgZGF0ZTogJ1NlbGVjdCBhIGRhdGUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldHRpbmdzTWFwID0ge307CgogICAgICAgIGxldCBjbG9zZUJvb3RzdHJhcERhdGVwaWNrZXIgPSBmYWxzZTsKICAgICAgICBsZXQJY2xvc2VCb290c3RyYXBEYXRlcGlja2VyUmFuZ2UgPSBmYWxzZTsKICAgICAgICBsZXQJY2xvc2VTZWxlY3QyID0gZmFsc2U7CgogICAgICAgIC8vRnJvbSBDb2xSZW9yZGVyIChTcHJ5TWVkaWEgTHRkICh3d3cuc3ByeW1lZGlhLmNvLnVrKSkKICAgICAgICBmdW5jdGlvbiBnZXRTZXR0aW5nc09iakZyb21UYWJsZShkdCkgewogICAgICAgICAgICB2YXIgb0RUU2V0dGluZ3M7CiAgICAgICAgICAgIGlmICgkLmZuLmRhdGFUYWJsZS5BcGkpIHsKICAgICAgICAgICAgICAgIG9EVFNldHRpbmdzID0gbmV3ICQuZm4uZGF0YVRhYmxlLkFwaShkdCkuc2V0dGluZ3MoKVswXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkdC5mblNldHRpbmdzKSB7IC8vIDEuOSBjb21wYXRpYmlsaXR5CiAgICAgICAgICAgICAgICAvLyBEYXRhVGFibGVzIG9iamVjdCwgY29udmVydCB0byB0aGUgc2V0dGluZ3Mgb2JqZWN0CiAgICAgICAgICAgICAgICBvRFRTZXR0aW5ncyA9IGR0LmZuU2V0dGluZ3MoKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZHQgPT09ICdzdHJpbmcnKSB7IC8vIGpRdWVyeSBzZWxlY3RvcgogICAgICAgICAgICAgICAgaWYgKCQuZm4uZGF0YVRhYmxlLmZuSXNEYXRhVGFibGUoJChkdClbMF0pKSB7CiAgICAgICAgICAgICAgICAgICAgb0RUU2V0dGluZ3MgPSAkKGR0KS5lcSgwKS5kYXRhVGFibGUoKS5mblNldHRpbmdzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZHQubm9kZU5hbWUgJiYgZHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3RhYmxlJykgewogICAgICAgICAgICAgICAgLy8gVGFibGUgbm9kZQogICAgICAgICAgICAgICAgaWYgKCQuZm4uZGF0YVRhYmxlLmZuSXNEYXRhVGFibGUoZHQubm9kZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgb0RUU2V0dGluZ3MgPSAkKGR0Lm5vZGVOYW1lKS5kYXRhVGFibGUoKS5mblNldHRpbmdzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZHQgaW5zdGFuY2VvZiBqUXVlcnkpIHsKICAgICAgICAgICAgICAgIC8vIGpRdWVyeSBvYmplY3QKICAgICAgICAgICAgICAgIGlmICgkLmZuLmRhdGFUYWJsZS5mbklzRGF0YVRhYmxlKGR0WzBdKSkgewogICAgICAgICAgICAgICAgICAgIG9EVFNldHRpbmdzID0gZHQuZXEoMCkuZGF0YVRhYmxlKCkuZm5TZXR0aW5ncygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gRGF0YVRhYmxlcyBzZXR0aW5ncyBvYmplY3QKICAgICAgICAgICAgICAgIG9EVFNldHRpbmdzID0gZHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG9EVFNldHRpbmdzOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXJyYXlTd2FwVmFsdWVXaXRoSW5kZXgocEFycmF5KSB7CiAgICAgICAgICAgIHZhciB0bXAgPSBbXSwKICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRtcFtwQXJyYXlbaV1dID0gaTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdG1wOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXJyYXlTd2FwVmFsdWVXaXRoSW5kZXgyKHBBcnJheSkgewogICAgICAgICAgICB2YXIgdG1wID0gW10sCiAgICAgICAgICAgICAgICBpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0bXBbcEFycmF5W2ldLl9Db2xSZW9yZGVyX2lPcmlnQ29sXSA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRtcDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGluaXRDb2xSZW9yZGVyMihzZXR0aW5nc0R0LCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSkgewogICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vU2F2ZWRTdGF0ZSAmJiBzZXR0aW5nc0R0Lm9TYXZlZFN0YXRlLkNvbFJlb3JkZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSA9IHt9OwogICAgICAgICAgICAgICAgICAgIHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLkNvbFJlb3JkZXIgPSBhcnJheVN3YXBWYWx1ZVdpdGhJbmRleChzZXR0aW5nc0R0Lm9TYXZlZFN0YXRlLkNvbFJlb3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNldHRpbmdzRHQuYW9Db2x1bW5zWzBdLl9Db2xSZW9yZGVyX2lPcmlnQ29sICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSB7fTsKICAgICAgICAgICAgICAgICAgICBwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XS5Db2xSZW9yZGVyID0gYXJyYXlTd2FwVmFsdWVXaXRoSW5kZXgyKHNldHRpbmdzRHQuYW9Db2x1bW5zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdENvbFJlb3JkZXJGcm9tRXZlbnQodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpIHsKICAgICAgICAgICAgcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSB1bmRlZmluZWQ7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb2x1bW5zQXJyYXlUb1N0cmluZyhjb2x1bW5fbnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBjb2x1bW5fbnVtYmVyX29iaiA9IHt9OwogICAgICAgICAgICBpZiAoY29sdW1uX251bWJlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uX251bWJlciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9vYmouY29sdW1uX251bWJlcl9zdHIgPSBjb2x1bW5fbnVtYmVyLmpvaW4oJ18nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9vYmouY29sdW1uX251bWJlcl9zdHIgPSBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBbXTsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyLnB1c2goY29sdW1uX251bWJlcl9vYmouY29sdW1uX251bWJlcl9zdHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9vYmouY29sdW1uX251bWJlcl9zdHIgPSAnZ2xvYmFsJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb2x1bW5fbnVtYmVyX29iai5jb2x1bW5fbnVtYmVyID0gY29sdW1uX251bWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNvbHVtbl9udW1iZXJfb2JqOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0T3B0aW9ucyhzZWxlY3RvcikgewogICAgICAgICAgICByZXR1cm4gb3B0aW9uc1tzZWxlY3Rvcl07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRBbGxPcHRpb25zKCkgewogICAgICAgICAgICByZXR1cm4gb3B0aW9uczsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV2ZW50VGFyZ2V0Rml4VXAocEV2ZW50KSB7CiAgICAgICAgICAgIGlmIChwRXZlbnQudGFyZ2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHBFdmVudC50YXJnZXQgPSBwRXZlbnQuc3JjRWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcEV2ZW50OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZG90Mm9iaih0bXBPYmosIGRvdF9yZWZzKSB7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgZG90X3JlZnMgPSBkb3RfcmVmcy5zcGxpdCgiLiIpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZG90X3JlZnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRtcE9iaiA9IHRtcE9ialtkb3RfcmVmc1tpXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRtcE9iajsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldE9wdGlvbnMoc2VsZWN0b3JfYXJnLCBvcHRpb25zX2FyZywgcGFyYW1zKSB7CiAgICAgICAgICAgIHZhciB0bXBPcHRpb25zID0ge30sCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgY29sX251bV9hc19pbnQsCiAgICAgICAgICAgICAgICBkZWZhdWx0X29wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3R5cGU6ICJzZWxlY3QiLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZV9hdXRvX2NvbXBsZXRlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBzb3J0X2FzOiAiYWxwaGEiLAogICAgICAgICAgICAgICAgICAgIHNvcnRfb3JkZXI6ICJhc2MiLAogICAgICAgICAgICAgICAgICAgIGRhdGVfZm9ybWF0OiAibW0vZGQveXl5eSIsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlX2NoYXI6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfbWF0Y2hfbW9kZTogImNvbnRhaW5zIiwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RfdHlwZTogdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdF90eXBlX29wdGlvbnM6IHt9LAogICAgICAgICAgICAgICAgICAgIGNhc2VfaW5zZW5zaXRpdmU6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGFfdHlwZTogJ3RleHQnLAogICAgICAgICAgICAgICAgICAgIGh0bWxfZGF0YV90eXBlOiAndGV4dCcsCiAgICAgICAgICAgICAgICAgICAgZXhjbHVkZV9sYWJlbDogJ2V4Y2x1ZGUnLAogICAgICAgICAgICAgICAgICAgIHN0eWxlX2NsYXNzOiAnJywKICAgICAgICAgICAgICAgICAgICByZXNldF9idXR0b25fc3R5bGVfY2xhc3M6ICcnLAogICAgICAgICAgICAgICAgICAgIGRhdGVwaWNrZXJfdHlwZTogJ2pxdWVyeS11aScsCiAgICAgICAgICAgICAgICAgICAgcmFuZ2VfZGF0YV90eXBlOiAnc2luZ2xlJywKICAgICAgICAgICAgICAgICAgICByYW5nZV9kYXRhX3R5cGVfZGVsaW06ICctJywKICAgICAgICAgICAgICAgICAgICBvbWl0X2RlZmF1bHRfbGFiZWw6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAvL2FkYXB0Q29udGFpbmVyQ3NzQ2xhc3NJbXBsID0gZnVuY3Rpb24gKGR1bW15KSB7IHJldHVybiAnJzsgfTsKCiAgICAgICAgICAgICQuZXh0ZW5kKHRydWUsIGRlZmF1bHRfb3B0aW9ucywgcGFyYW1zKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zX2FyZy5sZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgb3B0aW9uc1tzZWxlY3Rvcl9hcmddID0gb3B0aW9uc19hcmc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9wdGlvbnNfYXJnLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uc19hcmdbaV0uZGF0ZV9mb3JtYXQgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zX2FyZ1tpXS5tb21lbnRfZGF0ZV9mb3JtYXQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfYXJnW2ldLm1vbWVudF9kYXRlX2Zvcm1hdCA9IG9wdGlvbnNfYXJnW2ldLmRhdGVfZm9ybWF0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNfYXJnW2ldLnNlbGVjdF90eXBlID09PSAnc2VsZWN0MicpIHsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X29wdGlvbnMuc2VsZWN0X3R5cGVfb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9hZGFwdENvbnRhaW5lckNzc0NsYXNzOiBhZGFwdENvbnRhaW5lckNzc0NsYXNzSW1wbAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL25vIGluZGl2aWR1YWwgcmVzZXQgYnV0dG9uIGZvciBleHRlcm5hbGx5X3RyaWdnZXJlZCBtb2RlCiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdF9vcHRpb25zLmV4dGVybmFsbHlfdHJpZ2dlcmVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc19hcmdbaV0uZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL3ZhbGlkYXRlIGN1c3RvbSBmdW5jdGlvbiByZXF1aXJlZCBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICBpZiAob3B0aW9uc19hcmdbaV0uZmlsdGVyX3R5cGUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zX2FyZ1tpXS5maWx0ZXJfdHlwZS5pbmRleE9mKCdjdXN0b21fZnVuYycpICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zX2FyZ1tpXS5jdXN0b21fZnVuYyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvcjogWW91IGFyZSB0cnlpbmcgdG8gdXNlIGZpbHRlcl90eXBlOiAiY3VzdG9tX2Z1bmMgLyBtdWx0aV9zZWxlY3RfY3VzdG9tX2Z1bmMiIGZvciBjb2x1bW4gJyArIG9wdGlvbnNfYXJnW2ldLmNvbHVtbl9udW1iZXIgKyAnIGJ1dCB0aGVyZSBpcyBubyBzdWNoIGN1c3RvbV9mdW5jIGF0dHJpYnV0ZSBwcm92aWRlZCAoY3VzdG9tX2Z1bmM6IFwiZnVuY3Rpb24gcmVmZXJlbmNlIGdvZXMgaGVyZS4uLlwiKScpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sX251bV9hc19pbnQgPSArb3B0aW9uc19hcmdbaV0uY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgIGlmIChpc05hTihjb2xfbnVtX2FzX2ludCkpIHsKICAgICAgICAgICAgICAgICAgICB0bXBPcHRpb25zW29wdGlvbnNfYXJnW2ldLmNvbHVtbl9udW1iZXJfc3RyXSA9ICQuZXh0ZW5kKHRydWUsIHt9LCBkZWZhdWx0X29wdGlvbnMsIG9wdGlvbnNfYXJnW2ldKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG1wT3B0aW9uc1tjb2xfbnVtX2FzX2ludF0gPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdF9vcHRpb25zLCBvcHRpb25zX2FyZ1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3B0aW9uc1tzZWxlY3Rvcl9hcmddID0gdG1wT3B0aW9uczsKCiAgICAgICAgICAgIGNoZWNrM3JkUFBsdWdpbnNOZWVkZWRDbG9zZSgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2hlY2szcmRQUGx1Z2luc05lZWRlZENsb3NlKCkgewogICAgICAgICAgICBPYmplY3QuZW50cmllcyhnZXRBbGxPcHRpb25zKCkpLmZvckVhY2goZnVuY3Rpb24odGFibGVFbnRyeSkgewogICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXModGFibGVFbnRyeVsxXSkuZm9yRWFjaChmdW5jdGlvbihjb2x1bW5FbnRyeSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5FbnRyeVsxXS5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbkVudHJ5WzFdLmZpbHRlcl90eXBlID09PSAncmFuZ2VfZGF0ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQm9vdHN0cmFwRGF0ZXBpY2tlclJhbmdlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQm9vdHN0cmFwRGF0ZXBpY2tlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbkVudHJ5WzFdLnNlbGVjdF90eXBlID09PSAnc2VsZWN0MicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2VTZWxlY3QyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvL3Rha2VuIGFuZCBtb2RpZmllZCBmcm9tIERhdGFUYWJsZXMgMS4xMC4wLWJldGEuMiBzb3VyY2UKICAgICAgICBmdW5jdGlvbiB5YWRjZlZlcnNpb25DaGVjayh2ZXJzaW9uKSB7CiAgICAgICAgICAgIHZhciBhVGhpcyA9ICQuZm4uZGF0YVRhYmxlLmV4dC5zVmVyc2lvbi5zcGxpdCgnLicpLAogICAgICAgICAgICAgICAgYVRoYXQgPSB2ZXJzaW9uLnNwbGl0KCcuJyksCiAgICAgICAgICAgICAgICBpVGhpcywKICAgICAgICAgICAgICAgIGlUaGF0LAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGlMZW47CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBpTGVuID0gYVRoYXQubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBpVGhpcyA9IHBhcnNlSW50KGFUaGlzW2ldLCAxMCkgfHwgMDsKICAgICAgICAgICAgICAgIGlUaGF0ID0gcGFyc2VJbnQoYVRoYXRbaV0sIDEwKSB8fCAwOwoKICAgICAgICAgICAgICAgIC8vIFBhcnRzIGFyZSB0aGUgc2FtZSwga2VlcCBjb21wYXJpbmcKICAgICAgICAgICAgICAgIGlmIChpVGhpcyA9PT0gaVRoYXQpIHsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBQYXJ0cyBhcmUgZGlmZmVyZW50LCByZXR1cm4gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIHJldHVybiBpVGhpcyA+IGlUaGF0OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJlc2V0SUFwaUluZGV4KCkgewogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSAwOwoKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVJlZ0V4cChzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC8oWy4qKz9ePSE6JHt9KCl8XFtcXVwvXFxdKS9nLCAiXFwkMSIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXNjYXBlUmVnRXhwSW5BcnJheShhcnIpIHsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGFycltpXSA9IGFycltpXS5yZXBsYWNlKC8oWy4qKz9ePSE6JHt9KCl8XFtcXVwvXFxdKS9nLCAiXFwkMSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhcnI7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZXBsYWNlQWxsKHN0cmluZywgZmluZCwgcmVwbGFjZSkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cChlc2NhcGVSZWdFeHAoZmluZCksICdnJyksIHJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0VGFibGVJZChvYmopIHsKICAgICAgICAgICAgdmFyIHRhYmxlSWQ7CiAgICAgICAgICAgIGlmIChvYmoudGFibGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGFibGVJZCA9IG9iai50YWJsZSgpLm5vZGUoKS5pZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhYmxlSWQgPSBnZXRTZXR0aW5nc09iakZyb21UYWJsZShvYmopLnNUYWJsZUlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0YWJsZUlkOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseTIob2JqKSB7CiAgICAgICAgICAgIHZhciB0bXBTdHI7CiAgICAgICAgICAgIGlmIChvYmoub0luc3RhbmNlICE9PSB1bmRlZmluZWQgJiYgb2JqLm9JbnN0YW5jZS5zZWxlY3RvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0bXBTdHIgPSBvYmoub0luc3RhbmNlLnNlbGVjdG9yOwogICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5zZWxlY3RvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0bXBTdHIgPSBvYmouc2VsZWN0b3I7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLnRhYmxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRtcFN0ciA9IG9iai50YWJsZSgpLm5vZGUoKS5pZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0bXBTdHIgPSByZXBsYWNlQWxsKHRtcFN0ciwgIi4iLCAiLSIpOwogICAgICAgICAgICB0bXBTdHIgPSByZXBsYWNlQWxsKHRtcFN0ciwgJyAnLCAnJyk7CiAgICAgICAgICAgIHJldHVybiB0bXBTdHIucmVwbGFjZSgiOiIsICItIikucmVwbGFjZSgiKCIsICIiKS5yZXBsYWNlKCIpIiwgIiIpLnJlcGxhY2UoIiMiLCAiLSIpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseU5ldyh0bXBTdHIpIHsKICAgICAgICAgICAgdG1wU3RyID0gcmVwbGFjZUFsbCh0bXBTdHIsICI6IiwgIi0iKTsKICAgICAgICAgICAgdG1wU3RyID0gcmVwbGFjZUFsbCh0bXBTdHIsICIoIiwgIiIpOwogICAgICAgICAgICB0bXBTdHIgPSByZXBsYWNlQWxsKHRtcFN0ciwgIikiLCAiIik7CiAgICAgICAgICAgIHRtcFN0ciA9IHJlcGxhY2VBbGwodG1wU3RyLCAiLCIsICIiKTsKICAgICAgICAgICAgdG1wU3RyID0gcmVwbGFjZUFsbCh0bXBTdHIsICIuIiwgIi0iKTsKICAgICAgICAgICAgdG1wU3RyID0gcmVwbGFjZUFsbCh0bXBTdHIsICIjIiwgIi0iKTsKICAgICAgICAgICAgdG1wU3RyID0gcmVwbGFjZUFsbCh0bXBTdHIsICcgJywgJycpOwogICAgICAgICAgICByZXR1cm4gdG1wU3RyOwogICAgICAgIH0KCiAgICAgICAgeWFkY2ZEZWxheSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciB0aW1lciA9IDA7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoY2FsbGJhY2ssIG1zLCBwYXJhbSkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socGFyYW0pOwogICAgICAgICAgICAgICAgfSwgbXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRpbWVyOwogICAgICAgICAgICB9OwogICAgICAgIH0oKSk7CgogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVTZWxlY3RQbHVnaW4oc2VsZWN0VHlwZSwgJHNlbGVjdE9iamVjdCwgc2VsZWN0X3R5cGVfb3B0aW9ucykgewogICAgICAgICAgICBpZiAoc2VsZWN0VHlwZSA9PT0gJ2Nob3NlbicpIHsKICAgICAgICAgICAgICAgICRzZWxlY3RPYmplY3QuY2hvc2VuKHNlbGVjdF90eXBlX29wdGlvbnMpOwogICAgICAgICAgICAgICAgJHNlbGVjdE9iamVjdC5uZXh0KCkuYXR0cigib25jbGljayIsICJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIpLmF0dHIoIm9ubW91c2Vkb3duIiwgInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7Iik7CiAgICAgICAgICAgICAgICByZWZyZXNoU2VsZWN0UGx1Z2luKHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RfdHlwZTogc2VsZWN0VHlwZSwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RfdHlwZV9vcHRpb25zOiBzZWxlY3RfdHlwZV9vcHRpb25zCiAgICAgICAgICAgICAgICB9LCAkc2VsZWN0T2JqZWN0KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RUeXBlID09PSAnc2VsZWN0MicpIHsKICAgICAgICAgICAgICAgIGlmICghJHNlbGVjdE9iamVjdC5kYXRhKCdzZWxlY3QyJykpIHsKICAgICAgICAgICAgICAgICAgICAkc2VsZWN0T2JqZWN0LnNlbGVjdDIoc2VsZWN0X3R5cGVfb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoJHNlbGVjdE9iamVjdC5uZXh0KCkuaGFzQ2xhc3MoJ3NlbGVjdDItY29udGFpbmVyJykpIHsKICAgICAgICAgICAgICAgICAgICAkc2VsZWN0T2JqZWN0Lm5leHQoKS5hdHRyKCJvbmNsaWNrIiwgInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7IikuYXR0cigib25tb3VzZWRvd24iLCAieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RUeXBlID09PSAnY3VzdG9tX3NlbGVjdCcpIHsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnRDdXN0b21Jbml0RnVuYygkc2VsZWN0T2JqZWN0KTsKICAgICAgICAgICAgICAgICRzZWxlY3RPYmplY3QubmV4dCgpLmF0dHIoIm9uY2xpY2siLCAieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsiKS5hdHRyKCJvbm1vdXNlZG93biIsICJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWZyZXNoU2VsZWN0UGx1Z2luKGNvbHVtbk9iaiwgJHNlbGVjdE9iamVjdCwgdmFsKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RUeXBlID0gY29sdW1uT2JqLnNlbGVjdF90eXBlLAogICAgICAgICAgICAgICAgc2VsZWN0X3R5cGVfb3B0aW9ucyA9IGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zOwogICAgICAgICAgICBpZiAoc2VsZWN0VHlwZSA9PT0gJ2Nob3NlbicpIHsKICAgICAgICAgICAgICAgICRzZWxlY3RPYmplY3QudHJpZ2dlcigiY2hvc2VuOnVwZGF0ZWQiKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RUeXBlID09PSAnc2VsZWN0MicpIHsKICAgICAgICAgICAgICAgIGlmICghJHNlbGVjdE9iamVjdC5kYXRhKCdzZWxlY3QyJykpIHsKICAgICAgICAgICAgICAgICAgICAkc2VsZWN0T2JqZWN0LnNlbGVjdDIoc2VsZWN0X3R5cGVfb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAkc2VsZWN0T2JqZWN0LnZhbCh2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHNlbGVjdE9iamVjdC50cmlnZ2VyKCdjaGFuZ2UnKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxlY3RUeXBlID09PSAnY3VzdG9tX3NlbGVjdCcpIHsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnRDdXN0b21SZWZyZXNoRnVuYygkc2VsZWN0T2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdFNlbGVjdFBsdWdpbkN1c3RvbVRyaWdnZXJzKGluaXRGdW5jLCByZWZyZXNoRnVuYywgZGVzdHJveUZ1bmMpIHsKICAgICAgICAgICAgc2VsZWN0RWxlbWVudEN1c3RvbUluaXRGdW5jID0gaW5pdEZ1bmM7CiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnRDdXN0b21SZWZyZXNoRnVuYyA9IHJlZnJlc2hGdW5jOwogICAgICAgICAgICBzZWxlY3RFbGVtZW50Q3VzdG9tRGVzdHJveUZ1bmMgPSBkZXN0cm95RnVuYzsKICAgICAgICB9CgogICAgICAgIC8vVXNlZCBieSBleEZpbHRlckNvbHVtbiBmb3IgdHJhbnNsYXRpbmcgcmVhZGFibGUgc2VhcmNoIHZhbHVlIGludG8gcHJvcGVyIHNlYXJjaCBzdHJpbmcgZm9yIGRhdGF0YWJsZXMgZmlsdGVyaW5nCiAgICAgICAgZnVuY3Rpb24geWFkY2ZNYXRjaEZpbHRlclN0cmluZyh0YWJsZV9hcmcsIGNvbHVtbl9udW1iZXIsIHNlbGVjdGVkX3ZhbHVlLCBmaWx0ZXJfbWF0Y2hfbW9kZSwgbXVsdGlwbGUsIGV4Y2x1ZGUpIHsKICAgICAgICAgICAgdmFyIGNhc2VfaW5zZW5zaXRpdmUgPSB5YWRjZi5nZXRPcHRpb25zKHRhYmxlX2FyZy5zZWxlY3RvcilbY29sdW1uX251bWJlcl0uY2FzZV9pbnNlbnNpdGl2ZSwKICAgICAgICAgICAgICAgIHJldF92YWw7CgogICAgICAgICAgICBpZiAoIXNlbGVjdGVkX3ZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9udW1iZXJdLmJTbWFydCA9IGZhbHNlOwogICAgICAgICAgICB0YWJsZV9hcmcuZm5TZXR0aW5ncygpLmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fbnVtYmVyXS5iUmVnZXggPSB0cnVlOwogICAgICAgICAgICB0YWJsZV9hcmcuZm5TZXR0aW5ncygpLmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fbnVtYmVyXS5iQ2FzZUluc2Vuc2l0aXZlID0gY2FzZV9pbnNlbnNpdGl2ZTsKCiAgICAgICAgICAgIGlmIChtdWx0aXBsZSA9PT0gdW5kZWZpbmVkIHx8IG11bHRpcGxlID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgaWYgKGV4Y2x1ZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJjb250YWlucyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uYlNtYXJ0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uYlJlZ2V4ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldF92YWwgPSBzZWxlY3RlZF92YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAiZXhhY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldF92YWwgPSAiXiIgKyBzZWxlY3RlZF92YWx1ZSArICIkIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAic3RhcnRzV2l0aCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0X3ZhbCA9ICJeIiArIHNlbGVjdGVkX3ZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJyZWdleCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0X3ZhbCA9IHNlbGVjdGVkX3ZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0X3ZhbCA9ICJeKCg/ISIgKyBzZWxlY3RlZF92YWx1ZSArICIpLikqJCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX21hdGNoX21vZGUgIT09ICdyZWdleCcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIShzZWxlY3RlZF92YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZF92YWx1ZSA9IFtzZWxlY3RlZF92YWx1ZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlID0gZXNjYXBlUmVnRXhwSW5BcnJheShzZWxlY3RlZF92YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJjb250YWlucyIpIHsKICAgICAgICAgICAgICAgICAgICByZXRfdmFsID0gc2VsZWN0ZWRfdmFsdWUuam9pbigifCIpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImV4YWN0IikgewogICAgICAgICAgICAgICAgICAgIHJldF92YWwgPSAiXigiICsgc2VsZWN0ZWRfdmFsdWUuam9pbigifCIpICsgIikkIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewogICAgICAgICAgICAgICAgICAgIHJldF92YWwgPSAiXigiICsgc2VsZWN0ZWRfdmFsdWUuam9pbigifCIpICsgIikiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gInJlZ2V4IikgewogICAgICAgICAgICAgICAgICAgIHJldF92YWwgPSBzZWxlY3RlZF92YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0X3ZhbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHlhZGNmTWF0Y2hGaWx0ZXIob1RhYmxlLCBzZWxlY3RlZF92YWx1ZSwgZmlsdGVyX21hdGNoX21vZGUsIGNvbHVtbl9udW1iZXIsIGV4Y2x1ZGUsIG9yaWdpbmFsX2NvbHVtbl9udW1iZXIpIHsKICAgICAgICAgICAgdmFyIGNhc2VfaW5zZW5zaXRpdmUgPSB5YWRjZi5nZXRPcHRpb25zKG9UYWJsZS5zZWxlY3Rvcilbb3JpZ2luYWxfY29sdW1uX251bWJlcl0uY2FzZV9pbnNlbnNpdGl2ZTsKICAgICAgICAgICAgaWYgKGV4Y2x1ZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImNvbnRhaW5zIikgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcihzZWxlY3RlZF92YWx1ZSwgY29sdW1uX251bWJlciwgZmFsc2UsIHRydWUsIHRydWUsIGNhc2VfaW5zZW5zaXRpdmUpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImV4YWN0IikgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlID0gZXNjYXBlUmVnRXhwKHNlbGVjdGVkX3ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoIl4iICsgc2VsZWN0ZWRfdmFsdWUgKyAiJCIsIGNvbHVtbl9udW1iZXIsIHRydWUsIGZhbHNlLCB0cnVlLCBjYXNlX2luc2Vuc2l0aXZlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlID0gZXNjYXBlUmVnRXhwKHNlbGVjdGVkX3ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoIl4iICsgc2VsZWN0ZWRfdmFsdWUsIGNvbHVtbl9udW1iZXIsIHRydWUsIGZhbHNlLCB0cnVlLCBjYXNlX2luc2Vuc2l0aXZlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJyZWdleCIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAvL3ZhbGlkYXRlIHJlZ2V4LCBvbmx5IGNhbGwgZm5GaWx0ZXIgaWYgdmFsaWQKICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFJlZ0V4cChzZWxlY3RlZF92YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoc2VsZWN0ZWRfdmFsdWUsIGNvbHVtbl9udW1iZXIsIHRydWUsIGZhbHNlLCB0cnVlLCBjYXNlX2luc2Vuc2l0aXZlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcigiXigoPyEiICsgc2VsZWN0ZWRfdmFsdWUgKyAiKS4pKiQiLCBjb2x1bW5fbnVtYmVyLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgY2FzZV9pbnNlbnNpdGl2ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24geWFkY2ZQYXJzZU1hdGNoRmlsdGVyKHRtcFN0ciwgZmlsdGVyX21hdGNoX21vZGUpIHsKICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAiY29udGFpbnMiKSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSB0bXBTdHI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJleGFjdCIpIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHRtcFN0ci5zdWJzdHJpbmcoMSwgdG1wU3RyLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgcmV0VmFsID0gcmV0VmFsLnJlcGxhY2UoLyhbXFxdKS9nLCAnJyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewogICAgICAgICAgICAgICAgcmV0VmFsID0gdG1wU3RyLnN1YnN0cmluZygxLCB0bXBTdHIubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJldFZhbC5yZXBsYWNlKC8oW1xcXSkvZywgJycpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAicmVnZXgiKSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSB0bXBTdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldFZhbDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRvRmlsdGVyQ3VzdG9tRGF0ZUZ1bmMoYXJnLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlcikgewogICAgICAgICAgICB2YXIgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0sCiAgICAgICAgICAgICAgICB5YWRjZlN0YXRlLAogICAgICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJ2NsZWFyJyAmJiBleEdldENvbHVtbkZpbHRlclZhbChvVGFibGUsIGNvbHVtbl9udW1iZXIpID09PSAnJykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYXJnLnZhbHVlICE9PSB1bmRlZmluZWQgJiYgYXJnLnZhbHVlICE9PSAiLTEiKSB7CiAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy93ZWhuIGFyZyA9PT0gJ2NsZWFyJyBvciBhcmcudmFsdWUgPT09ICctMScKICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikudmFsKCctMScpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgcmVmcmVzaFNlbGVjdFBsdWdpbihjb2x1bW5PYmosICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksICctMScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgIT09IHVuZGVmaW5lZCAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0gPQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiBhcmcudmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgICAgIHlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldID0gW107CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IGFyZy52YWx1ZQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSA9IHlhZGNmU3RhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9BcGkuX2ZuU2F2ZVN0YXRlKG9UYWJsZS5mblNldHRpbmdzKCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvVGFibGUuZm5EcmF3KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KSB7CiAgICAgICAgICAgIHZhciBjb2x1bW5fbnVtYmVyX2ZpbHRlcjsKICAgICAgICAgICAgaWYgKChzZXR0aW5nc0R0Lm9TYXZlZFN0YXRlICYmIHNldHRpbmdzRHQub1NhdmVkU3RhdGUuQ29sUmVvcmRlciAhPT0gdW5kZWZpbmVkKSB8fAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdC5fY29sUmVvcmRlciB8fAogICAgICAgICAgICAgICAgKHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldICE9PSB1bmRlZmluZWQgJiYgcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0uQ29sUmVvcmRlciAhPT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgICAgICAgaW5pdENvbFJlb3JkZXIyKHNldHRpbmdzRHQsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KTsKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0uQ29sUmVvcmRlcltjb2x1bW5fbnVtYmVyXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY29sdW1uX251bWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29sdW1uX251bWJlcl9maWx0ZXI7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb0ZpbHRlcihhcmcsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyLCBmaWx0ZXJfbWF0Y2hfbW9kZSkgewogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwoKICAgICAgICAgICAgdmFyIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRfdmFsdWUsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIHNldHRpbmdzRHQgPSBnZXRTZXR0aW5nc09iakZyb21UYWJsZShvVGFibGUpOwoKICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KTsKCiAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXTsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gImNsZWFyIikgewogICAgICAgICAgICAgICAgaWYgKGV4R2V0Q29sdW1uRmlsdGVyVmFsKG9UYWJsZSwgY29sdW1uX251bWJlcikgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS52YWwoIi0xIikuZm9jdXMoKTsKICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5kYXRhKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiX3ZhbCIsICItMSIpOwogICAgICAgICAgICAgICAgb1RhYmxlLmZuRmlsdGVyKCIiLCBjb2x1bW5fbnVtYmVyX2ZpbHRlcik7CiAgICAgICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwoKICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4oY29sdW1uT2JqLCAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLCAnLTEnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS5hZGRDbGFzcygiaW51c2UiKTsKCiAgICAgICAgICAgICQoZG9jdW1lbnQpLmRhdGEoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJfdmFsIiwgYXJnLnZhbHVlKTsKCiAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlID0gJC50cmltKCQoYXJnKS5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS52YWwoKSk7CgogICAgICAgICAgICBpZiAoYXJnLnZhbHVlICE9PSAiLTEiKSB7CiAgICAgICAgICAgICAgICB5YWRjZk1hdGNoRmlsdGVyKG9UYWJsZSwgc2VsZWN0ZWRfdmFsdWUsIGZpbHRlcl9tYXRjaF9tb2RlLCBjb2x1bW5fbnVtYmVyX2ZpbHRlciwgZmFsc2UsIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgb1RhYmxlLmZuRmlsdGVyKCIiLCBjb2x1bW5fbnVtYmVyX2ZpbHRlcik7CiAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb0ZpbHRlck11bHRpU2VsZWN0KGFyZywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGZpbHRlcl9tYXRjaF9tb2RlKSB7CiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIHZhciBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlcyA9ICQoYXJnKS52YWwoKSwKICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlc190cmltbWVkID0gW10sCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgc3RyaW5nRm9yU2VhcmNoLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIsCiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUob1RhYmxlKTsKCiAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY2FsY0NvbHVtbk51bWJlckZpbHRlcihzZXR0aW5nc0R0LCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CiAgICAgICAgICAgICQoZG9jdW1lbnQpLmRhdGEoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJfdmFsIiwgc2VsZWN0ZWRfdmFsdWVzKTsKCiAgICAgICAgICAgIGlmIChzZWxlY3RlZF92YWx1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IHNlbGVjdGVkX3ZhbHVlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZF92YWx1ZXNbaV0gPT09ICItMSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfdmFsdWVzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbGVjdGVkX3ZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlc190cmltbWVkLnB1c2goJC50cmltKHNlbGVjdGVkX3ZhbHVlc1tpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkX3ZhbHVlc190cmltbWVkLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9tYXRjaF9tb2RlICE9PSAicmVnZXgiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ0ZvclNlYXJjaCA9IHNlbGVjdGVkX3ZhbHVlc190cmltbWVkLmpvaW4oJ25hcnV0b3V6b21ha2knKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nRm9yU2VhcmNoID0gc3RyaW5nRm9yU2VhcmNoLnJlcGxhY2UoLyhbLiorP149IToke30oKXxcW1xdXC9cXF0pL2csICJcXCQxIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ0ZvclNlYXJjaCA9IHN0cmluZ0ZvclNlYXJjaC5zcGxpdCgnbmFydXRvdXpvbWFraScpLmpvaW4oJ3wnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAiY29udGFpbnMiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoc3RyaW5nRm9yU2VhcmNoLCBjb2x1bW5fbnVtYmVyX2ZpbHRlciwgdHJ1ZSwgZmFsc2UsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAiZXhhY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoIl4oIiArIHN0cmluZ0ZvclNlYXJjaCArICIpJCIsIGNvbHVtbl9udW1iZXJfZmlsdGVyLCB0cnVlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuRmlsdGVyKCJeKCIgKyBzdHJpbmdGb3JTZWFyY2ggKyAiKSIsIGNvbHVtbl9udW1iZXJfZmlsdGVyLCB0cnVlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdGb3JTZWFyY2ggPSBzZWxlY3RlZF92YWx1ZXNfdHJpbW1lZC5qb2luKCd8Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcihzdHJpbmdGb3JTZWFyY2gsIGNvbHVtbl9udW1iZXJfZmlsdGVyLCB0cnVlLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcigiIiwgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcigiIiwgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB5YWRjZlBhcnNlTWF0Y2hGaWx0ZXJNdWx0aVNlbGVjdCh0bXBTdHIsIGZpbHRlcl9tYXRjaF9tb2RlKSB7CiAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImNvbnRhaW5zIikgewogICAgICAgICAgICAgICAgcmV0VmFsID0gdG1wU3RyOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAiZXhhY3QiKSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSB0bXBTdHIuc3Vic3RyaW5nKDEsIHRtcFN0ci5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJldFZhbC5zdWJzdHJpbmcoMSwgcmV0VmFsLmxlbmd0aCAtIDEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcl9tYXRjaF9tb2RlID09PSAic3RhcnRzV2l0aCIpIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHRtcFN0ci5zdWJzdHJpbmcoMSwgdG1wU3RyLmxlbmd0aCk7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZXRWYWwuc3Vic3RyaW5nKDEsIHJldFZhbC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWx0ZXJfbWF0Y2hfbW9kZSA9PT0gInJlZ2V4IikgewogICAgICAgICAgICAgICAgcmV0VmFsID0gdG1wU3RyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXRWYWw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkb0ZpbHRlckF1dG9jb21wbGV0ZShhcmcsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyLCBmaWx0ZXJfbWF0Y2hfbW9kZSkgewogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICB2YXIgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0sCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgIHNldHRpbmdzRHQgPSBnZXRTZXR0aW5nc09iakZyb21UYWJsZShvVGFibGUpOwoKICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KTsKCiAgICAgICAgICAgIGlmIChhcmcgPT09ICJjbGVhciIpIHsKICAgICAgICAgICAgICAgIGlmIChleEdldENvbHVtbkZpbHRlclZhbChvVGFibGUsIGNvbHVtbl9udW1iZXIpID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikudmFsKCIiKS5mb2N1cygpOwogICAgICAgICAgICAgICAgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLnJlbW92ZURhdGEoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJfdmFsIik7CiAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoIiIsIGNvbHVtbl9udW1iZXJfZmlsdGVyKTsKICAgICAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikuYWRkQ2xhc3MoImludXNlIik7CgogICAgICAgICAgICAkKGRvY3VtZW50KS5kYXRhKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiX3ZhbCIsIGFyZy52YWx1ZSk7CgogICAgICAgICAgICB5YWRjZk1hdGNoRmlsdGVyKG9UYWJsZSwgYXJnLnZhbHVlLCBmaWx0ZXJfbWF0Y2hfbW9kZSwgY29sdW1uX251bWJlcl9maWx0ZXIsIGZhbHNlLCBjb2x1bW5fbnVtYmVyKTsKCiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhdXRvY29tcGxldGVTZWxlY3QoZXZlbnQsIHVpKSB7CiAgICAgICAgICAgIHZhciB0YWJsZV9jb2x1bW4sCiAgICAgICAgICAgICAgICBkYXNoSW5kZXgsCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgIGNvbF9udW0sCiAgICAgICAgICAgICAgICBmaWx0ZXJfbWF0Y2hfbW9kZTsKCiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnRUYXJnZXRGaXhVcChldmVudCk7CiAgICAgICAgICAgIHRhYmxlX2NvbHVtbiA9IGV2ZW50LnRhcmdldC5pZC5yZXBsYWNlKCJ5YWRjZi1maWx0ZXItIiwgIiIpOwogICAgICAgICAgICBkYXNoSW5kZXggPSB0YWJsZV9jb2x1bW4ubGFzdEluZGV4T2YoIi0iKTsKICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB0YWJsZV9jb2x1bW4uc3Vic3RyaW5nKDAsIGRhc2hJbmRleCk7CiAgICAgICAgICAgIGNvbF9udW0gPSBwYXJzZUludCh0YWJsZV9jb2x1bW4uc3Vic3RyaW5nKGRhc2hJbmRleCArIDEpLCAxMCk7CiAgICAgICAgICAgIGZpbHRlcl9tYXRjaF9tb2RlID0gJChldmVudC50YXJnZXQpLmF0dHIoImZpbHRlcl9tYXRjaF9tb2RlIik7CgogICAgICAgICAgICBkb0ZpbHRlckF1dG9jb21wbGV0ZSh1aS5pdGVtLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sX251bSwgZmlsdGVyX21hdGNoX21vZGUpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc29ydE51bUFzYyhhLCBiKSB7CiAgICAgICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNvcnROdW1EZXNjKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGIgLSBhOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmluZE1pbkluQXJyYXkoYXJyYXksIGNvbHVtbk9iaikgewogICAgICAgICAgICB2YXIgbmFycmF5ID0gW10sCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbnVtLAogICAgICAgICAgICAgICAgbWluOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheVtpXSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouaWdub3JlX2NoYXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBhcnJheVtpXSA9IGFycmF5W2ldLnRvU3RyaW5nKCkucmVwbGFjZShjb2x1bW5PYmouaWdub3JlX2NoYXIsICIiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5yYW5nZV9kYXRhX3R5cGUgPT09ICdzaW5nbGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9ICthcnJheVtpXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBudW0gPSBhcnJheVtpXS5zcGxpdChjb2x1bW5PYmoucmFuZ2VfZGF0YV90eXBlX2RlbGltKTsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gbnVtWzBdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKG51bSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFycmF5LnB1c2gobnVtKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWluID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgbmFycmF5KTsKICAgICAgICAgICAgaWYgKCFpc0Zpbml0ZShtaW4pKSB7CiAgICAgICAgICAgICAgICBtaW4gPSAwOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1pbiAhPT0gMCkgewogICAgICAgICAgICAgICAgaWYgKG1pbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICBtaW4gPSBNYXRoLmZsb29yKG1pbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1pbiA9IC0xICogTWF0aC5jZWlsKG1pbiAqIC0xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG1pbjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZpbmRNYXhJbkFycmF5KGFycmF5LCBjb2x1bW5PYmopIHsKICAgICAgICAgICAgdmFyIG5hcnJheSA9IFtdLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIG51bSwKICAgICAgICAgICAgICAgIG1heDsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlbaV0gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmlnbm9yZV9jaGFyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlbaV0gPSBhcnJheVtpXS50b1N0cmluZygpLnJlcGxhY2UoY29sdW1uT2JqLmlnbm9yZV9jaGFyLCAiIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmoucmFuZ2VfZGF0YV90eXBlID09PSAnc2luZ2xlJykgewogICAgICAgICAgICAgICAgICAgICAgICBudW0gPSArYXJyYXlbaV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbnVtID0gYXJyYXlbaV0uc3BsaXQoY29sdW1uT2JqLnJhbmdlX2RhdGFfdHlwZV9kZWxpbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG51bSA9IG51bVsxXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc05hTihudW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hcnJheS5wdXNoKG51bSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG1heCA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIG5hcnJheSk7CiAgICAgICAgICAgIGlmICghaXNGaW5pdGUobWF4KSkgewogICAgICAgICAgICAgICAgbWF4ID0gMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1heCA9IE1hdGguY2VpbChtYXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXg7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRSYW5nZU51bWJlckFuZFNsaWRlckZpbHRlckNhcGFiaWxpdHkodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGZyb21JZCwgdG9JZCwgY29sX251bSwgaWdub3JlX2NoYXIsIHNsaWRlck1heE1pbikgewoKICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuYWZuRmlsdGVyaW5nLnB1c2goCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2V0dGluZ3NEdCwgYURhdGEsIGlEYXRhSW5kZXgsIHJvd0RhdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbWluLAogICAgICAgICAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5X2xvY2FsID0gdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5MihzZXR0aW5nc0R0KSwKICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlX2NoYXJfbG9jYWwgPSBpZ25vcmVfY2hhciwKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGFfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgaHRtbF9kYXRhX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbEZyb20sCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbFRvOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHlfbG9jYWwgIT09IGN1cnJlbnRfdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMoc2V0dGluZ3NEdC5vSW5zdGFuY2Uuc2VsZWN0b3IpW2NvbF9udW1dOwogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICdyYW5nZV9udW1iZXJfc2xpZGVyJykgewogICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSAkKCcjJyArIGZyb21JZCkudGV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAkKCcjJyArIHRvSWQpLnRleHQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSAkKCcjJyArIGZyb21JZCkudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9ICQoJyMnICsgdG9JZCkudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IGNhbGNDb2x1bW5OdW1iZXJGaWx0ZXIoc2V0dGluZ3NEdCwgY29sX251bSwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwoKICAgICAgICAgICAgICAgICAgICBpZiAocm93RGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFEYXRhID0gcm93RGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyX2RhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZG90Mm9iaihhRGF0YSwgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gYURhdGFbY29sdW1uX251bWJlcl9maWx0ZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gYURhdGFbY29sdW1uX251bWJlcl9maWx0ZXJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRmluaXRlKG1pbikgfHwgIWlzRmluaXRlKG1heCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhX3R5cGUgPSBjb2x1bW5PYmouY29sdW1uX2RhdGFfdHlwZTsKICAgICAgICAgICAgICAgICAgICBodG1sX2RhdGFfdHlwZSA9IGNvbHVtbk9iai5odG1sX2RhdGFfdHlwZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbl9kYXRhX3R5cGUgPT09ICJodG1sIiB8fCBjb2x1bW5fZGF0YV90eXBlID09PSAicmVuZGVyZWRfaHRtbCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWxfZGF0YV90eXBlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxfZGF0YV90eXBlID0gInRleHQiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHZhbCkubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGh0bWxfZGF0YV90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICQodmFsKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhbHVlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gJCh2YWwpLnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJpZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0b3IiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAkKHZhbCkuZmluZChjb2x1bW5PYmouaHRtbF9kYXRhX3NlbGVjdG9yKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmh0bWw1X2RhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbFsnQCcgKyBjb2x1bW5PYmouaHRtbDVfZGF0YV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlnbm9yZV9jaGFyX2xvY2FsICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gbWluLnJlcGxhY2UoaWdub3JlX2NoYXJfbG9jYWwsICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gbWF4LnJlcGxhY2UoaWdub3JlX2NoYXJfbG9jYWwsICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdmFsLnRvU3RyaW5nKCkucmVwbGFjZShpZ25vcmVfY2hhcl9sb2NhbCwgIiIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy9vbWl0IGVtcHR5IHJvd3Mgd2hlbiBmaWx0ZXJpbmcKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAncmFuZ2VfbnVtYmVyX3NsaWRlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gJycgJiYgKCgrbWluKSAhPT0gc2xpZGVyTWF4TWluLm1pbiB8fCAoK21heCkgIT09IHNsaWRlck1heE1pbi5tYXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09PSAnJyAmJiAobWluICE9PSAnJyB8fCBtYXggIT09ICcnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1pbiA9IChtaW4gIT09ICIiKSA/ICgrbWluKSA6IG1pbjsKICAgICAgICAgICAgICAgICAgICBtYXggPSAobWF4ICE9PSAiIikgPyAoK21heCkgOiBtYXg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5yYW5nZV9kYXRhX3R5cGUgPT09ICdzaW5nbGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICh2YWwgIT09ICIiKSA/ICgrdmFsKSA6IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbiA9PT0gIiIgJiYgbWF4ID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtaW4gPT09ICIiICYmIHZhbCA8PSBtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWluIDw9IHZhbCAmJiAiIiA9PT0gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1pbiA8PSB2YWwgJiYgdmFsIDw9IG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgPT09ICcnIHx8IGlzTmFOKHZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5yYW5nZV9kYXRhX3R5cGUgPT09ICdyYW5nZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdmFsLnNwbGl0KGNvbHVtbk9iai5yYW5nZV9kYXRhX3R5cGVfZGVsaW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxGcm9tID0gKHZhbFswXSAhPT0gIiIpID8gKCt2YWxbMF0pIDogdmFsWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxUbyA9ICh2YWxbMV0gIT09ICIiKSA/ICgrdmFsWzFdKSA6IHZhbFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbiA9PT0gIiIgJiYgbWF4ID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtaW4gPT09ICIiICYmIHZhbFRvIDw9IG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtaW4gPD0gdmFsRnJvbSAmJiAiIiA9PT0gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1pbiA8PSB2YWxGcm9tICYmIHZhbFRvIDw9IG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgodmFsRnJvbSA9PT0gJycgfHwgaXNOYU4odmFsRnJvbSkpICYmICh2YWxUbyA9PT0gJycgfHwgaXNOYU4odmFsVG8pKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0VmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkQ3VzdG9tRnVuY3Rpb25GaWx0ZXJDYXBhYmlsaXR5KHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBmaWx0ZXJJZCwgY29sX251bSkgewoKICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuYWZuRmlsdGVyaW5nLnB1c2goCiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoc2V0dGluZ3NEdCwgYURhdGEsIGlEYXRhSW5kZXgsIHN0YXRlVmFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpbHRlclZhbCA9ICQoJyMnICsgZmlsdGVySWQpLnZhbCgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5WYWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV9sb2NhbCA9IHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LAogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ID0geWFkY2YuZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseTIoc2V0dGluZ3NEdCksCiAgICAgICAgICAgICAgICAgICAgICAgIGN1c3RvbV9mdW5jLAogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlcjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5X2xvY2FsICE9PSBjdXJyZW50X3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5IHx8IGZpbHRlclZhbCA9PT0gJy0xJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY2FsY0NvbHVtbk51bWJlckZpbHRlcihzZXR0aW5nc0R0LCBjb2xfbnVtLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CgogICAgICAgICAgICAgICAgICAgIGNvbHVtblZhbCA9IGFEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXSA9PT0gIi0iID8gMCA6IGFEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXTsKCiAgICAgICAgICAgICAgICAgICAgY3VzdG9tX2Z1bmMgPSBnZXRPcHRpb25zKHNldHRpbmdzRHQub0luc3RhbmNlLnNlbGVjdG9yKVtjb2xfbnVtXS5jdXN0b21fZnVuYzsKCiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gY3VzdG9tX2Z1bmMoZmlsdGVyVmFsLCBjb2x1bW5WYWwsIGFEYXRhLCBzdGF0ZVZhbCk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXRWYWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFJhbmdlRGF0ZUZpbHRlckNhcGFiaWxpdHkodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGZyb21JZCwgdG9JZCwgY29sX251bSwgZGF0ZV9mb3JtYXQpIHsKCiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmFmbkZpbHRlcmluZy5wdXNoKAogICAgICAgICAgICAgICAgZnVuY3Rpb24gKHNldHRpbmdzRHQsIGFEYXRhLCBpRGF0YUluZGV4LCByb3dEYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1pbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZyb21JZCkgIT09IG51bGwgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcm9tSWQpLnZhbHVlIDogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRvSWQpICE9PSBudWxsID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodG9JZCkudmFsdWUgOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgdmFsLAogICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHlfbG9jYWwgPSB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF90YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSA9IHlhZGNmLmdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKHNldHRpbmdzRHQpLAogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YV90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICBodG1sX2RhdGFfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uT2JqLAogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgICAgICAgICAgbWluX3RpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG1heF90aW1lLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUmVuZGVyRnVuYywKICAgICAgICAgICAgICAgICAgICAgICAgZHBnOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHlfbG9jYWwgIT09IGN1cnJlbnRfdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMoc2V0dGluZ3NEdC5vSW5zdGFuY2Uuc2VsZWN0b3IpW2NvbF9udW1dOwogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRwZyA9ICQuZm4uZGF0ZXBpY2tlci5EUEdsb2JhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbF9udW0sIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyX2RhdGEgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyX3JlbmRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICBkYXRhUmVuZGVyRnVuYyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChyb3dEYXRhICE9PSB1bmRlZmluZWQgJiYgZGF0YVJlbmRlckZ1bmMgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyX2RhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZG90Mm9iaihyb3dEYXRhLCBjb2x1bW5fbnVtYmVyX2ZpbHRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSByb3dEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGFEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhX3R5cGUgPSBjb2x1bW5PYmouY29sdW1uX2RhdGFfdHlwZTsKICAgICAgICAgICAgICAgICAgICBodG1sX2RhdGFfdHlwZSA9IGNvbHVtbk9iai5odG1sX2RhdGFfdHlwZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbl9kYXRhX3R5cGUgPT09ICJodG1sIiB8fCBjb2x1bW5fZGF0YV90eXBlID09PSAicmVuZGVyZWRfaHRtbCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWxfZGF0YV90eXBlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxfZGF0YV90eXBlID0gInRleHQiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHZhbCkubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGh0bWxfZGF0YV90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9ICQodmFsKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhbHVlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gJCh2YWwpLnZhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJpZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0b3IiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAkKHZhbCkuZmluZChjb2x1bW5PYmouaHRtbF9kYXRhX3NlbGVjdG9yKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmh0bWw1X2RhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdmFsWydAJyArIGNvbHVtbk9iai5odG1sNV9kYXRhXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy9vbWl0IGVtcHR5IHJvd3Mgd2hlbiBmaWx0ZXJpbmcKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID09PSAnJyAmJiAobWluICE9PSAnJyB8fCBtYXggIT09ICcnKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaW4ubGVuZ3RoID09PSAoZGF0ZV9mb3JtYXQubGVuZ3RoICsgMikgfHwgY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZS5pbmRleE9mKCdib290c3RyYXAnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnanF1ZXJ5LXVpJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9IChtaW4gIT09ICIiKSA/ICQuZGF0ZXBpY2tlci5wYXJzZURhdGUoZGF0ZV9mb3JtYXQsIG1pbikgOiBtaW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gKG1pbiAhPT0gIiIpID8gbW9tZW50KG1pbiwgY29sdW1uT2JqLm1vbWVudF9kYXRlX2Zvcm1hdCkudG9EYXRlKCkgOiBtaW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSAobWluICE9PSAiIikgPyBkcGcucGFyc2VEYXRlKG1pbiwgZHBnLnBhcnNlRm9ybWF0KGNvbHVtbk9iai5kYXRlX2Zvcm1hdCkpIDogbWluOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyMSkge30KICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4Lmxlbmd0aCA9PT0gKGRhdGVfZm9ybWF0Lmxlbmd0aCArIDIpIHx8IGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUuaW5kZXhPZignYm9vdHN0cmFwJykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2pxdWVyeS11aScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAobWF4ICE9PSAiIikgPyAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKGRhdGVfZm9ybWF0LCBtYXgpIDogbWF4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGV0aW1lcGlja2VyJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IChtYXggIT09ICIiKSA/IG1vbWVudChtYXgsIGNvbHVtbk9iai5tb21lbnRfZGF0ZV9mb3JtYXQpLnRvRGF0ZSgpIDogbWF4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gKG1heCAhPT0gIiIpID8gZHBnLnBhcnNlRGF0ZShtYXgsIGRwZy5wYXJzZUZvcm1hdChjb2x1bW5PYmouZGF0ZV9mb3JtYXQpKSA6IG1heDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycjIpIHt9CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsICE9PSAiIikgPyAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKGRhdGVfZm9ybWF0LCB2YWwpIDogdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsICE9PSAiIikgPyBtb21lbnQodmFsLCBjb2x1bW5PYmoubW9tZW50X2RhdGVfZm9ybWF0KS50b0RhdGUoKSA6IHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAodmFsICE9PSAiIikgPyBkcGcucGFyc2VEYXRlKHZhbCwgZHBnLnBhcnNlRm9ybWF0KGNvbHVtbk9iai5kYXRlX2Zvcm1hdCkpIDogdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyMykge30KCiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGVfZm9ybWF0LnRvTG93ZXJDYXNlKCkgIT09ICdoaDptbScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtaW4gPT09ICIiIHx8ICEobWluIGluc3RhbmNlb2YgRGF0ZSkpICYmIChtYXggPT09ICIiIHx8ICEobWF4IGluc3RhbmNlb2YgRGF0ZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1pbiA9PT0gIiIgJiYgdmFsIDw9IG1heCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtaW4gPD0gdmFsICYmICIiID09PSBtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWluIDw9IHZhbCAmJiB2YWwgPD0gbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluX3RpbWUgPSBtb21lbnQobWluKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWluX3RpbWUgPSBtaW5fdGltZS5taW51dGVzKCkgKyBtaW5fdGltZS5ob3VycygpICogNjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc05hTihtaW5fdGltZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbl90aW1lID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbWF4X3RpbWUgPSBtb21lbnQobWF4KTsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4X3RpbWUgPSBtYXhfdGltZS5taW51dGVzKCkgKyBtYXhfdGltZS5ob3VycygpICogNjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc05hTihtYXhfdGltZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF90aW1lID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gbW9tZW50KHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5taW51dGVzKCkgKyB2YWwuaG91cnMoKSAqIDYwOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtaW4gPT09ICIiIHx8ICEobW9tZW50KG1pbiwgZGF0ZV9mb3JtYXQpLmlzVmFsaWQoKSkpICYmIChtYXggPT09ICIiIHx8ICEobW9tZW50KG1heCwgZGF0ZV9mb3JtYXQpLmlzVmFsaWQoKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1pbl90aW1lID09PSAiIiAmJiB2YWwgPD0gbWF4X3RpbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWluX3RpbWUgPD0gdmFsICYmICIiID09PSBtYXhfdGltZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtaW5fdGltZSA8PSB2YWwgJiYgdmFsIDw9IG1heF90aW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXRWYWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRSYW5nZU51bWJlckZpbHRlcihmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlciwgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0LCBmaWx0ZXJfZGVmYXVsdF9sYWJlbCwgaWdub3JlX2NoYXIpIHsKICAgICAgICAgICAgdmFyIGZyb21JZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi1mcm9tLSIgKyBjb2x1bW5fbnVtYmVyLAogICAgICAgICAgICAgICAgdG9JZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi10by0iICsgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wLAogICAgICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQsCiAgICAgICAgICAgICAgICBvVGFibGUsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHI7CgogICAgICAgICAgICBmaWx0ZXJfd3JhcHBlcl9pZCA9ICJ5YWRjZi1maWx0ZXItd3JhcHBlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyOwoKICAgICAgICAgICAgaWYgKCQoIiMiICsgZmlsdGVyX3dyYXBwZXJfaWQpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgLy9hZGQgYSB3cmFwcGVyIHRvIGhvbGQgYm90aCBmaWx0ZXIgYW5kIHJlc2V0IGJ1dHRvbgogICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgb25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIGlkPVwiIiArIGZpbHRlcl93cmFwcGVyX2lkICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXdyYXBwZXIgIiArIGNvbHVtbk9iai5zdHlsZV9jbGFzcyArICJcIj48L2Rpdj4iKTsKICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiIGRpdi55YWRjZi1maWx0ZXItd3JhcHBlciI7CiAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wID0gZmlsdGVyX3NlbGVjdG9yX3N0cmluZzsKCiAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8ZGl2IGlkPVwieWFkY2YtZmlsdGVyLXdyYXBwZXItaW5uZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci13cmFwcGVyLWlubmVyIiArICIgLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiXCI+PC9kaXY+Iik7CiAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgKz0gIiBkaXYueWFkY2YtZmlsdGVyLXdyYXBwZXItaW5uZXIiOwoKICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJ29ua2V5dXA9InlhZGNmLnJhbmdlTnVtYmVyS2V5VVAoXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnXCcsZXZlbnQpOyInOwogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxpbnB1dCBvbmtleWRvd249XCJ5YWRjZi5wcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2ZW50KTtcIiBwbGFjZWhvbGRlcj1cIiIgKyBmaWx0ZXJfZGVmYXVsdF9sYWJlbFswXSArICJcIiBpZD1cIiIgKyBmcm9tSWQgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyIHlhZGNmLWZpbHRlci1yYW5nZVwiICIgKyBmaWx0ZXJBY3Rpb25TdHIgKyAiPjwvaW5wdXQ+Iik7CiAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8c3BhbiBjbGFzcz1cInlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2VwZXJhdG9yXCIgPiIgKwogICAgICAgICAgICAgICAgIjwvc3Bhbj4iKTsKICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxpbnB1dCBvbmtleWRvd249XCJ5YWRjZi5wcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2ZW50KTtcIiBwbGFjZWhvbGRlcj1cIiIgKyBmaWx0ZXJfZGVmYXVsdF9sYWJlbFsxXSArICJcIiBpZD1cIiIgKyB0b0lkICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlciB5YWRjZi1maWx0ZXItcmFuZ2VcIiAiICsgZmlsdGVyQWN0aW9uU3RyICsgIj48L2lucHV0PiIpOwoKICAgICAgICAgICAgaWYgKGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZ190bXApLmFwcGVuZCgiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiICIgKwogICAgICAgICAgICAgICAgICAgICJvbmNsaWNrPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi5yYW5nZUNsZWFyKCciICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiJyxldmVudCwiICsgY29sdW1uX251bWJlciArICIpOyByZXR1cm4gZmFsc2U7XCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmVzZXQtYnV0dG9uICIgKyBjb2x1bW5PYmoucmVzZXRfYnV0dG9uX3N0eWxlX2NsYXNzICsgIlwiPiIgKyBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgKyAiPC9idXR0b24+Iik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlICYmIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSkgewogICAgICAgICAgICAgICAgICAgICQoJyMnICsgZnJvbUlkKS52YWwob1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0uZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb20gIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgZnJvbUlkKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS52YWwob1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0udG8pOwogICAgICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXS50byAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRJQXBpSW5kZXgoKTsKCiAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgYWRkUmFuZ2VOdW1iZXJBbmRTbGlkZXJGaWx0ZXJDYXBhYmlsaXR5KHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBmcm9tSWQsIHRvSWQsIGNvbHVtbl9udW1iZXIsIGlnbm9yZV9jaGFyKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRhdGVTZWxlY3RTaW5nbGUocERhdGUsIHBFdmVudCwgY2xlYXIpIHsKICAgICAgICAgICAgdmFyIG9UYWJsZSwKICAgICAgICAgICAgICAgIGRhdGUsCiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICBkYXNoSW5kZXgsCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGNvbHVtbk9iajsKCiAgICAgICAgICAgIGlmIChwRGF0ZS50eXBlID09PSAnZHAnKSB7CiAgICAgICAgICAgICAgICBldmVudCA9IHBEYXRlLnRhcmdldDsKICAgICAgICAgICAgfSBlbHNlIGlmIChwRGF0ZS50eXBlID09PSAnY2hhbmdlRGF0ZScpIHsKICAgICAgICAgICAgICAgIGV2ZW50ID0gcERhdGUuY3VycmVudFRhcmdldDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRhdGUgPSBwRGF0ZTsKICAgICAgICAgICAgICAgIGV2ZW50ID0gcEV2ZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gJChldmVudCkuYXR0cignaWQnKS5yZXBsYWNlKCd5YWRjZi1maWx0ZXItJywgJycpLnJlcGxhY2UoJy1kYXRlJywgJycpLnJlcGxhY2UoJy1yZXNldCcsICcnKTsKICAgICAgICAgICAgZGFzaEluZGV4ID0gY29sdW1uX251bWJlci5sYXN0SW5kZXhPZigiLSIpOwogICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSA9IGNvbHVtbl9udW1iZXIuc3Vic3RyaW5nKDAsIGRhc2hJbmRleCk7CgogICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gY29sdW1uX251bWJlci5zdWJzdHJpbmcoZGFzaEluZGV4ICsgMSk7CiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUob1RhYmxlKTsKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgaWYgKHBEYXRlLnR5cGUgPT09ICdkcCcpIHsKICAgICAgICAgICAgICAgIGlmIChtb21lbnQoJChldmVudCkudmFsKCksIGNvbHVtbk9iai5kYXRlX2Zvcm1hdCkuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9ICQoZXZlbnQpLnZhbCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhciA9ICdjbGVhcic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKGV2ZW50KS5ibHVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2Jvb3RzdHJhcC1kYXRlcGlja2VyJykgewogICAgICAgICAgICAgICAgaWYgKHBEYXRlLmRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IHBEYXRlLmZvcm1hdCgwLCBjb2x1bW5PYmouZGF0ZV9mb3JtYXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IGNhbGNDb2x1bW5OdW1iZXJGaWx0ZXIoc2V0dGluZ3NEdCwgY29sdW1uX251bWJlciwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwoKICAgICAgICAgICAgaWYgKGNsZWFyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgIT09ICdkYXRlX2N1c3RvbV9mdW5jJykgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcihkYXRlLCBjb2x1bW5fbnVtYmVyX2ZpbHRlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRvRmlsdGVyQ3VzdG9tRGF0ZUZ1bmMoeyB2YWx1ZTogZGF0ZSB9LCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNsZWFyID09PSAnY2xlYXInKSB7CiAgICAgICAgICAgICAgICBpZiAoZXhHZXRDb2x1bW5GaWx0ZXJWYWwob1RhYmxlLCBjb2x1bW5fbnVtYmVyKSA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnZGF0ZV9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAvL2hhbmRsZSBzdGF0ZSBzYXZpbmcKICAgICAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgIT09IHVuZGVmaW5lZCAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAiIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogIiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgPSB5YWRjZlN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcignJywgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwoJycpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLmRhdGVwaWNrZXIoJ3VwZGF0ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGF0ZVNlbGVjdChwRGF0ZSwgcEV2ZW50KSB7CiAgICAgICAgICAgIHZhciBvVGFibGUsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyLAogICAgICAgICAgICAgICAgZGFzaEluZGV4LAogICAgICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksCiAgICAgICAgICAgICAgICB5YWRjZlN0YXRlLAogICAgICAgICAgICAgICAgZnJvbSwKICAgICAgICAgICAgICAgIHRvLAogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgIHNldHRpbmdzRHQ7CgogICAgICAgICAgICBpZiAocERhdGUudHlwZSA9PT0gJ2RwJykgewogICAgICAgICAgICAgICAgZXZlbnQgPSBwRGF0ZS50YXJnZXQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocERhdGUudHlwZSA9PT0gJ2NoYW5nZURhdGUnKSB7CiAgICAgICAgICAgICAgICBldmVudCA9IHBEYXRlLmN1cnJlbnRUYXJnZXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBldmVudCA9IHBFdmVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29sdW1uX251bWJlciA9ICQoZXZlbnQpLmF0dHIoImlkIikucmVwbGFjZSgieWFkY2YtZmlsdGVyLSIsICIiKS5yZXBsYWNlKCItZnJvbS1kYXRlIiwgIiIpLnJlcGxhY2UoIi10by1kYXRlIiwgIiIpOwogICAgICAgICAgICBkYXNoSW5kZXggPSBjb2x1bW5fbnVtYmVyLmxhc3RJbmRleE9mKCItIik7CiAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ID0gY29sdW1uX251bWJlci5zdWJzdHJpbmcoMCwgZGFzaEluZGV4KTsKCiAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBjb2x1bW5fbnVtYmVyLnN1YnN0cmluZyhkYXNoSW5kZXggKyAxKTsKCgogICAgICAgICAgICBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKG9UYWJsZSk7CiAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY2FsY0NvbHVtbk51bWJlckZpbHRlcihzZXR0aW5nc0R0LCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CgogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwoKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgaWYgKHBEYXRlLnR5cGUgPT09ICdkcCcpIHsKICAgICAgICAgICAgICAgIGV2ZW50ID0gcERhdGUudGFyZ2V0OwogICAgICAgICAgICAgICAgaWYgKHBEYXRlLmRhdGUgPT09IGZhbHNlIHx8ICFtb21lbnQoJChldmVudCkudmFsKCksIGNvbHVtbk9iai5kYXRlX2Zvcm1hdCkuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgJChldmVudCkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgJChldmVudCkuZGF0YSgiRGF0ZVRpbWVQaWNrZXIiKS5taW5EYXRlKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJChldmVudCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKGV2ZW50KS5ibHVyKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocERhdGUudHlwZSA9PT0gJ2NoYW5nZURhdGUnKSB7CiAgICAgICAgICAgICAgICBpZiAocERhdGUuZGF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgJChldmVudCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoZXZlbnQpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJChldmVudCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgkKGV2ZW50KS5hdHRyKCJpZCIpLmluZGV4T2YoIi1mcm9tLSIpICE9PSAtMSkgewogICAgICAgICAgICAgICAgZnJvbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCQoZXZlbnQpLmF0dHIoImlkIikpLnZhbHVlOwogICAgICAgICAgICAgICAgdG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgkKGV2ZW50KS5hdHRyKCJpZCIpLnJlcGxhY2UoIi1mcm9tLSIsICItdG8tIikpLnZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgkKGV2ZW50KS5hdHRyKCJpZCIpKS52YWx1ZTsKICAgICAgICAgICAgICAgIGZyb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgkKGV2ZW50KS5hdHRyKCJpZCIpLnJlcGxhY2UoIi10by0iLCAiLWZyb20tIikpLnZhbHVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkRyYXcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcihmcm9tICsgJy15YWRjZl9kZWxpbS0nICsgdG8sIGNvbHVtbl9udW1iZXJfZmlsdGVyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUgPSB7fTsKICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0FwaS5fZm5TYXZlU3RhdGUob1RhYmxlLmZuU2V0dGluZ3MoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0ZlYXR1cmVzLmJTdGF0ZVNhdmUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlICE9PSB1bmRlZmluZWQgJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiB0bwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICAgdG86IHRvCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlID0geWFkY2ZTdGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0FwaS5fZm5TYXZlU3RhdGUob1RhYmxlLmZuU2V0dGluZ3MoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhZGRSYW5nZURhdGVGaWx0ZXIoZmlsdGVyX3NlbGVjdG9yX3N0cmluZywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCwgZmlsdGVyX2RlZmF1bHRfbGFiZWwsIGRhdGVfZm9ybWF0KSB7CiAgICAgICAgICAgIHZhciBmcm9tSWQgPSAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItZnJvbS1kYXRlLSIgKyBjb2x1bW5fbnVtYmVyLAogICAgICAgICAgICAgICAgdG9JZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi10by1kYXRlLSIgKyBjb2x1bW5fbnVtYmVyLAogICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZ190bXAsCiAgICAgICAgICAgICAgICBmaWx0ZXJfd3JhcHBlcl9pZCwKICAgICAgICAgICAgICAgIG9UYWJsZSwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIGRhdGVwaWNrZXJPYmogPSB7fSwKICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciwKICAgICAgICAgICAgICAgICRmcm9tSW5wdXQsCiAgICAgICAgICAgICAgICAkdG9JbnB1dCwKICAgICAgICAgICAgICAgIGlubmVyV3JhcHBlckFkZGl0aW9uYWxDbGFzcyA9ICcnOwoKICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQgPSAieWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcjsKCiAgICAgICAgICAgIGlmICgkKCIjIiArIGZpbHRlcl93cmFwcGVyX2lkKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXTsKICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgIGlubmVyV3JhcHBlckFkZGl0aW9uYWxDbGFzcyA9ICdpbnB1dC1kYXRlcmFuZ2UnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vYWRkIGEgd3JhcHBlciB0byBob2xkIGJvdGggZmlsdGVyIGFuZCByZXNldCBidXR0b24KICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxkaXYgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiICBpZD1cIiIgKyBmaWx0ZXJfd3JhcHBlcl9pZCArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci13cmFwcGVyICIgKyBjb2x1bW5PYmouc3R5bGVfY2xhc3MgKyAiXCI+PC9kaXY+Iik7CiAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgKz0gIiBkaXYueWFkY2YtZmlsdGVyLXdyYXBwZXIiOwogICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nX3RtcCA9IGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmc7CgogICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBpZD1cInlhZGNmLWZpbHRlci13cmFwcGVyLWlubmVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItd3JhcHBlci1pbm5lciAiICsgaW5uZXJXcmFwcGVyQWRkaXRpb25hbENsYXNzICsgIlwiPjwvZGl2PiIpOwogICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nICs9ICIgZGl2LnlhZGNmLWZpbHRlci13cmFwcGVyLWlubmVyIjsKCiAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICdvbmtleXVwPSJ5YWRjZi5yYW5nZURhdGVLZXlVUChcJycgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICdcJyxcJycgKyBkYXRlX2Zvcm1hdCArICdcJyxldmVudCk7Iic7CiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICcnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGlucHV0IG9ua2V5ZG93bj1cInlhZGNmLnByZXZlbnREZWZhdWx0Rm9yRW50ZXIoZXZlbnQpO1wiIHBsYWNlaG9sZGVyPVwiIiArIGZpbHRlcl9kZWZhdWx0X2xhYmVsWzBdICsgIlwiIGlkPVwiIiArIGZyb21JZCArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yYW5nZS1kYXRlIHlhZGNmLWZpbHRlci1yYW5nZSB5YWRjZi1maWx0ZXItcmFuZ2Utc3RhcnRcIiAiICsgZmlsdGVyQWN0aW9uU3RyICsgIj48L2lucHV0PiIpOwogICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPHNwYW4gY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmFuZ2UtZGF0ZS1zZXBlcmF0b3JcIiA+IiArICI8L3NwYW4+Iik7CiAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8aW5wdXQgb25rZXlkb3duPVwieWFkY2YucHJldmVudERlZmF1bHRGb3JFbnRlcihldmVudCk7XCIgcGxhY2Vob2xkZXI9XCIiICsgZmlsdGVyX2RlZmF1bHRfbGFiZWxbMV0gKyAiXCIgaWQ9XCIiICsgdG9JZCArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yYW5nZS1kYXRlIHlhZGNmLWZpbHRlci1yYW5nZSB5YWRjZi1maWx0ZXItcmFuZ2UtZW5kXCIgIiArIGZpbHRlckFjdGlvblN0ciArICI+PC9pbnB1dD4iKTsKCiAgICAgICAgICAgICRmcm9tSW5wdXQgPSAkKCIjIiArIGZyb21JZCk7CiAgICAgICAgICAgICR0b0lucHV0ID0gJCgiIyIgKyB0b0lkKTsKCiAgICAgICAgICAgIGlmIChmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wKS5hcHBlbmQoIjxidXR0b24gdHlwZT1cImJ1dHRvblwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiAiICsKICAgICAgICAgICAgICAgICAgICAib25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YucmFuZ2VDbGVhcignIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIicsZXZlbnQsIiArIGNvbHVtbl9udW1iZXIgKyAiKTsgcmV0dXJuIGZhbHNlO1wiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJlc2V0LWJ1dHRvbiAiICsgY29sdW1uT2JqLnJlc2V0X2J1dHRvbl9zdHlsZV9jbGFzcyArICJcIj4iICsgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICsgIjwvYnV0dG9uPiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2pxdWVyeS11aScpIHsKICAgICAgICAgICAgICAgIGRhdGVwaWNrZXJPYmouZGF0ZUZvcm1hdCA9IGRhdGVfZm9ybWF0OwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICBkYXRlcGlja2VyT2JqLmZvcm1hdCA9IGRhdGVfZm9ybWF0OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2pxdWVyeS11aScpIHsKICAgICAgICAgICAgICAgICAgICBkYXRlcGlja2VyT2JqLm9uU2VsZWN0ID0gZGF0ZVNlbGVjdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGZvciAnYm9vdHN0cmFwLWRhdGV0aW1lcGlja2VyJyBpdHMgaW1wbGVtZW50ZWQgYmVsb3cuLi4KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGF0ZXBpY2tlck9iaiA9ICQuZXh0ZW5kKHt9LCBkYXRlcGlja2VyT2JqLCBjb2x1bW5PYmouZmlsdGVyX3BsdWdpbl9vcHRpb25zKTsKCiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnanF1ZXJ5LXVpJykgewogICAgICAgICAgICAgICAgJGZyb21JbnB1dC5kYXRlcGlja2VyKCQuZXh0ZW5kKGRhdGVwaWNrZXJPYmosIHtvbkNsb3NlOiBmdW5jdGlvbiAoc2VsZWN0ZWREYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICR0b0lucHV0LmRhdGVwaWNrZXIoJ29wdGlvbicsICdtaW5EYXRlJywgc2VsZWN0ZWREYXRlKTsKICAgICAgICAgICAgICAgICAgICB9ICB9KSk7CiAgICAgICAgICAgICAgICAkdG9JbnB1dC5kYXRlcGlja2VyKCQuZXh0ZW5kKGRhdGVwaWNrZXJPYmosIHtvbkNsb3NlOiBmdW5jdGlvbiAoc2VsZWN0ZWREYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRmcm9tSW5wdXQuZGF0ZXBpY2tlcignb3B0aW9uJywgJ21heERhdGUnLCBzZWxlY3RlZERhdGUpOwogICAgICAgICAgICAgICAgICAgIH0gIH0pKTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2Jvb3RzdHJhcC1kYXRldGltZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgIGRhdGVwaWNrZXJPYmoudXNlQ3VycmVudCA9IGZhbHNlOwogICAgICAgICAgICAgICAgJGZyb21JbnB1dC5kYXRldGltZXBpY2tlcihkYXRlcGlja2VyT2JqKTsKICAgICAgICAgICAgICAgICR0b0lucHV0LmRhdGV0aW1lcGlja2VyKGRhdGVwaWNrZXJPYmopOwogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5leHRlcm5hbGx5X3RyaWdnZXJlZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICRmcm9tSW5wdXQuYWRkKCR0b0lucHV0KS5vbignZHAuaGlkZScsIGRhdGVTZWxlY3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXBpY2tlcicpIHsKICAgICAgICAgICAgICAgIGlmIChkYXRlX2Zvcm1hdCkgewogICAgICAgICAgICAgICAgICAgICQuZXh0ZW5kKGRhdGVwaWNrZXJPYmosIHsgZm9ybWF0OiBkYXRlX2Zvcm1hdCB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRmcm9tSW5wdXQuZGF0ZXBpY2tlcihkYXRlcGlja2VyT2JqKS5vbignY2hhbmdlRGF0ZScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZVNlbGVjdChlKTsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmRhdGVwaWNrZXIoJ2hpZGUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJHRvSW5wdXQuZGF0ZXBpY2tlcihkYXRlcGlja2VyT2JqKS5vbignY2hhbmdlRGF0ZScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZVNlbGVjdChlKTsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmRhdGVwaWNrZXIoJ2hpZGUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0pIHsKICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkudmFsKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb20pOwogICAgICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXS5mcm9tICE9PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICQoJyMnICsgdG9JZCkudmFsKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLnRvKTsKICAgICAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0udG8gIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgdG9JZCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGFkZFJhbmdlRGF0ZUZpbHRlckNhcGFiaWxpdHkodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGZyb21JZCwgdG9JZCwgY29sdW1uX251bWJlciwgZGF0ZV9mb3JtYXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkRGF0ZUZpbHRlcihmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlciwgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0LCBmaWx0ZXJfZGVmYXVsdF9sYWJlbCwgZGF0ZV9mb3JtYXQpIHsKICAgICAgICAgICAgdmFyIGRhdGVJZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wLAogICAgICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQsCiAgICAgICAgICAgICAgICBvVGFibGUsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBkYXRlcGlja2VyT2JqID0ge30sCiAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIsCiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0OwoKICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQgPSAieWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcjsKCiAgICAgICAgICAgIGlmICgkKCIjIiArIGZpbHRlcl93cmFwcGVyX2lkKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXTsKCiAgICAgICAgICAgIC8vYWRkIGEgd3JhcHBlciB0byBob2xkIGJvdGggZmlsdGVyIGFuZCByZXNldCBidXR0b24KICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxkaXYgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIGlkPVwiIiArIGZpbHRlcl93cmFwcGVyX2lkICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXdyYXBwZXJcIj48L2Rpdj4iKTsKICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiIGRpdi55YWRjZi1maWx0ZXItd3JhcHBlciI7CiAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wID0gZmlsdGVyX3NlbGVjdG9yX3N0cmluZzsKCiAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICdvbmtleXVwPSJ5YWRjZi5kYXRlS2V5VVAoXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnXCcsXCcnICsgZGF0ZV9mb3JtYXQgKyAnXCcsZXZlbnQpOyInOwogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxpbnB1dCBvbmtleWRvd249XCJ5YWRjZi5wcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2ZW50KTtcIiBwbGFjZWhvbGRlcj1cIiIgKyBmaWx0ZXJfZGVmYXVsdF9sYWJlbCArICJcIiBpZD1cIiIgKyBkYXRlSWQgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItZGF0ZVwiICIgKyBmaWx0ZXJBY3Rpb25TdHIgKyAiPjwvaW5wdXQ+Iik7CgogICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nX3RtcCkuYXBwZW5kKCc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgaWQ9IicgKyBkYXRlSWQgKyAnLXJlc2V0IiAnICsgJ29ubW91c2Vkb3duPSJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIgJyArCiAgICAgICAgICAgICAgICAgICAgJ29uY2xpY2s9InlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YuZGF0ZVNlbGVjdFNpbmdsZShcJycgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICdcJyx5YWRjZi5ldmVudFRhcmdldEZpeFVwKGV2ZW50KS50YXJnZXQsIFwnY2xlYXJcJyk7IHJldHVybiBmYWxzZTsiIGNsYXNzPSJ5YWRjZi1maWx0ZXItcmVzZXQtYnV0dG9uICcgKyBjb2x1bW5PYmoucmVzZXRfYnV0dG9uX3N0eWxlX2NsYXNzICsgJyI+JyArIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCArICc8L2J1dHRvbj4nKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICBkYXRlcGlja2VyT2JqLmRhdGVGb3JtYXQgPSBkYXRlX2Zvcm1hdDsKICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlLmluZGV4T2YoJ2Jvb3RzdHJhcCcpICE9PSAtMSkgewogICAgICAgICAgICAgICAgZGF0ZXBpY2tlck9iai5mb3JtYXQgPSBkYXRlX2Zvcm1hdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5leHRlcm5hbGx5X3RyaWdnZXJlZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZXBpY2tlck9iai5vblNlbGVjdCA9IGRhdGVTZWxlY3RTaW5nbGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRhdGVwaWNrZXJPYmogPSAkLmV4dGVuZCh7fSwgZGF0ZXBpY2tlck9iaiwgY29sdW1uT2JqLmZpbHRlcl9wbHVnaW5fb3B0aW9ucyk7CgogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2pxdWVyeS11aScpIHsKICAgICAgICAgICAgICAgICQoIiMiICsgZGF0ZUlkKS5kYXRlcGlja2VyKGRhdGVwaWNrZXJPYmopOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICBkYXRlcGlja2VyT2JqLnVzZUN1cnJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICQoIiMiICsgZGF0ZUlkKS5kYXRldGltZXBpY2tlcihkYXRlcGlja2VyT2JqKTsKICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0ZXBpY2tlck9iai5mb3JtYXQudG9Mb3dlckNhc2UoKSAhPT0gJ2hoOm1tJykgewogICAgICAgICAgICAgICAgICAgICAgICAkKCIjIiArIGRhdGVJZCkub24oJ2RwLmNoYW5nZScsIGRhdGVTZWxlY3RTaW5nbGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgZGF0ZUlkKS5vbignZHAuaGlkZScsIGRhdGVTZWxlY3RTaW5nbGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAkKCIjIiArIGRhdGVJZCkuZGF0ZXBpY2tlcihkYXRlcGlja2VyT2JqKS5vbignY2hhbmdlRGF0ZScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0ZVNlbGVjdFNpbmdsZShlKTsKICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmRhdGVwaWNrZXIoJ2hpZGUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uc1NlYXJjaCAhPT0gJycpIHsKICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKG9UYWJsZS5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9udW1iZXJdLnNTZWFyY2gpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnZGF0ZV9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzRHQgPSBnZXRTZXR0aW5nc09iakZyb21UYWJsZShvVGFibGUpOwoKICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlICYmIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBkYXRlSWQpLnZhbChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXS5mcm9tKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb20gIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGRhdGVJZCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQub0ZlYXR1cmVzLmJTZXJ2ZXJTaWRlICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkQ3VzdG9tRnVuY3Rpb25GaWx0ZXJDYXBhYmlsaXR5KHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIsIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmFuZ2VOdW1iZXJTbGRpZXJEcmF3VGlwcyhtaW5fdGlwX3ZhbCwgbWF4X3RpcF92YWwsIG1pbl90aXBfaWQsIG1heF90aXBfaWQsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyKSB7CiAgICAgICAgICAgIHZhciBmaXJzdF9oYW5kbGUgPSAkKCIueWFkY2YtbnVtYmVyLXNsaWRlci1maWx0ZXItd3JhcHBlci1pbm5lci4tIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksIC8vICsgIiAudWktc2xpZGVyLWhhbmRsZTpmaXJzdCIpLAogICAgICAgICAgICAgICAgbGFzdF9oYW5kbGUgPSAkKCIueWFkY2YtbnVtYmVyLXNsaWRlci1maWx0ZXItd3JhcHBlci1pbm5lci4tIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksIC8vICsgIiAudWktc2xpZGVyLWhhbmRsZTpsYXN0IiksCiAgICAgICAgICAgICAgICBtaW5fdGlwX2lubmVyLAogICAgICAgICAgICAgICAgbWF4X3RpcF9pbm5lcjsKCiAgICAgICAgICAgIG1pbl90aXBfaW5uZXIgPSAiPGRpdiBpZD1cIiIgKyBtaW5fdGlwX2lkICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWluLXRpcC1pbm5lclwiPiIgKyBtaW5fdGlwX3ZhbCArICI8L2Rpdj4iOwogICAgICAgICAgICBtYXhfdGlwX2lubmVyID0gIjxkaXYgaWQ9XCIiICsgbWF4X3RpcF9pZCArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1heC10aXAtaW5uZXJcIj4iICsgbWF4X3RpcF92YWwgKyAiPC9kaXY+IjsKCiAgICAgICAgICAgIGlmIChmaXJzdF9oYW5kbGUubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICBmaXJzdF9oYW5kbGUgPSAkKCIueWFkY2YtbnVtYmVyLXNsaWRlci1maWx0ZXItd3JhcHBlci1pbm5lci4tIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICIgLnVpLXNsaWRlci1oYW5kbGU6Zmlyc3QiKTsKICAgICAgICAgICAgICAgICQoZmlyc3RfaGFuZGxlKS5hZGRDbGFzcygieWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWluLXRpcCIpLmh0bWwobWluX3RpcF9pbm5lcik7CgogICAgICAgICAgICAgICAgbGFzdF9oYW5kbGUgPSAkKCIueWFkY2YtbnVtYmVyLXNsaWRlci1maWx0ZXItd3JhcHBlci1pbm5lci4tIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICIgLnVpLXNsaWRlci1oYW5kbGU6bGFzdCIpOwogICAgICAgICAgICAgICAgJChsYXN0X2hhbmRsZSkuYWRkQ2xhc3MoInlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1heC10aXAiKS5odG1sKG1heF90aXBfaW5uZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy9taWd0aCBoYXBwZW4gd2hlbiBzY3JvbGxYIGlzIHVzZWQgb3Igd2hlbiBmaWx0ZXIgcm93IGlzIGJlaW5nIGR1cGxpY2F0ZWQgYnkgRFQKICAgICAgICAgICAgICAgICQoJChmaXJzdF9oYW5kbGUpWzBdKS5maW5kKCcudWktc2xpZGVyLWhhbmRsZTpmaXJzdCcpLmFkZENsYXNzKCJ5YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyLXNsaWRlci1taW4tdGlwIikuaHRtbChtaW5fdGlwX2lubmVyKTsKICAgICAgICAgICAgICAgICQoJChsYXN0X2hhbmRsZSlbMF0pLmZpbmQoJy51aS1zbGlkZXItaGFuZGxlOmxhc3QnKS5hZGRDbGFzcygieWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWF4LXRpcCIpLmh0bWwobWF4X3RpcF9pbm5lcik7CgogICAgICAgICAgICAgICAgJCgkKGZpcnN0X2hhbmRsZSlbMV0pLmZpbmQoJy51aS1zbGlkZXItaGFuZGxlOmZpcnN0JykuYWRkQ2xhc3MoInlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1pbi10aXAiKS5odG1sKG1pbl90aXBfaW5uZXIpOwogICAgICAgICAgICAgICAgJCgkKGxhc3RfaGFuZGxlKVsxXSkuZmluZCgnLnVpLXNsaWRlci1oYW5kbGU6bGFzdCcpLmFkZENsYXNzKCJ5YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyLXNsaWRlci1tYXgtdGlwIikuaHRtbChtYXhfdGlwX2lubmVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmFuZ2VOdW1iZXJTbGlkZXJDaGFuZ2UodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGV2ZW50LCB1aSkgewogICAgICAgICAgICB2YXIgb1RhYmxlLAogICAgICAgICAgICAgICAgbWluX3ZhbCwKICAgICAgICAgICAgICAgIG1heF92YWwsCiAgICAgICAgICAgICAgICBzbGlkZXJfaW51c2UsCiAgICAgICAgICAgICAgICB5YWRjZlN0YXRlLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIGtleVVwLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyOwoKICAgICAgICAgICAgZXZlbnQgPSBldmVudFRhcmdldEZpeFVwKGV2ZW50KTsKICAgICAgICAgICAgY29sdW1uX251bWJlciA9ICQoZXZlbnQudGFyZ2V0KS5hdHRyKCdpZCcpLnJlcGxhY2UoInlhZGNmLWZpbHRlci0iLCAiIikucmVwbGFjZSh0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgIiIpLnJlcGxhY2UoIi1zbGlkZXItIiwgIiIpOwoKICAgICAgICAgICAgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIHNldHRpbmdzRHQgPSBnZXRTZXR0aW5nc09iakZyb21UYWJsZShvVGFibGUpOwogICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IGNhbGNDb2x1bW5OdW1iZXJGaWx0ZXIoc2V0dGluZ3NEdCwgY29sdW1uX251bWJlciwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwoKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAga2V5VXAgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKCiAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5EcmF3KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcih1aS52YWx1ZXNbMF0gKyAnLXlhZGNmX2RlbGltLScgKyB1aS52YWx1ZXNbMV0sIGNvbHVtbl9udW1iZXJfZmlsdGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1pbl92YWwgPSArJCgkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1pbi10aXAtaGlkZGVuIikpLnRleHQoKTsKICAgICAgICAgICAgICAgIG1heF92YWwgPSArJCgkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1heC10aXAtaGlkZGVuIikpLnRleHQoKTsKCiAgICAgICAgICAgICAgICBpZiAobWluX3ZhbCAhPT0gdWkudmFsdWVzWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkuZmluZCgiLnVpLXNsaWRlci1oYW5kbGUiKVswXSkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgc2xpZGVyX2ludXNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkuZmluZCgiLnVpLXNsaWRlci1oYW5kbGUiKVswXSkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobWF4X3ZhbCAhPT0gdWkudmFsdWVzWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkuZmluZCgiLnVpLXNsaWRlci1oYW5kbGUiKVsxXSkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgc2xpZGVyX2ludXNlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkuZmluZCgiLnVpLXNsaWRlci1oYW5kbGUiKVsxXSkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHNsaWRlcl9pbnVzZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5maW5kKCIudWktc2xpZGVyLXJhbmdlIikuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5maW5kKCIudWktc2xpZGVyLXJhbmdlIikucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgIT09IHVuZGVmaW5lZCAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiB1aS52YWx1ZXNbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IHVpLnZhbHVlc1sxXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogdWkudmFsdWVzWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IHVpLnZhbHVlc1sxXQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlID0geWFkY2ZTdGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfZGVsYXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5VXAoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHlhZGNmRGVsYXkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGtleVVwKCk7CiAgICAgICAgICAgICAgICB9LCBjb2x1bW5PYmouZmlsdGVyX2RlbGF5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYWRkUmFuZ2VOdW1iZXJTbGlkZXJGaWx0ZXIoZmlsdGVyX3NlbGVjdG9yX3N0cmluZywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCwgbWluX3ZhbCwgbWF4X3ZhbCwgaWdub3JlX2NoYXIpIHsKICAgICAgICAgICAgdmFyIHNsaWRlcklkID0gInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLXNsaWRlci0iICsgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIG1pbl90aXBfaWQgPSAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItbWluX3RpcC0iICsgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIG1heF90aXBfaWQgPSAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItbWF4X3RpcC0iICsgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmdfdG1wLAogICAgICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQsCiAgICAgICAgICAgICAgICBvVGFibGUsCiAgICAgICAgICAgICAgICBtaW5fc3RhdGVfdmFsID0gbWluX3ZhbCwKICAgICAgICAgICAgICAgIG1heF9zdGF0ZV92YWwgPSBtYXhfdmFsLAogICAgICAgICAgICAgICAgY29sdW1uT2JqLAogICAgICAgICAgICAgICAgc2xpZGVGdW5jLAogICAgICAgICAgICAgICAgY2hhbmdlRnVuYywKICAgICAgICAgICAgICAgIHNsaWRlck9iaiwKICAgICAgICAgICAgICAgIHNsaWRlck1heE1pbiA9IHsKICAgICAgICAgICAgICAgICAgICBtaW46IG1pbl92YWwsCiAgICAgICAgICAgICAgICAgICAgbWF4OiBtYXhfdmFsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGN1cnJTbGlkZXJNaW4gPSAkKCIjIiArIHNsaWRlcklkKS5zbGlkZXIoIm9wdGlvbiIsICJtaW4iKSwKICAgICAgICAgICAgICAgIGN1cnJTbGlkZXJNYXggPSAkKCIjIiArIHNsaWRlcklkKS5zbGlkZXIoIm9wdGlvbiIsICJtYXgiKSwKICAgICAgICAgICAgICAgIHJlZHJhd1RhYmxlOwoKICAgICAgICAgICAgZmlsdGVyX3dyYXBwZXJfaWQgPSAieWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcjsKCiAgICAgICAgICAgIGlmICgkKCIjIiArIGZpbHRlcl93cmFwcGVyX2lkKS5sZW5ndGggPiAwICYmIChjdXJyU2xpZGVyTWluID09PSBtaW5fdmFsICYmIGN1cnJTbGlkZXJNYXggPT09IG1heF92YWwpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICBzZXR0aW5nc0R0ID0gc2V0dGluZ3NNYXBbZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseTIob1RhYmxlKV07CgogICAgICAgICAgICBpZiAoJCgiIyIgKyBmaWx0ZXJfd3JhcHBlcl9pZCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgJCgiIyIgKyBzbGlkZXJJZCkuc2xpZGVyKCJkZXN0cm95Iik7CiAgICAgICAgICAgICAgICAkKCIjIiArIGZpbHRlcl93cmFwcGVyX2lkKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHJlZHJhd1RhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQub0ZlYXR1cmVzLmJTdGF0ZVNhdmUgPT09IHRydWUgJiYgc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlICYmIHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldICYmIHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1pbl92YWwgIT09IHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluX3N0YXRlX3ZhbCA9IHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb207CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChtYXhfdmFsICE9PSBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXS50bykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhfc3RhdGVfdmFsID0gc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0udG87CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNGaW5pdGUobWluX3ZhbCkgJiYgaXNGaW5pdGUobWF4X3ZhbCkgJiYgaXNGaW5pdGUobWluX3N0YXRlX3ZhbCkgJiYgaXNGaW5pdGUobWF4X3N0YXRlX3ZhbCkpIHsKCiAgICAgICAgICAgICAgICAvL2FkZCBhIHdyYXBwZXIgdG8gaG9sZCBib3RoIGZpbHRlciBhbmQgcmVzZXQgYnV0dG9uCiAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgb25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIGlkPVwiIiArIGZpbHRlcl93cmFwcGVyX2lkICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXdyYXBwZXIgIiArIGNvbHVtbk9iai5zdHlsZV9jbGFzcyArICJcIj48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgKz0gIiBkaXYueWFkY2YtZmlsdGVyLXdyYXBwZXIiOwogICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZ190bXAgPSBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nOwoKICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8ZGl2IGlkPVwieWFkY2YtZmlsdGVyLXdyYXBwZXItaW5uZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLW51bWJlci1zbGlkZXItZmlsdGVyLXdyYXBwZXItaW5uZXIiICsgIiAtIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIj48L2Rpdj4iKTsKICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgKz0gIiBkaXYueWFkY2YtbnVtYmVyLXNsaWRlci1maWx0ZXItd3JhcHBlci1pbm5lciI7CgogICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxkaXYgaWQ9XCIiICsgc2xpZGVySWQgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyLXNsaWRlclwiPjwvZGl2PiIpOwogICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiICMiICsgc2xpZGVySWQ7CgogICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxzcGFuIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWluLXRpcC1oaWRkZW4gaGlkZVwiPiIgKyBtaW5fdmFsICsgIjwvc3Bhbj4iKTsKICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8c3BhbiBjbGFzcz1cInlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1heC10aXAtaGlkZGVuIGhpZGVcIj4iICsgbWF4X3ZhbCArICI8L3NwYW4+Iik7CgogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5leHRlcm5hbGx5X3RyaWdnZXJlZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHNsaWRlRnVuYyA9IGZ1bmN0aW9uIChldmVudCwgdWkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2VOdW1iZXJTbGRpZXJEcmF3VGlwcyh1aS52YWx1ZXNbMF0sIHVpLnZhbHVlc1sxXSwgbWluX3RpcF9pZCwgbWF4X3RpcF9pZCwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgICAgICAgICByYW5nZU51bWJlclNsaWRlckNoYW5nZSh0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZXZlbnQsIHVpKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNoYW5nZUZ1bmMgPSBmdW5jdGlvbiAoZXZlbnQsIHVpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlTnVtYmVyU2xkaWVyRHJhd1RpcHModWkudmFsdWVzWzBdLCB1aS52YWx1ZXNbMV0sIG1pbl90aXBfaWQsIG1heF90aXBfaWQsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgJChldmVudC50YXJnZXQpLnNsaWRlcigib3B0aW9uIiwgInlhZGNmLXJlc2V0IikgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5zbGlkZXIoIm9wdGlvbiIsICJ5YWRjZi1yZXNldCIsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlTnVtYmVyU2xpZGVyQ2hhbmdlKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBldmVudCwgdWkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2xpZGVGdW5jID0gZnVuY3Rpb24gKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICByYW5nZU51bWJlclNsZGllckRyYXdUaXBzKHVpLnZhbHVlc1swXSwgdWkudmFsdWVzWzFdLCBtaW5fdGlwX2lkLCBtYXhfdGlwX2lkLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VGdW5jID0gZnVuY3Rpb24gKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICByYW5nZU51bWJlclNsZGllckRyYXdUaXBzKHVpLnZhbHVlc1swXSwgdWkudmFsdWVzWzFdLCBtaW5fdGlwX2lkLCBtYXhfdGlwX2lkLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNsaWRlck9iaiA9IHsKICAgICAgICAgICAgICAgICAgICByYW5nZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBtaW46IG1pbl92YWwsCiAgICAgICAgICAgICAgICAgICAgbWF4OiBtYXhfdmFsLAogICAgICAgICAgICAgICAgICAgIHZhbHVlczogW21pbl9zdGF0ZV92YWwsIG1heF9zdGF0ZV92YWxdLAogICAgICAgICAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICByYW5nZU51bWJlclNsZGllckRyYXdUaXBzKG1pbl9zdGF0ZV92YWwsIG1heF9zdGF0ZV92YWwsIG1pbl90aXBfaWQsIG1heF90aXBfaWQsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHNsaWRlOiBzbGlkZUZ1bmMsCiAgICAgICAgICAgICAgICAgICAgY2hhbmdlOiBjaGFuZ2VGdW5jCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3BsdWdpbl9vcHRpb25zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAkLmV4dGVuZChzbGlkZXJPYmosIGNvbHVtbk9iai5maWx0ZXJfcGx1Z2luX29wdGlvbnMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICQoIiMiICsgc2xpZGVySWQpLnNsaWRlcihzbGlkZXJPYmopOwoKICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nX3RtcCkuYXBwZW5kKCI8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJvbmNsaWNrPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi5yYW5nZU51bWJlclNsaWRlckNsZWFyKCciICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiJyxldmVudCk7IHJldHVybiBmYWxzZTtcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yZXNldC1idXR0b24gcmFuZ2UtbnVtYmVyLXNsaWRlci1yZXNldC1idXR0b24gIiArIGNvbHVtbk9iai5yZXNldF9idXR0b25fc3R5bGVfY2xhc3MgKyAiXCI+IiArIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCArICI8L2J1dHRvbj4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0Lm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlICYmIHNldHRpbmdzRHQub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSAmJiBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAmJiBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0Zpbml0ZShtaW5fdmFsKSAmJiBtaW5fdmFsICE9PSBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXS5mcm9tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCIudWktc2xpZGVyLWhhbmRsZSIpWzBdKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKG1heF92YWwpICYmIG1heF92YWwgIT09IHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLnRvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCIudWktc2xpZGVyLWhhbmRsZSIpWzFdKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKChpc0Zpbml0ZShtaW5fdmFsKSAmJiBpc0Zpbml0ZShtYXhfdmFsKSkgJiYgKG1pbl92YWwgIT09IHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb20gfHwgbWF4X3ZhbCAhPT0gc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0udG8pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCIudWktc2xpZGVyLXJhbmdlIikpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwoKICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQub0ZlYXR1cmVzLmJTZXJ2ZXJTaWRlICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBhZGRSYW5nZU51bWJlckFuZFNsaWRlckZpbHRlckNhcGFiaWxpdHkodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIG1pbl90aXBfaWQsIG1heF90aXBfaWQsIGNvbHVtbl9udW1iZXIsIGlnbm9yZV9jaGFyLCBzbGlkZXJNYXhNaW4pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWRyYXdUYWJsZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgb1RhYmxlLmZuRHJhdyhmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lUaGlyZFBhcnR5UGx1Z2lucyh0YWJsZV9hcmcpIHsKCiAgICAgICAgICAgIHZhciB0YWJsZU9wdGlvbnMsCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaktleSwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICBvcHRpb25zT2JqLAogICAgICAgICAgICAgICAgZnJvbUlkLAogICAgICAgICAgICAgICAgdG9JZDsKCiAgICAgICAgICAgIC8vY2hlY2sgaWYgdGhlIHRhYmxlIGFyZyBpcyBmcm9tIG5ldyBkYXRhdGFibGVzIEFQSSAoY2FwaXRhbCAiRCIpCiAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuc2V0dGluZ3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGFibGVfYXJnID0gdGFibGVfYXJnLnNldHRpbmdzKClbMF0ub0luc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhYmxlT3B0aW9ucyA9IGdldE9wdGlvbnModGFibGVfYXJnLnNlbGVjdG9yKTsKICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5Mih0YWJsZV9hcmcpOwoKICAgICAgICAgICAgZm9yIChjb2x1bW5PYmpLZXkgaW4gdGFibGVPcHRpb25zKSB7CiAgICAgICAgICAgICAgICBpZiAodGFibGVPcHRpb25zLmhhc093blByb3BlcnR5KGNvbHVtbk9iaktleSkpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zT2JqID0gdGFibGVPcHRpb25zW2NvbHVtbk9iaktleV07CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlciA9IG9wdGlvbnNPYmouY29sdW1uX251bWJlcjsKCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChvcHRpb25zT2JqLmZpbHRlcl90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYyc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2N1c3RvbV9mdW5jJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAob3B0aW9uc09iai5zZWxlY3RfdHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Nob3Nlbic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikuY2hvc2VuKCdkZXN0cm95Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdDInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLnNlbGVjdDIoJ2Rlc3Ryb3knKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VzdG9tX3NlbGVjdCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RFbGVtZW50Q3VzdG9tRGVzdHJveUZ1bmMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudEN1c3RvbURlc3Ryb3lGdW5jKCQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2F1dG9fY29tcGxldGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS5hdXRvY29tcGxldGUoImRlc3Ryb3kiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAob3B0aW9uc09iai5zZWxlY3RfdHlwZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2pxdWVyeS11aSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikuZGF0ZXBpY2tlcigiZGVzdHJveSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdib290c3RyYXAtZGF0ZXRpbWVwaWNrZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfZGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItZnJvbS1kYXRlLSIgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi10by1kYXRlLSIgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChvcHRpb25zT2JqLnNlbGVjdF90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnanF1ZXJ5LXVpJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBmcm9tSWQpLmRhdGVwaWNrZXIoImRlc3Ryb3kiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyB0b0lkKS5kYXRlcGlja2VyKCJkZXN0cm95Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Jvb3RzdHJhcC1kYXRldGltZXBpY2tlcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgZnJvbUlkKS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgdG9JZCkuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyYW5nZV9udW1iZXJfc2xpZGVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi1zbGlkZXItIiArIGNvbHVtbl9udW1iZXIpLnNsaWRlcigiZGVzdHJveSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZW1vdmVGaWx0ZXJzKG9UYWJsZSkgewogICAgICAgICAgICB2YXIgdGFibGVJZCA9IGdldFRhYmxlSWQob1RhYmxlKTsKICAgICAgICAgICAgJCgnIycgKyB0YWJsZUlkICsgJyAueWFkY2YtZmlsdGVyLXdyYXBwZXInKS5yZW1vdmUoKTsKICAgICAgICAgICAgaWYgKHlhZGNmVmVyc2lvbkNoZWNrKCcxLjEwJykpIHsKICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZignZHJhdy5kdCcsIG9UYWJsZS5zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3hoci5kdCcsIG9UYWJsZS5zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2NvbHVtbi12aXNpYmlsaXR5LmR0Jywgb1RhYmxlLnNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZignZGVzdHJveS5kdCcsIG9UYWJsZS5zZWxlY3Rvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2RyYXcnLCBvVGFibGUuc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCdkZXN0cm95Jywgb1RhYmxlLnNlbGVjdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZXN0cm95VGhpcmRQYXJ0eVBsdWdpbnMob1RhYmxlKTsKICAgICAgICB9CgogICAgICAgIC8qIGFscGhhbnVtLmpzIChDKSBCcmlhbiBIdWlzbWFuCgkJICAgQmFzZWQgb24gdGhlIEFscGhhbnVtIEFsZ29yaXRobSBieSBEYXZpZCBLb2VsbGUKCQkgICBUaGUgQWxwaGFudW0gQWxnb3JpdGhtIGlzIGRpc2N1c3NlZCBhdCBodHRwOi8vd3d3LkRhdmVLb2VsbGUuY29tCgkJKi8KICAgICAgICBmdW5jdGlvbiBzb3J0QWxwaGFOdW0oYSwgYikgewogICAgICAgICAgICBmdW5jdGlvbiBjaHVua2lmeSh0KSB7CiAgICAgICAgICAgICAgICB2YXIgdHogPSBbXTsKICAgICAgICAgICAgICAgIHZhciB4ID0gMCwgeSA9IC0xLCBuID0gMCwgaSwgajsKCiAgICAgICAgICAgICAgICB3aGlsZSAoaSA9IChqID0gdC5jaGFyQXQoeCsrKSkuY2hhckNvZGVBdCgwKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBtID0gKGkgPT0gNDYgfHwgKGkgPj00OCAmJiBpIDw9IDU3KSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0gIT09IG4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHpbKyt5XSA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBuID0gbTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdHpbeV0gKz0gajsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0ejsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgYS5sYWJlbCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGEgPSBhLmxhYmVsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgYiA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIGIubGFiZWwgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBiID0gYi5sYWJlbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGFhID0gY2h1bmtpZnkoYS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgdmFyIGJiID0gY2h1bmtpZnkoYi50b0xvd2VyQ2FzZSgpKTsKCiAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyBhYVt4XSAmJiBiYlt4XTsgeCsrKSB7CiAgICAgICAgICAgICAgICBpZiAoYWFbeF0gIT09IGJiW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBOdW1iZXIoYWFbeF0pLCBkID0gTnVtYmVyKGJiW3hdKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYyA9PSBhYVt4XSAmJiBkID09IGJiW3hdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjIC0gZDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgcmV0dXJuIChhYVt4XSA+IGJiW3hdKSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYWEubGVuZ3RoIC0gYmIubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc29ydENvbHVtbkRhdGEoY29sdW1uX2RhdGEsIGNvbHVtbk9iaikgewogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAic2VsZWN0IiB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJhdXRvX2NvbXBsZXRlIiB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJtdWx0aV9zZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYycgfHwgY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAiY3VzdG9tX2Z1bmMiKSB7CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLnNvcnRfYXMgPT09ICJhbHBoYSIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLnNvcnRfb3JkZXIgPT09ICJhc2MiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLnNvcnQoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5zb3J0X29yZGVyID09PSAiZGVzYyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEuc29ydCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YS5yZXZlcnNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouc29ydF9hcyA9PT0gIm51bSIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLnNvcnRfb3JkZXIgPT09ICJhc2MiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLnNvcnQoc29ydE51bUFzYyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouc29ydF9vcmRlciA9PT0gImRlc2MiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLnNvcnQoc29ydE51bURlc2MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLnNvcnRfYXMgPT09ICJhbHBoYU51bSIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLnNvcnRfb3JkZXIgPT09ICJhc2MiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLnNvcnQoc29ydEFscGhhTnVtKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5zb3J0X29yZGVyID09PSAiZGVzYyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEuc29ydChzb3J0QWxwaGFOdW0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YS5yZXZlcnNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouc29ydF9hcyA9PT0gImN1c3RvbSIpIHsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YS5zb3J0KGNvbHVtbk9iai5zb3J0X2FzX2N1c3RvbV9mdW5jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29sdW1uX2RhdGE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpbHRlcmVkUm93cyh0YWJsZSkgewogICAgICAgICAgICB2YXIgZGF0YVRtcCwKICAgICAgICAgICAgICAgIGRhdGEgPSBbXSwKICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgIGlmICh5YWRjZlZlcnNpb25DaGVjaygnMS4xMCcpKSB7CiAgICAgICAgICAgICAgICBkYXRhVG1wID0gdGFibGUuXygndHInLCB7IGZpbHRlcjogJ2FwcGxpZWQnIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGF0YVRtcCA9IHRhYmxlLnJvd3MoeyBmaWx0ZXI6ICdhcHBsaWVkJ30pLmRhdGEoKS50b0FycmF5KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGRhdGFUbXAubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGRhdGEucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgX2FEYXRhOiBkYXRhVG1wW2ldCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHBhcnNlVGFibGVDb2x1bW4ocFRhYmxlLCBjb2x1bW5PYmosIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBwU2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIGNvbF9pbm5lcl9lbGVtZW50cywKICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhLAogICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGFfaGVscGVyLAogICAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICAgIGssCiAgICAgICAgICAgICAgICBjb2xfZmlsdGVyX2FycmF5ID0ge30sCiAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YSA9IFtdLAogICAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICAgIGRhdGFfbGVuZ3RoLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyOwoKICAgICAgICAgICAgaWYgKHBTZXR0aW5ncyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0ID0gcFNldHRpbmdzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKHBUYWJsZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY3VtdWxhdGl2ZV9maWx0ZXJpbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGRhdGEgPSBzZXR0aW5nc0R0LmFvRGF0YTsKICAgICAgICAgICAgICAgIGRhdGFfbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkYXRhID0gZ2V0RmlsdGVyZWRSb3dzKHBUYWJsZSk7CiAgICAgICAgICAgICAgICBkYXRhX2xlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY29sX2ZpbHRlcl9hcnJheSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb2xfZmlsdGVyX2FycmF5ID0gY29sdW1uT2JqLmNvbF9maWx0ZXJfYXJyYXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CiAgICAgICAgICAgIGlmIChpc05hTihzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fbnVtYmVyX2ZpbHRlcl0ubURhdGEpICYmIHR5cGVvZiBzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fbnVtYmVyX2ZpbHRlcl0ubURhdGEgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICBjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhID0gc2V0dGluZ3NEdC5hb0NvbHVtbnNbY29sdW1uX251bWJlcl9maWx0ZXJdLm1EYXRhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc05hTihzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fbnVtYmVyX2ZpbHRlcl0ubVJlbmRlcikgJiYgdHlwZW9mIHNldHRpbmdzRHQuYW9Db2x1bW5zW2NvbHVtbl9udW1iZXJfZmlsdGVyXS5tUmVuZGVyICE9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgY29sdW1uT2JqLmNvbHVtbl9udW1iZXJfcmVuZGVyID0gc2V0dGluZ3NEdC5hb0NvbHVtbnNbY29sdW1uX251bWJlcl9maWx0ZXJdLm1SZW5kZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBkYXRhX2xlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmNvbHVtbl9kYXRhX3R5cGUgPT09ICJodG1sIikgewogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2VsZW1lbnRzID0gJChkYXRhW2pdLl9hRGF0YVtjb2x1bW5fbnVtYmVyX2ZpbHRlcl0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9lbGVtZW50cyA9IGRvdDJvYmooZGF0YVtqXS5fYURhdGEsIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZWxlbWVudHMgPSAkKGNvbF9pbm5lcl9lbGVtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb2xfaW5uZXJfZWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgY29sX2lubmVyX2VsZW1lbnRzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YV9oZWxwZXIgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoY29sdW1uT2JqLmh0bWxfZGF0YV90eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gJChjb2xfaW5uZXJfZWxlbWVudHNba10pLnRleHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9ICQoY29sX2lubmVyX2VsZW1lbnRzW2tdKS52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IGNvbF9pbm5lcl9lbGVtZW50c1trXS5pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0b3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlbiA9ICQoY29sX2lubmVyX2VsZW1lbnRzW2tdKS5maW5kKGNvbHVtbk9iai5odG1sX2RhdGFfc2VsZWN0b3IpLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGEgPSAkKGNvbF9pbm5lcl9lbGVtZW50c1trXSkuZmluZChjb2x1bW5PYmouaHRtbF9kYXRhX3NlbGVjdG9yKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGVuID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGFfaGVscGVyID0gJChjb2xfaW5uZXJfZWxlbWVudHNba10pLmZpbmQoY29sdW1uT2JqLmh0bWxfZGF0YV9zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xfaW5uZXJfZGF0YSB8fCBjb2xfaW5uZXJfZGF0YV9oZWxwZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbF9pbm5lcl9kYXRhX2hlbHBlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC50cmltKGNvbF9pbm5lcl9kYXRhKSAhPT0gJycgJiYgIShjb2xfZmlsdGVyX2FycmF5Lmhhc093blByb3BlcnR5KGNvbF9pbm5lcl9kYXRhKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9maWx0ZXJfYXJyYXlbY29sX2lubmVyX2RhdGFdID0gY29sX2lubmVyX2RhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YS5wdXNoKGNvbF9pbm5lcl9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gY29sX2lubmVyX2RhdGFfaGVscGVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YV9oZWxwZXIuZWFjaChmdW5jdGlvbiAoaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbG0gPSAkKGNvbF9pbm5lcl9kYXRhW2luZGV4XSkudGV4dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQudHJpbShlbG0pICE9PSAnJyAmJiAhKGNvbF9maWx0ZXJfYXJyYXkuaGFzT3duUHJvcGVydHkoZWxtKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfZmlsdGVyX2FycmF5W2VsbV0gPSBlbG07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEucHVzaChlbG0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sX2lubmVyX2VsZW1lbnRzLnNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IGNvbF9pbm5lcl9lbGVtZW50cy5zZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gZGF0YVtqXS5fYURhdGFbY29sdW1uX251bWJlcl9maWx0ZXJdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkLnRyaW0oY29sX2lubmVyX2RhdGEpICE9PSAnJyAmJiAhKGNvbF9maWx0ZXJfYXJyYXkuaGFzT3duUHJvcGVydHkoY29sX2lubmVyX2RhdGEpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2ZpbHRlcl9hcnJheVtjb2xfaW5uZXJfZGF0YV0gPSBjb2xfaW5uZXJfZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLnB1c2goY29sX2lubmVyX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmNvbHVtbl9kYXRhX3R5cGUgPT09ICJ0ZXh0IikgewogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmoudGV4dF9kYXRhX2RlbGltaXRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9lbGVtZW50cyA9IGRhdGFbal0uX2FEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXS5zcGxpdChjb2x1bW5PYmoudGV4dF9kYXRhX2RlbGltaXRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZWxlbWVudHMgPSBkb3Qyb2JqKGRhdGFbal0uX2FEYXRhLCBjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9lbGVtZW50cyA9IChjb2xfaW5uZXJfZWxlbWVudHMgKyAnJykuc3BsaXQoY29sdW1uT2JqLnRleHRfZGF0YV9kZWxpbWl0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBjb2xfaW5uZXJfZWxlbWVudHMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gY29sX2lubmVyX2VsZW1lbnRzW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQudHJpbShjb2xfaW5uZXJfZGF0YSkgIT09ICcnICYmICEoY29sX2ZpbHRlcl9hcnJheS5oYXNPd25Qcm9wZXJ0eShjb2xfaW5uZXJfZGF0YSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2ZpbHRlcl9hcnJheVtjb2xfaW5uZXJfZGF0YV0gPSBjb2xfaW5uZXJfZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YS5wdXNoKGNvbF9pbm5lcl9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gZGF0YVtqXS5fYURhdGFbY29sdW1uX251bWJlcl9maWx0ZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb2xfaW5uZXJfZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmh0bWw1X2RhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IGNvbF9pbm5lcl9kYXRhWydAJyArIGNvbHVtbk9iai5odG1sNV9kYXRhXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbF9pbm5lcl9kYXRhICYmIGNvbF9pbm5lcl9kYXRhLmRpc3BsYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGEgPSBjb2xfaW5uZXJfZGF0YS5kaXNwbGF5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdXYXJuaW5nOiBMb29rcyBsaWtlIHlvdSBoYXZlIGZvcmdvdCB0byBkZWZpbmUgdGhlIGh0bWw1X2RhdGEgYXR0cmlidXRlIGZvciB0aGUgJyArIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyICsgJyBjb2x1bW4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhW2pdLl9hRmlsdGVyRGF0YSAhPT0gdW5kZWZpbmVkICYmIGRhdGFbal0uX2FGaWx0ZXJEYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IGRhdGFbal0uX2FGaWx0ZXJEYXRhW2NvbHVtbl9udW1iZXJfZmlsdGVyXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gZG90Mm9iaihkYXRhW2pdLl9hRGF0YSwgY29sdW1uT2JqLmNvbHVtbl9udW1iZXJfZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQudHJpbShjb2xfaW5uZXJfZGF0YSkgIT09ICcnICYmICEoY29sX2ZpbHRlcl9hcnJheS5oYXNPd25Qcm9wZXJ0eShjb2xfaW5uZXJfZGF0YSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfZmlsdGVyX2FycmF5W2NvbF9pbm5lcl9kYXRhXSA9IGNvbF9pbm5lcl9kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEucHVzaChjb2xfaW5uZXJfZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5jb2x1bW5fZGF0YV90eXBlID09PSAicmVuZGVyZWRfaHRtbCIpIHsKICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZWxlbWVudHMgPSBkYXRhW2pdLl9hRmlsdGVyRGF0YVtjb2x1bW5fbnVtYmVyX2ZpbHRlcl07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb2xfaW5uZXJfZWxlbWVudHMgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9lbGVtZW50cyA9ICQoY29sX2lubmVyX2VsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbF9pbm5lcl9lbGVtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgY29sX2lubmVyX2VsZW1lbnRzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjb2x1bW5PYmouaHRtbF9kYXRhX3R5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidGV4dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9ICQoY29sX2lubmVyX2VsZW1lbnRzW2tdKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGEgPSAkKGNvbF9pbm5lcl9lbGVtZW50c1trXSkudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGEgPSBjb2xfaW5uZXJfZWxlbWVudHNba10uaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0b3IiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2lubmVyX2RhdGEgPSAkKGNvbF9pbm5lcl9lbGVtZW50c1trXSkuZmluZChjb2x1bW5PYmouaHRtbF9kYXRhX3NlbGVjdG9yKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaW5uZXJfZGF0YSA9IGNvbF9pbm5lcl9lbGVtZW50cy5zZWxlY3RvcjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9pbm5lcl9kYXRhID0gY29sX2lubmVyX2VsZW1lbnRzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoJC50cmltKGNvbF9pbm5lcl9kYXRhKSAhPT0gJycgJiYgIShjb2xfZmlsdGVyX2FycmF5Lmhhc093blByb3BlcnR5KGNvbF9pbm5lcl9kYXRhKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sX2ZpbHRlcl9hcnJheVtjb2xfaW5uZXJfZGF0YV0gPSBjb2xfaW5uZXJfZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEucHVzaChjb2xfaW5uZXJfZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbHVtbk9iai5jb2xfZmlsdGVyX2FycmF5ID0gY29sX2ZpbHRlcl9hcnJheTsKICAgICAgICAgICAgcmV0dXJuIGNvbHVtbl9kYXRhOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYXBwZW5kRmlsdGVycyhvVGFibGUsIGFyZ3MsIHRhYmxlX3NlbGVjdG9yLCBwU2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyICRmaWx0ZXJfc2VsZWN0b3IsCiAgICAgICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nLAogICAgICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgICAgIGZpbHRlcl9jb250YWluZXJfaWQsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2RhdGEsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyLAogICAgICAgICAgICAgICAgY29sdW1uX3Bvc2l0aW9uLAogICAgICAgICAgICAgICAgZmlsdGVyX2RlZmF1bHRfbGFiZWwsCiAgICAgICAgICAgICAgICBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQsCiAgICAgICAgICAgICAgICBlbmFibGVfYXV0b19jb21wbGV0ZSwKICAgICAgICAgICAgICAgIGRhdGVfZm9ybWF0LAogICAgICAgICAgICAgICAgaWdub3JlX2NoYXIsCiAgICAgICAgICAgICAgICBmaWx0ZXJfbWF0Y2hfbW9kZSwKICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhLAogICAgICAgICAgICAgICAgY29sdW1uX2RhdGFfdGVtcCwKICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wLAogICAgICAgICAgICAgICAgaWksCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgIG1pbl92YWwsCiAgICAgICAgICAgICAgICBtYXhfdmFsLAogICAgICAgICAgICAgICAgY29sX251bV92aXNpYmxlLAogICAgICAgICAgICAgICAgY29sX251bV92aXNpYmxlX2l0ZXIsCiAgICAgICAgICAgICAgICB0bXBTdHIsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmpLZXksCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBmaWx0ZXJzX3Bvc2l0aW9uLAogICAgICAgICAgICAgICAgdW5pcXVlX3RoLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciwKICAgICAgICAgICAgICAgIGN1c3RvbV9mdW5jX2ZpbHRlcl92YWx1ZV9ob2xkZXIsCiAgICAgICAgICAgICAgICBleGNsdWRlX3N0cjsKCiAgICAgICAgICAgIGlmIChwU2V0dGluZ3MgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKG9UYWJsZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0ID0gcFNldHRpbmdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldHRpbmdzTWFwW2dlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKG9UYWJsZSldID0gc2V0dGluZ3NEdDsKCiAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ID0geWFkY2YuZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseTIob1RhYmxlKTsKCiAgICAgICAgICAgIGluaXRDb2xSZW9yZGVyMihzZXR0aW5nc0R0LCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CgogICAgICAgICAgICBmaWx0ZXJzX3Bvc2l0aW9uID0gJChkb2N1bWVudCkuZGF0YSh0YWJsZV9zZWxlY3RvciArICJfZmlsdGVyc19wb3NpdGlvbiIpOwogICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vU2Nyb2xsLnNYICE9PSAnJyB8fCBzZXR0aW5nc0R0Lm9TY3JvbGwuc1kgIT09ICcnKSB7CiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3RvciA9ICcueWFkY2YtZGF0YXRhYmxlcy10YWJsZS0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHk7CiAgICAgICAgICAgICAgICBpZiAoJCh0YWJsZV9zZWxlY3RvcikubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsWFlIYW5kbGVyKG9UYWJsZSwgJyMnICsgZ2V0VGFibGVJZChvVGFibGUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vQXBpLl9mbkdldFVuaXF1ZVRocyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB1bmlxdWVfdGggPSBzZXR0aW5nc0R0Lm9BcGkuX2ZuR2V0VW5pcXVlVGhzKHNldHRpbmdzRHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoY29sdW1uT2JqS2V5IGluIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmdzLmhhc093blByb3BlcnR5KGNvbHVtbk9iaktleSkpIHsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmogPSBhcmdzW2NvbHVtbk9iaktleV07CgogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wID0gJyc7CiAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGNvbHVtbk9iai5kYXRhOwogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhID0gW107CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGFfdGVtcCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZpbHRlcl9jb250YWluZXJfaWQgPSBjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9pZDsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gY29sdW1uT2JqLmNvbHVtbl9udW1iZXI7CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX251bWJlciA9ICtjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9wb3NpdGlvbiA9IGNvbHVtbl9udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIChwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkICYmIChwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkICYmIHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLkNvbFJlb3JkZXIgIT09IHVuZGVmaW5lZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX3Bvc2l0aW9uID0gcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0uQ29sUmVvcmRlcltjb2x1bW5fbnVtYmVyXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iai5jb2x1bW5fbnVtYmVyID0gY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2RhdGEgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKHNldHRpbmdzRHQuYW9Db2x1bW5zW2NvbHVtbl9wb3NpdGlvbl0ubURhdGEpICYmIHR5cGVvZiBzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fcG9zaXRpb25dLm1EYXRhICE9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2RhdGEgPSBzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fcG9zaXRpb25dLm1EYXRhOwogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmouY29sdW1uX251bWJlcl9kYXRhID0gY29sdW1uX251bWJlcl9kYXRhOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4oc2V0dGluZ3NEdC5hb0NvbHVtbnNbY29sdW1uX3Bvc2l0aW9uXS5tUmVuZGVyKSAmJiB0eXBlb2Ygc2V0dGluZ3NEdC5hb0NvbHVtbnNbY29sdW1uX3Bvc2l0aW9uXS5tUmVuZGVyICE9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmouY29sdW1uX251bWJlcl9yZW5kZXIgPSBzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2x1bW5fcG9zaXRpb25dLm1SZW5kZXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpbHRlcl9kZWZhdWx0X2xhYmVsID0gY29sdW1uT2JqLmZpbHRlcl9kZWZhdWx0X2xhYmVsOwogICAgICAgICAgICAgICAgICAgIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCA9IGNvbHVtbk9iai5maWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQ7CiAgICAgICAgICAgICAgICAgICAgZW5hYmxlX2F1dG9fY29tcGxldGUgPSBjb2x1bW5PYmouZW5hYmxlX2F1dG9fY29tcGxldGU7CiAgICAgICAgICAgICAgICAgICAgZGF0ZV9mb3JtYXQgPSBjb2x1bW5PYmouZGF0ZV9mb3JtYXQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVfZm9ybWF0ID0gZGF0ZV9mb3JtYXQucmVwbGFjZSgieXl5eSIsICJ5eSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2Jvb3RzdHJhcC1kYXRldGltZXBpY2tlcicgJiYgY29sdW1uT2JqLmZpbHRlcl9wbHVnaW5fb3B0aW9ucyAhPT0gdW5kZWZpbmVkICYmIGNvbHVtbk9iai5maWx0ZXJfcGx1Z2luX29wdGlvbnMuZm9ybWF0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZV9mb3JtYXQgPSBjb2x1bW5PYmouZmlsdGVyX3BsdWdpbl9vcHRpb25zLmZvcm1hdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29sdW1uT2JqLmRhdGVfZm9ybWF0ID0gZGF0ZV9mb3JtYXQ7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouaWdub3JlX2NoYXIgIT09IHVuZGVmaW5lZCAmJiAhKGNvbHVtbk9iai5pZ25vcmVfY2hhciBpbnN0YW5jZW9mIFJlZ0V4cCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlX2NoYXIgPSBuZXcgUmVnRXhwKGNvbHVtbk9iai5pZ25vcmVfY2hhciwgImciKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uT2JqLmlnbm9yZV9jaGFyID0gaWdub3JlX2NoYXI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZpbHRlcl9tYXRjaF9tb2RlID0gY29sdW1uT2JqLmZpbHRlcl9tYXRjaF9tb2RlOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uX251bWJlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCJZb3UgbXVzdCBzcGVjaWZ5IGNvbHVtbiBudW1iZXIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGVuYWJsZV9hdXRvX2NvbXBsZXRlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9ICJhdXRvX2NvbXBsZXRlIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfZGVmYXVsdF9sYWJlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX2RlZmF1bHRfbGFiZWwgPSBwbGFjZWhvbGRlckxhbmcuc2VsZWN0OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gIm11bHRpX3NlbGVjdCIgfHwgY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnbXVsdGlfc2VsZWN0X2N1c3RvbV9mdW5jJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX2RlZmF1bHRfbGFiZWwgPSBwbGFjZWhvbGRlckxhbmcuc2VsZWN0X211bHRpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gImF1dG9fY29tcGxldGUiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gInRleHQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfZGVmYXVsdF9sYWJlbCA9IHBsYWNlaG9sZGVyTGFuZy5maWx0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAicmFuZ2VfbnVtYmVyIiB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJyYW5nZV9kYXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX2RlZmF1bHRfbGFiZWwgPSBwbGFjZWhvbGRlckxhbmcucmFuZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAiZGF0ZSIgfHwgY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnZGF0ZV9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcl9kZWZhdWx0X2xhYmVsID0gcGxhY2Vob2xkZXJMYW5nLmRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uT2JqLmZpbHRlcl9kZWZhdWx0X2xhYmVsID0gZmlsdGVyX2RlZmF1bHRfbGFiZWw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ID0gIngiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGlpID0gMDsgaWkgPCBkYXRhLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEucHVzaChkYXRhW2lpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCB8fCBjb2x1bW5PYmouYXBwZW5kX2RhdGFfdG9fdGFibGVfZGF0YSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iai5jb2xfZmlsdGVyX2FycmF5ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YV90ZW1wID0gcGFyc2VUYWJsZUNvbHVtbihvVGFibGUsIGNvbHVtbk9iaiwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIHNldHRpbmdzRHQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmFwcGVuZF9kYXRhX3RvX3RhYmxlX2RhdGEgIT09ICdiZWZvcmUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YSA9IGNvbHVtbl9kYXRhLmNvbmNhdChjb2x1bW5fZGF0YV90ZW1wKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhX3RlbXAgPSBzb3J0Q29sdW1uRGF0YShjb2x1bW5fZGF0YV90ZW1wLCBjb2x1bW5PYmopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uX2RhdGEgPSBjb2x1bW5fZGF0YS5jb25jYXQoY29sdW1uX2RhdGFfdGVtcCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouYXBwZW5kX2RhdGFfdG9fdGFibGVfZGF0YSA9PT0gdW5kZWZpbmVkIHx8IGNvbHVtbk9iai5hcHBlbmRfZGF0YV90b190YWJsZV9kYXRhID09PSAnc29ydGVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fZGF0YSA9IHNvcnRDb2x1bW5EYXRhKGNvbHVtbl9kYXRhLCBjb2x1bW5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gInJhbmdlX251bWJlcl9zbGlkZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbl92YWwgPSBmaW5kTWluSW5BcnJheShjb2x1bW5fZGF0YSwgY29sdW1uT2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4X3ZhbCA9IGZpbmRNYXhJbkFycmF5KGNvbHVtbl9kYXRhLCBjb2x1bW5PYmopOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9jb250YWluZXJfaWQgPT09IHVuZGVmaW5lZCAmJiBjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3RvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vQ2FuJ3Qgc2hvdyBmaWx0ZXIgaW5zaWRlIGEgY29sdW1uIGZvciBhIGhpZGRlbiBvbmUgKHBsYWNlIGl0IG91dHNpZGUgdXNpbmcgZmlsdGVyX2NvbnRhaW5lcl9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQuYW9Db2x1bW5zW2NvbHVtbl9wb3NpdGlvbl0uYlZpc2libGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdZYWRjZiB3YXJuaW5nOiBDYW5cJ3Qgc2hvdyBmaWx0ZXIgaW5zaWRlIGEgY29sdW1uIE4jJyArIGNvbHVtbl9udW1iZXIgKyAnIGZvciBhIGhpZGRlbiBvbmUgKHBsYWNlIGl0IG91dHNpZGUgdXNpbmcgZmlsdGVyX2NvbnRhaW5lcl9pZCknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyc19wb3NpdGlvbiAhPT0gJ3RoZWFkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXF1ZV90aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9oYW5kbGUgaGlkZGVuIGNvbHVtbnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfbnVtX3Zpc2libGUgPSBjb2x1bW5fcG9zaXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2xfbnVtX3Zpc2libGVfaXRlciA9IDA7IGNvbF9udW1fdmlzaWJsZV9pdGVyIDwgc2V0dGluZ3NEdC5hb0NvbHVtbnMubGVuZ3RoICYmIGNvbF9udW1fdmlzaWJsZV9pdGVyIDwgY29sdW1uX3Bvc2l0aW9uOyBjb2xfbnVtX3Zpc2libGVfaXRlcisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0LmFvQ29sdW1uc1tjb2xfbnVtX3Zpc2libGVfaXRlcl0uYlZpc2libGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfbnVtX3Zpc2libGUtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fcG9zaXRpb24gPSBjb2xfbnVtX3Zpc2libGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyA9IHRhYmxlX3NlbGVjdG9yICsgJyAnICsgZmlsdGVyc19wb3NpdGlvbiArICcgdGg6ZXEoJyArIGNvbHVtbl9wb3NpdGlvbiArICcpJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyA9IHRhYmxlX3NlbGVjdG9yICsgJyAnICsgZmlsdGVyc19wb3NpdGlvbiArICcgdGg6ZXEoJyArICQodW5pcXVlX3RoW2NvbHVtbl9wb3NpdGlvbl0pLmluZGV4KCkgKyAnKSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcnNfdHJfaW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgPSB0YWJsZV9zZWxlY3RvciArICcgJyArIGZpbHRlcnNfcG9zaXRpb24gKyAnIHRyOmVxKCcgKyAkKHVuaXF1ZV90aFtjb2x1bW5fcG9zaXRpb25dKS5wYXJlbnQoKS5pbmRleCgpICsgJykgdGg6ZXEoJyArICQodW5pcXVlX3RoW2NvbHVtbl9wb3NpdGlvbl0pLmluZGV4KCkgKyAnKSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgPSB0YWJsZV9zZWxlY3RvciArICcgJyArIGZpbHRlcnNfcG9zaXRpb24gKyAnIHRyOmVxKCcgKyBjb2x1bW5PYmouZmlsdGVyc190cl9pbmRleCArICcpIHRoOmVxKCcgKyAkKHVuaXF1ZV90aFtjb2x1bW5fcG9zaXRpb25dKS5pbmRleCgpICsgJyknOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICRmaWx0ZXJfc2VsZWN0b3IgPSAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5zZWxlY3RfdHlwZSA9PT0gJ3NlbGVjdDInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmlsdGVyX3NlbGVjdG9yID0gJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCJzZWxlY3QueWFkY2YtZmlsdGVyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX2NvbnRhaW5lcl9pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3RvciA9ICIjIiArIGZpbHRlcl9jb250YWluZXJfaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoY29sdW1uT2JqLmZpbHRlcl9jb250YWluZXJfc2VsZWN0b3IpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkVSUk9SOiBGaWx0ZXIgY29udGFpbmVyIGNvdWxkIG5vdCBiZSBmb3VuZCwgY29sdW1uT2JqLmZpbHRlcl9jb250YWluZXJfc2VsZWN0b3I6ICIgKyBjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nID0gY29sdW1uT2JqLmZpbHRlcl9jb250YWluZXJfc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgICRmaWx0ZXJfc2VsZWN0b3IgPSAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJyB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJtdWx0aV9zZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRhX2FzX2lzICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLm9taXRfZGVmYXVsdF9sYWJlbCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCA9ICI8b3B0aW9uIHZhbHVlPVwiIiArICItMSIgKyAiXCI+IiArIGZpbHRlcl9kZWZhdWx0X2xhYmVsICsgIjwvb3B0aW9uPiI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLnNlbGVjdF90eXBlID09PSAnc2VsZWN0MicgJiYgY29sdW1uT2JqLnNlbGVjdF90eXBlX29wdGlvbnMucGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCAmJiBjb2x1bW5PYmouc2VsZWN0X3R5cGVfb3B0aW9ucy5hbGxvd0NsZWFyID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCA9ICI8b3B0aW9uIHZhbHVlPVwiXCI+PC9vcHRpb24+IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAibXVsdGlfc2VsZWN0IiB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICdtdWx0aV9zZWxlY3RfY3VzdG9tX2Z1bmMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouc2VsZWN0X3R5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc190bXAgPSAiPG9wdGlvbiBkYXRhLXBsYWNlaG9sZGVyPVwidHJ1ZVwiIHZhbHVlPVwiIiArICItMSIgKyAiXCI+IiArIGZpbHRlcl9kZWZhdWx0X2xhYmVsICsgIjwvb3B0aW9uPiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouYXBwZW5kX2RhdGFfdG9fdGFibGVfZGF0YSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb2x1bW5fZGF0YVswXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpaSA9IDA7IGlpIDwgY29sdW1uX2RhdGEubGVuZ3RoOyBpaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCArPSAiPG9wdGlvbiB2YWx1ZT1cIiIgKyAoY29sdW1uX2RhdGFbaWldLnZhbHVlICsgJycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpICsgIlwiPiIgKyBjb2x1bW5fZGF0YVtpaV0ubGFiZWwgKyAiPC9vcHRpb24+IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IGNvbHVtbl9kYXRhLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc190bXAgKz0gIjxvcHRpb24gdmFsdWU9XCIiICsgKGNvbHVtbl9kYXRhW2lpXSArICcnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKSArICJcIj4iICsgY29sdW1uX2RhdGFbaWldICsgIjwvb3B0aW9uPiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IGNvbHVtbl9kYXRhLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbHVtbl9kYXRhW2lpXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wICs9ICI8b3B0aW9uIHZhbHVlPVwiIiArIChjb2x1bW5fZGF0YVtpaV0udmFsdWUgKyAnJykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7JykgKyAiXCI+IiArIGNvbHVtbl9kYXRhW2lpXS5sYWJlbCArICI8L29wdGlvbj4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc190bXAgKz0gIjxvcHRpb24gdmFsdWU9XCIiICsgKGNvbHVtbl9kYXRhW2lpXSArICcnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKSArICJcIj4iICsgY29sdW1uX2RhdGFbaWldICsgIjwvb3B0aW9uPiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCA9IGNvbHVtbk9iai5kYXRhOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl9kYXRhID0gb3B0aW9uc190bXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICgkZmlsdGVyX3NlbGVjdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAic2VsZWN0IiB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJtdWx0aV9zZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJyB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICdtdWx0aV9zZWxlY3RfY3VzdG9tX2Z1bmMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnY3VzdG9tX2Z1bmMnIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21fZnVuY19maWx0ZXJfdmFsdWVfaG9sZGVyID0gJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRmaWx0ZXJfc2VsZWN0b3IuZW1wdHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRmaWx0ZXJfc2VsZWN0b3IuYXBwZW5kKGNvbHVtbl9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0LmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fcG9zaXRpb25dLnNTZWFyY2ggIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gc2V0dGluZ3NEdC5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHlhZGNmUGFyc2VNYXRjaEZpbHRlcih0bXBTdHIsIGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXS5maWx0ZXJfbWF0Y2hfbW9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKHRtcFN0cikuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJtdWx0aV9zZWxlY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHlhZGNmUGFyc2VNYXRjaEZpbHRlck11bHRpU2VsZWN0KHRtcFN0ciwgZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdLmZpbHRlcl9tYXRjaF9tb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gdG1wU3RyLnJlcGxhY2UoL1xcL2csICIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gdG1wU3RyLnNwbGl0KCJ8Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKHRtcFN0cik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJyB8fCBjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICdtdWx0aV9zZWxlY3RfY3VzdG9tX2Z1bmMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gY3VzdG9tX2Z1bmNfZmlsdGVyX3ZhbHVlX2hvbGRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wU3RyID09PSAnLTEnIHx8IHRtcFN0ciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKHRtcFN0cik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwodG1wU3RyKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbGl6ZVNlbGVjdFBsdWdpbihjb2x1bW5PYmouc2VsZWN0X3R5cGUsICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksIGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouY3VtdWxhdGl2ZV9maWx0ZXJpbmcgPT09IHRydWUgJiYgY29sdW1uT2JqLnNlbGVjdF90eXBlID09PSAnY2hvc2VuJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4oY29sdW1uT2JqLCAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJhdXRvX2NvbXBsZXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkuZGF0YSgieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIsIGNvbHVtbl9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfY29udGFpbmVyX2lkID09PSB1bmRlZmluZWQgJiYgY29sdW1uT2JqLmZpbHRlcl9jb250YWluZXJfc2VsZWN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArICIgZGl2LkRhdGFUYWJsZXNfc29ydF93cmFwcGVyIikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArICIgZGl2LkRhdGFUYWJsZXNfc29ydF93cmFwcGVyIikuY3NzKCJkaXNwbGF5IiwgImlubGluZS1ibG9jayIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9jb250YWluZXJfaWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iai5maWx0ZXJfY29udGFpbmVyX3NlbGVjdG9yID0gIiMiICsgZmlsdGVyX2NvbnRhaW5lcl9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKCIjeWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIGdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHlOZXcoY29sdW1uT2JqLmZpbHRlcl9jb250YWluZXJfc2VsZWN0b3IpKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGNvbHVtbk9iai5maWx0ZXJfY29udGFpbmVyX3NlbGVjdG9yKS5hcHBlbmQoIjxkaXYgaWQ9XCJ5YWRjZi1maWx0ZXItd3JhcHBlci0iICsgZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseU5ldyhjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3RvcikgKyAiXCI+PC9kaXY+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nID0gIiN5YWRjZi1maWx0ZXItd3JhcHBlci0iICsgZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseU5ldyhjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ2N1c3RvbV9mdW5jJykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vYWRkIGEgd3JhcHBlciB0byBob2xkIGJvdGggZmlsdGVyIGFuZCByZXNldCBidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8ZGl2IGlkPVwieWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci13cmFwcGVyXCI+PC9kaXY+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nICs9ICIgZGl2LnlhZGNmLWZpbHRlci13cmFwcGVyIjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICdvbmNoYW5nZT0ieWFkY2YuZG9GaWx0ZXIodGhpcywgXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnXCcsICcgKyBjb2x1bW5fbnVtYmVyICsgJywgXCcnICsgZmlsdGVyX21hdGNoX21vZGUgKyAnXCcpOyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8c2VsZWN0IGlkPVwieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXIgIiArIGNvbHVtbk9iai5zdHlsZV9jbGFzcyArICJcIiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyICsgIiBvbmtleWRvd249XCJ5YWRjZi5wcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2ZW50KTtcIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgb25jbGljaz0neWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsnPiIgKyBjb2x1bW5fZGF0YSArICI8L3NlbGVjdD4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS5hZnRlcigiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICItcmVzZXRcIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgb25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YuZG9GaWx0ZXIoJ2NsZWFyJywgJyIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICInLCAiICsgY29sdW1uX251bWJlciArICIpOyByZXR1cm4gZmFsc2U7XCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmVzZXQtYnV0dG9uICIgKyBjb2x1bW5PYmoucmVzZXRfYnV0dG9uX3N0eWxlX2NsYXNzICsgIlwiPiIgKyBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgKyAiPC9idXR0b24+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnb25jaGFuZ2U9InlhZGNmLmRvRmlsdGVyQ3VzdG9tRGF0ZUZ1bmModGhpcywgXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgICsgJ1wnLCAnICsgIGNvbHVtbl9udW1iZXIgKyAnKTsiJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPHNlbGVjdCBpZD1cInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyICIgKyBjb2x1bW5PYmouc3R5bGVfY2xhc3MgKyAiXCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciArICIgb25rZXlkb3duPVwieWFkY2YucHJldmVudERlZmF1bHRGb3JFbnRlcihldmVudCk7XCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9J3lhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7Jz4iICsgY29sdW1uX2RhdGEgKyAiPC9zZWxlY3Q+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCIueWFkY2YtZmlsdGVyIikuYWZ0ZXIoIjxidXR0b24gdHlwZT1cImJ1dHRvblwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvbmNsaWNrPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi5kb0ZpbHRlckN1c3RvbURhdGVGdW5jKCdjbGVhcicsICciICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiJywgIiArIGNvbHVtbl9udW1iZXIgKyAiKTsgcmV0dXJuIGZhbHNlO1wiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJlc2V0LWJ1dHRvbiAiICsgY29sdW1uT2JqLnJlc2V0X2J1dHRvbl9zdHlsZV9jbGFzcyArICJcIj4iICsgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICsgIjwvYnV0dG9uPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQub0ZlYXR1cmVzLmJTdGF0ZVNhdmUgPT09IHRydWUgJiYgc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgJiYgc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gJiYgc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdLmZyb207CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG1wU3RyID09PSAnLTEnIHx8IHRtcFN0ciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwodG1wU3RyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwodG1wU3RyKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ3VzdG9tRnVuY3Rpb25GaWx0ZXJDYXBhYmlsaXR5KHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCAieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIsIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZlBhcnNlTWF0Y2hGaWx0ZXIodG1wU3RyLCBnZXRPcHRpb25zKG9UYWJsZS5zZWxlY3RvcilbY29sdW1uX251bWJlcl0uZmlsdGVyX21hdGNoX21vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKHRtcFN0cikuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5zZWxlY3RfdHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbGl6ZVNlbGVjdFBsdWdpbihjb2x1bW5PYmouc2VsZWN0X3R5cGUsICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksIGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmN1bXVsYXRpdmVfZmlsdGVyaW5nID09PSB0cnVlICYmIGNvbHVtbk9iai5zZWxlY3RfdHlwZSA9PT0gJ2Nob3NlbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaFNlbGVjdFBsdWdpbihjb2x1bW5PYmosICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJtdWx0aV9zZWxlY3QiIHx8IGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYycpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2FkZCBhIHdyYXBwZXIgdG8gaG9sZCBib3RoIGZpbHRlciBhbmQgcmVzZXQgYnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBpZD1cInlhZGNmLWZpbHRlci13cmFwcGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItd3JhcHBlclwiPjwvZGl2PiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiIGRpdi55YWRjZi1maWx0ZXItd3JhcHBlciI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gIm11bHRpX3NlbGVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnb25jaGFuZ2U9InlhZGNmLmRvRmlsdGVyTXVsdGlTZWxlY3QodGhpcywgXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnXCcsICcgKyBjb2x1bW5fbnVtYmVyICsgJywgXCcnICsgZmlsdGVyX21hdGNoX21vZGUgKyAnXCcpOyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8c2VsZWN0IG11bHRpcGxlIGRhdGEtcGxhY2Vob2xkZXI9XCIiICsgZmlsdGVyX2RlZmF1bHRfbGFiZWwgKyAiXCIgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlciAiICsgY29sdW1uT2JqLnN0eWxlX2NsYXNzICsgIlwiICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgKyAiIG9ua2V5ZG93bj1cInlhZGNmLnByZXZlbnREZWZhdWx0Rm9yRW50ZXIoZXZlbnQpO1wiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiBvbmNsaWNrPSd5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyc+IiArIGNvbHVtbl9kYXRhICsgIjwvc2VsZWN0PiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS5hZnRlcigiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9uY2xpY2s9XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO3lhZGNmLmRvRmlsdGVyKCdjbGVhcicsICciICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiJywgIiArIGNvbHVtbl9udW1iZXIgKyAiKTsgcmV0dXJuIGZhbHNlO1wiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJlc2V0LWJ1dHRvbiAiICsgY29sdW1uT2JqLnJlc2V0X2J1dHRvbl9zdHlsZV9jbGFzcyArICJcIj4iICsgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICsgIjwvYnV0dG9uPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaCAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gc2V0dGluZ3NEdC5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZlBhcnNlTWF0Y2hGaWx0ZXJNdWx0aVNlbGVjdCh0bXBTdHIsIGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXS5maWx0ZXJfbWF0Y2hfbW9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHRtcFN0ci5yZXBsYWNlKC9cXC9nLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHRtcFN0ci5zcGxpdCgifCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnZhbCh0bXBTdHIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJ29uY2hhbmdlPSJ5YWRjZi5kb0ZpbHRlckN1c3RvbURhdGVGdW5jKHRoaXMsIFwnJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJ1wnLCAnICsgY29sdW1uX251bWJlciArICcpOyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8c2VsZWN0IG11bHRpcGxlIGRhdGEtcGxhY2Vob2xkZXI9XCIiICsgZmlsdGVyX2RlZmF1bHRfbGFiZWwgKyAiXCIgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlciAiICsgY29sdW1uT2JqLnN0eWxlX2NsYXNzICsgIlwiICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgKyAiIG9ua2V5ZG93bj1cInlhZGNmLnByZXZlbnREZWZhdWx0Rm9yRW50ZXIoZXZlbnQpO1wiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiBvbmNsaWNrPSd5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyc+IiArIGNvbHVtbl9kYXRhICsgIjwvc2VsZWN0PiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS5hZnRlcigiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm9uY2xpY2s9XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO3lhZGNmLmRvRmlsdGVyQ3VzdG9tRGF0ZUZ1bmMoJ2NsZWFyJywgJyIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICInLCAiICsgY29sdW1uX251bWJlciArICIpOyByZXR1cm4gZmFsc2U7XCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmVzZXQtYnV0dG9uICIgKyBjb2x1bW5PYmoucmVzZXRfYnV0dG9uX3N0eWxlX2NsYXNzICsgIlwiPiIgKyBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgKyAiPC9idXR0b24+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSAmJiBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSAmJiBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAmJiBzZXR0aW5nc0R0Lm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0gc2V0dGluZ3NEdC5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0uZnJvbTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXBTdHIgPT09ICctMScgfHwgdG1wU3RyID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnZhbCh0bXBTdHIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnZhbCh0bXBTdHIpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0Lm9GZWF0dXJlcy5iU2VydmVyU2lkZSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDdXN0b21GdW5jdGlvbkZpbHRlckNhcGFiaWxpdHkodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX2NvbnRhaW5lcl9zZWxlY3RvciA9PT0gdW5kZWZpbmVkICYmIGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zLndpZHRoID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmouc2VsZWN0X3R5cGVfb3B0aW9ucyA9ICQuZXh0ZW5kKGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zLCB7d2lkdGg6ICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuY2xvc2VzdCgidGgiKS53aWR0aCgpICsgInB4In0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfY29udGFpbmVyX3NlbGVjdG9yICE9PSB1bmRlZmluZWQgJiYgY29sdW1uT2JqLnNlbGVjdF90eXBlX29wdGlvbnMud2lkdGggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iai5zZWxlY3RfdHlwZV9vcHRpb25zID0gJC5leHRlbmQoY29sdW1uT2JqLnNlbGVjdF90eXBlX29wdGlvbnMsIHt3aWR0aDogJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5jbG9zZXN0KGNvbHVtbk9iai5maWx0ZXJfY29udGFpbmVyX3NlbGVjdG9yKS53aWR0aCgpICsgInB4In0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouc2VsZWN0X3R5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxpemVTZWxlY3RQbHVnaW4oY29sdW1uT2JqLnNlbGVjdF90eXBlLCAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLCBjb2x1bW5PYmouc2VsZWN0X3R5cGVfb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5jdW11bGF0aXZlX2ZpbHRlcmluZyA9PT0gdHJ1ZSAmJiBjb2x1bW5PYmouc2VsZWN0X3R5cGUgPT09ICdjaG9zZW4nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4oY29sdW1uT2JqLCAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAiYXV0b19jb21wbGV0ZSIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2FkZCBhIHdyYXBwZXIgdG8gaG9sZCBib3RoIGZpbHRlciBhbmQgcmVzZXQgYnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBpZD1cInlhZGNmLWZpbHRlci13cmFwcGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItd3JhcHBlclwiPjwvZGl2PiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiIGRpdi55YWRjZi1maWx0ZXItd3JhcHBlciI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQWN0aW9uU3RyID0gJ29ua2V5dXA9InlhZGNmLmF1dG9jb21wbGV0ZUtleVVQKFwnJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJ1wnLGV2ZW50KTsiJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXh0ZXJuYWxseV90cmlnZ2VyZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8aW5wdXQgb25rZXlkb3duPVwieWFkY2YucHJldmVudERlZmF1bHRGb3JFbnRlcihldmVudCk7XCIgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlclwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiBvbmNsaWNrPSd5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICInIHBsYWNlaG9sZGVyPSciICsgZmlsdGVyX2RlZmF1bHRfbGFiZWwgKyAiJyIgKyAiIGZpbHRlcl9tYXRjaF9tb2RlPSciICsgZmlsdGVyX21hdGNoX21vZGUgKyAiJyAiICsgZmlsdGVyQWN0aW9uU3RyICsgIj48L2lucHV0PiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkuZGF0YSgieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIsIGNvbHVtbl9kYXRhKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuZmluZCgiLnlhZGNmLWZpbHRlciIpLmFmdGVyKCI8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvbmNsaWNrPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi5kb0ZpbHRlckF1dG9jb21wbGV0ZSgnY2xlYXInLCAnIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIicsICIgKyBjb2x1bW5fbnVtYmVyICsgIik7IHJldHVybiBmYWxzZTtcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yZXNldC1idXR0b24gIiArIGNvbHVtbk9iai5yZXNldF9idXR0b25fc3R5bGVfY2xhc3MgKyAiXCI+IiArIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCArICI8L2J1dHRvbj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJ0ZXh0IikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vYWRkIGEgd3JhcHBlciB0byBob2xkIGJvdGggZmlsdGVyIGFuZCByZXNldCBidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8ZGl2IGlkPVwieWFkY2YtZmlsdGVyLXdyYXBwZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlci13cmFwcGVyXCI+PC9kaXY+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nICs9ICIgZGl2LnlhZGNmLWZpbHRlci13cmFwcGVyIjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJBY3Rpb25TdHIgPSAnb25rZXl1cD0ieWFkY2YudGV4dEtleVVQKGV2ZW50LFwnJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJ1wnLCAnICsgY29sdW1uX251bWJlciArICcpOyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5leHRlcm5hbGx5X3RyaWdnZXJlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlckFjdGlvblN0ciA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2x1ZGVfc3RyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4Y2x1ZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2x1ZGVfc3RyID0gJzxzcGFuIGNsYXNzPSJ5YWRjZi1leGNsdWRlLXdyYXBwZXIiIG9ubW91c2Vkb3duPSJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIgb25jbGljaz0ieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9InlhZGNmLWxhYmVsIHNtYWxsIj4nICsgY29sdW1uT2JqLmV4Y2x1ZGVfbGFiZWwgKyAnPC9kaXY+PGlucHV0IHR5cGU9ImNoZWNrYm94IiB0aXRsZT0iJyArIGNvbHVtbk9iai5leGNsdWRlX2xhYmVsICsgJyIgb25jbGljaz0ieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi50ZXh0S2V5VVAoZXZlbnQsXCcnICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnXCcsJyArIGNvbHVtbl9udW1iZXIgKyAnKTsiPjwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2x1ZGVfc3RyID0gJzxzcGFuIGNsYXNzPSJ5YWRjZi1leGNsdWRlLXdyYXBwZXIiIG9ubW91c2Vkb3duPSJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIgb25jbGljaz0ieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsiPicgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9InlhZGNmLWxhYmVsIHNtYWxsIj4nICsgY29sdW1uT2JqLmV4Y2x1ZGVfbGFiZWwgKyAnPC9kaXY+PGlucHV0IHR5cGU9ImNoZWNrYm94IiB0aXRsZT0iJyArIGNvbHVtbk9iai5leGNsdWRlX2xhYmVsICsgJyIgb25jbGljaz0ieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTsiPjwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZChleGNsdWRlX3N0ciArICI8aW5wdXQgdHlwZT1cInRleHRcIiBvbmtleWRvd249XCJ5YWRjZi5wcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2ZW50KTtcIiBpZD1cInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyICIgKyBjb2x1bW5PYmouc3R5bGVfY2xhc3MgKyAiXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9J3lhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7IiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIicgcGxhY2Vob2xkZXI9JyIgKyBmaWx0ZXJfZGVmYXVsdF9sYWJlbCArICInIiArICIgZmlsdGVyX21hdGNoX21vZGU9JyIgKyBmaWx0ZXJfbWF0Y2hfbW9kZSArICInICIgKyBmaWx0ZXJBY3Rpb25TdHIgKyAiPjwvaW5wdXQ+Iik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS5hZnRlcigiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgIiArICIgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciArICItcmVzZXRcIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvbmNsaWNrPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTt5YWRjZi50ZXh0S2V5VVAoZXZlbnQsJyIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICInLCAnIiArIGNvbHVtbl9udW1iZXIgKyAiJywgJ2NsZWFyJyk7IHJldHVybiBmYWxzZTtcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yZXNldC1idXR0b24gIiArIGNvbHVtbk9iai5yZXNldF9idXR0b25fc3R5bGVfY2xhc3MgKyAiXCI+IiArIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCArICI8L2J1dHRvbj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4Y2x1ZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRtcFN0ci5pbmRleE9mKCdeKCg/IScpICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci13cmFwcGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLmZpbmQoJzpjaGVja2JveCcpLnByb3AoJ2NoZWNrZWQnLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB0bXBTdHIuc3Vic3RyaW5nKDUsIHRtcFN0ci5pbmRleE9mKCcpLiknKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHlhZGNmUGFyc2VNYXRjaEZpbHRlcih0bXBTdHIsIGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXS5maWx0ZXJfbWF0Y2hfbW9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwodG1wU3RyKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAiZGF0ZSIgfHwgY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAnZGF0ZV9jdXN0b21fZnVuYycpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGREYXRlRmlsdGVyKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyLCBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQsIGZpbHRlcl9kZWZhdWx0X2xhYmVsLCBkYXRlX2Zvcm1hdCk7CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSA9PT0gInJhbmdlX251bWJlciIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRSYW5nZU51bWJlckZpbHRlcihmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlciwgZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0LCBmaWx0ZXJfZGVmYXVsdF9sYWJlbCwgaWdub3JlX2NoYXIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJyYW5nZV9udW1iZXJfc2xpZGVyIikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZFJhbmdlTnVtYmVyU2xpZGVyRmlsdGVyKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyLCBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQsIG1pbl92YWwsIG1heF92YWwsIGlnbm9yZV9jaGFyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uT2JqLmZpbHRlcl90eXBlID09PSAicmFuZ2VfZGF0ZSIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRSYW5nZURhdGVGaWx0ZXIoZmlsdGVyX3NlbGVjdG9yX3N0cmluZywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGZpbHRlcl9yZXNldF9idXR0b25fdGV4dCwgZmlsdGVyX2RlZmF1bHRfbGFiZWwsIGRhdGVfZm9ybWF0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgkKGRvY3VtZW50KS5kYXRhKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiX3ZhbCIpICE9PSB1bmRlZmluZWQgJiYgJChkb2N1bWVudCkuZGF0YSgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIl92YWwiKSAhPT0gIi0xIikgewogICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS52YWwoJChkb2N1bWVudCkuZGF0YSgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIl92YWwiKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX3R5cGUgPT09ICJhdXRvX2NvbXBsZXRlIikgewogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5PYmouZmlsdGVyX3BsdWdpbl9vcHRpb25zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiAkKGRvY3VtZW50KS5kYXRhKCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Q6IGF1dG9jb21wbGV0ZVNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmV4dGVybmFsbHlfdHJpZ2dlcmVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgY29sdW1uT2JqLmZpbHRlcl9wbHVnaW5fb3B0aW9ucy5zZWxlY3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS5hdXRvY29tcGxldGUoY29sdW1uT2JqLmZpbHRlcl9wbHVnaW5fb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0LmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fcG9zaXRpb25dLnNTZWFyY2ggIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSBzZXR0aW5nc0R0LmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fcG9zaXRpb25dLnNTZWFyY2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZlBhcnNlTWF0Y2hGaWx0ZXIodG1wU3RyLCBnZXRPcHRpb25zKG9UYWJsZS5zZWxlY3RvcilbY29sdW1uX251bWJlcl0uZmlsdGVyX21hdGNoX21vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwodG1wU3RyKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhGaWx0ZXJDb2x1bW5RdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAoZXhGaWx0ZXJDb2x1bW5RdWV1ZS5zaGlmdCgpKSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByYW5nZUNsZWFyKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBldmVudCwgY29sdW1uX251bWJlcikgewogICAgICAgICAgICB2YXIgb1RhYmxlID0gb1RhYmxlc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0sCiAgICAgICAgICAgICAgICB5YWRjZlN0YXRlLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyLAogICAgICAgICAgICAgICAgY3VycmVudEZpbHRlclZhbHVlcywKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIGZyb21JZCA9ICJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi1mcm9tLWRhdGUtIiArIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICB0b0lkID0gInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLXRvLWRhdGUtIiArIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICAkZnJvbUlucHV0LAogICAgICAgICAgICAgICAgJHRvSW5wdXQ7CgogICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICBldmVudCA9IGV2ZW50VGFyZ2V0Rml4VXAoZXZlbnQpOwogICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUob1RhYmxlKTsKCiAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY2FsY0NvbHVtbk51bWJlckZpbHRlcihzZXR0aW5nc0R0LCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CgogICAgICAgICAgICBjdXJyZW50RmlsdGVyVmFsdWVzID0gZXhHZXRDb2x1bW5GaWx0ZXJWYWwob1RhYmxlLCBjb2x1bW5fbnVtYmVyKTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaWx0ZXJWYWx1ZXMuZnJvbSA9PT0gJycgJiYgY3VycmVudEZpbHRlclZhbHVlcy50byA9PT0gJycpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnBhcmVudCgpLmZpbmQoIi55YWRjZi1maWx0ZXItcmFuZ2UiKS52YWwoIiIpOwogICAgICAgICAgICBpZiAoJChldmVudC50YXJnZXQpLnBhcmVudCgpLmZpbmQoIi55YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyIikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZSIpWzBdKS5mb2N1cygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHNhdmVTdGF0ZVNhdmUob1RhYmxlLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgJycsICcnKTsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkRyYXcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcignJywgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIW9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgIT09IHVuZGVmaW5lZCAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV1bY29sdW1uX251bWJlcl0gPQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiAnJwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogJycsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvOiAnJwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSA9IHlhZGNmU3RhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9BcGkuX2ZuU2F2ZVN0YXRlKG9UYWJsZS5mblNldHRpbmdzKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CgogICAgICAgICAgICAkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZSIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2Jvb3RzdHJhcC1kYXRlcGlja2VyJykgewogICAgICAgICAgICAgICAgJGZyb21JbnB1dCA9ICQoIiMiICsgZnJvbUlkKTsKICAgICAgICAgICAgICAgICR0b0lucHV0ID0gJCgiIyIgKyB0b0lkKTsKICAgICAgICAgICAgICAgICRmcm9tSW5wdXQuZGF0ZXBpY2tlcigndXBkYXRlJyk7CiAgICAgICAgICAgICAgICAkdG9JbnB1dC5kYXRlcGlja2VyKCd1cGRhdGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmFuZ2VOdW1iZXJTbGlkZXJDbGVhcih0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZXZlbnQpIHsKICAgICAgICAgICAgdmFyIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLAogICAgICAgICAgICAgICAgbWluX3ZhbCwKICAgICAgICAgICAgICAgIG1heF92YWwsCiAgICAgICAgICAgICAgICBjdXJyZW50RmlsdGVyVmFsdWVzLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlcjsKCiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnRUYXJnZXRGaXhVcChldmVudCk7CiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CgogICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gcGFyc2VJbnQoJChldmVudC50YXJnZXQpLnByZXYoKS5maW5kKCIueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXIiKS5hdHRyKCJpZCIpLnJlcGxhY2UoInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLXNsaWRlci0iLCAiIiksIDEwKTsKCiAgICAgICAgICAgIG1pbl92YWwgPSArJCgkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyLW1pbi10aXAtaGlkZGVuIikpLnRleHQoKTsKICAgICAgICAgICAgbWF4X3ZhbCA9ICskKCQoZXZlbnQudGFyZ2V0KS5wYXJlbnQoKS5maW5kKCIueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWF4LXRpcC1oaWRkZW4iKSkudGV4dCgpOwoKICAgICAgICAgICAgY3VycmVudEZpbHRlclZhbHVlcyA9IGV4R2V0Q29sdW1uRmlsdGVyVmFsKG9UYWJsZSwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgIGlmICgrY3VycmVudEZpbHRlclZhbHVlcy5mcm9tID09PSBtaW5fdmFsICYmICtjdXJyZW50RmlsdGVyVmFsdWVzLnRvID09PSBtYXhfdmFsKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5wcmV2KCkuZmluZCgiLnlhZGNmLWZpbHRlci1yYW5nZS1udW1iZXItc2xpZGVyIikuc2xpZGVyKCJvcHRpb24iLCAieWFkY2YtcmVzZXQiLCB0cnVlKTsKICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnByZXYoKS5maW5kKCIueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXIiKS5zbGlkZXIoIm9wdGlvbiIsICJ2YWx1ZXMiLCBbbWluX3ZhbCwgbWF4X3ZhbF0pOwoKICAgICAgICAgICAgJCgkKGV2ZW50LnRhcmdldCkucHJldigpLmZpbmQoIi51aS1zbGlkZXItaGFuZGxlIilbMF0pLmF0dHIoInRhYmluZGV4IiwgLTEpLmZvY3VzKCk7CgogICAgICAgICAgICAkKCQoZXZlbnQudGFyZ2V0KS5wcmV2KCkuZmluZCgiLnVpLXNsaWRlci1oYW5kbGUiKVswXSkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICQoJChldmVudC50YXJnZXQpLnByZXYoKS5maW5kKCIudWktc2xpZGVyLWhhbmRsZSIpWzFdKS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnByZXYoKS5maW5kKCIudWktc2xpZGVyLXJhbmdlIikucmVtb3ZlQ2xhc3MoImludXNlIik7CgogICAgICAgICAgICBvVGFibGUuZm5EcmF3KCk7CiAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CgogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkYXRlS2V5VVAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGRhdGVfZm9ybWF0LCBldmVudCkgewogICAgICAgICAgICB2YXIgb1RhYmxlLAogICAgICAgICAgICAgICAgZGF0ZSwKICAgICAgICAgICAgICAgIGRhdGVJZCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmo7CgogICAgICAgICAgICBldmVudCA9IGV2ZW50VGFyZ2V0Rml4VXAoZXZlbnQpOwoKICAgICAgICAgICAgZGF0ZUlkID0gZXZlbnQudGFyZ2V0LmlkOwogICAgICAgICAgICBkYXRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZGF0ZUlkKS52YWx1ZTsKCiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwogICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gcGFyc2VJbnQoZGF0ZUlkLnJlcGxhY2UoInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIsICIiKSwgMTApOwogICAgICAgICAgICBjb2x1bW5PYmogPSBnZXRPcHRpb25zKG9UYWJsZS5zZWxlY3RvcilbY29sdW1uX251bWJlcl07CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGUubGVuZ3RoID09PSAoZGF0ZV9mb3JtYXQubGVuZ3RoICsgMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IChkYXRlICE9PSAiIikgPyAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKGRhdGVfZm9ybWF0LCBkYXRlKSA6IGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIxKSB7fQoKICAgICAgICAgICAgaWYgKGRhdGUgaW5zdGFuY2VvZiBEYXRlIHx8IG1vbWVudChkYXRlLCBjb2x1bW5PYmouZGF0ZV9mb3JtYXQpLmlzVmFsaWQoKSkgewogICAgICAgICAgICAgICAgJCgiIyIgKyBkYXRlSWQpLmFkZENsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfdHlwZSAhPT0gJ2RhdGVfY3VzdG9tX2Z1bmMnKSB7CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuRmlsdGVyKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGRhdGVJZCkudmFsdWUsIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRvRmlsdGVyQ3VzdG9tRGF0ZUZ1bmMoeyB2YWx1ZTogZGF0ZSB9LCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0ZSA9PT0gIiIgfHwgJC50cmltKGV2ZW50LnRhcmdldC52YWx1ZSkgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAkKCIjIiArIGRhdGVJZCkucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAkKCcjJyArIGV2ZW50LnRhcmdldC5pZCkucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICBvVGFibGUuZm5GaWx0ZXIoJycsIGNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgcmVzZXRJQXBpSW5kZXgoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmFuZ2VEYXRlS2V5VVAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGRhdGVfZm9ybWF0LCBldmVudCkgewogICAgICAgICAgICB2YXIgb1RhYmxlLAogICAgICAgICAgICAgICAgbWluLAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgZnJvbUlkLAogICAgICAgICAgICAgICAgdG9JZCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBrZXlVcCwKICAgICAgICAgICAgICAgIHNldHRpbmdzRHQsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgIGRwZywKICAgICAgICAgICAgICAgIG1pblRtcCwKICAgICAgICAgICAgICAgIG1heFRtcDsKCiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnRUYXJnZXRGaXhVcChldmVudCk7CiAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CgogICAgICAgICAgICBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKCiAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBwYXJzZUludCgkKGV2ZW50LnRhcmdldCkuYXR0cigiaWQiKS5yZXBsYWNlKCctZnJvbS1kYXRlLScsICcnKS5yZXBsYWNlKCctdG8tZGF0ZS0nLCAnJykucmVwbGFjZSgneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgJycpLCAxMCk7CiAgICAgICAgICAgIGNvbHVtbk9iaiA9IGdldE9wdGlvbnMob1RhYmxlLnNlbGVjdG9yKVtjb2x1bW5fbnVtYmVyXTsKICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKG9UYWJsZSk7CiAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyID0gY2FsY0NvbHVtbk51bWJlckZpbHRlcihzZXR0aW5nc0R0LCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CgogICAgICAgICAgICBpZiAoY29sdW1uT2JqLmRhdGVwaWNrZXJfdHlwZSA9PT0gJ2Jvb3RzdHJhcC1kYXRlcGlja2VyJykgewogICAgICAgICAgICAgICAgZHBnID0gJC5mbi5kYXRlcGlja2VyLkRQR2xvYmFsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBrZXlVcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmIChldmVudC50YXJnZXQuaWQuaW5kZXhPZigiLWZyb20tIikgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgZnJvbUlkID0gZXZlbnQudGFyZ2V0LmlkOwogICAgICAgICAgICAgICAgICAgIHRvSWQgPSBldmVudC50YXJnZXQuaWQucmVwbGFjZSgiLWZyb20tIiwgIi10by0iKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG9JZCA9IGV2ZW50LnRhcmdldC5pZDsKICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSBldmVudC50YXJnZXQuaWQucmVwbGFjZSgiLXRvLSIsICItZnJvbS0iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcm9tSWQpLnZhbHVlOwogICAgICAgICAgICAgICAgbWF4ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodG9JZCkudmFsdWU7CgogICAgICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5kYXRlcGlja2VyX3R5cGUgPT09ICdqcXVlcnktdWknKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbi5sZW5ndGggPT09IChkYXRlX2Zvcm1hdC5sZW5ndGggKyAyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gKG1pbiAhPT0gIiIpID8gJC5kYXRlcGlja2VyLnBhcnNlRGF0ZShkYXRlX2Zvcm1hdCwgbWluKSA6IG1pbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge30KICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4Lmxlbmd0aCA9PT0gKGRhdGVfZm9ybWF0Lmxlbmd0aCArIDIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXggPSAobWF4ICE9PSAiIikgPyAkLmRhdGVwaWNrZXIucGFyc2VEYXRlKGRhdGVfZm9ybWF0LCBtYXgpIDogbWF4OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGV0aW1lcGlja2VyJykgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9IG1vbWVudChtaW4sIGNvbHVtbk9iai5tb21lbnRfZGF0ZV9mb3JtYXQpLnRvRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4obWluLmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9IG1vbWVudChtYXgsIGNvbHVtbk9iai5tb21lbnRfZGF0ZV9mb3JtYXQpLnRvRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4obWF4LmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5PYmouZGF0ZXBpY2tlcl90eXBlID09PSAnYm9vdHN0cmFwLWRhdGVwaWNrZXInKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gZHBnLnBhcnNlRGF0ZShtaW4sIGRwZy5wYXJzZUZvcm1hdChjb2x1bW5PYmouZGF0ZV9mb3JtYXQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTmFOKG1pbi5nZXRUaW1lKCkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge30KICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXggPSBkcGcucGFyc2VEYXRlKG1heCwgZHBnLnBhcnNlRm9ybWF0KGNvbHVtbk9iai5kYXRlX2Zvcm1hdCkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4obWF4LmdldFRpbWUoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICgoKG1heCBpbnN0YW5jZW9mIERhdGUpICYmIChtaW4gaW5zdGFuY2VvZiBEYXRlKSAmJiAobWF4ID49IG1pbikpIHx8ICFtaW4gfHwgIW1heCkgewoKICAgICAgICAgICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluVG1wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZnJvbUlkKS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbWF4VG1wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodG9JZCkudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVTdGF0ZVNhdmUob1RhYmxlLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgIW1pbiA/ICcnIDogbWluVG1wICwgIW1heCA/ICcnIDogbWF4VG1wKTsKICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuRHJhdygpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcihkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcm9tSWQpLnZhbHVlICsgJy15YWRjZl9kZWxpbS0nICsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodG9JZCkudmFsdWUsIGNvbHVtbl9udW1iZXJfZmlsdGVyKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChtaW4gaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgZnJvbUlkKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkKCIjIiArIGZyb21JZCkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChtYXggaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgdG9JZCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyB0b0lkKS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICgkLnRyaW0oZXZlbnQudGFyZ2V0LnZhbHVlKSA9PT0gIiIgJiYgJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJpbnVzZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgZXZlbnQudGFyZ2V0LmlkKS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzZXRJQXBpSW5kZXgoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX2RlbGF5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGtleVVwKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBldmVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB5YWRjZkRlbGF5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBrZXlVcCh0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZXZlbnQpOwogICAgICAgICAgICAgICAgfSwgY29sdW1uT2JqLmZpbHRlcl9kZWxheSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHJhbmdlTnVtYmVyS2V5VVAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGV2ZW50KSB7CiAgICAgICAgICAgIHZhciBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSwKICAgICAgICAgICAgICAgIG1pbiwKICAgICAgICAgICAgICAgIG1heCwKICAgICAgICAgICAgICAgIGZyb21JZCwKICAgICAgICAgICAgICAgIHRvSWQsCiAgICAgICAgICAgICAgICB5YWRjZlN0YXRlLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIGtleVVwLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfZmlsdGVyOwoKICAgICAgICAgICAgZXZlbnQgPSBldmVudFRhcmdldEZpeFVwKGV2ZW50KTsKICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKCiAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBwYXJzZUludCgkKGV2ZW50LnRhcmdldCkuYXR0cigiaWQiKS5yZXBsYWNlKCctZnJvbS0nLCAnJykucmVwbGFjZSgnLXRvLScsICcnKS5yZXBsYWNlKCd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCAnJyksIDEwKTsKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwogICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUob1RhYmxlKTsKICAgICAgICAgICAgY29sdW1uX251bWJlcl9maWx0ZXIgPSBjYWxjQ29sdW1uTnVtYmVyRmlsdGVyKHNldHRpbmdzRHQsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KTsKCiAgICAgICAgICAgIGtleVVwID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5pZC5pbmRleE9mKCItZnJvbS0iKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSBldmVudC50YXJnZXQuaWQ7CiAgICAgICAgICAgICAgICAgICAgdG9JZCA9IGV2ZW50LnRhcmdldC5pZC5yZXBsYWNlKCItZnJvbS0iLCAiLXRvLSIpOwoKICAgICAgICAgICAgICAgICAgICBtaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcm9tSWQpLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIG1heCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRvSWQpLnZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b0lkID0gZXZlbnQudGFyZ2V0LmlkOwogICAgICAgICAgICAgICAgICAgIGZyb21JZCA9IGV2ZW50LnRhcmdldC5pZC5yZXBsYWNlKCItdG8tIiwgIi1mcm9tLSIpOwoKICAgICAgICAgICAgICAgICAgICBtYXggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0b0lkKS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICBtaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcm9tSWQpLnZhbHVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG1pbiA9IChtaW4gIT09ICIiKSA/ICgrbWluKSA6IG1pbjsKICAgICAgICAgICAgICAgIG1heCA9IChtYXggIT09ICIiKSA/ICgrbWF4KSA6IG1heDsKCiAgICAgICAgICAgICAgICBpZiAoKCFpc05hTihtYXgpICYmICFpc05hTihtaW4pICYmIChtYXggPj0gbWluKSkgfHwgbWluID09PSAiIiB8fCBtYXggPT09ICIiKSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5EcmF3KCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuRmlsdGVyKG1pbiArICcteWFkY2ZfZGVsaW0tJyArIG1heCwgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZnJvbUlkKS52YWx1ZSAhPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBmcm9tSWQpLmFkZENsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodG9JZCkudmFsdWUgIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoIiMiICsgdG9JZCkuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoJC50cmltKGV2ZW50LnRhcmdldC52YWx1ZSkgPT09ICIiICYmICQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygiaW51c2UiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkKCIjIiArIGV2ZW50LnRhcmdldC5pZCkucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0ZlYXR1cmVzLmJTdGF0ZVNhdmUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGUgIT09IHVuZGVmaW5lZCAmJiBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiBtaW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBtYXgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IG1pbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bzogbWF4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSA9IHlhZGNmU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGNvbHVtbk9iai5maWx0ZXJfZGVsYXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAga2V5VXAoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHlhZGNmRGVsYXkoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGtleVVwKCk7CiAgICAgICAgICAgICAgICB9LCBjb2x1bW5PYmouZmlsdGVyX2RlbGF5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZG9GaWx0ZXJNdWx0aVRhYmxlc011bHRpU2VsZWN0KHRhYmxlc1NlbGVjdG9ycywgZXZlbnQsIGNvbHVtbl9udW1iZXJfc3RyLCBjbGVhcikgewoKICAgICAgICAgICAgdmFyIGNvbHVtbnNPYmogPSBnZXRPcHRpb25zKHRhYmxlc1NlbGVjdG9ycyArICdfJyArIGNvbHVtbl9udW1iZXJfc3RyKVtjb2x1bW5fbnVtYmVyX3N0cl0sCiAgICAgICAgICAgICAgICByZWdleCA9IGZhbHNlLAogICAgICAgICAgICAgICAgc21hcnQgPSB0cnVlLAogICAgICAgICAgICAgICAgY2FzZUluc2VuID0gdHJ1ZSwKICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLAogICAgICAgICAgICAgICAgdGFibGVzQXJyYXkgPSBvVGFibGVzW3RhYmxlc1NlbGVjdG9yc10sCiAgICAgICAgICAgICAgICBzZWxlY3RlZF92YWx1ZXMgPSAkKGV2ZW50LnRhcmdldCkudmFsKCksCiAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgZXZlbnQgPSBldmVudFRhcmdldEZpeFVwKGV2ZW50KTsKICAgICAgICAgICAgdGFibGVzQXNPbmUgPSBuZXcgJC5mbi5kYXRhVGFibGUuQXBpKHRhYmxlc0FycmF5KTsKCiAgICAgICAgICAgIGlmIChjbGVhciAhPT0gdW5kZWZpbmVkIHx8ICFzZWxlY3RlZF92YWx1ZXMgfHwgc2VsZWN0ZWRfdmFsdWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgaWYgKGNsZWFyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgnc2VsZWN0JykudmFsKCctMScpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnBhcmVudCgpLmZpbmQoJ3NlbGVjdG4gJykucmVtb3ZlQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uc09iai5jb2x1bW5fbnVtYmVyIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgICAgICAgICB0YWJsZXNBc09uZS5jb2x1bW5zKGNvbHVtbnNPYmouY29sdW1uX251bWJlcikuc2VhcmNoKCcnKS5kcmF3KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLnNlYXJjaCgnJykuZHJhdygpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4oY29sdW1uc09iaiwgJCgnIycgKyBjb2x1bW5zT2JqLmZpbHRlcl9jb250YWluZXJfaWQgKyAnIHNlbGVjdCcpLCAnLTEnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJChldmVudC50YXJnZXQpLmFkZENsYXNzKCJpbnVzZSIpOwoKICAgICAgICAgICAgcmVnZXggPSB0cnVlOwogICAgICAgICAgICBzbWFydCA9IGZhbHNlOwogICAgICAgICAgICBjYXNlSW5zZW4gPSBjb2x1bW5zT2JqLmNhc2VfaW5zZW5zaXRpdmU7CgogICAgICAgICAgICBpZiAoc2VsZWN0ZWRfdmFsdWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSBzZWxlY3RlZF92YWx1ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRfdmFsdWVzW2ldID09PSAiLTEiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZF92YWx1ZXMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfdmFsdWVzID0gc2VsZWN0ZWRfdmFsdWVzLmpvaW4oJ25hcnV0b3V6b21ha2knKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZF92YWx1ZXMgPSBzZWxlY3RlZF92YWx1ZXMucmVwbGFjZSgvKFsuKis/Xj0hOiR7fSgpfFxbXF1cL1xcXSkvZywgIlxcJDEiKTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZF92YWx1ZXMgPSBzZWxlY3RlZF92YWx1ZXMuc3BsaXQoJ25hcnV0b3V6b21ha2knKS5qb2luKCd8Jyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouZmlsdGVyX21hdGNoX21vZGUgPT09ICJleGFjdCIpIHsKICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlcyA9ICJeIiArIHNlbGVjdGVkX3ZhbHVlcyArICIkIjsKICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5zT2JqLmZpbHRlcl9tYXRjaF9tb2RlID09PSAic3RhcnRzV2l0aCIpIHsKICAgICAgICAgICAgICAgIHNlbGVjdGVkX3ZhbHVlcyA9ICJeIiArIHNlbGVjdGVkX3ZhbHVlczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29sdW1uc09iai5jb2x1bW5fbnVtYmVyIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLmNvbHVtbnMoY29sdW1uc09iai5jb2x1bW5fbnVtYmVyKS5zZWFyY2goc2VsZWN0ZWRfdmFsdWVzLCByZWdleCwgc21hcnQsIGNhc2VJbnNlbikuZHJhdygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFibGVzQXNPbmUuc2VhcmNoKHNlbGVjdGVkX3ZhbHVlcywgcmVnZXgsIHNtYXJ0LCBjYXNlSW5zZW4pLmRyYXcoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZG9GaWx0ZXJNdWx0aVRhYmxlcyh0YWJsZXNTZWxlY3RvcnMsIGV2ZW50LCBjb2x1bW5fbnVtYmVyX3N0ciwgY2xlYXIpIHsKCiAgICAgICAgICAgIHZhciBjb2x1bW5zT2JqID0gZ2V0T3B0aW9ucyh0YWJsZXNTZWxlY3RvcnMgKyAnXycgKyBjb2x1bW5fbnVtYmVyX3N0cilbY29sdW1uX251bWJlcl9zdHJdLAogICAgICAgICAgICAgICAgcmVnZXggPSBmYWxzZSwKICAgICAgICAgICAgICAgIHNtYXJ0ID0gdHJ1ZSwKICAgICAgICAgICAgICAgIGNhc2VJbnNlbiA9IHRydWUsCiAgICAgICAgICAgICAgICBzZXJhY2hWYWwsCiAgICAgICAgICAgICAgICB0YWJsZXNBc09uZSwKICAgICAgICAgICAgICAgIHRhYmxlc0FycmF5ID0gb1RhYmxlc1t0YWJsZXNTZWxlY3RvcnNdOwoKICAgICAgICAgICAgZXZlbnQgPSBldmVudFRhcmdldEZpeFVwKGV2ZW50KTsKICAgICAgICAgICAgdGFibGVzQXNPbmUgPSBuZXcgJC5mbi5kYXRhVGFibGUuQXBpKHRhYmxlc0FycmF5KTsKCiAgICAgICAgICAgIGlmIChjbGVhciAhPT0gdW5kZWZpbmVkIHx8IGV2ZW50LnRhcmdldC52YWx1ZSA9PT0gJy0xJykgewogICAgICAgICAgICAgICAgaWYgKGNsZWFyICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAkKGV2ZW50LnRhcmdldCkucGFyZW50KCkuZmluZCgnc2VsZWN0JykudmFsKCctMScpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgJChldmVudC50YXJnZXQpLnBhcmVudCgpLmZpbmQoJ3NlbGVjdCcpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouY29sdW1uX251bWJlciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgdGFibGVzQXNPbmUuY29sdW1ucyhjb2x1bW5zT2JqLmNvbHVtbl9udW1iZXIpLnNlYXJjaCgnJykuZHJhdygpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0YWJsZXNBc09uZS5zZWFyY2goJycpLmRyYXcoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZWZyZXNoU2VsZWN0UGx1Z2luKGNvbHVtbnNPYmosICQoJyMnICsgY29sdW1uc09iai5maWx0ZXJfY29udGFpbmVyX2lkICsgJyBzZWxlY3QnKSwgJy0xJyk7CgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkKGV2ZW50LnRhcmdldCkuYWRkQ2xhc3MoImludXNlIik7CgogICAgICAgICAgICBzZXJhY2hWYWwgPSBldmVudC50YXJnZXQudmFsdWU7CiAgICAgICAgICAgIHNtYXJ0ID0gZmFsc2U7CiAgICAgICAgICAgIGNhc2VJbnNlbiA9IGNvbHVtbnNPYmouY2FzZV9pbnNlbnNpdGl2ZTsKICAgICAgICAgICAgLyoKCQkJaWYgKGNvbHVtbnNPYmouZmlsdGVyX21hdGNoX21vZGUgPT09ICJjb250YWlucyIpIHsKCQkJCXJlZ2V4ID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoY29sdW1uc09iai5maWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImV4YWN0IikgewoJCQkJcmVnZXggPSB0cnVlOwoJCQkJc2VyYWNoVmFsID0gIl4iICsgc2VyYWNoVmFsICsgIiQiOwoJCQl9IGVsc2UgaWYgKGNvbHVtbnNPYmouZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewoJCQkJcmVnZXggPSB0cnVlOwoJCQkJc2VyYWNoVmFsID0gIl4iICsgc2VyYWNoVmFsOwoJCQl9Ki8KICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouY29sdW1uX251bWJlciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICB0YWJsZXNBc09uZS5jb2x1bW5zKGNvbHVtbnNPYmouY29sdW1uX251bWJlcikuc2VhcmNoKHNlcmFjaFZhbCwgcmVnZXgsIHNtYXJ0LCBjYXNlSW5zZW4pLmRyYXcoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLnNlYXJjaChzZXJhY2hWYWwsIHJlZ2V4LCBzbWFydCwgY2FzZUluc2VuKS5kcmF3KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRleHRLZXlVcE11bHRpVGFibGVzKHRhYmxlc1NlbGVjdG9ycywgZXZlbnQsIGNvbHVtbl9udW1iZXJfc3RyLCBjbGVhcikgewoKICAgICAgICAgICAgdmFyIGtleVVwLAogICAgICAgICAgICAgICAgY29sdW1uc09iaiA9IGdldE9wdGlvbnModGFibGVzU2VsZWN0b3JzICsgJ18nICsgY29sdW1uX251bWJlcl9zdHIpW2NvbHVtbl9udW1iZXJfc3RyXSwKICAgICAgICAgICAgICAgIHJlZ2V4ID0gZmFsc2UsCiAgICAgICAgICAgICAgICBzbWFydCA9IHRydWUsCiAgICAgICAgICAgICAgICBjYXNlSW5zZW4gPSB0cnVlLAogICAgICAgICAgICAgICAgc2VyYWNoVmFsLAogICAgICAgICAgICAgICAgdGFibGVzQXNPbmUsCiAgICAgICAgICAgICAgICB0YWJsZXNBcnJheSA9IG9UYWJsZXNbdGFibGVzU2VsZWN0b3JzXTsKCiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnRUYXJnZXRGaXhVcChldmVudCk7CiAgICAgICAgICAgIHRhYmxlc0FzT25lID0gbmV3ICQuZm4uZGF0YVRhYmxlLkFwaSh0YWJsZXNBcnJheSk7CgogICAgICAgICAgICBrZXlVcCA9IGZ1bmN0aW9uICh0YWJsZXNBc09uZSwgZXZlbnQsIGNsZWFyKSB7CgogICAgICAgICAgICAgICAgaWYgKGNsZWFyICE9PSB1bmRlZmluZWQgfHwgZXZlbnQudGFyZ2V0LnZhbHVlID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIGlmIChjbGVhciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5wcmV2KCkudmFsKCIiKS5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICAkKGV2ZW50LnRhcmdldCkucHJldigpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS52YWwoIiIpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5yZW1vdmVDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouY29sdW1uX251bWJlciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLmNvbHVtbnMoY29sdW1uc09iai5jb2x1bW5fbnVtYmVyKS5zZWFyY2goJycpLmRyYXcoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZXNBc09uZS5zZWFyY2goJycpLmRyYXcoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KS5hZGRDbGFzcygiaW51c2UiKTsKCiAgICAgICAgICAgICAgICBzZXJhY2hWYWwgPSBldmVudC50YXJnZXQudmFsdWU7CiAgICAgICAgICAgICAgICBzbWFydCA9IGZhbHNlOwogICAgICAgICAgICAgICAgY2FzZUluc2VuID0gY29sdW1uc09iai5jYXNlX2luc2Vuc2l0aXZlOwogICAgICAgICAgICAgICAgLyoKCQkJCWlmIChjb2x1bW5zT2JqLmZpbHRlcl9tYXRjaF9tb2RlID09PSAiY29udGFpbnMiKSB7CgkJCQkJcmVnZXggPSBmYWxzZTsKCQkJCX0gZWxzZSBpZiAoY29sdW1uc09iai5maWx0ZXJfbWF0Y2hfbW9kZSA9PT0gImV4YWN0IikgewoJCQkJCXJlZ2V4ID0gdHJ1ZTsKCQkJCQlzZXJhY2hWYWwgPSAiXiIgKyBzZXJhY2hWYWwgKyAiJCI7CgkJCQl9IGVsc2UgaWYgKGNvbHVtbnNPYmouZmlsdGVyX21hdGNoX21vZGUgPT09ICJzdGFydHNXaXRoIikgewoJCQkJCXJlZ2V4ID0gdHJ1ZTsKCQkJCQlzZXJhY2hWYWwgPSAiXiIgKyBzZXJhY2hWYWw7CgkJCQl9CgkqLwogICAgICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouY29sdW1uX251bWJlciBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgdGFibGVzQXNPbmUuY29sdW1ucyhjb2x1bW5zT2JqLmNvbHVtbl9udW1iZXIpLnNlYXJjaChzZXJhY2hWYWwsIHJlZ2V4LCBzbWFydCwgY2FzZUluc2VuKS5kcmF3KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRhYmxlc0FzT25lLnNlYXJjaChzZXJhY2hWYWwsIHJlZ2V4LCBzbWFydCwgY2FzZUluc2VuKS5kcmF3KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouZmlsdGVyX2RlbGF5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGtleVVwKHRhYmxlc0FzT25lLCBldmVudCwgY2xlYXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgeWFkY2ZEZWxheShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAga2V5VXAodGFibGVzQXNPbmUsIGV2ZW50LCBjbGVhcik7CiAgICAgICAgICAgICAgICB9LCBjb2x1bW5zT2JqLmZpbHRlcl9kZWxheSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRleHRLZXlVUChldiwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGNsZWFyKSB7CiAgICAgICAgICAgIHZhciBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgIG9UYWJsZSA9IG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLAogICAgICAgICAgICAgICAga2V5VXAsCiAgICAgICAgICAgICAgICBjb2x1bW5PYmosCiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUob1RhYmxlKSwKICAgICAgICAgICAgICAgIGV4Y2x1ZGUsCiAgICAgICAgICAgICAgICBrZXlDb2RlcyA9IFszNywgMzgsIDM5LCA0MF07CgogICAgICAgICAgICBpZiAoa2V5Q29kZXMuaW5kZXhPZihldi5rZXlDb2RlKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IGNhbGNDb2x1bW5OdW1iZXJGaWx0ZXIoc2V0dGluZ3NEdCwgY29sdW1uX251bWJlciwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwoKICAgICAgICAgICAgY29sdW1uT2JqID0gZ2V0T3B0aW9ucyhvVGFibGUuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwoKICAgICAgICAgICAga2V5VXAgPSBmdW5jdGlvbiAodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIGNvbHVtbl9udW1iZXIsIGNsZWFyKSB7CiAgICAgICAgICAgICAgICB2YXIgZml4ZWRQcmVmaXggPSAnJzsKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0Ll9maXhlZEhlYWRlciAhPT0gdW5kZWZpbmVkICYmICQoJy5maXhlZEhlYWRlci1mbG9hdGluZycpLmlzKCI6dmlzaWJsZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgZml4ZWRQcmVmaXggPSAnLmZpeGVkSGVhZGVyLWZsb2F0aW5nICc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uT2JqLmZpbHRlcnNfcG9zaXRpb24gPT09ICd0Zm9vdCcgJiYgc2V0dGluZ3NEdC5uU2Nyb2xsRm9vdCkgewogICAgICAgICAgICAgICAgICAgIGZpeGVkUHJlZml4ID0gJy4nICsgc2V0dGluZ3NEdC5uU2Nyb2xsRm9vdC5jbGFzc05hbWUgKyAnICc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSBvVGFibGVzSW5kZXhbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldOwoKICAgICAgICAgICAgICAgIGlmIChjbGVhciA9PT0gJ2NsZWFyJyB8fCAkKGZpeGVkUHJlZml4ICsgIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikudmFsKCkgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNsZWFyID09PSAnY2xlYXInICYmIGV4R2V0Q29sdW1uRmlsdGVyVmFsKG9UYWJsZSwgY29sdW1uX251bWJlcikgPT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICQoZml4ZWRQcmVmaXggKyAiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS52YWwoIiIpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgJChmaXhlZFByZWZpeCArICIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcigiIiwgY29sdW1uX251bWJlcl9maWx0ZXIpOwogICAgICAgICAgICAgICAgICAgIHJlc2V0SUFwaUluZGV4KCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZXhjbHVkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGV4Y2x1ZGUgPSAkKGZpeGVkUHJlZml4ICsgIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikuY2xvc2VzdCgnLnlhZGNmLWZpbHRlci13cmFwcGVyJykuZmluZCgnLnlhZGNmLWV4Y2x1ZGUtd3JhcHBlciA6Y2hlY2tib3gnKS5wcm9wKCdjaGVja2VkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKGZpeGVkUHJlZml4ICsgIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iICsgY29sdW1uX251bWJlcikuYWRkQ2xhc3MoImludXNlIik7CgogICAgICAgICAgICAgICAgeWFkY2ZNYXRjaEZpbHRlcihvVGFibGUsICQoZml4ZWRQcmVmaXggKyAiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyKS52YWwoKSwgY29sdW1uT2JqLmZpbHRlcl9tYXRjaF9tb2RlLCBjb2x1bW5fbnVtYmVyX2ZpbHRlciwgZXhjbHVkZSwgY29sdW1uX251bWJlcik7CgogICAgICAgICAgICAgICAgcmVzZXRJQXBpSW5kZXgoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChjb2x1bW5PYmouZmlsdGVyX2RlbGF5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGtleVVwKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBjb2x1bW5fbnVtYmVyLCBjbGVhcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB5YWRjZkRlbGF5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBrZXlVcCh0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgY29sdW1uX251bWJlciwgY2xlYXIpOwogICAgICAgICAgICAgICAgfSwgY29sdW1uT2JqLmZpbHRlcl9kZWxheSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGF1dG9jb21wbGV0ZUtleVVQKHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBldmVudCkgewogICAgICAgICAgICB2YXIgb1RhYmxlLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGtleUNvZGVzID0gWzM3LCAzOCwgMzksIDQwXTsKCiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnRUYXJnZXRGaXhVcChldmVudCk7CgogICAgICAgICAgICBpZiAoa2V5Q29kZXMuaW5kZXhPZihldmVudC5rZXlDb2RlKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC52YWx1ZSA9PT0gIiIgJiYgZXZlbnQua2V5Q29kZSA9PT0gOCAmJiAkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoImludXNlIikpIHsKICAgICAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IG9UYWJsZXNJbmRleFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV07CiAgICAgICAgICAgICAgICBvVGFibGUgPSBvVGFibGVzW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XTsKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBwYXJzZUludCgkKGV2ZW50LnRhcmdldCkuYXR0cigiaWQiKS5yZXBsYWNlKCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgIi0iLCAiIiksIDEwKTsKCiAgICAgICAgICAgICAgICAkKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCJpbnVzZSIpOwogICAgICAgICAgICAgICAgJChkb2N1bWVudCkucmVtb3ZlRGF0YSgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIl92YWwiKTsKICAgICAgICAgICAgICAgIG9UYWJsZS5mbkZpbHRlcigiIiwgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICByZXNldElBcGlJbmRleCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0RPTVNvdXJjZSh0YWJsZVZhcikgewogICAgICAgICAgICB2YXIgc2V0dGluZ3NEdDsKICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKHRhYmxlVmFyKTsKICAgICAgICAgICAgaWYgKCFzZXR0aW5nc0R0LnNBamF4U291cmNlICYmICFzZXR0aW5nc0R0LmFqYXggJiYgc2V0dGluZ3NEdC5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNjcm9sbFhZSGFuZGxlcihvVGFibGUsIHRhYmxlX3NlbGVjdG9yKSB7CiAgICAgICAgICAgIHZhciAkdG1wU2VsZWN0b3IsCiAgICAgICAgICAgICAgICBmaWx0ZXJzX3Bvc2l0aW9uID0gJChkb2N1bWVudCkuZGF0YSh0YWJsZV9zZWxlY3RvciArICJfZmlsdGVyc19wb3NpdGlvbiIpLAogICAgICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5MihvVGFibGUpOwoKICAgICAgICAgICAgaWYgKGZpbHRlcnNfcG9zaXRpb24gPT09ICd0aGVhZCcpIHsKICAgICAgICAgICAgICAgIGZpbHRlcnNfcG9zaXRpb24gPSAnLmRhdGFUYWJsZXNfc2Nyb2xsSGVhZCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmaWx0ZXJzX3Bvc2l0aW9uID0gJy5kYXRhVGFibGVzX3Njcm9sbEZvb3QnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9TY3JvbGwuc1ggIT09ICcnIHx8IG9UYWJsZS5mblNldHRpbmdzKCkub1Njcm9sbC5zWSAhPT0gJycpIHsKICAgICAgICAgICAgICAgICR0bXBTZWxlY3RvciA9ICQodGFibGVfc2VsZWN0b3IpLmNsb3Nlc3QoJy5kYXRhVGFibGVzX3Njcm9sbCcpLmZpbmQoZmlsdGVyc19wb3NpdGlvbiArICcgdGFibGUnKTsKICAgICAgICAgICAgICAgICR0bXBTZWxlY3Rvci5hZGRDbGFzcygneWFkY2YtZGF0YXRhYmxlcy10YWJsZS0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmaXJzdEZyb21PYmplY3Qob2JqKSB7CiAgICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdEFuZEJpbmRUYWJsZShvVGFibGUsIHRhYmxlX3NlbGVjdG9yLCBpbmRleCwgcFRhYmxlRFQpIHsKCiAgICAgICAgICAgIHZhciB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSA9IHlhZGNmLmdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKG9UYWJsZSksCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl90bXA7CiAgICAgICAgICAgIG9UYWJsZXNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldID0gb1RhYmxlOwogICAgICAgICAgICB0YWJsZXNEVFt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBwVGFibGVEVDsKICAgICAgICAgICAgb1RhYmxlc0luZGV4W3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSA9IGluZGV4OwoKICAgICAgICAgICAgc2Nyb2xsWFlIYW5kbGVyKG9UYWJsZSwgdGFibGVfc2VsZWN0b3IpOwoKICAgICAgICAgICAgaWYgKGlzRE9NU291cmNlKG9UYWJsZSkpIHsKICAgICAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX3RtcCA9IHRhYmxlX3NlbGVjdG9yOwogICAgICAgICAgICAgICAgaWYgKHRhYmxlX3NlbGVjdG9yLmluZGV4T2YoIjplcSIpICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX3RtcCA9IHRhYmxlX3NlbGVjdG9yLnN1YnN0cmluZygwLCB0YWJsZV9zZWxlY3Rvci5sYXN0SW5kZXhPZigiOmVxIikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXBwZW5kRmlsdGVycyhvVGFibGUsIGdldE9wdGlvbnModGFibGVfc2VsZWN0b3JfdG1wKSwgdGFibGVfc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgaWYgKGdldE9wdGlvbnModGFibGVfc2VsZWN0b3JfdG1wKVtmaXJzdEZyb21PYmplY3QoZ2V0T3B0aW9ucyh0YWJsZV9zZWxlY3Rvcl90bXApKV0uY3VtdWxhdGl2ZV9maWx0ZXJpbmcgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAvL3doZW4gZmlsdGVycyBzaG91bGQgYmUgcG9wdWxhdGVkIG9ubHkgZnJvbSB2aXNpYmxlIHJvd3MgKG5vbiBmaWx0ZXJlZCkKICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3NlYXJjaC5kdCcsIG9UYWJsZS5zZWxlY3Rvcikub24oJ3NlYXJjaC5kdCcsIG9UYWJsZS5zZWxlY3RvciwgZnVuY3Rpb24gKGUsIHNldHRpbmdzLCBqc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZV9zZWxlY3Rvcl90bXAgPSBvVGFibGUuc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZV9zZWxlY3Rvci5pbmRleE9mKCI6ZXEiKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX3RtcCA9IHRhYmxlX3NlbGVjdG9yLnN1YnN0cmluZygwLCB0YWJsZV9zZWxlY3Rvci5sYXN0SW5kZXhPZigiOmVxIikpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZEZpbHRlcnMob1RhYmxlLCBnZXRPcHRpb25zKHRhYmxlX3NlbGVjdG9yX3RtcCksIG9UYWJsZS5zZWxlY3Rvciwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYXBwZW5kRmlsdGVycyhvVGFibGUsIGdldE9wdGlvbnModGFibGVfc2VsZWN0b3IpLCB0YWJsZV9zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICBpZiAoeWFkY2ZWZXJzaW9uQ2hlY2soJzEuMTAnKSkgewogICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigneGhyLmR0Jywgb1RhYmxlLnNlbGVjdG9yKS5vbigneGhyLmR0Jywgb1RhYmxlLnNlbGVjdG9yLCBmdW5jdGlvbiAoZSwgc2V0dGluZ3MsIGpzb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbF9udW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ID0gZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseTIob1RhYmxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFqc29uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZGF0YXRhYmxlcyB4aHIuZHQgZXZlbnQgY2FtZSBiYWNrIHdpdGggbnVsbCBhcyBkYXRhIChub3RoaW5nIGZvciB5YWRjZiB0byBkbyB3aXRoIGl0KS4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3Mub1NhdmVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRDb2xSZW9yZGVyMihzZXR0aW5ncywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29sX251bSBpbiB5YWRjZi5nZXRPcHRpb25zKHNldHRpbmdzLm9JbnN0YW5jZS5zZWxlY3RvcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5YWRjZi5nZXRPcHRpb25zKHNldHRpbmdzLm9JbnN0YW5jZS5zZWxlY3RvcikuaGFzT3duUHJvcGVydHkoY29sX251bSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoanNvblsneWFkY2ZfZGF0YV8nICsgY29sX251bV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IGNvbF9udW07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncy5vU2F2ZWRTdGF0ZSAhPT0gbnVsbCAmJiBwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX2ZpbHRlciA9IHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLkNvbFJlb3JkZXJbY29sX251bV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWFkY2YuZ2V0T3B0aW9ucyhzZXR0aW5ncy5vSW5zdGFuY2Uuc2VsZWN0b3IpW2NvbF9udW1dLmRhdGEgPSBqc29uWyd5YWRjZl9kYXRhXycgKyBjb2x1bW5fbnVtYmVyX2ZpbHRlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9ldmVudHMgdGhhdCBhZmZlY3RzIGJvdGggRE9NIGFuZCBBamF4CiAgICAgICAgICAgIGlmICh5YWRjZlZlcnNpb25DaGVjaygnMS4xMCcpKSB7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2RyYXcuZHQnLCBvVGFibGUuc2VsZWN0b3IpLm9uKCdkcmF3LmR0Jywgb1RhYmxlLnNlbGVjdG9yLCBmdW5jdGlvbiAoZXZlbnQsIHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgYXBwZW5kRmlsdGVycyhvVGFibGUsIHlhZGNmLmdldE9wdGlvbnMoc2V0dGluZ3Mub0luc3RhbmNlLnNlbGVjdG9yKSwgc2V0dGluZ3Mub0luc3RhbmNlLnNlbGVjdG9yLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZignY29sdW1uLXZpc2liaWxpdHkuZHQnLCBvVGFibGUuc2VsZWN0b3IpLm9uKCdjb2x1bW4tdmlzaWJpbGl0eS5kdCcsIG9UYWJsZS5zZWxlY3RvciwgZnVuY3Rpb24gKGUsIHNldHRpbmdzLCBjb2xfbnVtLCBzdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uc09iaiA9IGdldE9wdGlvbnMoc2V0dGluZ3Mub0luc3RhbmNlLnNlbGVjdG9yKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT09IHRydWUgJiYgc2V0dGluZ3MuX29GaXhlZENvbHVtbnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldICE9PSB1bmRlZmluZWQgJiYgcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0uQ29sUmVvcmRlciAhPT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX251bSA9IHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldLkNvbFJlb3JkZXJbY29sX251bV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2V0dGluZ3Mub1NhdmVkU3RhdGUgJiYgc2V0dGluZ3Mub1NhdmVkU3RhdGUuQ29sUmVvcmRlciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfbnVtID0gc2V0dGluZ3Mub1NhdmVkU3RhdGUuQ29sUmVvcmRlcltjb2xfbnVtXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvYmpbY29sX251bV0gPSB5YWRjZi5nZXRPcHRpb25zKHNldHRpbmdzLm9JbnN0YW5jZS5zZWxlY3RvcilbY29sX251bV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmpbY29sX251bV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqW2NvbF9udW1dLmNvbHVtbl9udW1iZXIgPSBjb2xfbnVtOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9ialtjb2xfbnVtXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kRmlsdGVycyhvVGFibGVzW3lhZGNmLmdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKHNldHRpbmdzKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iaiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3Mub0luc3RhbmNlLnNlbGVjdG9yLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNldHRpbmdzLl9vRml4ZWRDb2x1bW5zICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXBwZW5kRmlsdGVycyhvVGFibGVzW3lhZGNmLmdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKHNldHRpbmdzKV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zT2JqLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3Mub0luc3RhbmNlLnNlbGVjdG9yLCBzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2NvbHVtbi1yZW9yZGVyLmR0Jywgb1RhYmxlLnNlbGVjdG9yKS5vbignY29sdW1uLXJlb3JkZXIuZHQnLCBvVGFibGUuc2VsZWN0b3IsIGZ1bmN0aW9uIChlLCBzZXR0aW5ncywganNvbikgewogICAgICAgICAgICAgICAgICAgIHZhciB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSA9IGdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKG9UYWJsZSk7CiAgICAgICAgICAgICAgICAgICAgaW5pdENvbFJlb3JkZXJGcm9tRXZlbnQodGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2Rlc3Ryb3kuZHQnLCBvVGFibGUuc2VsZWN0b3IpLm9uKCdkZXN0cm95LmR0Jywgb1RhYmxlLnNlbGVjdG9yLCBmdW5jdGlvbiAoZXZlbnQsIHVpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRmlsdGVycyhvVGFibGUsIHlhZGNmLmdldE9wdGlvbnModWkub0luc3RhbmNlLnNlbGVjdG9yKSwgdWkub0luc3RhbmNlLnNlbGVjdG9yKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCdkcmF3Jywgb1RhYmxlLnNlbGVjdG9yKS5vbignZHJhdycsIG9UYWJsZS5zZWxlY3RvciwgZnVuY3Rpb24gKGV2ZW50LCBzZXR0aW5ncykgewogICAgICAgICAgICAgICAgICAgIGFwcGVuZEZpbHRlcnMob1RhYmxlLCB5YWRjZi5nZXRPcHRpb25zKHNldHRpbmdzLm9JbnN0YW5jZS5zZWxlY3RvciksIHNldHRpbmdzLm9JbnN0YW5jZS5zZWxlY3Rvciwgc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2Rlc3Ryb3knLCBvVGFibGUuc2VsZWN0b3IpLm9uKCdkZXN0cm95Jywgb1RhYmxlLnNlbGVjdG9yLCBmdW5jdGlvbiAoZXZlbnQsIHVpKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRmlsdGVycyhvVGFibGUsIHlhZGNmLmdldE9wdGlvbnModWkub0luc3RhbmNlLnNlbGVjdG9yKSwgdWkub0luc3RhbmNlLnNlbGVjdG9yKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoeWFkY2ZWZXJzaW9uQ2hlY2soJzEuMTAnKSkgewogICAgICAgICAgICAgICAgICAgICQob1RhYmxlLnNlbGVjdG9yKS5vZmYoJ3N0YXRlU2F2ZVBhcmFtcy5kdCcpLm9uKCdzdGF0ZVNhdmVQYXJhbXMuZHQnLCBmdW5jdGlvbiAoZSwgc2V0dGluZ3MsIGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLm9Mb2FkZWRTdGF0ZSAmJiBzZXR0aW5ncy5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnlhZGNmU3RhdGUgPSBzZXR0aW5ncy5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEubmFydXRvID0gJ2t1cmFtYSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJChvVGFibGUuc2VsZWN0b3IpLm9mZignc3RhdGVTYXZlUGFyYW1zJykub24oJ3N0YXRlU2F2ZVBhcmFtcycsIGZ1bmN0aW9uIChlLCBzZXR0aW5ncywgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3Mub0xvYWRlZFN0YXRlICYmIHNldHRpbmdzLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEueWFkY2ZTdGF0ZSA9IHNldHRpbmdzLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5uYXJ1dG8gPSAna3VyYW1hJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy93aGVuIHVzaW5nIERPTSBzb3VyY2UKICAgICAgICAgICAgICAgIGlmIChpc0RPTVNvdXJjZShvVGFibGUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy93ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IHRoZSB5YWRjZiBzdGF0ZSB3aWxsIGJlIHNhdmVkIGFmdGVyIHBhZ2UgcmVsb2FkCiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgICAgICAvL3JlZHJhdyB0aGUgdGFibGUgaW4gb3JkZXIgdG8gYXBwbHkgdGhlIGZpbHRlcnMKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5EcmF3KGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJC5mbi55YWRjZiA9IGZ1bmN0aW9uIChvcHRpb25zX2FyZywgcGFyYW1zKSB7CgogICAgICAgICAgICB2YXIgdG1wUGFyYW1zLAogICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICBzZWxlY3RvciwKICAgICAgICAgICAgICAgIHRhYmxlU2VsZWN0b3IgPSAnIycgKyB0aGlzLmZuU2V0dGluZ3MoKS5zVGFibGVJZDsKCiAgICAgICAgICAgIC8vaW4gY2FzZSB0aGF0IGluc3RhbmNlLnNlbGVjdG9yIHdpbGwgYmUgdW5kZWZpbmVkIChqUXVlcnkgMykKICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RvciA9IHRhYmxlU2VsZWN0b3I7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcGFyYW1zID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdG1wUGFyYW1zID0gcGFyYW1zOwogICAgICAgICAgICAgICAgcGFyYW1zID0ge307CiAgICAgICAgICAgICAgICBwYXJhbXMuZmlsdGVyc19wb3NpdGlvbiA9IHRtcFBhcmFtczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyYW1zLmZpbHRlcnNfcG9zaXRpb24gPT09IHVuZGVmaW5lZCB8fCBwYXJhbXMuZmlsdGVyc19wb3NpdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICAgICAgICAgIHBhcmFtcy5maWx0ZXJzX3Bvc2l0aW9uID0gJ3RoZWFkJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcmFtcy5maWx0ZXJzX3Bvc2l0aW9uID0gJ3Rmb290JzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFyYW1zLmxhbmd1YWdlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGZvciAodG1wUGFyYW1zIGluIHBsYWNlaG9sZGVyTGFuZykgewogICAgICAgICAgICAgICAgICAgIGlmIChwbGFjZWhvbGRlckxhbmcuaGFzT3duUHJvcGVydHkodG1wUGFyYW1zKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmxhbmd1YWdlW3RtcFBhcmFtc10gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXJMYW5nW3RtcFBhcmFtc10gPSBwYXJhbXMubGFuZ3VhZ2VbdG1wUGFyYW1zXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAkKGRvY3VtZW50KS5kYXRhKHRoaXMuc2VsZWN0b3IgKyAiX2ZpbHRlcnNfcG9zaXRpb24iLCBwYXJhbXMuZmlsdGVyc19wb3NpdGlvbik7CgogICAgICAgICAgICBpZiAoJCh0aGlzLnNlbGVjdG9yKS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHNldE9wdGlvbnModGhpcy5zZWxlY3Rvciwgb3B0aW9uc19hcmcsIHBhcmFtcyk7CiAgICAgICAgICAgICAgICBpbml0QW5kQmluZFRhYmxlKHRoaXMsIHRoaXMuc2VsZWN0b3IsIDApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChpOyBpIDwgJCh0aGlzLnNlbGVjdG9yKS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSB0aGlzLnNlbGVjdG9yICsgIjplcSgiICsgaSArICIpIjsKICAgICAgICAgICAgICAgICAgICBzZXRPcHRpb25zKHRoaXMuc2VsZWN0b3IsIG9wdGlvbnNfYXJnLCBwYXJhbXMpOwogICAgICAgICAgICAgICAgICAgIGluaXRBbmRCaW5kVGFibGUodGhpcywgc2VsZWN0b3IsIGkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJC5mbi5kYXRhVGFibGVFeHQuaUFwaUluZGV4ID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBhcmFtcyAhPT0gdW5kZWZpbmVkICYmIHBhcmFtcy5vbkluaXRDb21wbGV0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBwYXJhbXMub25Jbml0Q29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBpbml0KG9UYWJsZSwgb3B0aW9uc19hcmcsIHBhcmFtcykgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvVGFibGUuc2V0dGluZ3MoKVswXS5vSW5zdGFuY2UsCiAgICAgICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgICAgIHNlbGVjdG9yLAogICAgICAgICAgICAgICAgdG1wUGFyYW1zLAogICAgICAgICAgICAgICAgdGFibGVTZWxlY3RvciA9ICcjJyArIG9UYWJsZS50YWJsZSgpLm5vZGUoKS5pZDsKCiAgICAgICAgICAgIC8vaW4gY2FzZSB0aGF0IGluc3RhbmNlLnNlbGVjdG9yIHdpbGwgYmUgdW5kZWZpbmVkIChqUXVlcnkgMykKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5zZWxlY3RvcikgewogICAgICAgICAgICAgICAgaW5zdGFuY2Uuc2VsZWN0b3IgPSB0YWJsZVNlbGVjdG9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFyYW1zID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHBhcmFtcyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRtcFBhcmFtcyA9IHBhcmFtczsKICAgICAgICAgICAgICAgIHBhcmFtcyA9IHt9OwogICAgICAgICAgICAgICAgcGFyYW1zLmZpbHRlcnNfcG9zaXRpb24gPSB0bXBQYXJhbXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmFtcy5maWx0ZXJzX3Bvc2l0aW9uID09PSB1bmRlZmluZWQgfHwgcGFyYW1zLmZpbHRlcnNfcG9zaXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgICAgICAgICAgICBwYXJhbXMuZmlsdGVyc19wb3NpdGlvbiA9ICd0aGVhZCc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJhbXMuZmlsdGVyc19wb3NpdGlvbiA9ICd0Zm9vdCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmFtcy5sYW5ndWFnZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKHRtcFBhcmFtcyBpbiBwbGFjZWhvbGRlckxhbmcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGxhY2Vob2xkZXJMYW5nLmhhc093blByb3BlcnR5KHRtcFBhcmFtcykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5sYW5ndWFnZVt0bXBQYXJhbXNdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyTGFuZ1t0bXBQYXJhbXNdID0gcGFyYW1zLmxhbmd1YWdlW3RtcFBhcmFtc107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJChkb2N1bWVudCkuZGF0YShpbnN0YW5jZS5zZWxlY3RvciArICJfZmlsdGVyc19wb3NpdGlvbiIsIHBhcmFtcy5maWx0ZXJzX3Bvc2l0aW9uKTsKCiAgICAgICAgICAgIGlmICgkKGluc3RhbmNlLnNlbGVjdG9yKS5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHNldE9wdGlvbnMoaW5zdGFuY2Uuc2VsZWN0b3IsIG9wdGlvbnNfYXJnLCBwYXJhbXMpOwogICAgICAgICAgICAgICAgaW5pdEFuZEJpbmRUYWJsZShpbnN0YW5jZSwgaW5zdGFuY2Uuc2VsZWN0b3IsIDAsIG9UYWJsZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGk7IGkgPCAkKGluc3RhbmNlLnNlbGVjdG9yKS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICQuZm4uZGF0YVRhYmxlRXh0LmlBcGlJbmRleCA9IGk7CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBpbnN0YW5jZS5zZWxlY3RvciArICI6ZXEoIiArIGkgKyAiKSI7CiAgICAgICAgICAgICAgICAgICAgc2V0T3B0aW9ucyhpbnN0YW5jZS5zZWxlY3Rvciwgb3B0aW9uc19hcmcsIHBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgaW5pdEFuZEJpbmRUYWJsZShpbnN0YW5jZSwgc2VsZWN0b3IsIGksIG9UYWJsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkLmZuLmRhdGFUYWJsZUV4dC5pQXBpSW5kZXggPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGFyYW1zICE9PSB1bmRlZmluZWQgJiYgcGFyYW1zLm9uSW5pdENvbXBsZXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHBhcmFtcy5vbkluaXRDb21wbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhcHBlbmRGaWx0ZXJzTXVsdGlwbGVUYWJsZXModGFibGVzQXJyYXksIHRhYmxlc1NlbGVjdG9ycywgY29sT2JqRHVtbXkpIHsKICAgICAgICAgICAgdmFyIGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcgPSAiIyIgKyBjb2xPYmpEdW1teS5maWx0ZXJfY29udGFpbmVyX2lkLAogICAgICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5TmV3KHRhYmxlc1NlbGVjdG9ycyksCiAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCwKICAgICAgICAgICAgICAgIGlpLAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlcl9zdHIgPSBjb2x1bW5zQXJyYXlUb1N0cmluZyhjb2xPYmpEdW1teS5jb2x1bW5fbnVtYmVyKS5jb2x1bW5fbnVtYmVyX3N0ciwKICAgICAgICAgICAgICAgIHRhYmxlVG1wLAogICAgICAgICAgICAgICAgdGFibGVUbXBBcnIsCiAgICAgICAgICAgICAgICB0YWJsZVRtcEFyckluZGV4LAogICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucyA9IGdldE9wdGlvbnModGFibGVzU2VsZWN0b3JzICsgJ18nICsgY29sdW1uX251bWJlcl9zdHIpW2NvbHVtbl9udW1iZXJfc3RyXSwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfaW5kZXgsCiAgICAgICAgICAgICAgICBjb2x1bW5zVG1wQXJyLAogICAgICAgICAgICAgICAgc2V0dGluZ3NEdCwKICAgICAgICAgICAgICAgIHRtcFN0ciwKICAgICAgICAgICAgICAgIGNvbHVtbkZvclN0YXRlU2F2aW5nOwoKICAgICAgICAgICAgLy9hZGQgYSB3cmFwcGVyIHRvIGhvbGQgYm90aCBmaWx0ZXIgYW5kIHJlc2V0IGJ1dHRvbgogICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmFwcGVuZCgiPGRpdiBpZD1cInlhZGNmLWZpbHRlci13cmFwcGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXJfc3RyICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXdyYXBwZXJcIj48L2Rpdj4iKTsKICAgICAgICAgICAgZmlsdGVyX3NlbGVjdG9yX3N0cmluZyArPSAiIGRpdi55YWRjZi1maWx0ZXItd3JhcHBlciI7CiAgICAgICAgICAgIGlmIChjb2x1bW5fbnVtYmVyX3N0ci5pbmRleE9mKCdfJykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICBjb2x1bW5Gb3JTdGF0ZVNhdmluZyA9IGNvbHVtbl9udW1iZXJfc3RyLnNwbGl0KCdfJylbMF07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb2x1bW5Gb3JTdGF0ZVNhdmluZyA9IGNvbHVtbl9udW1iZXJfc3RyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKGZpbHRlck9wdGlvbnMuZmlsdGVyX3R5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOgogICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuYXBwZW5kKCI8aW5wdXQgdHlwZT1cInRleHRcIiBpZD1cInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyX3N0ciArICJcIiBjbGFzcz1cInlhZGNmLWZpbHRlclwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiBvbmNsaWNrPSd5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpOyIgKwogICAgICAgICAgICAgICAgICAgICAgICAiJyBwbGFjZWhvbGRlcj0nIiArIGZpbHRlck9wdGlvbnMuZmlsdGVyX2RlZmF1bHRfbGFiZWwgKyAiJyIgKyAiIG9ua2V5dXA9XCJ5YWRjZi50ZXh0S2V5VXBNdWx0aVRhYmxlcygnIiArIHRhYmxlc1NlbGVjdG9ycyArICInLGV2ZW50LCciICsgY29sdW1uX251bWJlcl9zdHIgKyAiJyk7XCI+PC9pbnB1dD4iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyT3B0aW9ucy5maWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZmlsdGVyX3NlbGVjdG9yX3N0cmluZykuZmluZCgiLnlhZGNmLWZpbHRlciIpLmFmdGVyKCI8YnV0dG9uIHR5cGU9XCJidXR0b25cIiAiICsgIiBpZD1cInlhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyX3N0ciArICItcmVzZXRcIiBvbm1vdXNlZG93bj1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7XCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAib25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YudGV4dEtleVVwTXVsdGlUYWJsZXMoJyIgKyB0YWJsZXNTZWxlY3RvcnMgKyAiJywgZXZlbnQsJyIgKyBjb2x1bW5fbnVtYmVyX3N0ciArICInLCdjbGVhcicpOyByZXR1cm4gZmFsc2U7XCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXItcmVzZXQtYnV0dG9uICIgKyBmaWx0ZXJPcHRpb25zLnJlc2V0X2J1dHRvbl9zdHlsZV9jbGFzcyArICJcIj4iICsgZmlsdGVyT3B0aW9ucy5maWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgKyAiPC9idXR0b24+Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZXNBcnJheVswXS50YWJsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlVG1wID0gJCgnIycgKyB0YWJsZXNBcnJheVswXS50YWJsZSgpLm5vZGUoKS5pZCkuZGF0YVRhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVUbXAgPSB0YWJsZXNBcnJheVswXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKHRhYmxlVG1wKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3NEdC5hb1ByZVNlYXJjaENvbHNbY29sdW1uRm9yU3RhdGVTYXZpbmddLnNTZWFyY2ggIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbkZvclN0YXRlU2F2aW5nXS5zU2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZlBhcnNlTWF0Y2hGaWx0ZXIodG1wU3RyLCBmaWx0ZXJPcHRpb25zLmZpbHRlcl9tYXRjaF9tb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyX3N0cikudmFsKHRtcFN0cikuYWRkQ2xhc3MoImludXNlIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdCc6CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlck9wdGlvbnMuc2VsZWN0X3R5cGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zX3RtcCA9ICI8b3B0aW9uIGRhdGEtcGxhY2Vob2xkZXI9XCJ0cnVlXCIgdmFsdWU9XCIiICsgIi0xIiArICJcIj4iICsgZmlsdGVyT3B0aW9ucy5maWx0ZXJfZGVmYXVsdF9sYWJlbCArICI8L29wdGlvbj4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wID0gIiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJPcHRpb25zLnNlbGVjdF90eXBlID09PSAnc2VsZWN0MicgJiYgZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZV9vcHRpb25zLnBsYWNlaG9sZGVyICE9PSB1bmRlZmluZWQgJiYgZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZV9vcHRpb25zLmFsbG93Q2xlYXIgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc190bXAgPSAiPG9wdGlvbiB2YWx1ZT1cIlwiPjwvb3B0aW9uPiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJPcHRpb25zLmRhdGEgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJPcHRpb25zLmRhdGEgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVUbXBBcnIgPSB0YWJsZXNTZWxlY3RvcnMuc3BsaXQoJywnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh0YWJsZVRtcEFyckluZGV4ID0gMDsgdGFibGVUbXBBcnJJbmRleCA8IHRhYmxlVG1wQXJyLmxlbmd0aDsgdGFibGVUbXBBcnJJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFibGVzQXJyYXlbdGFibGVUbXBBcnJJbmRleF0udGFibGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlVG1wID0gJCgnIycgKyB0YWJsZXNBcnJheVt0YWJsZVRtcEFyckluZGV4XS50YWJsZSgpLm5vZGUoKS5pZCkuZGF0YVRhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlVG1wID0gdGFibGVzQXJyYXlbdGFibGVUbXBBcnJJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNET01Tb3VyY2UodGFibGVUbXApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9jaGVjayBpZiBhamF4IHNvdXJjZSwgaWYgc28sIGxpc3RlbiBmb3IgZHQuZHJhdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNUbXBBcnIgPSBmaWx0ZXJPcHRpb25zLmNvbHVtbl9udW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb2x1bW5fbnVtYmVyX2luZGV4ID0gMDsgY29sdW1uX251bWJlcl9pbmRleCA8IGNvbHVtbnNUbXBBcnIubGVuZ3RoOyBjb2x1bW5fbnVtYmVyX2luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucy5jb2x1bW5fbnVtYmVyID0gY29sdW1uc1RtcEFycltjb2x1bW5fbnVtYmVyX2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucy5kYXRhID0gZmlsdGVyT3B0aW9ucy5kYXRhLmNvbmNhdChwYXJzZVRhYmxlQ29sdW1uKHRhYmxlVG1wLCBmaWx0ZXJPcHRpb25zLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJPcHRpb25zLmNvbHVtbl9udW1iZXIgPSBjb2x1bW5zVG1wQXJyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ2RyYXcuZHQnLCAnIycgKyB0YWJsZXNBcnJheVt0YWJsZVRtcEFyckluZGV4XS50YWJsZSgpLm5vZGUoKS5pZCkub24oJ2RyYXcuZHQnLCAnIycgKyB0YWJsZXNBcnJheVt0YWJsZVRtcEFyckluZGV4XS50YWJsZSgpLm5vZGUoKS5pZCwgZnVuY3Rpb24gKGV2ZW50LCB1aSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uc190bXAgPSAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zVG1wQXJyID0gZmlsdGVyT3B0aW9ucy5jb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbHVtbl9udW1iZXJfaW5kZXggPSAwOyBjb2x1bW5fbnVtYmVyX2luZGV4IDwgY29sdW1uc1RtcEFyci5sZW5ndGg7IGNvbHVtbl9udW1iZXJfaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucy5jb2x1bW5fbnVtYmVyID0gY29sdW1uc1RtcEFycltjb2x1bW5fbnVtYmVyX2luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlck9wdGlvbnMuZGF0YSA9IGZpbHRlck9wdGlvbnMuZGF0YS5jb25jYXQocGFyc2VUYWJsZUNvbHVtbih0YWJsZVRtcCwgZmlsdGVyT3B0aW9ucywgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHksIHVpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucy5jb2x1bW5fbnVtYmVyID0gY29sdW1uc1RtcEFycjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyT3B0aW9ucy5kYXRhID0gc29ydENvbHVtbkRhdGEoZmlsdGVyT3B0aW9ucy5kYXRhLCBmaWx0ZXJPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpaSA9IDA7IGlpIDwgZmlsdGVyT3B0aW9ucy5kYXRhLmxlbmd0aDsgaWkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uc190bXAgKz0gIjxvcHRpb24gdmFsdWU9XCIiICsgZmlsdGVyT3B0aW9ucy5kYXRhW2lpXSArICJcIj4iICsgZmlsdGVyT3B0aW9ucy5kYXRhW2lpXSArICI8L29wdGlvbj4iOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgZmlsdGVyT3B0aW9ucy5maWx0ZXJfY29udGFpbmVyX2lkICsgJyBzZWxlY3QnKS5lbXB0eSgpLmFwcGVuZChvcHRpb25zX3RtcCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbml0aWFsaXplU2VsZWN0UGx1Z2luKGZpbHRlck9wdGlvbnMuc2VsZWN0X3R5cGUsICQoJyMnICsgZmlsdGVyT3B0aW9ucy5maWx0ZXJfY29udGFpbmVyX2lkICsgJyBzZWxlY3QnKSwgZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZV9vcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJPcHRpb25zLmN1bXVsYXRpdmVfZmlsdGVyaW5nID09PSB0cnVlICYmIGZpbHRlck9wdGlvbnMuc2VsZWN0X3R5cGUgPT09ICdjaG9zZW4nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaFNlbGVjdFBsdWdpbihmaWx0ZXJPcHRpb25zLCAkKCcjJyArIGZpbHRlck9wdGlvbnMuZmlsdGVyX2NvbnRhaW5lcl9pZCArICcgc2VsZWN0JykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZpbHRlck9wdGlvbnMuZGF0YSA9IHNvcnRDb2x1bW5EYXRhKGZpbHRlck9wdGlvbnMuZGF0YSwgZmlsdGVyT3B0aW9ucyk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZXNBcnJheVswXS50YWJsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlVG1wID0gJCgnIycgKyB0YWJsZXNBcnJheVswXS50YWJsZSgpLm5vZGUoKS5pZCkuZGF0YVRhYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVUbXAgPSB0YWJsZXNBcnJheVswXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NEdCA9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKHRhYmxlVG1wKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWx0ZXJPcHRpb25zLmRhdGFbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IGZpbHRlck9wdGlvbnMuZGF0YS5sZW5ndGg7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wICs9ICI8b3B0aW9uIHZhbHVlPVwiIiArIGZpbHRlck9wdGlvbnMuZGF0YVtpaV0udmFsdWUgKyAiXCI+IiArIGZpbHRlck9wdGlvbnMuZGF0YVtpaV0ubGFiZWwgKyAiPC9vcHRpb24+IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaWkgPSAwOyBpaSA8IGZpbHRlck9wdGlvbnMuZGF0YS5sZW5ndGg7IGlpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnNfdG1wICs9ICI8b3B0aW9uIHZhbHVlPVwiIiArIGZpbHRlck9wdGlvbnMuZGF0YVtpaV0gKyAiXCI+IiArIGZpbHRlck9wdGlvbnMuZGF0YVtpaV0gKyAiPC9vcHRpb24+IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyT3B0aW9ucy5maWx0ZXJfdHlwZSA9PT0gJ3NlbGVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxzZWxlY3QgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcl9zdHIgKyAiXCIgY2xhc3M9XCJ5YWRjZi1maWx0ZXJcIiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJvbmNoYW5nZT1cInlhZGNmLmRvRmlsdGVyTXVsdGlUYWJsZXMoJyIgKyB0YWJsZXNTZWxlY3RvcnMgKyAiJyxldmVudCwnIiArIGNvbHVtbl9udW1iZXJfc3RyICsgIicpXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9J3lhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7Jz4iICsgb3B0aW9uc190bXAgKyAiPC9zZWxlY3Q+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0LmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5Gb3JTdGF0ZVNhdmluZ10uc1NlYXJjaCAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbkZvclN0YXRlU2F2aW5nXS5zU2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0geWFkY2ZQYXJzZU1hdGNoRmlsdGVyKHRtcFN0ciwgZmlsdGVyT3B0aW9ucy5maWx0ZXJfbWF0Y2hfbW9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXJfc3RyKS52YWwodG1wU3RyKS5hZGRDbGFzcygiaW51c2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyT3B0aW9ucy5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5hcHBlbmQoIjxzZWxlY3QgbXVsdGlwbGUgZGF0YS1wbGFjZWhvbGRlcj1cIiIgKyBmaWx0ZXJPcHRpb25zLmZpbHRlcl9kZWZhdWx0X2xhYmVsICsgIlwiIGlkPVwieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXJfc3RyICsgIlwiIGNsYXNzPVwieWFkY2YtZmlsdGVyXCIgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAib25jaGFuZ2U9XCJ5YWRjZi5kb0ZpbHRlck11bHRpVGFibGVzTXVsdGlTZWxlY3QoJyIgKyB0YWJsZXNTZWxlY3RvcnMgKyAiJyxldmVudCwnIiArIGNvbHVtbl9udW1iZXJfc3RyICsgIicpXCIgb25tb3VzZWRvd249XCJ5YWRjZi5zdG9wUHJvcGFnYXRpb24oZXZlbnQpO1wiIG9uY2xpY2s9J3lhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7Jz4iICsgb3B0aW9uc190bXAgKyAiPC9zZWxlY3Q+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZXR0aW5nc0R0LmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5Gb3JTdGF0ZVNhdmluZ10uc1NlYXJjaCAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHNldHRpbmdzRHQuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbkZvclN0YXRlU2F2aW5nXS5zU2VhcmNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wU3RyID0geWFkY2ZQYXJzZU1hdGNoRmlsdGVyTXVsdGlTZWxlY3QodG1wU3RyLCBmaWx0ZXJPcHRpb25zLmZpbHRlcl9tYXRjaF9tb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHRtcFN0ci5yZXBsYWNlKC9cXC9nLCAiIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB0bXBTdHIuc3BsaXQoInwiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcl9zdHIpLnZhbCh0bXBTdHIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJPcHRpb25zLmZpbHRlcl90eXBlID09PSAnc2VsZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyT3B0aW9ucy5maWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGZpbHRlcl9zZWxlY3Rvcl9zdHJpbmcpLmZpbmQoIi55YWRjZi1maWx0ZXIiKS5hZnRlcigiPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgIiArICIgaWQ9XCJ5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICArICctJyArIGNvbHVtbl9udW1iZXJfc3RyICsgIi1yZXNldFwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAib25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YuZG9GaWx0ZXJNdWx0aVRhYmxlcygnIiArIHRhYmxlc1NlbGVjdG9ycyArICInLCBldmVudCwnIiArIGNvbHVtbl9udW1iZXJfc3RyICsgIicsJ2NsZWFyJyk7IHJldHVybiBmYWxzZTtcIiBjbGFzcz1cInlhZGNmLWZpbHRlci1yZXNldC1idXR0b24gIiArIGZpbHRlck9wdGlvbnMucmVzZXRfYnV0dG9uX3N0eWxlX2NsYXNzICsgIlwiPiIgKyBmaWx0ZXJPcHRpb25zLmZpbHRlcl9yZXNldF9idXR0b25fdGV4dCArICI8L2J1dHRvbj4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlsdGVyT3B0aW9ucy5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlck9wdGlvbnMuZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJChmaWx0ZXJfc2VsZWN0b3Jfc3RyaW5nKS5maW5kKCIueWFkY2YtZmlsdGVyIikuYWZ0ZXIoIjxidXR0b24gdHlwZT1cImJ1dHRvblwiICIgKyAiIGlkPVwieWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXJfc3RyICsgIi1yZXNldFwiIG9ubW91c2Vkb3duPVwieWFkY2Yuc3RvcFByb3BhZ2F0aW9uKGV2ZW50KTtcIiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAib25jbGljaz1cInlhZGNmLnN0b3BQcm9wYWdhdGlvbihldmVudCk7eWFkY2YuZG9GaWx0ZXJNdWx0aVRhYmxlc011bHRpU2VsZWN0KCciICsgdGFibGVzU2VsZWN0b3JzICsgIicsIGV2ZW50LCciICsgY29sdW1uX251bWJlcl9zdHIgKyAiJywnY2xlYXInKTsgcmV0dXJuIGZhbHNlO1wiIGNsYXNzPVwieWFkY2YtZmlsdGVyLXJlc2V0LWJ1dHRvbiAiICsgZmlsdGVyT3B0aW9ucy5yZXNldF9idXR0b25fc3R5bGVfY2xhc3MgKyAiXCI+IiArIGZpbHRlck9wdGlvbnMuZmlsdGVyX3Jlc2V0X2J1dHRvbl90ZXh0ICsgIjwvYnV0dG9uPiIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxpemVTZWxlY3RQbHVnaW4oZmlsdGVyT3B0aW9ucy5zZWxlY3RfdHlwZSwgJCgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyX3N0ciksIGZpbHRlck9wdGlvbnMuc2VsZWN0X3R5cGVfb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJPcHRpb25zLmN1bXVsYXRpdmVfZmlsdGVyaW5nID09PSB0cnVlICYmIGZpbHRlck9wdGlvbnMuc2VsZWN0X3R5cGUgPT09ICdjaG9zZW4nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoU2VsZWN0UGx1Z2luKGZpbHRlck9wdGlvbnMsICQoIiN5YWRjZi1maWx0ZXItIiArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcl9zdHIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ0ZpbHRlcnMgTXVsdGlwbGUgVGFibGVzIGRvZXMgbm90IHN1cHBvcnQgJyArIGZpbHRlck9wdGlvbnMuZmlsdGVyX3R5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpbml0TXVsdGlwbGVUYWJsZXModGFibGVzQXJyYXksIGZpbHRlcnNPcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBpLAogICAgICAgICAgICAgICAgdGFibGVzU2VsZWN0b3JzID0gJycsCiAgICAgICAgICAgICAgICBkZWZhdWx0X29wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3R5cGU6ICJ0ZXh0IiwKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfY29udGFpbmVyX2lkOiAnJywKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJfcmVzZXRfYnV0dG9uX3RleHQ6ICd4JywKICAgICAgICAgICAgICAgICAgICBjYXNlX2luc2Vuc2l0aXZlOiB0cnVlCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY29sdW1uc09iaktleSwKICAgICAgICAgICAgICAgIGNvbHVtbnNPYmosCiAgICAgICAgICAgICAgICBjb2x1bW5zQXJySW5kZXgsCiAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyX3N0ciwKICAgICAgICAgICAgICAgIGR1bW15QXJyOwoKICAgICAgICAgICAgZm9yIChjb2x1bW5zQXJySW5kZXggPSAwOyBjb2x1bW5zQXJySW5kZXggPCBmaWx0ZXJzT3B0aW9ucy5sZW5ndGg7IGNvbHVtbnNBcnJJbmRleCsrKSB7CiAgICAgICAgICAgICAgICBkdW1teUFyciA9IFtdOwogICAgICAgICAgICAgICAgY29sdW1uc09iaiA9IGZpbHRlcnNPcHRpb25zW2NvbHVtbnNBcnJJbmRleF07CiAgICAgICAgICAgICAgICBpZiAoY29sdW1uc09iai5maWx0ZXJfZGVmYXVsdF9sYWJlbCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouZmlsdGVyX3R5cGUgPT09ICJzZWxlY3QiIHx8IGNvbHVtbnNPYmouZmlsdGVyX3R5cGUgPT09ICdjdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uc09iai5maWx0ZXJfZGVmYXVsdF9sYWJlbCA9ICJTZWxlY3QgdmFsdWUiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uc09iai5maWx0ZXJfdHlwZSA9PT0gIm11bHRpX3NlbGVjdCIgfHwgY29sdW1uc09iai5maWx0ZXJfdHlwZSA9PT0gJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uc09iai5maWx0ZXJfZGVmYXVsdF9sYWJlbCA9ICJTZWxlY3QgdmFsdWVzIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbnNPYmouZmlsdGVyX3R5cGUgPT09ICJhdXRvX2NvbXBsZXRlIiB8fCBjb2x1bW5zT2JqLmZpbHRlcl90eXBlID09PSAidGV4dCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uc09iai5maWx0ZXJfZGVmYXVsdF9sYWJlbCA9ICdUeXBlIHRvIGZpbHRlcic7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5zT2JqLmZpbHRlcl90eXBlID09PSAicmFuZ2VfbnVtYmVyIiB8fCBjb2x1bW5zT2JqLmZpbHRlcl90eXBlID09PSAicmFuZ2VfZGF0ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uc09iai5maWx0ZXJfZGVmYXVsdF9sYWJlbCA9IFsiZnJvbSIsICJ0byJdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sdW1uc09iai5maWx0ZXJfdHlwZSA9PT0gImRhdGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNPYmouZmlsdGVyX2RlZmF1bHRfbGFiZWwgPSAiU2VsZWN0IGEgZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sdW1uc09iaiA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0X29wdGlvbnMsIGNvbHVtbnNPYmopOwoKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXJfc3RyID0gY29sdW1uc0FycmF5VG9TdHJpbmcoY29sdW1uc09iai5jb2x1bW5fbnVtYmVyKS5jb2x1bW5fbnVtYmVyX3N0cjsKICAgICAgICAgICAgICAgIGNvbHVtbnNPYmouY29sdW1uX251bWJlcl9zdHIgPSBjb2x1bW5fbnVtYmVyX3N0cjsKCiAgICAgICAgICAgICAgICBkdW1teUFyci5wdXNoKGNvbHVtbnNPYmopOwogICAgICAgICAgICAgICAgdGFibGVzU2VsZWN0b3JzID0gJyc7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGFibGVzQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFibGVzQXJyYXlbaV0udGFibGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZXNTZWxlY3RvcnMgKz0gdGFibGVzQXJyYXlbaV0udGFibGUoKS5ub2RlKCkuaWQgKyAnLCc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVzU2VsZWN0b3JzICs9IGdldFNldHRpbmdzT2JqRnJvbVRhYmxlKHRhYmxlc0FycmF5W2ldKS5zVGFibGVJZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YWJsZXNTZWxlY3RvcnMgPSB0YWJsZXNTZWxlY3RvcnMuc3Vic3RyaW5nKDAsIHRhYmxlc1NlbGVjdG9ycy5sZW5ndGggLSAxKTsKCiAgICAgICAgICAgICAgICBzZXRPcHRpb25zKHRhYmxlc1NlbGVjdG9ycyArICdfJyArIGNvbHVtbl9udW1iZXJfc3RyLCBkdW1teUFycik7CiAgICAgICAgICAgICAgICBvVGFibGVzW3RhYmxlc1NlbGVjdG9yc10gPSB0YWJsZXNBcnJheTsKICAgICAgICAgICAgICAgIGFwcGVuZEZpbHRlcnNNdWx0aXBsZVRhYmxlcyh0YWJsZXNBcnJheSwgdGFibGVzU2VsZWN0b3JzLCBjb2x1bW5zT2JqKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5pdE11bHRpcGxlQ29sdW1ucyh0YWJsZSwgZmlsdGVyc09wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIHRhYmxlc0FycmF5ID0gW107CiAgICAgICAgICAgIHRhYmxlc0FycmF5LnB1c2godGFibGUpOwogICAgICAgICAgICBpbml0TXVsdGlwbGVUYWJsZXModGFibGVzQXJyYXksIGZpbHRlcnNPcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNsb3NlM3JkUFBsdWdpbnNOZWVkZWRDbG9zZShldnQpIHsKICAgICAgICAgICAgaWYgKGNsb3NlQm9vdHN0cmFwRGF0ZXBpY2tlclJhbmdlKSB7CiAgICAgICAgICAgICAgICAkKCcueWFkY2YtZmlsdGVyLXJhbmdlLWRhdGUnKS5ub3QoJChldnQudGFyZ2V0KSkuZGF0ZXBpY2tlcignaGlkZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjbG9zZUJvb3RzdHJhcERhdGVwaWNrZXIpIHsKICAgICAgICAgICAgICAgICQoJy55YWRjZi1maWx0ZXItZGF0ZScpLm5vdCgkKGV2dC50YXJnZXQpKS5kYXRlcGlja2VyKCdoaWRlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNsb3NlU2VsZWN0MikgewogICAgICAgICAgICAgICAgbGV0IGN1cnJlbnRTZWxlY3QyOwogICAgICAgICAgICAgICAgaWYgKGV2dC50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoJ3lhZGNmLWZpbHRlci1yZXNldC1idXR0b24nKSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAkKCdzZWxlY3QueWFkY2YtZmlsdGVyJykuc2VsZWN0MignY2xvc2UnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFNlbGVjdDIgPSAkKCQoZXZ0LnRhcmdldCkuY2xvc2VzdCgnLnlhZGNmLWZpbHRlci13cmFwcGVyJykuZmluZCgnc2VsZWN0JykpOwogICAgICAgICAgICAgICAgICAgICQoJ3NlbGVjdC55YWRjZi1maWx0ZXInKS5ub3QoY3VycmVudFNlbGVjdDIpLnNlbGVjdDIoJ2Nsb3NlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbihldnQpIHsKICAgICAgICAgICAgY2xvc2UzcmRQUGx1Z2luc05lZWRlZENsb3NlKGV2dCk7CiAgICAgICAgICAgIGlmIChldnQuc3RvcFByb3BhZ2F0aW9uICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV2dC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcmV2ZW50RGVmYXVsdEZvckVudGVyKGV2dCkgewogICAgICAgICAgICBpZiAoZXZ0LmtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgICBpZiAoZXZ0LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV2dC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgZnVuY3Rpb24gZXhJbnRlcm5hbEZpbHRlckNvbHVtbkFKQVhRdWV1ZSh0YWJsZV9hcmcsIGNvbF9maWx0ZXJfYXJyKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBleEZpbHRlckNvbHVtbih0YWJsZV9hcmcsIGNvbF9maWx0ZXJfYXJyLCB0cnVlKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4RmlsdGVyQ29sdW1uKHRhYmxlX2FyZywgY29sX2ZpbHRlcl9hcnIsIGFqYXhTb3VyY2UpIHsKICAgICAgICAgICAgdmFyIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LAogICAgICAgICAgICAgICAgaiwKICAgICAgICAgICAgICAgIHRtcFN0ciwKICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIsCiAgICAgICAgICAgICAgICBjb2x1bW5fcG9zaXRpb24sCiAgICAgICAgICAgICAgICBmaWx0ZXJfdmFsdWUsCiAgICAgICAgICAgICAgICBmcm9tSWQsCiAgICAgICAgICAgICAgICB0b0lkLAogICAgICAgICAgICAgICAgc2xpZGVySWQsCiAgICAgICAgICAgICAgICBvcHRpb25zT2JqLAogICAgICAgICAgICAgICAgbWluLAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgZXhjbHVkZSA9IGZhbHNlOwogICAgICAgICAgICAvL2NoZWNrIGlmIHRoZSB0YWJsZSBhcmcgaXMgZnJvbSBuZXcgZGF0YXRhYmxlcyBBUEkgKGNhcGl0YWwgIkQiKQogICAgICAgICAgICBpZiAodGFibGVfYXJnLnNldHRpbmdzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRhYmxlX2FyZyA9IHRhYmxlX2FyZy5zZXR0aW5ncygpWzBdLm9JbnN0YW5jZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5Mih0YWJsZV9hcmcpOwogICAgICAgICAgICBpZiAoaXNET01Tb3VyY2UodGFibGVfYXJnKSB8fCBhamF4U291cmNlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgY29sX2ZpbHRlcl9hcnIubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBjb2x1bW5fbnVtYmVyID0gY29sX2ZpbHRlcl9hcnJbal1bMF07CiAgICAgICAgICAgICAgICAgICAgY29sdW1uX3Bvc2l0aW9uID0gY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICBleGNsdWRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldICE9PSB1bmRlZmluZWQgJiYgKHBsdWdpbnNbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldICE9PSB1bmRlZmluZWQgJiYgcGx1Z2luc1t0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0uQ29sUmVvcmRlciAhPT0gdW5kZWZpbmVkKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5fcG9zaXRpb24gPSBwbHVnaW5zW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XS5Db2xSZW9yZGVyW2NvbHVtbl9udW1iZXJdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvcHRpb25zT2JqID0gZ2V0T3B0aW9ucyh0YWJsZV9hcmcuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwogICAgICAgICAgICAgICAgICAgIGZpbHRlcl92YWx1ZSA9IGNvbF9maWx0ZXJfYXJyW2pdWzFdOwoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG9wdGlvbnNPYmouZmlsdGVyX3R5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYXV0b19jb21wbGV0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfdmFsdWUgIT09IHVuZGVmaW5lZCAmJiBmaWx0ZXJfdmFsdWUuaW5kZXhPZignX2V4Y2x1ZGVfJykgIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjbHVkZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyX3ZhbHVlID0gZmlsdGVyX3ZhbHVlLnJlcGxhY2UoJ19leGNsdWRlXycsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKGZpbHRlcl92YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3ZhbHVlICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikuYWRkQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZk1hdGNoRmlsdGVyU3RyaW5nKHRhYmxlX2FyZywgY29sdW1uX3Bvc2l0aW9uLCBmaWx0ZXJfdmFsdWUsIG9wdGlvbnNPYmouZmlsdGVyX21hdGNoX21vZGUsIGZhbHNlLCBleGNsdWRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaCA9IHRtcFN0cjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS52YWwoZmlsdGVyX3ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfdmFsdWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS5hZGRDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKS5yZW1vdmVDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFN0ciA9IHlhZGNmTWF0Y2hGaWx0ZXJTdHJpbmcodGFibGVfYXJnLCBjb2x1bW5fcG9zaXRpb24sIGZpbHRlcl92YWx1ZSwgb3B0aW9uc09iai5maWx0ZXJfbWF0Y2hfbW9kZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoID0gdG1wU3RyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNPYmouc2VsZWN0X3R5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4ob3B0aW9uc09iaiwgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbXVsdGlfc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcikudmFsKGZpbHRlcl92YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBTdHIgPSB5YWRjZk1hdGNoRmlsdGVyU3RyaW5nKHRhYmxlX2FyZywgY29sdW1uX3Bvc2l0aW9uLCBmaWx0ZXJfdmFsdWUsIG9wdGlvbnNPYmouZmlsdGVyX21hdGNoX21vZGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoID0gdG1wU3RyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNPYmouc2VsZWN0X3R5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4ob3B0aW9uc09iaiwgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfZGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSAneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctZnJvbS1kYXRlLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy10by1kYXRlLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnZhbChmaWx0ZXJfdmFsdWUuZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyX3ZhbHVlLmZyb20gIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLmFkZENsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnZhbChmaWx0ZXJfdmFsdWUudG8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl92YWx1ZS50byAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLmFkZENsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlX2FyZy5mblNldHRpbmdzKCkub0ZlYXR1cmVzLmJTZXJ2ZXJTaWRlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluID0gZmlsdGVyX3ZhbHVlLmZyb207CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gZmlsdGVyX3ZhbHVlLnRvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaCA9IG1pbiArICcteWFkY2ZfZGVsaW0tJyArIG1heDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVTdGF0ZVNhdmUodGFibGVfYXJnLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZmlsdGVyX3ZhbHVlLmZyb20sIGZpbHRlcl92YWx1ZS50byk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfbnVtYmVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy1mcm9tLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy10by0nICsgY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgZnJvbUlkKS52YWwoZmlsdGVyX3ZhbHVlLmZyb20pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl92YWx1ZS5mcm9tICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgZnJvbUlkKS5hZGRDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS52YWwoZmlsdGVyX3ZhbHVlLnRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJfdmFsdWUudG8gIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5hZGRDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5yZW1vdmVDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaCA9IGZpbHRlcl92YWx1ZS5mcm9tICsgJy15YWRjZl9kZWxpbS0nICsgZmlsdGVyX3ZhbHVlLnRvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZVN0YXRlU2F2ZSh0YWJsZV9hcmcsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBmaWx0ZXJfdmFsdWUuZnJvbSwgZmlsdGVyX3ZhbHVlLnRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyYW5nZV9udW1iZXJfc2xpZGVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlcklkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLXNsaWRlci0nICsgY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy1taW5fdGlwLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy1tYXhfdGlwLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl92YWx1ZS5mcm9tICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbiA9ICQoJyMnICsgZnJvbUlkKS5jbG9zZXN0KCcueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXInKS5maW5kKCIueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWluLXRpcC1oaWRkZW4iKS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gJCgnIycgKyBmcm9tSWQpLmNsb3Nlc3QoJy55YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyLXNsaWRlcicpLmZpbmQoIi55YWRjZi1maWx0ZXItcmFuZ2UtbnVtYmVyLXNsaWRlci1tYXgtdGlwLWhpZGRlbiIpLnRleHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkudGV4dChmaWx0ZXJfdmFsdWUuZnJvbSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbiAhPT0gZmlsdGVyX3ZhbHVlLmZyb20pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnBhcmVudCgpLmFkZENsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucGFyZW50KCkucGFyZW50KCkuZmluZCgndWktc2xpZGVyLXJhbmdlJykuYWRkQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucGFyZW50KCkucGFyZW50KCkuZmluZCgndWktc2xpZGVyLXJhbmdlJykucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgc2xpZGVySWQpLnNsaWRlcigndmFsdWVzJywgMCwgZmlsdGVyX3ZhbHVlLmZyb20pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl92YWx1ZS50byAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnRleHQoZmlsdGVyX3ZhbHVlLnRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4ICE9PSBmaWx0ZXJfdmFsdWUudG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5wYXJlbnQoKS5hZGRDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5wYXJlbnQoKS5wYXJlbnQoKS5maW5kKCcudWktc2xpZGVyLXJhbmdlJykuYWRkQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5wYXJlbnQoKS5wYXJlbnQoKS5maW5kKCcudWktc2xpZGVyLXJhbmdlJykucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgc2xpZGVySWQpLnNsaWRlcigndmFsdWVzJywgMSwgZmlsdGVyX3ZhbHVlLnRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9wb3NpdGlvbl0uc1NlYXJjaCA9IGZpbHRlcl92YWx1ZS5mcm9tICsgJy15YWRjZl9kZWxpbS0nICsgZmlsdGVyX3ZhbHVlLnRvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZVN0YXRlU2F2ZSh0YWJsZV9hcmcsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LCBmaWx0ZXJfdmFsdWUuZnJvbSwgZmlsdGVyX3ZhbHVlLnRvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjdXN0b21fZnVuYyc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnZhbChmaWx0ZXJfdmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbHRlcl92YWx1ZSAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLmFkZENsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlX2FyZy5mblNldHRpbmdzKCkub0ZlYXR1cmVzLmJTZXJ2ZXJTaWRlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX3Bvc2l0aW9uXS5zU2VhcmNoID0gZmlsdGVyX3ZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNPYmouc2VsZWN0X3R5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4ob3B0aW9uc09iaiwgJCgnI3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLScgKyBjb2x1bW5fbnVtYmVyKSwgZmlsdGVyX3ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVTdGF0ZVNhdmUodGFibGVfYXJnLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZmlsdGVyX3ZhbHVlLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGFibGVfYXJnLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlNlcnZlclNpZGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0YWJsZV9hcmcuZm5EcmF3KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWJsZV9hcmcuZm5EcmF3KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgMTApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhGaWx0ZXJDb2x1bW5RdWV1ZS5wdXNoKGV4SW50ZXJuYWxGaWx0ZXJDb2x1bW5BSkFYUXVldWUodGFibGVfYXJnLCBjb2xfZmlsdGVyX2FycikpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleEdldENvbHVtbkZpbHRlclZhbCh0YWJsZV9hcmcsIGNvbHVtbl9udW1iZXIpIHsKICAgICAgICAgICAgdmFyIHJldFZhbCwKICAgICAgICAgICAgICAgIGZyb21JZCwKICAgICAgICAgICAgICAgIHRvSWQsCiAgICAgICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwKICAgICAgICAgICAgICAgIG9wdGlvbnNPYmosCiAgICAgICAgICAgICAgICAkZmlsdGVyRWxlbWVudDsKCiAgICAgICAgICAgIC8vY2hlY2sgaWYgdGhlIHRhYmxlIGFyZyBpcyBmcm9tIG5ldyBkYXRhdGFibGVzIEFQSSAoY2FwaXRhbCAiRCIpCiAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuc2V0dGluZ3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGFibGVfYXJnID0gdGFibGVfYXJnLnNldHRpbmdzKClbMF0ub0luc3RhbmNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRpb25zT2JqID0gZ2V0T3B0aW9ucyh0YWJsZV9hcmcuc2VsZWN0b3IpW2NvbHVtbl9udW1iZXJdOwogICAgICAgICAgICB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSA9IHlhZGNmLmdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyKHRhYmxlX2FyZyk7CgogICAgICAgICAgICAkZmlsdGVyRWxlbWVudCA9ICQoJyN5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy0nICsgY29sdW1uX251bWJlcik7CiAgICAgICAgICAgIHN3aXRjaCAob3B0aW9uc09iai5maWx0ZXJfdHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgIGNhc2UgJ2N1c3RvbV9mdW5jJzoKICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSAkZmlsdGVyRWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmV0VmFsID09PSAnLTEnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldFZhbCA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ2F1dG9fY29tcGxldGUnOgogICAgICAgICAgICAgICAgY2FzZSAndGV4dCc6CiAgICAgICAgICAgICAgICBjYXNlICdkYXRlJzoKICAgICAgICAgICAgICAgIGNhc2UgJ2RhdGVfY3VzdG9tX2Z1bmMnOgogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9ICRmaWx0ZXJFbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgIGlmICgkZmlsdGVyRWxlbWVudC5wcmV2KCkuaGFzQ2xhc3MoJ3lhZGNmLWV4Y2x1ZGUtd3JhcHBlcicpICYmICRmaWx0ZXJFbGVtZW50LnByZXYoKS5maW5kKCdpbnB1dCcpLnByb3AoJ2NoZWNrZWQnKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSAnX2V4Y2x1ZGVfJyArIHJldFZhbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdtdWx0aV9zZWxlY3QnOgogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9ICRmaWx0ZXJFbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXRWYWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gJyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfZGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0ge307CiAgICAgICAgICAgICAgICAgICAgZnJvbUlkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLWZyb20tZGF0ZS0nICsgY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICB0b0lkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLXRvLWRhdGUtJyArIGNvbHVtbl9udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIHJldFZhbC5mcm9tID0gJCgnIycgKyBmcm9tSWQpLnZhbCgpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbC50byA9ICQoJyMnICsgdG9JZCkudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdyYW5nZV9udW1iZXInOgogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZyb21JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy1mcm9tLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgIHRvSWQgPSAneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctdG8tJyArIGNvbHVtbl9udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIHJldFZhbC5mcm9tID0gJCgnIycgKyBmcm9tSWQpLnZhbCgpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbC50byA9ICQoJyMnICsgdG9JZCkudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdyYW5nZV9udW1iZXJfc2xpZGVyJzoKICAgICAgICAgICAgICAgICAgICByZXRWYWwgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSAneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctbWluX3RpcC0nICsgY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICB0b0lkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLW1heF90aXAtJyArIGNvbHVtbl9udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIHJldFZhbC5mcm9tID0gJCgnIycgKyBmcm9tSWQpLnRleHQoKTsKICAgICAgICAgICAgICAgICAgICByZXRWYWwudG8gPSAkKCcjJyArIHRvSWQpLnRleHQoKTsKCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdleEdldENvbHVtbkZpbHRlclZhbCBlcnJvcjogbm8gc3VjaCBmaWx0ZXJfdHlwZTogJyArIG9wdGlvbnNPYmouZmlsdGVyX3R5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXRWYWw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjbGVhclN0YXRlU2F2ZShvVGFibGUsIGNvbHVtbl9udW1iZXIsIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5KSB7CiAgICAgICAgICAgIHZhciB5YWRjZlN0YXRlOwogICAgICAgICAgICBpZiAob1RhYmxlLmZuU2V0dGluZ3MoKS5vRmVhdHVyZXMuYlN0YXRlU2F2ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vQXBpLl9mblNhdmVTdGF0ZShvVGFibGUuZm5TZXR0aW5ncygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlICE9PSB1bmRlZmluZWQgJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlID0geWFkY2ZTdGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0FwaS5fZm5TYXZlU3RhdGUob1RhYmxlLmZuU2V0dGluZ3MoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNhdmVTdGF0ZVNhdmUob1RhYmxlLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSwgZnJvbSwgdG8pIHsKICAgICAgICAgICAgdmFyIHlhZGNmU3RhdGU7CiAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU3RhdGVTYXZlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUgPSB7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlICE9PSB1bmRlZmluZWQgJiYgb1RhYmxlLmZuU2V0dGluZ3MoKS5vTG9hZGVkU3RhdGUueWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0xvYWRlZFN0YXRlLnlhZGNmU3RhdGVbdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHldW2NvbHVtbl9udW1iZXJdID0gewogICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiBmcm9tLAogICAgICAgICAgICAgICAgICAgICAgICB0bzogdG8KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgeWFkY2ZTdGF0ZVt0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICB5YWRjZlN0YXRlW3RhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5XVtjb2x1bW5fbnVtYmVyXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogZnJvbSwKICAgICAgICAgICAgICAgICAgICAgICAgdG86IHRvCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBvVGFibGUuZm5TZXR0aW5ncygpLm9Mb2FkZWRTdGF0ZS55YWRjZlN0YXRlID0geWFkY2ZTdGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9UYWJsZS5mblNldHRpbmdzKCkub0FwaS5fZm5TYXZlU3RhdGUob1RhYmxlLmZuU2V0dGluZ3MoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGV4UmVzZXRBbGxGaWx0ZXJzKHRhYmxlX2FyZywgbm9SZWRyYXcsIGNvbHVtbnMpIHsKICAgICAgICAgICAgdmFyIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5LAogICAgICAgICAgICAgICAgY29sdW1uX251bWJlciwKICAgICAgICAgICAgICAgIGZyb21JZCwKICAgICAgICAgICAgICAgIHRvSWQsCiAgICAgICAgICAgICAgICBzbGlkZXJJZCwKICAgICAgICAgICAgICAgIHRhYmxlT3B0aW9ucywKICAgICAgICAgICAgICAgIG9wdGlvbnNPYmosCiAgICAgICAgICAgICAgICBjb2x1bW5PYmpLZXksCiAgICAgICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUodGFibGVfYXJnKSwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICAkZmlsdGVyRWxlbWVudDsKCiAgICAgICAgICAgIC8vY2hlY2sgaWYgdGhlIHRhYmxlIGFyZyBpcyBmcm9tIG5ldyBkYXRhdGFibGVzIEFQSSAoY2FwaXRhbCAiRCIpCiAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuc2V0dGluZ3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGFibGVfYXJnID0gdGFibGVfYXJnLnNldHRpbmdzKClbMF0ub0luc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhYmxlT3B0aW9ucyA9IGdldE9wdGlvbnModGFibGVfYXJnLnNlbGVjdG9yKTsKICAgICAgICAgICAgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgPSB5YWRjZi5nZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5Mih0YWJsZV9hcmcpOwogICAgICAgICAgICBzZXR0aW5nc0R0ID0gZ2V0U2V0dGluZ3NPYmpGcm9tVGFibGUodGFibGVfYXJnKTsKCiAgICAgICAgICAgIGZvciAoY29sdW1uT2JqS2V5IGluIHRhYmxlT3B0aW9ucykgewogICAgICAgICAgICAgICAgaWYgKHRhYmxlT3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShjb2x1bW5PYmpLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc09iaiA9IHRhYmxlT3B0aW9uc1tjb2x1bW5PYmpLZXldOwogICAgICAgICAgICAgICAgICAgIGNvbHVtbl9udW1iZXIgPSBvcHRpb25zT2JqLmNvbHVtbl9udW1iZXI7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5zICE9PSB1bmRlZmluZWQgJiYgJC5pbkFycmF5KGNvbHVtbl9udW1iZXIsIGNvbHVtbnMpID09PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkucmVtb3ZlRGF0YSgiI3lhZGNmLWZpbHRlci0iICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAiLSIgKyBjb2x1bW5fbnVtYmVyICsgIl92YWwiKTsKCiAgICAgICAgICAgICAgICAgICAgJGZpbHRlckVsZW1lbnQgPSAkKCcjeWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctJyArIGNvbHVtbl9udW1iZXIpOwoKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG9wdGlvbnNPYmouZmlsdGVyX3R5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VzdG9tX2Z1bmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGZpbHRlckVsZW1lbnQudmFsKCctMScpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uc1NlYXJjaCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnNPYmouc2VsZWN0X3R5cGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hTZWxlY3RQbHVnaW4ob3B0aW9uc09iaiwgJGZpbHRlckVsZW1lbnQsICctMScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2F1dG9fY29tcGxldGUnOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0ZXh0JzoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmlsdGVyRWxlbWVudC52YWwoJycpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uc1NlYXJjaCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRmaWx0ZXJFbGVtZW50LnByZXYoKS5oYXNDbGFzcygneWFkY2YtZXhjbHVkZS13cmFwcGVyJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmlsdGVyRWxlbWVudC5wcmV2KCkuZmluZCgnaW5wdXQnKS5wcm9wKCdjaGVja2VkJywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211bHRpX3NlbGVjdF9jdXN0b21fZnVuYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmlsdGVyRWxlbWVudC52YWwoJy0xJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5kYXRhKCIjeWFkY2YtZmlsdGVyLSIgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICItIiArIGNvbHVtbl9udW1iZXIgKyAiX3ZhbCIsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZV9hcmcuZm5TZXR0aW5ncygpLmFvUHJlU2VhcmNoQ29sc1tjb2x1bW5fbnVtYmVyXS5zU2VhcmNoID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uc09iai5zZWxlY3RfdHlwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaFNlbGVjdFBsdWdpbihvcHRpb25zT2JqLCAkZmlsdGVyRWxlbWVudCwgJy0xJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfZGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tSWQgPSAneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctZnJvbS1kYXRlLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy10by1kYXRlLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnZhbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnZhbCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmxlX2FyZy5mblNldHRpbmdzKCkub0ZlYXR1cmVzLmJTZXJ2ZXJTaWRlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFibGVfYXJnLmZuU2V0dGluZ3MoKS5hb1ByZVNlYXJjaENvbHNbY29sdW1uX251bWJlcl0uc1NlYXJjaCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJTdGF0ZVNhdmUodGFibGVfYXJnLCBjb2x1bW5fbnVtYmVyLCB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFuZ2VfbnVtYmVyJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb21JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy1mcm9tLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9JZCA9ICd5YWRjZi1maWx0ZXItJyArIHRhYmxlX3NlbGVjdG9yX2pxX2ZyaWVuZGx5ICsgJy10by0nICsgY29sdW1uX251bWJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgZnJvbUlkKS52YWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBmcm9tSWQpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS52YWwoJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5yZW1vdmVDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9udW1iZXJdLnNTZWFyY2ggPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyU3RhdGVTYXZlKHRhYmxlX2FyZywgY29sdW1uX251bWJlciwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JhbmdlX251bWJlcl9zbGlkZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVySWQgPSAneWFkY2YtZmlsdGVyLScgKyB0YWJsZV9zZWxlY3Rvcl9qcV9mcmllbmRseSArICctc2xpZGVyLScgKyBjb2x1bW5fbnVtYmVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbUlkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLW1pbl90aXAtJyArIGNvbHVtbl9udW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0lkID0gJ3lhZGNmLWZpbHRlci0nICsgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkgKyAnLW1heF90aXAtJyArIGNvbHVtbl9udW1iZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkudGV4dCgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIGZyb21JZCkucGFyZW50KCkucGFyZW50KCkuZmluZCgndWktc2xpZGVyLXJhbmdlJykucmVtb3ZlQ2xhc3MoJ2ludXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcjJyArIHRvSWQpLnRleHQoJycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyB0b0lkKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnaW51c2UnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJyMnICsgdG9JZCkucGFyZW50KCkucGFyZW50KCkuZmluZCgnLnVpLXNsaWRlci1yYW5nZScpLnJlbW92ZUNsYXNzKCdpbnVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnIycgKyBzbGlkZXJJZCkuc2xpZGVyKCJvcHRpb24iLCAidmFsdWVzIiwgWyQoJyMnICsgZnJvbUlkKS5wYXJlbnQoKS5wYXJlbnQoKS5maW5kKCcueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWluLXRpcC1oaWRkZW4nKS50ZXh0KCksICQoJyMnICsgZnJvbUlkKS5wYXJlbnQoKS5wYXJlbnQoKS5maW5kKCcueWFkY2YtZmlsdGVyLXJhbmdlLW51bWJlci1zbGlkZXItbWF4LXRpcC1oaWRkZW4nKS50ZXh0KCldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWJsZV9hcmcuZm5TZXR0aW5ncygpLm9GZWF0dXJlcy5iU2VydmVyU2lkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhYmxlX2FyZy5mblNldHRpbmdzKCkuYW9QcmVTZWFyY2hDb2xzW2NvbHVtbl9udW1iZXJdLnNTZWFyY2ggPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyU3RhdGVTYXZlKHRhYmxlX2FyZywgY29sdW1uX251bWJlciwgdGFibGVfc2VsZWN0b3JfanFfZnJpZW5kbHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9SZWRyYXcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIC8vY2xlYXIgZ2xvYmFsIGZpbHRlcgogICAgICAgICAgICAgICAgc2V0dGluZ3NEdC5vUHJldmlvdXNTZWFyY2guc1NlYXJjaCA9ICcnOwogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzRHQuYWFuRmVhdHVyZXMuZiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNldHRpbmdzRHQuYWFuRmVhdHVyZXMuZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAkKCdpbnB1dCcsIHNldHRpbmdzRHQuYWFuRmVhdHVyZXMuZltpXSkudmFsKCcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvL2VuZCBvZiBjbGVhciBnbG9iYWwgZmlsdGVyCiAgICAgICAgICAgICAgICB0YWJsZV9hcmcuZm5EcmF3KHNldHRpbmdzRHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBleFJlc2V0RmlsdGVycyh0YWJsZV9hcmcsIGNvbHVtbnMsIG5vUmVkcmF3KSB7CiAgICAgICAgICAgIGV4UmVzZXRBbGxGaWx0ZXJzKHRhYmxlX2FyZywgbm9SZWRyYXcsIGNvbHVtbnMpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXhGaWx0ZXJFeHRlcm5hbGx5VHJpZ2dlcmVkKHRhYmxlX2FyZykgewogICAgICAgICAgICB2YXIgY29sdW1uc09iaiwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaktleSwKICAgICAgICAgICAgICAgIGNvbHVtbk9iaiwKICAgICAgICAgICAgICAgIGZpbHRlclZhbHVlLAogICAgICAgICAgICAgICAgZmlsdGVyc1ZhbHVlc1NpbmdsZUVsZW0sCiAgICAgICAgICAgICAgICBmaWx0ZXJzVmFsdWVzQXJyID0gW107CgogICAgICAgICAgICAvL2NoZWNrIGlmIHRoZSB0YWJsZSBhcmcgaXMgZnJvbSBuZXcgZGF0YXRhYmxlcyBBUEkgKGNhcGl0YWwgIkQiKQogICAgICAgICAgICBpZiAodGFibGVfYXJnLnNldHRpbmdzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRhYmxlX2FyZyA9IHRhYmxlX2FyZy5zZXR0aW5ncygpWzBdLm9JbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb2x1bW5zT2JqID0gZ2V0T3B0aW9ucyh0YWJsZV9hcmcuc2VsZWN0b3IpOwoKICAgICAgICAgICAgZm9yIChjb2x1bW5PYmpLZXkgaW4gY29sdW1uc09iaikgewogICAgICAgICAgICAgICAgaWYgKGNvbHVtbnNPYmouaGFzT3duUHJvcGVydHkoY29sdW1uT2JqS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGNvbHVtbk9iaiA9IGNvbHVtbnNPYmpbY29sdW1uT2JqS2V5XTsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJWYWx1ZSA9IGV4R2V0Q29sdW1uRmlsdGVyVmFsKHRhYmxlX2FyZywgY29sdW1uT2JqLmNvbHVtbl9udW1iZXIpOwogICAgICAgICAgICAgICAgICAgIGZpbHRlcnNWYWx1ZXNTaW5nbGVFbGVtID0gW107CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1ZhbHVlc1NpbmdsZUVsZW0ucHVzaChjb2x1bW5PYmouY29sdW1uX251bWJlcik7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1ZhbHVlc1NpbmdsZUVsZW0ucHVzaChmaWx0ZXJWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyc1ZhbHVlc0Fyci5wdXNoKGZpbHRlcnNWYWx1ZXNTaW5nbGVFbGVtKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBleEZpbHRlckNvbHVtbih0YWJsZV9hcmcsIGZpbHRlcnNWYWx1ZXNBcnIsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaW5pdDogaW5pdCwKICAgICAgICAgICAgZG9GaWx0ZXI6IGRvRmlsdGVyLAogICAgICAgICAgICBkb0ZpbHRlck11bHRpU2VsZWN0OiBkb0ZpbHRlck11bHRpU2VsZWN0LAogICAgICAgICAgICBkb0ZpbHRlckF1dG9jb21wbGV0ZTogZG9GaWx0ZXJBdXRvY29tcGxldGUsCiAgICAgICAgICAgIGF1dG9jb21wbGV0ZUtleVVQOiBhdXRvY29tcGxldGVLZXlVUCwKICAgICAgICAgICAgZ2V0T3B0aW9uczogZ2V0T3B0aW9ucywKICAgICAgICAgICAgcmFuZ2VOdW1iZXJLZXlVUDogcmFuZ2VOdW1iZXJLZXlVUCwKICAgICAgICAgICAgcmFuZ2VEYXRlS2V5VVA6IHJhbmdlRGF0ZUtleVVQLAogICAgICAgICAgICByYW5nZUNsZWFyOiByYW5nZUNsZWFyLAogICAgICAgICAgICByYW5nZU51bWJlclNsaWRlckNsZWFyOiByYW5nZU51bWJlclNsaWRlckNsZWFyLAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IHN0b3BQcm9wYWdhdGlvbiwKICAgICAgICAgICAgZXhGaWx0ZXJDb2x1bW46IGV4RmlsdGVyQ29sdW1uLAogICAgICAgICAgICBleEdldENvbHVtbkZpbHRlclZhbDogZXhHZXRDb2x1bW5GaWx0ZXJWYWwsCiAgICAgICAgICAgIGV4UmVzZXRBbGxGaWx0ZXJzOiBleFJlc2V0QWxsRmlsdGVycywKICAgICAgICAgICAgZGF0ZUtleVVQOiBkYXRlS2V5VVAsCiAgICAgICAgICAgIGRhdGVTZWxlY3RTaW5nbGU6IGRhdGVTZWxlY3RTaW5nbGUsCiAgICAgICAgICAgIHRleHRLZXlVUDogdGV4dEtleVVQLAogICAgICAgICAgICBkb0ZpbHRlckN1c3RvbURhdGVGdW5jOiBkb0ZpbHRlckN1c3RvbURhdGVGdW5jLAogICAgICAgICAgICBldmVudFRhcmdldEZpeFVwOiBldmVudFRhcmdldEZpeFVwLAogICAgICAgICAgICBpbml0TXVsdGlwbGVUYWJsZXM6IGluaXRNdWx0aXBsZVRhYmxlcywKICAgICAgICAgICAgaW5pdE11bHRpcGxlQ29sdW1uczogaW5pdE11bHRpcGxlQ29sdW1ucywKICAgICAgICAgICAgdGV4dEtleVVwTXVsdGlUYWJsZXM6IHRleHRLZXlVcE11bHRpVGFibGVzLAogICAgICAgICAgICBkb0ZpbHRlck11bHRpVGFibGVzOiBkb0ZpbHRlck11bHRpVGFibGVzLAogICAgICAgICAgICBkb0ZpbHRlck11bHRpVGFibGVzTXVsdGlTZWxlY3Q6IGRvRmlsdGVyTXVsdGlUYWJsZXNNdWx0aVNlbGVjdCwKICAgICAgICAgICAgZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseU5ldzogZ2VuZXJhdGVUYWJsZVNlbGVjdG9ySlFGcmllbmRseU5ldywKICAgICAgICAgICAgZXhGaWx0ZXJFeHRlcm5hbGx5VHJpZ2dlcmVkOiBleEZpbHRlckV4dGVybmFsbHlUcmlnZ2VyZWQsCiAgICAgICAgICAgIGV4UmVzZXRGaWx0ZXJzOiBleFJlc2V0RmlsdGVycywKICAgICAgICAgICAgaW5pdFNlbGVjdFBsdWdpbkN1c3RvbVRyaWdnZXJzOiBpbml0U2VsZWN0UGx1Z2luQ3VzdG9tVHJpZ2dlcnMsCiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0Rm9yRW50ZXI6IHByZXZlbnREZWZhdWx0Rm9yRW50ZXIsCiAgICAgICAgICAgIGdlbmVyYXRlVGFibGVTZWxlY3RvckpRRnJpZW5kbHkyOiBnZW5lcmF0ZVRhYmxlU2VsZWN0b3JKUUZyaWVuZGx5MgogICAgICAgIH07CgogICAgfSgpKTsKICAgIGlmICh3aW5kb3cpIHsKICAgICAgICB3aW5kb3cueWFkY2YgPSB5YWRjZjsKICAgIH0KICAgIHJldHVybiB5YWRjZjsKfSkpOwoK</ActualData>
          </HTTPData>
        </HTTPDataSet>
        <IsExternalData>false</IsExternalData>
      </HTTPBody>
      <TcpPackets>
        <PacketInfo time="89390015" offset="0" length="4096" />
        <PacketInfo time="89390031" offset="4096" length="16384" />
        <PacketInfo time="89390031" offset="20480" length="12341" />
      </TcpPackets>
    </HTTPResponse>
  </HTTPTask>
</HTTPSnapshot>