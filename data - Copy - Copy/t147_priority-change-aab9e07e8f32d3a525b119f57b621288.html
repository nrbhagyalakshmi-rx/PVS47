var currentPriority,changeToPriority;
$(document).ready(function(){$(document).on("click",".changePriority",setPriorityTriggerButton);$(document).on("click",".changeToPriority",setChangeToPriorityTriggerButton);$(document).on("click",".priorityChangeNotAllowed",showNotAllowedNotification);$("#priorityJustificationPopover #edit-box").hide();$("#priorityJustificationPopover .selectJustification").on("click",function(a){1==a.which&&(a=$(this).html(),initChangePriority(a))});$("#priorityJustificationPopover #addNewJustification, #priorityJustificationPopover .editIcon").on("click",function(a){$(a.target).hasClass("editIcon")&&
$("#priorityJustificationPopover .editedJustification").val($(this).parent().siblings(".selectJustification").html());$("#priorityJustificationPopover #addNewJustification").hide();$("#priorityJustificationPopover #edit-box").show();priorityEditPadding()});$("#priorityJustificationPopover #confirmJustification").on("click",function(){initChangePriority($("#priorityJustificationPopover .editedJustification").val())});$("#priorityJustificationPopover").on("hide.bs.modal",function(){clearAndHidePriorityJustificationEditBox()});
$("#priorityJustificationPopover").on("shown.bs.modal",function(){$("#priorityJustificationPopover .popover-content").scrollTop(0);$("a:visible:first",this).focus()});$("#priorityJustificationPopover #cancelJustification").on("click",function(){clearAndHidePriorityJustificationEditBox()});$("#priorityPopover").on("shown.bs.modal",function(){$("a:visible:first",this).focus()})});
var showNotAllowedNotification=function(){$.Notification.notify("warning","top right","Warning","You don't have access to change the priority for this product.",{autoHideDelay:2E4})},clearAndHidePriorityJustificationEditBox=function(){$("#priorityJustificationPopover #edit-box").hide();$("#priorityJustificationPopover .editedJustification").val("");$("#priorityJustificationPopover #addNewJustification").show();priorityEditPadding()},setPriorityJustificationPopOverTitle=function(){var a=$(currentPriority).parent().attr("title"),
b=$(changeToPriority).parent().data("priority"),a="Priority Change from "+a+" to "+b;$("#priorityJustificationPopover .popover-title").html(a)},setPriorityTriggerButton=function(a){currentPriority=$(a.target);$("#priorityPopover ."+$(currentPriority).attr("class").split(" ").join(".")).parent().hide();$("#priorityPopover :not(."+$(currentPriority).attr("class").split(" ").join(".")+")").parent().show()},setChangeToPriorityTriggerButton=function(a){changeToPriority=$(a.target);forceJustification?setPriorityJustificationPopOverTitle():
initChangePriority()},initChangePriority=function(a){var b;b=$("#detailed-view-checkbox").is(":checked")?$("table#alertsDetailsTable .copy-select:checked").length:$("table.DTFC_Cloned .copy-select:checked").length;1<b&&$(currentPriority).closest("tr").find(".copy-select").prop("checked")?priorityBulkUpdate(b,a):(b=$(currentPriority).closest("tr").index(),isAbstractViewOrCaseView(b)&&(b/=2),b=populatePriorityChangeData(b),changePriority(a,b,!1))},changePriority=function(a,b,c){b["newPriority.id"]=
$(changeToPriority).parent().data("id");b["newPriority.id"]||(b["newPriority.id"]=$(changeToPriority).data("id"));a&&(b.justification=a);var d=$(currentPriority).closest("td"),e;$.ajax({url:changePriorityUrl,type:"POST",data:b,dataType:"json",beforeSend:function(){d.is("td")||(d=$(currentPriority).closest("span"));e=$(d).html();c?$.each($(".copy-select:checked"),function(){$(this).closest("td").siblings("td.priorityParent").html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")}):
$(d).html("<i id='priorityChangeProcessing' class='mdi mdi-spin mdi-loading'></i>")},success:function(a){if(a.status){a=$(changeToPriority).parent().data("priority");e=signal.utils.render("priority",{priorityValue:a?a:$(changeToPriority).data("priority"),priorityClass:a?$(changeToPriority).attr("class"):changeToPriority.context.children[0].className,isPriorityChangeAllowed:!0});if(c){var g=new Set;$.each($(".copy-select:checked"),function(){$(this).closest("td").siblings("td.priorityParent").html(e);
var a=$(this).closest("tr").index();isAbstractViewOrCaseView(a)&&(a/=2);g.add(a)});updateDueIn(g)}else $(d).html(e),a=$(d).closest("tr").index(),isAbstractViewOrCaseView(a)&&(a/=2),updateDueIn([a]);$.Notification.notify("success","top right","Success","Priority changed successfully.",{autoHideDelay:1E4});applicationLabel==APPLICATION_NAME.CASE_DETAIL&&$("#caseHistoryModalTable").DataTable().ajax.reload();applicationLabel==APPLICATION_LABEL.EVENT_DETAIL&&($("#currentAlertHistoryModalTable").DataTable().ajax.reload(),
$("#evdasHistoryModalTable").DataTable().ajax.reload());$("#priority").val(b["newPriority.id"])}else c?table.columns.adjust().draw():$(d).html(e),$.Notification.notify("error","top right","Error","Sorry we could not proceed with the request. Kindly contact the administrator.",{autoHideDelay:1E4});$("#priorityJustificationPopover").modalPopover("hide");$("#priorityPopover").modalPopover("hide")},error:function(){d&&$(d).html(e);$.Notification.notify("error","top right","Error","Sorry we could not proceed with the request. Kindly contact the administrator.",
{autoHideDelay:1E4});table.columns.adjust().draw()}})},priorityBulkUpdate=function(a,b){var c;switch(applicationName){case "Single Case Alert":c="Case";break;case "Aggregate Case Alert":c="PEC";break;case "EVDAS Alert":c="PEC";break;case "Ad-Hoc Alert":c="Observation";break;case "Literature Search Alert":c="Article"}bootbox.dialog({title:"Apply To All",message:signal.utils.render("bulk_operation_options",{totalSelectedRecords:a,alertType:c}),buttons:{ok:{label:"Ok",className:"btn btn-primary",callback:function(){switch($("input[name=bulkOptions]:checked").val()){case "current":var a=
populatePriorityChangeData($(currentPriority).closest("tr").index());changePriority(b,a,!1);break;case "allSelected":checkIfSafetyLeadOfAllSelectedRows()?(a=populatePriorityChangeData($(currentPriority).closest("tr").index(),!0),changePriority(b,a,!0)):$.Notification.notify("error","top right","Error","You must be safety lead for all the selected safety observation for changing the priority",{autoHideDelay:1E4})}}},cancel:{label:"Cancel",className:"btn btn-default"}}})},checkIfSafetyLeadOfAllSelectedRows=
function(){var a=!0;$.each($(".copy-select:checked"),function(){$(this).parent().siblings("td.priorityParent").find("a.priorityChangeNotAllowed").length&&(a=!1)});return a},populatePriorityChangeData=function(a,b){var c={},d=$("#signalIdPartner").val();if(b){var e=new Set,f=[];a=$("#detailed-view-checkbox").is(":checked")?"table#alertsDetailsTable .copy-select:checked":"table.DTFC_Cloned .copy-select:checked";$.each($(a),function(){var a=$(this).closest("tr").index();isAbstractViewOrCaseView(a)&&
(a/=2);e.add(a)});e.forEach(function(a){f.push(populatePriorityDataFromGrid(a))});c.selectedRows=JSON.stringify(f)}else c.selectedRows=-1<a&&!d?JSON.stringify([populatePriorityDataFromGrid(a)]):JSON.stringify([populatePriorityDataFromOther(d)]);return c},populatePriorityDataFromGrid=function(a){var b={};a=table.rows(a).data()[0];b["configObj.id"]=a.alertConfigId;b["executedConfigObj.id"]=a.execConfigId;b["alert.id"]=a.id;return b},populatePriorityDataFromOther=function(a){var b={};b["signal.id"]=
a;b["configObj.id"]=$("#configId").html();b["executedConfigObj.id"]=$("#execConfigId").val();b["alert.id"]=$("#alertId").val();return b},priorityEditPadding=function(){var a=$(".popover.priority ul.text-list > li:last-child").height()+11+"px";$(".popover.priority ul.text-list").css("padding-bottom",a);$(".editedJustification").focus()},updateDueIn=function(a){$("#signalIdPartner").val()||a.forEach(function(a){if(-1<a){var c="table#alertsDetailsTable tr:nth-child("+(a+1)+") td.dueIn";a=new Date(table.rows(a).data()[0].detectedDate);
var d=$(changeToPriority).parent().data("days"),e=new Date;a=a.addDays(d).getTime()-e.getTime();a=Math.ceil(a/864E5);$(c).html(signal.list_utils.due_in_comp(a))}})};