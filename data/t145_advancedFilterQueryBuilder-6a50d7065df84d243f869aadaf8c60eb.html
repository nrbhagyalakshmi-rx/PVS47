var AJAXKeywordList,AJAXFieldMap=[],AJAXValueSampleList,AJAXOperatorStringList,AJAXOperatorNumList,AJAXOperatorDateList,AJAXOperatorValuelessList,AJAXOperatorBooleanList,AJAXFinished=7,AJAXCount=0,RF_TYPE_TEXT="text",RF_TYPE_STRING="string",RF_TYPE_DATE="date",RF_TYPE_NUMBER="number",RF_TYPE_PART_DATE="partialDate",RF_TYPE_AUTOCOMPLETE="autocomplete",RF_TYPE_BOOLEAN="boolean",EDITOR_TYPE_TEXT=0,EDITOR_TYPE_DATE=1,EDITOR_TYPE_SELECT=2,EDITOR_TYPE_NONE=3,EDITOR_TYPE_AUTOCOMPLETE=4,LAST_X_DATE_OPERATORS=
["LAST_X_DAYS","LAST_X_WEEKS","LAST_X_MONTHS","LAST_X_YEARS"],NEXT_X_DATE_OPERATORS=["NEXT_X_DAYS","NEXT_X_WEEKS","NEXT_X_MONTHS","NEXT_X_YEARS"],RELATIVE_DATE_OPERATORS=["YESTERDAY","LAST_WEEK","LAST_MONTH","LAST_YEAR"],IS_EMPTY_OPERATORS=["IS_EMPTY","IS_NOT_EMPTY"],EQUALS_OPERATORS=["EQUALS","NOT_EQUAL"],hasBlanks=!1,keys=[],$selectedField,$selectedOperator,$selectedValue,$selectDate,$selectSelect,selectedGroup,builderAll,builderSubgroup,$queryJSON,dragSourceEl,draggingFromGroup,Expressions,Expression,
ExpressionList,backboneExpressions,expressionList,editable=!0,signal=signal||{};
signal.advancedFilter=function(){return{initializeAdvancedFilters:function(){$selectedField=$("#selectField");$selectedOperator=$("#selectOperator");$selectedValue=$("#selectValue");$selectDate=$("#selectDate");$selectSelect=$("#selectSelect");builderAll=document.getElementById("builderAll");$queryJSON=$("#queryJSON");Expressions=Backbone.Collection.extend({});Expression=Backbone.Model.extend({});ExpressionList=Backbone.View.extend({initialize:function(){var a=$queryJSON.val();null==a||""==a?(selectedGroup=
createGroup(),builderAll.appendChild(selectedGroup)):(buildQueryFromJSON(a),selectedGroup=builderAll.getElementsByClassName("group")[0]);addSubgroup(builderAll);builderSubgroup=getSubgroup(builderAll);$(selectedGroup).addClass("selectedGroup");$("#toAddContainer").on("query.builder.updateAJAXValues",function(a){updateAJAXValues(a.target)});$queryJSON.val(printAll())}});getAJAXValues();$("#showDate").hide();$("#showSelect").hide();$("#showSelectAuto").hide();$("#errorMessageOperator").hide();backboneExpressions=
new Expressions;expressionList=new ExpressionList;$("#selectField").select2({dropdownParent:$("#createAdvancedFilterModal")});$("#selectField").val("-1").trigger("change");$("#selectSelect").select2();$("#selectSelectAuto").select2({minimumInputLength:2,multiple:!0,ajax:{quietMillis:100,dataType:"json",url:function(){return getSelectAutoUrl($(this))},data:function(a){var b=$(this).closest(".toAddContainer")[0],b=$(getFieldFromExpression(b)).select2("val"),d={};"alertTags"==b?d.isCaseSeriesTag=!0:
"globalTags"==b?d.isCaseSeriesTag=!1:"assignedTo.id"==b?d.isGroup=!1:"assignedToGroup.id"==b?d.isGroup=!0:d.field=b;d.alertType=apptype;d.term=a.term||"";d.page=a.page||1;d.max=30;return d},processResults:function(a,b){b.page=b.page||1;return{results:a.list,pagination:{more:30*b.page<a.totalCount}}}}});$("#selectSelectAuto").val("").trigger("change");$("#selectDate").datepicker({allowPastDates:!0});$("#queryLevel").select2();$.each(document.getElementsByClassName("doneLoading"),function(){$(this).hide()});
$("#createAdvancedFilterModal").on("hidden.bs.modal",function(a){$("#createAdvancedFilterModal .modal-title").html("Add New Filter");$("#queryJSON").val("");$("#builderAll").empty();$("#selectField").data("select2")&&$("#selectField").select2("destroy");$("#selectSelect").data("select2")&&$("#selectSelect").select2("destroy");$("#selectSelectAuto").data("select2")&&$("#selectSelectAuto").select2("destroy")})}}}();
$(document).on("change",".expressionField",function(){var a=$(this).closest(".toAddContainer")[0],b=$(a).closest(".expression")[0],d=$(this)[0].value;updateAJAXFields(a);updateAJAXValues(a);b&&null!=b.expressionIndex&&(backboneExpressions.at(b.expressionIndex).set("field",d),backboneExpressions.at(b.expressionIndex).set("op",$(getOperatorFromExpression(a))[0].value),backboneExpressions.at(b.expressionIndex).set("value",""));$(getValueSelectFromExpression(a)).val("");$(getValueTextFromExpression(a)).val("");
""!=d&&$(this.parentElement).removeClass("has-error");$queryJSON.val(printAll())});
$(document).on("change",".expressionOp",function(){var a=$(this).closest(".toAddContainer"),b=a.closest(".expression")[0],d=$(this)[0].value;updateAJAXOperators(a,d);if(b&&void 0!=b&&null!=b.expressionIndex){backboneExpressions.at(b.expressionIndex).set("op",d);var c=!1;$.each(AJAXOperatorValuelessList,function(a,b){if(null!=b&&b.value==d)return c=!0,!1});c?backboneExpressions.at(b.expressionIndex).set("value",d):backboneExpressions.at(b.expressionIndex).set("value","")}$(getValueSelectFromExpression(a)).val("").trigger("change");
$(getValueSelectAutoFromExpression(a)).val("").trigger("change");$(getValueTextFromExpression(a)).val("");$(getValueDateInputFromExpression(a)).val("");$queryJSON.val(printAll())});
$(document).on("change",".expressionValueText",function(){var a=$(this).closest(".toAddContainer"),b=a.closest(".expression")[0];b&&null!=b.expressionIndex&&backboneExpressions.at(b.expressionIndex).set("value",$(getValueTextFromExpression(a))[0].value);""!=$(this)[0].value&&$(this.parentElement).removeClass("has-error");$queryJSON.val(printAll())});
$(document).on("change",".expressionValueSelectAuto",function(){var a=$(this).closest(".toAddContainer"),b=$(a).closest(".expression")[0],a=$(getValueSelectAutoFromExpression(a)).select2("val");$.isArray(a)&&(a=$.grep(a,function(a){if(""!=a)return a}),0==a.length&&(a=""));if(b&&void 0!=b&&null!=b.expressionIndex){if($.isArray(a)){for(var d="",c=0;c<a.length;c++)d=0!=c?d+(";"+a[c]):d+a[c];a=d}backboneExpressions.at(b.expressionIndex).set("value",a)}$queryJSON.val(printAll())});
$(document).on("change",".keywordExpression",function(){var a=this.parentElement,b=a.parentElement,d=!1;if(2<getExpressionOrGroupCountFromGroup(b)){var c=getFirstChildWithClassnameIndexFromElement("expression",b),e=getKeywordIndexFromElement(b.children[c]);this===b.children[c].children[e]&&(c=getSecondChildWithClassnameIndexFromElement("expression",b),-1==c&&(c=getFirstChildWithClassnameIndexFromElement("group",b)),e=getKeywordIndexFromElement(b.children[c]));$(this).val()!=$(b.children[c].children[e]).val()&&
(d=!0);d&&(c=getChildIndexFromParent(a,b),d=encapsulateFromIndexToIndexInNewGroup(b,c+1,getLastExpressionOrGroupIndexFromGroup(b)),b.insertBefore(d,b.children[c].nextSibling),c=encapsulateFromIndexToIndexInNewGroup(b,0,c),b.insertBefore(c,b.firstChild),a=a.children[getKeywordIndexFromElement(a)],addKeyword(c,a.value,"keywordGroup"),cleanUpKeywords(c),cleanUpKeywords(d),cleanUpKeywordGroups(b))}printToJSON()});
$(document).on("change",".keywordGroup",function(){var a=this.parentElement,b=a.parentElement,d=!1;if(2<getExpressionOrGroupCountFromGroup(b)){var c=getFirstChildWithClassnameIndexFromElement("group",b),e=getKeywordIndexFromElement(b.children[c]);this===b.children[c].children[e]&&(c=getSecondChildWithClassnameIndexFromElement("group",b),e=getKeywordIndexFromElement(b.children[c]));$(this).val()!=$(b.children[c].children[e]).val()&&(d=!0);d&&(c=getChildIndexFromParent(a,b),d=encapsulateFromIndexToIndexInNewGroup(b,
c+1,getLastExpressionOrGroupIndexFromGroup(b)),b.insertBefore(d,b.children[c].nextSibling),c=encapsulateFromIndexToIndexInNewGroup(b,0,c),b.insertBefore(c,b.firstChild),a=a.children[getKeywordIndexFromElement(a)],addKeyword(c,a.value,"keywordGroup"),cleanUpKeywordGroups(c),cleanUpKeywordGroups(d),cleanUpKeywordGroups(b))}printToJSON()});
$(document).on("click","#addExpression",function(){$("#errorMessageOperator").hide();var a=!0;"Select Field"==$selectedField.val()&&($selectedField.parent().addClass("has-error"),a=!1);if(a){var b=document.getElementById("toAddContainer"),a=$(getFieldFromExpression(b)).val(),d=$(getOperatorFromExpression(b))[0].value,c,e=[],f=!1;if($(b.getElementsByClassName("expressionValueText")[0]).is(":visible"))if(AJAXFieldMap[a]==RF_TYPE_DATE){if(c=$(b.getElementsByClassName("expressionValueText")[0])[0].value,
!_.isEmpty(c)&&(0>=c||isNaN(c)))return $("#errorMessageOperator").show(),!1}else c=$(b.getElementsByClassName("expressionValueText")[0])[0].value;else if($(b.getElementsByClassName("expressionValueSelect")[0]).is(":visible"))c=$(getValueSelectFromExpression(b)).val(),$.isArray(c)&&(c=$.grep(c,function(a){return""!=a}));else if($($(b).find(".expressionValueSelectAuto")[0]).is(":visible")){var g=$(getValueSelectAutoFromExpression(b)).select2("data");c=$(getValueSelectAutoFromExpression(b)).select2("val");
_.each(g,function(a){e.push({id:a.id,text:a.text})});$.isArray(c)&&(c=$.grep(c,function(a){return""!=a}));c||(c="")}else $(b.getElementsByClassName("expressionValueDateInput")[0]).is(":visible")?(c=$(b.getElementsByClassName("expressionValueDateInput")[0])[0].value,f=!0):c=$(b.getElementsByClassName("expressionOp")[0])[0].value;$("#selectField").select2("destroy");$("#selectSelect").select2("destroy");$("#selectSelectAuto").select2("destroy");b=b.cloneNode(!0);$(b).removeAttr("id");$(getValueDateFromExpression(b)).datepicker({allowPastDates:!0});
f&&$(getValueDateFromExpression(b)).datepicker("setDate",c);null!=c&&""!=c||$(getValueDateInputFromExpression(b)).val("");addOnchangeMethodsToDatepickerElement(getValueDateFromExpression(b));g={};0<builderAll.getElementsByClassName("selectedGroup").length?f=selectedGroup:(f=builderAll.getElementsByClassName("group"),0==f.length?(f=createGroup(),builderAll.insertBefore(f,builderAll.children[0])):f=f[0],selectedGroup=f,$(selectedGroup).addClass("selectedGroup"));var h=getLastChildWithClassnameIndexFromElement("expression",
f);-1<h?f.insertBefore(createExpressionFromInput(b,a,d,c,g),f.children[h].nextSibling):0<f.children.length&&f.insertBefore(createExpressionFromInput(b,a,d,c,g),f.children[0]);$(getFieldFromExpression(b)).select2();$(getValueSelectFromExpression(b)).select2();$("#selectField").select2({dropdownParent:$("#createAdvancedFilterModal")});$("#selectSelect").select2();$(getValueSelectAutoFromExpression(b)).select2({minimumInputLength:2,multiple:!0,ajax:{quietMillis:100,dataType:"json",url:function(){return getSelectAutoUrl($(this))},
data:function(a){var b=$(this).closest(".toAddContainer")[0],b=$(getFieldFromExpression(b)).select2("val"),c={};"alertTags"==b?c.isCaseSeriesTag=!0:"globalTags"==b?c.isCaseSeriesTag=!1:"assignedTo.id"==b?c.isGroup=!1:"assignedToGroup.id"==b?c.isGroup=!0:c.field=b;c.alertType=apptype;c.term=a.term||"";c.page=a.page||1;c.max=30;return c},processResults:function(a,b){b.page=b.page||1;return{results:a.list,pagination:{more:30*b.page<a.totalCount}}}}});for(a=0;a<e.length;a++)d=new Option(e[a].text,e[a].id,
!0,!0),$(getValueSelectAutoFromExpression(b)).append(d).trigger("change");$(getValueSelectAutoFromExpression(b)).trigger({type:"select2:select",params:{data:e}});$("#selectSelectAuto").select2({minimumInputLength:2,multiple:!0,ajax:{quietMillis:100,dataType:"json",url:function(){return getSelectAutoUrl($(this))},data:function(a){var b=$(this).closest(".toAddContainer")[0],b=$(getFieldFromExpression(b)).select2("val"),c={};"alertTags"==b?c.isCaseSeriesTag=!0:"globalTags"==b?c.isCaseSeriesTag=!1:"assignedTo.id"==
b?c.isGroup=!1:"assignedToGroup.id"==b?c.isGroup=!0:c.field=b;c.alertType=apptype;c.term=a.term||"";c.page=a.page||1;c.max=30;return c},processResults:function(a,b){b.page=b.page||1;return{results:a.list,pagination:{more:30*b.page<a.totalCount}}}}});$("#selectSelectAuto").select2("val","");d=$("#selectSelect").val();if("undefined"!=typeof d&&null!=d)for(a=d.length;a--;)""===d[a]&&d.splice(a,1);$("#selectSelect").val(d);cleanUpKeywords(f);printToJSON()}});
$(document).on("click",".removeExpression",function(){var a=this.parentElement.parentElement,b=this.parentElement.expressionIndex;backboneExpressions.remove(backboneExpressions.at(b));checkIndexes(b);this.parentElement.remove();0<a.children.length&&cleanUpKeywords(a);printToJSON()});
$(document).on("click",".removeGroup",function(){for(var a=this.parentElement,b=a.parentElement,d=a.getElementsByClassName("expression"),c,e=0;e<d.length;e++)c=d[e].expressionIndex,backboneExpressions.remove(backboneExpressions.at(c)),checkIndexes(c);this.parentElement.remove();0<a.children.length&&(cleanUpKeywordGroups(a),cleanUpKeywords(a));cleanUpKeywordGroups(b);cleanUpKeywords(b);printToJSON()});
$(document).on("change",".expressionValueSelect",function(){var a=$(this).closest(".toAddContainer"),b=$(a).closest(".expression")[0],a=$(getValueSelectFromExpression(a)).val();$.isArray(a)&&(a=$.grep(a,function(a){if(""!=a)return a}),0==a.length&&(a=""));if(b&&null!=b.expressionIndex){if($.isArray(a)){for(var d="",c=0;c<a.length;c++)d=0!=c?d+(";"+a[c]):d+a[c];a=d}backboneExpressions.at(b.expressionIndex).set("value",a)}$queryJSON.val(printAll())});
function getPossibleValuesAJAX(){$.ajax({type:"GET",url:possibleValuesUrl,dataType:"json",success:function(a){AJAXValueSampleList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}
function getReportFieldsAJAX(){$.ajax({type:"GET",url:allFieldsUrl,dataType:"json",success:function(a){$.each(a,function(){if(this.isAutocomplete)AJAXFieldMap[this.name]=RF_TYPE_AUTOCOMPLETE;else switch(this.dataType){case "java.lang.String":AJAXFieldMap[this.name]=this.isText?RF_TYPE_TEXT:RF_TYPE_STRING;break;case "java.util.Date":AJAXFieldMap[this.name]=RF_TYPE_DATE;break;case "java.lang.Number":AJAXFieldMap[this.name]=RF_TYPE_NUMBER;break;case "java.lang.Boolean":AJAXFieldMap[this.name]=RF_TYPE_BOOLEAN}});
AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}function getDateOperatorsAJAX(){$.ajax({type:"GET",url:dateOperatorsUrl,dataType:"json",success:function(a){AJAXOperatorDateList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}function getNumOperatorsAJAX(){$.ajax({type:"GET",url:numOperatorsUrl,dataType:"json",success:function(a){AJAXOperatorNumList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}
function getStringOperatorsAJAX(){$.ajax({type:"GET",url:stringOperatorsUrl,dataType:"json",success:function(a){AJAXOperatorStringList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}function getBooleanOperatorsAJAX(){$.ajax({type:"GET",url:booleanOperatorsUrl,dataType:"json",success:function(a){AJAXOperatorBooleanList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}
function getValuelessOperatorsAJAX(){$.ajax({type:"GET",url:valuelessOperatorsUrl,dataType:"json",success:function(a){AJAXOperatorValuelessList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}function getKeywordsAJAX(){$.ajax({type:"GET",url:keywordsUrl,dataType:"json",success:function(a){AJAXKeywordList=a;AJAXCount==AJAXFinished?updateInitialAJAXLists():AJAXCount++}})}
function getAJAXValues(){getPossibleValuesAJAX();getReportFieldsAJAX();getDateOperatorsAJAX();getNumOperatorsAJAX();getStringOperatorsAJAX();"undefined"!==typeof booleanOperatorsUrl?getBooleanOperatorsAJAX():AJAXFinished=6;getValuelessOperatorsAJAX();getKeywordsAJAX()}
function updateAJAXFields(a){var b=$(getFieldFromExpression(a)).val(),d=getOperatorFromExpression(a);$(d).empty();switch(AJAXFieldMap[b]){case RF_TYPE_DATE:$.each(AJAXOperatorDateList,function(a,b){$(d).append($("<option></option>").attr("value",this.value).text(this.display))});break;case RF_TYPE_NUMBER:$.each(AJAXOperatorNumList,function(a,b){$(d).append($("<option></option>").attr("value",this.value).text(this.display))});break;case RF_TYPE_AUTOCOMPLETE:$("#selectSelectAuto").val("").trigger("change");
case RF_TYPE_STRING:$.each(AJAXOperatorStringList,function(a,b){$(d).append($("<option></option>").attr("value",this.value).text(this.display))});break;case RF_TYPE_BOOLEAN:$.each(AJAXOperatorBooleanList,function(a,b){$(d).append($("<option></option>").attr("value",this.value).text(this.display))});break;case RF_TYPE_PART_DATE:$.each(AJAXOperatorDateList,function(a,b){$(d).append($("<option></option>").attr("value",this.value).text(this.display))})}}
function updateAJAXOperators(a,b){var d=$(getFieldFromExpression(a)).val(),c=$(getOperatorFromExpression(a))[0].value,e=a.parentElement;_.contains(IS_EMPTY_OPERATORS,c)?(void 0!=e&&null!=e.expressionIndex&&backboneExpressions.at(e.expressionIndex).set("value",b),showHideValue(EDITOR_TYPE_NONE,a)):AJAXFieldMap[d]!=RF_TYPE_DATE&&AJAXFieldMap[d]!=RF_TYPE_PART_DATE||!_.contains(RELATIVE_DATE_OPERATORS,c)?AJAXFieldMap[d]==RF_TYPE_DATE&&_.contains(LAST_X_DATE_OPERATORS,c)?showHideValue(EDITOR_TYPE_TEXT,
a):AJAXFieldMap[d]==RF_TYPE_DATE?showHideValue(EDITOR_TYPE_DATE,a):AJAXFieldMap[d]==RF_TYPE_STRING?_.contains(EQUALS_OPERATORS,c)&&AJAXValueSampleList[d]&&0<AJAXValueSampleList[d].length?showHideValue(EDITOR_TYPE_SELECT,a):showHideValue(EDITOR_TYPE_TEXT,a):AJAXFieldMap[d]==RF_TYPE_BOOLEAN?_.contains(EQUALS_OPERATORS,c)&&AJAXValueSampleList[d]&&0<AJAXValueSampleList[d].length?showHideValue(EDITOR_TYPE_SELECT,a):showHideValue(EDITOR_TYPE_TEXT,a):AJAXFieldMap[d]==RF_TYPE_AUTOCOMPLETE?_.contains(EQUALS_OPERATORS,
c)?showHideValue(EDITOR_TYPE_AUTOCOMPLETE,a):showHideValue(EDITOR_TYPE_TEXT,a):showHideValue(EDITOR_TYPE_TEXT,a):(void 0!=e&&null!=e.expressionIndex&&backboneExpressions.at(e.expressionIndex).set("value",b),showHideValue(EDITOR_TYPE_NONE,a))}
function updateAJAXValues(a){var b=$(getFieldFromExpression(a)).val(),d=getValueSelectFromExpression(a);$(d).empty();if(null!=b)if("-1"==b)showHideValue(EDITOR_TYPE_TEXT,a);else if(AJAXFieldMap[b]!=RF_TYPE_DATE)if(AJAXFieldMap[b]==RF_TYPE_AUTOCOMPLETE)showHideValue(EDITOR_TYPE_AUTOCOMPLETE,a);else if(AJAXValueSampleList[b]){var c,e;$.each(AJAXValueSampleList[b],function(){""!=this&&(e=this.id?this.id:this,c=this.text?this.text:this,$(d).append($("<option></option>").attr("value",e).text(c)))});showHideValue(EDITOR_TYPE_SELECT,
a)}else showHideValue(EDITOR_TYPE_TEXT,a);else showHideValue(EDITOR_TYPE_DATE,a)}
function updateInitialAJAXLists(){$.each(document.getElementsByClassName("builderAll")[0].getElementsByClassName("expression"),function(){var a=this.getElementsByClassName("toAddContainer")[0];updateAJAXFields(a);updateAJAXValues(a);$(getOperatorFromExpression(a)).val(backboneExpressions.at($(this)[0].expressionIndex).get("op"));updateAJAXOperators(a);var b=getCorrectSelectValueFromContainer(a);if(b===getValueTextFromExpression(a))$(getValueTextFromExpression(a)).val(backboneExpressions.at($(this)[0].expressionIndex).get("value"));else if(b===
getValueSelectFromExpression(a))b=backboneExpressions.at($(this)[0].expressionIndex).get("value"),(b=b.split(";"))&&(b[0].trim()||(b=null)),$(getValueSelectFromExpression(a)).val(b);else if(b===getValueSelectAutoFromExpression(a)){b=backboneExpressions.at($(this)[0].expressionIndex).get("value");(b=b.split(";"))&&(b[0].trim()||(b=null));var d=$(getFieldFromExpression(a)).val(),c=[],e;d==ADVANCED_FILTER_FIELDS.ASSIGNED_TO_USER_ID||d==ADVANCED_FILTER_FIELDS.ASSIGNED_TO_GROUP_ID?_.each(b,function(a){(e=
$.grep(AJAXValueSampleList[d],function(b){return b.id==a}))?c.push({id:e[0].id,text:e[0].text}):c.push({id:a,text:a})}):_.each(b,function(a){c.push({id:a,text:a})});for(b=0;b<c.length;b++){var f=new Option(c[b].text,c[b].id,!0,!0);$(getValueSelectAutoFromExpression(a)).append(f).trigger("change")}$(getValueSelectAutoFromExpression(a)).trigger({type:"select2:select",params:{data:c}})}else $(getValueDateInputFromExpression(a)).val(backboneExpressions.at($(this)[0].expressionIndex).get("value"))});$.each(document.getElementsByClassName("loading"),
function(){$(this).hide()});$.each(document.getElementsByClassName("doneLoading"),function(){$(this).show()});editable||($("#toAddContainer").parent().hide(),$("#toAddContainerSet").parent().hide());AJAXCount=0}
function printAll(){hasBlanks=!1;keys=[];var a=document.getElementsByClassName("builderAll")[0],a='{"all":{"containerGroups":['+printRecurJSON(a);if(hasBlanks){for(var a=a+',"blankParameters":[',b=0;b<keys.length;b++)0<b&&(a+=","),a+="{"+keys[b]+"}";a+="]"}a+="}";$("#hasBlanksQuery").val(hasBlanks);return a}
function printRecurJSON(a){for(var b=" ",d,c=getLastExpressionOrGroupIndexFromGroup(a),e=-1,f=-1,g=!1,h=0;h<a.children.length;h++){if(a.children[h].classList.contains("expression")){var g=backboneExpressions.at(a.children[h].expressionIndex),k=g.get("op");_.contains(IS_EMPTY_OPERATORS,k)?g.set("value",k):g.set("value",g.get("value"));b+='{"index":"'+a.children[h].expressionIndex+'","field":"'+g.get("field")+'","op":"'+k+'","value":"'+g.get("value")+'"';-1==g.get("field")&&(hasBlanks=!0);if(null==
g.get("value")||""==$.trim(g.get("value")))hasBlanks=!0,keys.push('"key":'+(keys.length+1)+',"field":"'+g.get("field")+'","op":"'+k+'","value":"'+g.get("value")+'"'),b+=',"key":"'+keys.length+'"';b+="}";-1==e&&(e=h);g=!0}else a.children[h].classList.contains("group")&&("  ] } "==printRecurJSON(a.children[h])&&(hasBlanks=!0),b+='{"expressions":['+printRecurJSON(a.children[h]),-1==f&&(f=h),g=!0);g&&h<c&&(b+=", ",g=!1)}if(-1!=e){if(c=getKeywordIndexFromElement(a.children[e]),-1!=c&&(d=a.children[e].children[c].value),
d)return b+'],"keyword":"'+d+'"}'}else if(-1==e&&-1!=f&&(c=getKeywordIndexFromElement(a.children[f]),-1!=c&&(d=a.children[f].children[c].value),d))return b+'],"keyword":"'+d+'"}';return b+" ] } "}
function buildQueryFromJSON(a){a=JSON.parse(a).all;var b=a.keyword;a.containerGroups.forEach(function(a){var c=createGroup(),e=getLastExpressionOrGroupIndexFromGroup(builderAll);-1!=e?builderAll.insertBefore(c,builderAll.children[e].nextSibling):builderAll.insertBefore(c,builderAll.firstChild);a.expressions.forEach(function(b){parseGroup(c,b,a.keyword)});b&&addKeyword(c,b,"keywordGroup");cleanUpKeywords(c);cleanUpKeywordGroups(c)});cleanUpKeywordGroups(builderAll)}
function parseGroup(a,b,d){if(b.expressions){var c=createGroup(),e=getLastExpressionOrGroupIndexFromGroup(a);-1!=e?a.insertBefore(c,a.children[e].nextSibling):a.insertBefore(c,a.firstChild);b.expressions.forEach(function(a){parseGroup(c,a,b.keyword)});d&&addKeyword(c,d,"keywordGroup");cleanUpKeywords(c);cleanUpKeywordGroups(c)}else{e=document.createElement("div");e.className="expression";var f=document.getElementById("toAddContainer").cloneNode(!0);$(f).removeAttr("id");$(getValueDateFromExpression(f)).datepicker({allowPastDates:!0});
addOnchangeMethodsToDatepickerElement(getValueDateFromExpression(f));e.appendChild(f);var g;g=_.contains(IS_EMPTY_OPERATORS,b.op)?b.op:b.value;var h=new Expression({field:b.field,op:b.op,value:g});backboneExpressions.add(h);getValueTextFromExpression(e).value=g;g=$(getFieldFromExpression(f));g.val(b.field);g.select2();$(getValueSelectFromExpression(f)).select2();$(getValueSelectAutoFromExpression(f)).select2({minimumInputLength:2,multiple:!0,ajax:{quietMillis:100,dataType:"json",url:function(){return getSelectAutoUrl($(this))},
data:function(a){var b=$(this).closest(".toAddContainer")[0],b=$(getFieldFromExpression(b)).select2("val"),c={};"alertTags"==b?c.isCaseSeriesTag=!0:"globalTags"==b?c.isCaseSeriesTag=!1:"assignedTo.id"==b?c.isGroup=!1:"assignedToGroup.id"==b?c.isGroup=!0:c.field=b;c.alertType=apptype;c.term=a.term||"";c.page=a.page||1;c.max=30;return c},processResults:function(a,b){b.page=b.page||1;return{results:a.list,pagination:{more:30*b.page<a.totalCount}}}}});d&&addKeyword(e,d,"keywordExpression");editable&&
addButtonRemove(e,"removeExpression");e.expressionIndex=backboneExpressions.indexOf(h);editable&&(addDragListeners(e),e.draggable=!0);d=getLastChildWithClassnameIndexFromElement("expression",a);-1!=d?a.insertBefore(e,a.children[d].nextSibling):a.insertBefore(e,a.firstChild)}}function printToJSON(){$queryJSON.val(printAll())}
function parseSetGroup(a,b,d){if(b.expressions){var c=createGroup(),e=getLastExpressionOrGroupIndexFromGroup(a);-1!=e?a.insertBefore(c,a.children[e].nextSibling):a.insertBefore(c,a.firstChild);b.expressions.forEach(function(a){parseSetGroup(c,a,b.keyword)});d&&addKeyword(c,d,"keywordGroup");cleanUpKeywords(c);cleanUpKeywordGroups(c)}}function handleDragStart(a){this.style.opacity="0.4";dragSourceEl=this;draggingFromGroup=this.parentElement;$(builderSubgroup).show()}
function handleDragOver(a){a.preventDefault&&a.preventDefault();return!1}function handleDragEnter(a){this.classList.add("over");null==draggingFromGroup&&(draggingFromGroup=this);if(!draggingFromGroup.contains(this)){a=draggingFromGroup.getElementsByClassName("subgroup");for(var b=0;b<a.length;b++)$(a[b]).hide()}$(this).hasClass("group")&&($(getSubgroup(this)).show(),draggingFromGroup=this)}function handleDragLeave(a){this.classList.remove("over")}
function handleDrop(a){a.stopPropagation&&a.stopPropagation();dragSourceEl!=this&&(a=this.getElementsByClassName("toAddContainer")[0],this.insertBefore(dragSourceEl.getElementsByClassName("toAddContainer")[0],this.children[0]),dragSourceEl.insertBefore(a,dragSourceEl.children[0]),a=dragSourceEl.expressionIndex,dragSourceEl.expressionIndex=this.expressionIndex,this.expressionIndex=a);$(getSubgroup(this.parentElement)).hide();return!1}
function handleDragEnd(a){this.style.opacity="1";[].forEach.call($(".expression"),function(a){a.classList.remove("over")});[].forEach.call($(".group"),function(a){a.classList.remove("over")});[].forEach.call($(".subgroup"),function(a){a.classList.remove("over");$(a).hide()});$(builderSubgroup).hide();$(getSubgroup(draggingFromGroup)).hide();printToJSON()}
function handleDropIntoGroup(a){a.stopPropagation&&a.stopPropagation();a=dragSourceEl.parentElement;if(a!=this){var b=getLastChildWithClassnameIndexFromElement("expression",this),d;if(-1!=b){this.insertBefore(dragSourceEl,this.children[b].nextSibling);var c=getKeywordIndexFromElement(this.children[b]);-1!=c&&(d=this.children[b].children[c].value)}else this.insertBefore(dragSourceEl,this.firstChild);d&&(b=getKeywordIndexFromElement(dragSourceEl),-1!=b&&(dragSourceEl.children[b].value=d));cleanUpKeywords(a);
cleanUpKeywordGroups(a);cleanUpKeywords(this)}$(getSubgroup(this)).hide();return!1}
function handleDropIntoSubgroup(a){a.stopPropagation&&a.stopPropagation();a=dragSourceEl.parentElement;var b=this.parentElement,d=createGroup();d.insertBefore(dragSourceEl,d.firstChild);var c=getLastExpressionOrGroupIndexFromGroup(b);-1!=c?b.insertBefore(d,b.children[c].nextSibling):b.insertBefore(d,b.firstChild);cleanUpKeywords(a);cleanUpKeywordGroups(a);cleanUpKeywords(b);cleanUpKeywordGroups(b);cleanUpKeywords(d);$(this).hide();return!1}
function handleClickGroup(a){$(selectedGroup).removeClass("selectedGroup");selectedGroup=this;$(selectedGroup).addClass("selectedGroup")}function addDragListeners(a){a.addEventListener("dragstart",handleDragStart,!1);a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("dragenter",handleDragEnter,!1);a.addEventListener("dragleave",handleDragLeave,!1);a.addEventListener("drop",handleDrop,!1);a.addEventListener("dragend",handleDragEnd,!1)}
function addGroupDragListeners(a){a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("dragenter",handleDragEnter,!0);a.addEventListener("dragleave",handleDragLeave,!1);a.addEventListener("drop",handleDropIntoGroup,!1);a.addEventListener("click",handleClickGroup,!0)}
function addSubgroupDragListeners(a){a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("dragenter",handleDragEnter,!1);a.addEventListener("dragleave",handleDragLeave,!1);a.addEventListener("drop",handleDropIntoSubgroup,!0)}
function addOnchangeMethodsToDatepickerElement(a){$(a).on("changed.fu.datepicker",function(a,d){a=this.parentElement.parentElement;d=a.parentElement;null!=d.expressionIndex&&backboneExpressions.at(d.expressionIndex).set("value",$(getValueDateInputFromExpression(a))[0].value);$queryJSON.val(printAll())});$(a).click(function(){var a=this.parentElement.parentElement.parentElement,d=a.parentElement;null!=d.expressionIndex&&backboneExpressions.at(d.expressionIndex).set("value",$(getValueDateInputFromExpression(a))[0].value);
$queryJSON.val(printAll())});$(getValueDateInputFromExpression(a.parentElement.parentElement)).change(function(){var b=a.parentElement.parentElement,d=b.parentElement;null!=d.expressionIndex&&backboneExpressions.at(d.expressionIndex).set("value",$(getValueDateInputFromExpression(b))[0].value);$queryJSON.val(printAll())})}
function encapsulateFromIndexToIndexInNewGroup(a,b,d){for(var c=createGroup();d>=b;d--)if($(a.children[d]).hasClass("expression")||$(a.children[d]).hasClass("group"))c.firstChild?c.insertBefore(a.children[d],c.firstChild):c.appendChild(a.children[d]);return c}function createGroup(){var a=document.createElement("div");a.className="group";editable&&addButtonRemove(a,"removeGroup");editable&&addGroupDragListeners(a);addSubgroup(a);return a}
function addButtonRemove(a,b){var d=document.createElement("button"),c=document.createTextNode("x");d.appendChild(c);d.className=b+" btn btn-default btn-xs";a.appendChild(d)}function addKeyword(a,b,d){var c=document.createElement("select"),e=document.createElement("option");e.text="and";c.add(e);e=document.createElement("option");e.text="or";c.add(e);c.value=b;c.classList.add(d);c.classList.add("form-control");a.appendChild(c);editable||(c.disabled="disabled")}
function addSubgroup(a){var b=document.createElement("div");b.className="subgroup";editable&&addSubgroupDragListeners(b);$(b).hide();a.appendChild(b)}
function cleanUpKeywordGroups(a){for(var b=0,d=-1,c=0;c<a.children.length;c++)$(a.children[c]).hasClass("group")&&(b++,d=c);0<b&&(c=getKeywordIndexFromElement(a.children[d]),-1<c&&a.children[d].children[c].remove());if(0<b){c=getKeywordIndexFromElement(a.children[d]);-1<c&&a.children[d].children[c].remove();for(var c=-1,e=0;-1==c;)$(a.children[e]).hasClass("group")?c=e:e++;e=getKeywordIndexFromElement(a.children[c]);if(-1==e)if(2==b)addKeyword(a.children[c],"and","keywordGroup");else if(2<b){var f=
getKeywordIndexFromElement(a.children[c].nextSibling);addKeyword(a.children[c],$(a.children[c].nextSibling.children[f]).val(),"keywordGroup")}2<b&&-1==getKeywordIndexFromElement(a.children[d-1])&&addKeyword(a.children[d-1],$(a.children[c].children[e]).val(),"keywordGroup")}else c=getKeywordIndexFromElement(a),-1<c&&-1!=d&&a.children[d].children[c].remove()}
function cleanUpKeywords(a){var b=getLastChildWithClassnameIndexFromElement("expression",a),d=getFirstChildWithClassnameIndexFromElement("group",a);if(-1<b){var c=a.children[b].getElementsByClassName("keywordExpression");0!=c.length&&-1==d&&c[0].remove();1==b?0==a.children[0].getElementsByClassName("keywordExpression").length&&addKeyword(a.children[0],"and","keywordExpression"):1<b&&0==a.children[b-1].getElementsByClassName("keywordExpression").length&&addKeyword(a.children[b-1],$(a.children[0].getElementsByClassName("keywordExpression")[0]).val(),
"keywordExpression");-1!=d&&0==c.length&&(a.children[0].getElementsByClassName("keywordExpression")[0]?addKeyword(a.children[b],$(a.children[0].getElementsByClassName("keywordExpression")[0]).val(),"keywordExpression"):addKeyword(a.children[b],"and","keywordExpression"))}}
function createExpressionFromInput(a,b,d,c,e){e=c;if($.isArray(c)){e="";for(var f=0;f<c.length;f++)e=0!=f?e+(";"+c[f]):e+c[f]}e=new Expression({field:b,op:d,value:e});backboneExpressions.add(e);f=document.createElement("div");$(getFieldFromExpression(a)).val(b);$(getOperatorFromExpression(a)).val(d);b=getDestroyedSelectValueFromContainer(a);$(b).val(c).trigger("change");f.appendChild(a);editable&&addButtonRemove(f,"removeExpression");f.className="expression";editable&&(f.draggable=!0,addDragListeners(f));
f.expressionIndex=backboneExpressions.indexOf(e);return f}
function getDestroyedSelectValueFromContainer(a){var b=$(getFieldFromExpression(a)).val()[0].value,d=$(getOperatorFromExpression(a))[0].value;if(AJAXFieldMap[b]==RF_TYPE_DATE)return getValueDateFromExpression(a);if(AJAXFieldMap[b]==RF_TYPE_STRING)_.contains(EQUALS_OPERATORS,d);else if(AJAXFieldMap[b]==RF_TYPE_BOOLEAN)_.contains(EQUALS_OPERATORS,d);else if(AJAXFieldMap[b]==RF_TYPE_AUTOCOMPLETE&&_.contains(EQUALS_OPERATORS,d))return getValueSelectAutoFromExpression(a);return getValueSelectFromExpression(a)}
function getCorrectSelectValueFromContainer(a){var b=$(getFieldFromExpression(a)).val(),d=$(getOperatorFromExpression(a))[0].value;if(AJAXFieldMap[b]==RF_TYPE_DATE)return getValueDateFromExpression(a);if(AJAXFieldMap[b]==RF_TYPE_STRING){if(_.contains(EQUALS_OPERATORS,d))return getValueSelectFromExpression(a)}else if(AJAXFieldMap[b]==RF_TYPE_BOOLEAN){if(_.contains(EQUALS_OPERATORS,d))return getValueSelectFromExpression(a)}else if(AJAXFieldMap[b]==RF_TYPE_AUTOCOMPLETE&&_.contains(EQUALS_OPERATORS,d))return getValueSelectAutoFromExpression(a);
return getValueTextFromExpression(a)}
function showHideValue(a,b){switch(a){case EDITOR_TYPE_DATE:$(getValueTextFromExpression(b).parentElement).hide();$(getValueSelectFromExpression(b).parentElement).hide();$(getValueSelectAutoFromExpression(b).parentElement).hide();$(getValueDateFromExpression(b).parentElement).show();break;case EDITOR_TYPE_SELECT:$(getValueTextFromExpression(b).parentElement).hide();$(getValueSelectFromExpression(b).parentElement).show();$(getValueSelectAutoFromExpression(b).parentElement).hide();$(getValueDateFromExpression(b).parentElement).hide();
break;case EDITOR_TYPE_AUTOCOMPLETE:$(getValueTextFromExpression(b).parentElement).hide();$(getValueSelectFromExpression(b).parentElement).hide();$(getValueSelectAutoFromExpression(b).parentElement).show();$(getValueDateFromExpression(b).parentElement).hide();break;case EDITOR_TYPE_NONE:$(getValueTextFromExpression(b).parentElement).hide();$(getValueSelectFromExpression(b).parentElement).hide();$(getValueSelectAutoFromExpression(b).parentElement).hide();$(getValueDateFromExpression(b).parentElement).hide();
break;default:$(getValueTextFromExpression(b).parentElement).show(),$(getValueSelectFromExpression(b).parentElement).hide(),$(getValueSelectAutoFromExpression(b).parentElement).hide(),$(getValueDateFromExpression(b).parentElement).hide()}}function getFieldFromExpression(a){return $(a).find("select.expressionField")[0]}function getOperatorFromExpression(a){return $(a).find(".expressionOp")[0]}function getValueTextFromExpression(a){return $(a).find(".expressionValueText")[0]}
function getValueSelectFromExpression(a){a=$(a).find(".expressionValueSelect");return 1<a.length?a[1]:a[0]}function getValueSelectAutoFromExpression(a){a=$(a).find(".expressionValueSelectAuto");return 1<a.length?a[1]:a[0]}function getValueDateFromExpression(a){return $(a).find(".expressionValueDate")[0]}function getValueDateInputFromExpression(a){return $(a).find(".expressionValueDateInput")[0]}function getChildIndexFromParent(a,b){return Array.prototype.indexOf.call(b.children,a)}
function getKeywordIndexFromElement(a){for(var b=0;b<a.children.length;b++)if($(a.children[b]).hasClass("keywordExpression")||$(a.children[b]).hasClass("keywordGroup"))return b;return-1}function getFirstChildWithClassnameIndexFromElement(a,b){for(var d=0;d<b.children.length;d++)if($(b.children[d]).hasClass(a))return d;return-1}function getSecondChildWithClassnameIndexFromElement(a,b){for(var d=!0,c=0;c<b.children.length;c++)if($(b.children[c]).hasClass(a))if(d)d=!1;else return c;return-1}
function getLastChildWithClassnameIndexFromElement(a,b){for(var d=-1,c=0;c<b.children.length;c++)$(b.children[c]).hasClass(a)&&(d=c);return d}function getLastExpressionOrGroupIndexFromGroup(a){for(var b=-1,d=0;d<a.children.length;d++)if($(a.children[d]).hasClass("expression")||$(a.children[d]).hasClass("group"))b=d;return b}
function getExpressionOrGroupCountFromGroup(a){for(var b=0,d=0;d<a.children.length;d++)($(a.children[d]).hasClass("expression")||$(a.children[d]).hasClass("group"))&&b++;return b}function getSubgroup(a){for(var b=0;b<a.children.length;b++)if($(a.children[b]).hasClass("subgroup"))return a.children[b];return null}function checkIndexes(a){for(var b=document.getElementsByClassName("expression"),d=0;d<b.length;d++)a<b[d].expressionIndex&&b[d].expressionIndex--}
function removeEmptyGroups(a){$.each(a.getElementsByClassName("group"),function(){if(this!==window&&0==this.getElementsByClassName("expression").length){var a=this.parentElement;this.remove();cleanUpKeywordGroups(a)}})}$(document).on("change","#name",function(){0<$(this).val().trim().length&&$("#name").parent().removeClass("has-error")});
$(document).on("submit","#advancedFilterForm",function(a){$("#btnSubmit").attr("disabled","disabled");a.preventDefault();if(finalizeForm()){a=$(this).serialize();var b=$(this).attr("action");$.ajax({type:"POST",url:b,data:a,dataType:"json",success:saveAdvancedFilterSuccessCallback})}else showErrorMessage("Please fill the required fields."),$(".expressionField")[0].focus(),$("#btnSubmit").removeAttr("disabled")});
$(document).on("click",".filtersWithoutSaving",function(a){a.preventDefault();finalizeForm()?($(".advanced-filter-dropdown").val("").trigger("change"),closeModal()):showErrorMessage("Please fill the required fields.")});
$(document).on("click",".deleteAdvFilter",function(a){a.preventDefault();bootbox.confirm({message:$.i18n._("deleteThis"),buttons:{confirm:{label:"Yes",className:"btn-primary"},cancel:{label:"No",className:"btn-default"}},callback:function(a){a&&(a={},a.id=$("#filterId").val(),$.ajax({type:"POST",url:filterDeleteUrl,data:a,dataType:"json",success:deleteAdvancedFilterSuccessCallback}))}})});
var saveAdvancedFilterSuccessCallback=function(a){a.status?($("#btnSubmit").removeAttr("disabled"),closeModal(),a=new Option(a.data.text,a.data.id,!0,!0),$(".advanced-filter-dropdown").append(a).trigger("change")):($("#btnSubmit").removeAttr("disabled"),showErrorMessage(a.message))},deleteAdvancedFilterSuccessCallback=function(a){a.status?(closeModal(),location.reload()):showErrorMessage(a.message)};
function showErrorMessage(a){var b=$(".msgContainer").find(".alert");b.find(".message").text(a);$(".msgContainer").show();b.alert();b.fadeTo(5E3,500).slideUp(500,function(){b.slideUp(500)})}function finalizeForm(){printToJSON();return"true"===$("#hasBlanksQuery").val()?!1:!0}
function getSelectAutoUrl(a){a=a.closest(".toAddContainer")[0];a=$(getFieldFromExpression(a)).select2("val");return"alertTags"==a||"globalTags"==a?fetchTagsUrl:"assignedTo.id"==a||"assignedToGroup.id"==a?fetchUsersUrl:selectAutoUrl}function closeModal(){$("#createAdvancedFilterModal").modal("hide")};